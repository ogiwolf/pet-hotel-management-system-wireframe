<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw Pad App</title>
    <!-- 引入新設計的字體 -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
    <!-- 引入 Tailwind CSS (Play CDN - 僅用於開發/原型階段) -->
    <!-- 注意：生產環境應使用 Tailwind CLI 或 PostCSS 插件構建 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Leaflet 地圖 (免費替代方案) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* 匹配新設計的基礎樣式 */
        body {
            font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
            background-color: #f0f2f5; /* 整體背景色 */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
        }

        .phone-mockup {
            width: 375px;
            min-height: 667px;
            background-color: #fff;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* 為底部導航預留空間 */
            position: relative; /* 為訂房流程的absolute定位提供參考 */
        }

        /* 隱藏滾動條 */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* 新設計風格的按鈕 */
        .btn-main {
             display: flex;
             cursor: pointer;
             align-items: center;
             justify-content: center;
             overflow: hidden;
             border-radius: 9999px; /* rounded-full */
             height: 48px; /* h-12 */
             padding-left: 24px; /* px-6 */
             padding-right: 24px;
             background-color: #181111;
             color: #ffffff;
             font-size: 1rem; /* text-base */
             font-weight: 700; /* font-bold */
             line-height: 1.5; /* leading-normal */
             border: none;
             width: 100%;
        }
        .btn-main:hover {
            background-color: #333;
        }
        
        /* 表單輸入框樣式 */
        .form-input-styled {
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            color: #181111;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            padding: 0.75rem;
            font-size: 1rem;
        }
        .form-input-styled:focus {
            outline: none;
            box-shadow: 0 0 0 2px #181111;
            border-color: #181111;
        }
        
        /* 卡片樣式 */
        .listing-card {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 1rem; /* gap-4 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            border: 1px solid #f4f0f0;
            background-color: #fff;
        }
        
        .listing-card .info-section {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* gap-4 */
            flex: 2 1 0%;
        }
        
        .listing-card .image-section {
            width: 100%;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1 / 1;
            background-size: cover;
            border-radius: 0.75rem; /* rounded-xl */
            flex: 1.5 1 0%;
        }
        
        /* 底部導航項目 */
        .nav-item .icon-wrapper { color: #886364; }
        .nav-item p { color: #886364; }
        .nav-item.active .icon-wrapper { color: #181111; }
        .nav-item.active p { color: #181111; }

        /* 模態框樣式 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 15px; width: 90%; max-width: 360px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .calendar-day {
            padding: 8px 0; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.selected { background-color: #181111; color: #fff; }
        .calendar-day.in-range { background-color: #e5e7eb; color: #181111; border-radius: 0; }
        .calendar-day.range-start { background-color: #181111; color: #fff; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .calendar-day.range-end { background-color: #181111; color: #fff; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        
        /* 服務類型切換 */
        .service-type-toggle button {
            transition: all 0.2s ease-in-out;
        }
        .service-type-toggle button.active {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #181111;
        }
        .service-type-toggle button:not(.active) {
            color: #886364;
        }
        
        /* 方案樣式 */
        .package-item {
            border: 2px solid #f4f0f0;
            transition: all 0.2s ease-in-out;
        }
        .package-item.selected {
            border-color: #181111;
            background-color: #f9fafb;
        }
        .package-item.unavailable {
            opacity: 0.5;
            background-color: #f9fafb;
            cursor: not-allowed;
        }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #181111; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        
        /* 時間滑桿樣式 */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e5e7eb;
            outline: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .slider:hover {
            background: #d1d5db;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-moz-range-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        /* 時間顯示標籤樣式 */
        #start-time-display {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        #end-time-display {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        /* 管理行事曆樣式 */
        .mgmt-calendar-cell.blocked {
            background-image: repeating-linear-gradient(45deg, #e5e7eb, #e5e7eb 5px, #f9fafb 5px, #f9fafb 10px);
        }

        /* 當前時間線動畫 */
        .current-time-line {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* UI優化：隱藏結束時間滑桿，只保留開始時間選擇 */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }
        
        /* 優化時長顯示區域 */
        #daycare-date-selection .bg-gray-50 {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
        }

        /* 美化時間選擇區域 */
        #daycare-date-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        #daycare-date-selection .mb-4 {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        #daycare-date-selection .bg-gray-50 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* 確保所有時間滑桿都顯示 - 覆蓋之前的隱藏規則 */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }

        /* 更強制的顯示規則 */
        #end-time-slider,
        #end-time-display {
            display: block !important;
            visibility: visible !important;
        }
        
        /* 確保結束時間區域顯示 */
        #daycare-date-selection div:has(#end-time-slider) {
            display: block !important;
            opacity: 1 !important;
        }

        /* 設定頁面標籤樣式 */
        .settings-tab-btn {
            background-color: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        
        .settings-tab-btn.active {
            background-color: #181111;
            color: white;
        }
        
        .settings-tab-btn:hover:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .settings-tab-content {
            transition: opacity 0.3s ease;
        }

        /* 日間安親時間選擇優化 */
        .daycare-time-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        /* 確保時段選擇器文字可見 */
        .time-range-selector {
            background: white !important;
            border: 2px solid #e5e7eb !important;
        }
        
        .time-range-selector select {
            color: #181111 !important;
            background: white !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector label {
            color: #374151 !important;
            font-weight: 600 !important;
        }
        
        /* 時段資訊顯示區域 */
        .time-range-selector .bg-white {
            background: #f9fafb !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector .bg-white span {
            color: #181111 !important;
        }
        
        /* 時段可用性概覽樣式 */
        .time-availability-overview {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
        }
        
        /* 時間軸樣式 */
        .timeline-container {
            position: relative;
            padding: 30px 0;
        }
        
        .timeline-line {
            position: relative;
            display: flex;
            align-items: center;
            height: 50px;
            background: #f3f4f6;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-segment {
            position: relative;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 600;
            font-size: 11px;
            text-align: center;
            border-right: 2px solid white;
        }
        
        .timeline-segment:last-child {
            border-right: none;
        }
        
        .timeline-segment.available {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .timeline-segment.unavailable {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .timeline-segment:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .timeline-segment.selected {
            box-shadow: 0 0 0 3px #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }
        
        .segment-time {
            font-size: 10px;
            line-height: 1.2;
            padding: 0 4px;
        }
        

        
        .preset-time-slots {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .preset-time-slot {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .preset-time-slot:hover {
            border-color: #181111;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preset-time-slot.selected {
            border-color: #181111;
            background-color: #f9fafb;
            box-shadow: 0 2px 8px rgba(24, 17, 17, 0.15);
        }
        
        .preset-time-slot .time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .time-label {
            font-weight: 600;
            color: #181111;
            font-size: 16px;
        }
        
        .preset-time-slot .price {
            font-weight: 700;
            color: #059669;
            font-size: 18px;
        }
        
        .preset-time-slot .time-detail {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .preset-time-slot .feature-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        /* 價格透明度改進 */
        .price-transparency {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .price-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .price-item:last-child {
            border-bottom: none;
        }
        
        .price-item.addon {
            background: #f9fafb;
            margin: 8px -12px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .price-item .item-label {
            color: #374151;
            font-size: 14px;
        }
        
        .price-item .item-detail {
            color: #6b7280;
            font-size: 13px;
        }
        
        .price-item .item-price {
            font-weight: 600;
            color: #181111;
        }
        
        .price-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }
        
        .price-total .total-label {
            font-weight: 700;
            color: #181111;
            font-size: 16px;
        }
        
        .price-total .total-price {
            font-weight: 700;
            color: #059669;
            font-size: 20px;
        }
        
        /* 錯誤處理機制優化 */
        .error-handling {
            margin: 16px 0;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        
        .error-message .error-title {
            color: #dc2626;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message .error-list {
            color: #7f1d1d;
            font-size: 13px;
            margin: 0;
            padding-left: 20px;
        }
        
        .error-message .error-list li {
            margin-bottom: 4px;
        }
        
        .validation-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .validation-indicator.valid {
            color: #059669;
        }
        
        .validation-indicator.invalid {
            color: #dc2626;
        }
        
        .validation-indicator .icon {
            width: 16px;
            height: 16px;
        }
        
        /* 自訂時段選擇優化 */
        .custom-time-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
            margin-top: 16px;
        }
        
        .custom-time-toggle {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .custom-time-toggle:hover {
            border-color: #181111;
            color: #181111;
        }
        
        .custom-time-toggle.active {
            background: #181111;
            color: white;
            border-color: #181111;
        }
        
        .time-sliders {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .time-sliders.hidden {
            display: none;
        }
        
        /* == START: 新增寵物檔案相關樣式 == */
        .pet-tag-btn {
            background-color: #f3f4f6;
            color: #374151;
            padding: 6px 12px;
            border-radius: 9999px;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .pet-tag-btn:hover {
            background-color: #e5e7eb;
        }
        
        .pet-tag-btn.active {
            background-color: #181111;
            color: white;
        }
        
        .pet-selection-card {
            transition: all 0.2s;
        }
        
        .pet-selection-card:hover {
            border-color: #d1d5db;
        }
        
        .pet-selection-card.selected {
            border-color: #181111;
            background-color: #f9fafb;
        }
        /* == END: 新增寵物檔案相關樣式 == */
    </style>
</head>
<body>
    <div class="phone-mockup">
        <!-- 主內容區域 -->
        <div id="main-content" class="content-area no-scrollbar">

            <!-- 所有頁面容器 -->
            <div id="home-page" class="page-content"></div>
            <div id="search-result-page" class="page-content hidden"></div>
            <div id="search-results-page" class="page-content hidden"></div>
            <div id="detail-page" class="page-content hidden"></div>
            <div id="favorites-page" class="page-content hidden"></div>
            <div id="orders-page" class="page-content hidden"></div>
            <div id="order-detail-page" class="page-content hidden"></div>
            <div id="user-center-page" class="page-content hidden"></div>
            <div id="merchant-dashboard-page" class="page-content hidden"></div>
            <div id="analytics-dashboard-page" class="page-content hidden"></div>
            <div id="room-management-page" class="page-content hidden"></div>
            <div id="package-management-page" class="page-content hidden"></div>
            <div id="chat-page" class="page-content hidden"></div>
            <div id="calendar-management-page" class="page-content hidden"></div>
            <div id="booking-flow-page" class="page-content hidden"></div>
            <div id="payment-success-page" class="page-content hidden">
                <!-- 付款成功頁面內容將由 JavaScript 動態生成 -->
            </div>
            <div id="settings-page" class="page-content hidden"></div>
            
            <!-- == START: 新增寵物檔案相關頁面 == -->
            <div id="my-pets-page" class="page-content hidden"></div>
            <div id="pet-profile-page" class="page-content hidden"></div>
            <!-- == END: 新增寵物檔案相關頁面 == -->
            
            <!-- == START: 新增的金流頁面容器 == -->
            <div id="finance-dashboard-page" class="page-content hidden"></div>
            <div id="payout-settings-page" class="page-content hidden"></div>
            <div id="payout-history-page" class="page-content hidden"></div>
            <!-- == END: 新增的金流頁面容器 == -->
        </div>

        <!-- 全螢幕模態框 (用於新增/編輯) -->
        <div id="form-modal" class="absolute inset-0 bg-gray-50 z-20 hidden page-content no-scrollbar">
            <!-- 內容由JS動態生成 -->
        </div>

        <!-- 日曆 Modal -->
        <div id="calendar-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <!-- 日曆內容由JS生成 -->
            </div>
        </div>

        <!-- 底部導覽列 -->
        <div class="absolute bottom-0 left-0 right-0 z-10">
            <div class="flex gap-2 border-t border-[#f4f0f0] bg-white px-4 pb-3 pt-2">
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="home">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l80-75.48.11-.11a16,16,0,0,1,21.53,0,1.14,1.14,0,0,0,.11.11l80,75.48A16,16,0,0,1,224,115.55Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">首頁</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="favorites">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,16V161.57l-51.77-32.35a8,8,0,0,0-8.48,0L72,161.56V48Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">我的收藏</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="orders">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,48H48A16,16,0,0,0,32,64V192a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V64A16,16,0,0,0,208,48Zm-40,96H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Zm0-32H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">訂單</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="account">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">我的帳戶</p>
                </a>
            </div>
            <div class="h-5 bg-white"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 狀態與資料 ---
            let isUserMerchant = false;
            let currentCalendarDate = new Date();
            let selectedCheckinDate = null;
            let selectedCheckoutDate = null;
            let isSelectingCheckin = true;
            let managementCalendarDate = new Date();
            let currentManagementRoomId = 1;
            let managementViewMode = 'monthly'; // 'monthly' or 'daily'


            // == START: 新增寵物檔案假資料 ==
            window.mockPets = [
                {
                    id: 1,
                    name: '小黃',
                    photoUrl: 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center',
                    breed: '黃金獵犬',
                    age: 3,
                    weight: 25,
                    gender: 'male', // male, female
                    isNeutered: true,
                    personalityTags: ['親人', '活潑', '親狗', '已定點大小便'],
                    vaccines: [
                        { name: '狂犬病疫苗', date: '2025-03-15', proofUrl: '' },
                        { name: '八合一疫苗', date: '2025-03-15', proofUrl: '' }
                    ],
                    allergies: '海鮮、花生',
                    medications: '每日早晚飯後需服用關節保健藥 1 顆。',
                    specialNeeds: '關節較敏感，不適合劇烈跳躍。'
                },
                {
                    id: 2,
                    name: '咪咪',
                    photoUrl: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=150&h=150&fit=crop&crop=center',
                    breed: '英國短毛貓',
                    age: 5,
                    weight: 5,
                    gender: 'female',
                    isNeutered: true,
                    personalityTags: ['內向', '親人', '有點膽小'],
                    vaccines: [
                        { name: '三合一疫苗', date: '2025-01-20', proofUrl: '' }
                    ],
                    allergies: '無',
                    medications: '無',
                    specialNeeds: '喜歡有躲藏空間的地方。'
                }
            ];
            // == END: 新增寵物檔案假資料 ==

            window.mockOrders = [
                { id: 1, name: '快樂爪子旅館', date: '2025/07/10 - 2025/07/12', pet: '1 犬', total: 1600, status: 'pending' },
                { id: 2, name: '貓語天堂', date: '2025/06/01 - 2025/06/05', pet: '2 貓', total: 3250, status: 'completed' },
                { id: 3, name: '寵物樂園', date: '2025/05/20 - 2025/05/22', pet: '1 犬', total: 1800, status: 'cancelled' },
                { id: 4, name: '汪星人度假村', date: '2025-07-01 - 2025-07-03', pet: '1 犬', total: 2850, status: 'pending' },
                { id: 5, name: '快樂爪子旅館', date: '2025-04-10 - 2025-04-12', pet: '1 貓', total: 1300, status: 'completed' },
            ];
            
            // 寵物旅館假資料
            const mockHotels = [
                {
                    id: 1,
                    name: '快樂爪子旅館',
                    location: '台北市中山區',
                    rating: 4.8,
                    reviewCount: 120,
                    price: 800,
                    imageUrl: 'https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600',
                    petTypes: ['dog', 'cat'],
                    services: ['overnight', 'daycare'],
                    features: ['24小時監控', '專業獸醫', '大型活動區'],
                    distance: '0.5km'
                },
                {
                    id: 2,
                    name: '貓語天堂',
                    location: '新北市板橋區',
                    rating: 4.9,
                    reviewCount: 150,
                    price: 650,
                    imageUrl: 'https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800',
                    petTypes: ['cat'],
                    services: ['overnight', 'daycare'],
                    features: ['專屬貓跳台', '獨立空調', '貓咪專用玩具'],
                    distance: '1.2km'
                },
                {
                    id: 3,
                    name: '汪星人度假村',
                    location: '台北市信義區',
                    rating: 4.7,
                    reviewCount: 89,
                    price: 1200,
                    imageUrl: 'https://images.unsplash.com/photo-1552053831-71594a27632d?q=80&w=1000',
                    petTypes: ['dog'],
                    services: ['overnight'],
                    features: ['大型戶外空間', '專業訓練師', 'SPA服務'],
                    distance: '2.1km'
                },
                {
                    id: 4,
                    name: '寵物樂園',
                    location: '台北市大安區',
                    rating: 4.6,
                    reviewCount: 203,
                    price: 900,
                    imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600',
                    petTypes: ['dog', 'cat', 'rabbit'],
                    services: ['overnight', 'daycare'],
                    features: ['多種寵物服務', '24小時照護', '定期健康檢查'],
                    distance: '0.8km'
                },
                {
                    id: 5,
                    name: '毛孩之家',
                    location: '台北市松山區',
                    rating: 4.5,
                    reviewCount: 67,
                    price: 750,
                    imageUrl: 'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?q=80&w=600',
                    petTypes: ['dog', 'cat', 'bird'],
                    services: ['daycare'],
                    features: ['溫馨環境', '專業照護', '個別關注'],
                    distance: '1.5km'
                },
                {
                    id: 6,
                    name: '寵物皇宮',
                    location: '台北市內湖區',
                    rating: 4.9, 
                    reviewCount: 156,
                    price: 1500,
                    imageUrl: 'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?q=80&w=600',
                    petTypes: ['dog', 'cat'],
                    services: ['overnight'],
                    features: ['豪華套房', '專屬管家', '頂級服務'],
                    distance: '3.2km'
                },
                {
                    id: 7,
                    name: '小動物天堂',
                    location: '台北市士林區',
                    rating: 4.4,
                    reviewCount: 45,
                    price: 500,
                    imageUrl: 'https://images.unsplash.com/photo-1583337130417-3346a1be7dee?q=80&w=600',
                    petTypes: ['rabbit', 'bird', 'other'],
                    services: ['daycare'],
                    features: ['小動物專區', '專業照護', '安全環境'],
                    distance: '2.8km'
                },
                {
                    id: 8,
                    name: '寵物溫馨小屋',
                    location: '台北市萬華區',
                    rating: 4.7,
                    reviewCount: 98,
                    price: 850,
                    imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600',
                    petTypes: ['dog', 'cat'],
                    services: ['overnight', 'daycare'],
                    features: ['家庭式照護', '溫馨環境', '個別關注'],
                    distance: '1.8km'
                }
            ];
            
            // 收藏的假資料
            let favoriteHotels = [
                {
                    id: 1,
                    name: '貓語天堂',
                    location: '新北市',
                    rating: 4.9,
                    reviewCount: 150,
                    petTypes: ['cat'],
                    imageUrl: 'https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800'
                },
                {
                    id: 3,
                    name: '汪星人度假村',
                    location: '台中市',
                    rating: 4.7,
                    reviewCount: 85,
                    petTypes: ['dog'],
                    imageUrl: 'https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600'
                }
            ];
            
            window.mockRoomTypes = [
                // 日租房型：標準犬房
                { id: 1, name: '標準犬房', description: '舒適的標準房，適合中小型犬。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 5, status: 'active', serviceType: 'overnight', basePrice: 800, minNights: 1, maxNights: 30 },
                // 日租房型：豪華貓別墅
                { id: 2, name: '豪華貓別墅', description: '寬敞的豪華別墅，附有貓跳台與獨立通風。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 3, status: 'active', serviceType: 'overnight', basePrice: 1500, minNights: 1, maxNights: 15 },
                // 時租房型：小型寵物寄宿籠（最小時數4小時，之後每小時計費）
                { id: 3, name: '小型寵物寄宿籠', description: '安全舒適的寄宿籠，適合兔子、倉鼠等。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 10, status: 'disabled', serviceType: 'daycare', minHours: 4, hourlyRate: 30, startTime: '09:00', endTime: '18:00' },
                // 日租房型：陽光豪華雙人房
                { id: 4, name: '陽光豪華雙人房', description: '附有陽台的雙寵物豪華房。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 2, status: 'active', serviceType: 'overnight', basePrice: 1200, minNights: 1, maxNights: 30 }
            ];
            
            window.mockBookings = [
                // 日租預訂
                { id: 1, roomId: 1, serviceType: 'overnight', customer: '陳先生', startDate: '2025-07-10', endDate: '2025-07-12' },
                { id: 2, roomId: 2, serviceType: 'overnight', customer: '林小姐', startDate: '2025-07-15', endDate: '2025-07-18' },
                { id: 3, roomId: 1, serviceType: 'overnight', customer: '王小姐', startDate: '2025-07-20', endDate: '2025-07-25' },
                { id: 5, roomId: 2, serviceType: 'overnight', customer: '張太太', startDate: '2025-07-01', endDate: '2025-07-03' },
                { id: 7, roomId: 4, serviceType: 'overnight', customer: '蔡小姐', startDate: '2025-07-22', endDate: '2025-07-23' },
                { id: 8, roomId: 4, serviceType: 'overnight', customer: '鄭先生', startDate: '2025-07-08', endDate: '2025-07-11' },
                { id: 9, roomId: 1, serviceType: 'overnight', customer: '趙小姐', startDate: '2025-07-10', endDate: '2025-07-11' },
                // 新增更多預訂來模擬滿房情況
                { id: 10, roomId: 1, serviceType: 'overnight', customer: '劉先生', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 11, roomId: 1, serviceType: 'overnight', customer: '黃小姐', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 12, roomId: 1, serviceType: 'overnight', customer: '周先生', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 13, roomId: 1, serviceType: 'overnight', customer: '吳太太', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 14, roomId: 1, serviceType: 'overnight', customer: '林先生', startDate: '2025-01-15', endDate: '2025-01-17' },
                // 時租預訂（原來的 packageId 102/103 都是時租，統一轉換）
                { id: 4, roomId: 1, serviceType: 'daycare', customer: '李先生', startDate: '2025-07-05', endDate: '2025-07-05', startTime: '09:00', endTime: '13:00', duration: 4 },
                { id: 6, roomId: 1, serviceType: 'daycare', customer: '吳先生', startDate: '2025-07-14', endDate: '2025-07-14', startTime: '14:00', endTime: '18:00', duration: 4 },
                // 時租預訂（roomId 3 原本是時租方案）
                { id: 15, roomId: 3, serviceType: 'daycare', customer: '陳太太', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '17:00', duration: 8 },
                { id: 16, roomId: 3, serviceType: 'daycare', customer: '張先生', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '10:00', endTime: '18:00', duration: 8 },
                { id: 17, roomId: 3, serviceType: 'daycare', customer: '李小姐', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '13:00', duration: 4 },
                { id: 18, roomId: 3, serviceType: 'daycare', customer: '王先生', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '10:00', endTime: '18:00', duration: 8 },
                { id: 19, roomId: 3, serviceType: 'daycare', customer: '劉太太', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '17:00', duration: 8 },
                { id: 20, roomId: 3, serviceType: 'daycare', customer: '黃先生', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '14:00', endTime: '18:00', duration: 4 },
                { id: 21, roomId: 3, serviceType: 'daycare', customer: '周太太', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '17:00', duration: 8 },
                { id: 22, roomId: 3, serviceType: 'daycare', customer: '吳先生', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '10:00', endTime: '18:00', duration: 8 },
                { id: 23, roomId: 3, serviceType: 'daycare', customer: '林太太', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '13:00', duration: 4 },
                { id: 24, roomId: 3, serviceType: 'daycare', customer: '陳先生', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '10:00', endTime: '17:00', duration: 7 },
                { id: 25, roomId: 3, serviceType: 'daycare', customer: '張太太', startDate: '2025-01-15', endDate: '2025-01-15', startTime: '09:00', endTime: '17:00', duration: 8 },
            ];
            
            window.mockComments = [
                { 
                    id: 1, 
                    customer: '陳先生', 
                    rating: 5, 
                    comment: '服務非常棒！我的狗狗住得很開心，環境乾淨舒適，工作人員也很專業。', 
                    date: '2025-07-15', 
                    roomType: '標準犬房',
                    reply: '',
                    status: 'pending'
                },
                { 
                    id: 2, 
                    customer: '林小姐', 
                    rating: 4, 
                    comment: '整體還不錯，但房間有點小，價格稍微貴了一點。', 
                    date: '2025-07-20', 
                    roomType: '豪華貓別墅',
                    reply: '',
                    status: 'pending'
                },
                { 
                    id: 3, 
                    customer: '王小姐', 
                    rating: 5, 
                    comment: '非常推薦！我的貓咪在這裡住得很安心，設施齊全，工作人員很細心。', 
                    date: '2025-07-25', 
                    roomType: '豪華貓別墅',
                    reply: '謝謝您的肯定！我們會繼續努力提供更好的服務。',
                    status: 'replied'
                },
                { 
                    id: 4, 
                    customer: '張先生', 
                    rating: 3, 
                    comment: '房間還可以，但隔音效果不太好，晚上有點吵。', 
                    date: '2025-07-30', 
                    roomType: '小型寵物寄宿籠',
                    reply: '',
                    status: 'pending'
                },
                { 
                    id: 5, 
                    customer: '李小姐', 
                    rating: 5, 
                    comment: '超級滿意！我的兔子在這裡住得很舒服，環境很好，價格合理。', 
                    date: '2025-08-05', 
                    roomType: '小型寵物寄宿籠',
                    reply: '感謝您的支持！我們很開心能為您的兔子提供舒適的住宿環境。',
                    status: 'replied'
                }
            ];

            // --- 元素選擇 ---
            const navItems = document.querySelectorAll('.nav-item');
            const mainContent = document.getElementById('main-content');
            const pages = {
                home: document.getElementById('home-page'),
                searchResult: document.getElementById('search-result-page'),
                searchResults: document.getElementById('search-results-page'),
                detail: document.getElementById('detail-page'),
                favorites: document.getElementById('favorites-page'),
                orders: document.getElementById('orders-page'),
                orderDetail: document.getElementById('order-detail-page'),
                account: document.getElementById('user-center-page'),
                chat: document.getElementById('chat-page'),
                merchantDashboard: document.getElementById('merchant-dashboard-page'),
                analyticsDashboard: document.getElementById('analytics-dashboard-page'),
                roomManagement: document.getElementById('room-management-page'),
                packageManagement: document.getElementById('package-management-page'),
                calendarManagement: document.getElementById('calendar-management-page'),
                bookingFlow: document.getElementById('booking-flow-page'),
                paymentSuccess: document.getElementById('payment-success-page'),
                settings: document.getElementById('settings-page'),
                
                // == START: 新增的寵物檔案頁面參照 ==
                myPets: document.getElementById('my-pets-page'),
                petProfile: document.getElementById('pet-profile-page'),
                // == END: 新增的寵物檔案頁面參照 ==
                
                // == START: 新增的頁面參照 ==
                financeDashboard: document.getElementById('finance-dashboard-page'),
                payoutSettings: document.getElementById('payout-settings-page'),
                payoutHistory: document.getElementById('payout-history-page'),
                // == END: 新增的頁面參照 ==
            };
            const calendarModal = document.getElementById('calendar-modal');
            const formModal = document.getElementById('form-modal');

            // --- 核心功能：頁面切換 ---
            window.showPage = function(pageKey, state = {}) {
                Object.values(pages).forEach(page => page && page.classList.add('hidden'));
                
                const targetPage = pages[pageKey];
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    if (pageKey === 'detail') renderDetailPage(state);
                    if (pageKey === 'orders') renderOrdersPage();
                    if (pageKey === 'orderDetail') renderOrderDetailPage(state);
                    if (pageKey === 'account') renderUserCenterPage();
                    if (pageKey === 'merchantDashboard') renderMerchantDashboard();
                    
                    // == START: 新增的頁面渲染呼叫 ==
                    if (pageKey === 'financeDashboard') renderFinanceDashboardPage();
                    if (pageKey === 'payoutSettings') renderPayoutSettingsPage();
                    if (pageKey === 'payoutHistory') renderPayoutHistoryPage();
                    // == END: 新增的頁面渲染呼叫 ==
                    
                    if (pageKey === 'roomManagement') renderRoomListPage();
                    // packageManagement page removed - packages are now integrated into room types
                    if (pageKey === 'chat') renderChatPage(state);
                    if (pageKey === 'home') renderHomePage();
                    if (pageKey === 'searchResult') renderSearchResultPage();
                    if (pageKey === 'searchResults') renderSearchResultsPage(state);
                    if (pageKey === 'favorites') renderFavoritesPage();
                    if (pageKey === 'calendarManagement') renderCalendarManagementPage();
                    if (pageKey === 'bookingFlow') renderBookingFlowPage();
                    if (pageKey === 'paymentSuccess') renderPaymentSuccessPage();
                    if (pageKey === 'settings') renderSettingsPage();
                    
                    // == START: 新增的寵物檔案頁面渲染呼叫 ==
                    if (pageKey === 'myPets') renderMyPetsPage(state.fromPage);
                    if (pageKey === 'petProfile') renderPetProfilePage(state.petId, state.fromPage); // 我們會傳入 petId 和 fromPage
                    // == END: 新增的寵物檔案頁面渲染呼叫 ==
                }
                updateNavActiveState(pageKey);
            }

            function updateNavActiveState(activePageKey) {
                navItems.forEach(item => {
                    const page = item.dataset.page;
                    item.classList.toggle('active', page === activePageKey);
                });
            }

            // --- 渲染函式 ---
            
            // 搜尋頁面
            function renderSearchResultPage() {
                const container = pages.searchResult;
                
                // 預設搜尋條件
                const defaultSearchData = {
                    location: '',
                    checkinDate: new Date().toISOString().split('T')[0],
                    checkoutDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    petCount: 1,
                    serviceType: 'overnight',
                    petTypes: ['dog', 'cat']
                };
                
                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="search-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">搜尋</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>
                        
                        <!-- 搜尋內容 -->
                        <div class="p-4 pb-20">
                            <!-- 搜尋地點 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4 mb-4">
                                <h3 class="font-bold text-[#181111] mb-3">搜尋地點</h3>
                                <div class="flex w-full items-stretch rounded-xl h-12 mb-3">
                                    <div class="text-[#886364] flex border-none bg-[#f4f0f0] items-center justify-center pl-4 rounded-l-xl">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                                            <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                                        </svg>
                                    </div>
                                    <input id="search-location-input" placeholder="輸入地點" class="form-input-styled placeholder:text-[#886364] px-4 rounded-l-none pl-2 text-base font-normal leading-normal">
                                </div>
                                
                                <!-- 附近區域選項 -->
                                <div class="flex items-center text-[#886364] cursor-pointer hover:text-[#181111] transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="text-sm">附近區域</span>
                                </div>
                                
                                <!-- 最近搜尋 -->
                                <div class="mt-4">
                                    <h4 class="font-bold text-[#181111] mb-2">最近搜尋</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center text-[#886364] cursor-pointer hover:text-[#181111] transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span class="text-sm">台北市中山區</span>
                                        </div>
                                        <div class="flex items-center text-[#886364] cursor-pointer hover:text-[#181111] transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <span class="text-sm">台北101</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 篩選選項 -->
                            <div class="space-y-3 mb-6">
                                <!-- 日期選擇 -->
                                <div class="bg-white rounded-xl border border-gray-100 p-4 cursor-pointer" id="date-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-[#181111]">日期</span>
                                        <div class="flex items-center">
                                            <span class="text-sm text-[#181111]" id="date-display">8月20日 週三 - 8月23日 週五</span>
                                            <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 寵物數量 -->
                                <div class="bg-white rounded-xl border border-gray-100 p-4 cursor-pointer" id="pet-count-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-[#181111]">寵物數量</span>
                                        <div class="flex items-center">
                                            <span class="text-sm text-[#181111]" id="pet-count-display">1</span>
                                            <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 服務類型 -->
                                <div class="bg-white rounded-xl border border-gray-100 p-4 cursor-pointer" id="service-type-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-[#181111]">服務類型</span>
                                        <div class="flex items-center">
                                            <span class="text-sm text-[#181111]" id="service-type-display">寄宿過夜</span>
                                            <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 寵物種類 -->
                                <div class="bg-white rounded-xl border border-gray-100 p-4 cursor-pointer" id="pet-type-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium text-[#181111]">寵物種類</span>
                                        <div class="flex items-center">
                                            <span class="text-sm text-[#181111]" id="pet-type-display">犬、貓</span>
                                            <svg class="w-4 h-4 ml-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 底部按鈕 -->
                            <div class="flex justify-between items-center">
                                <button id="clear-search-btn" class="px-6 py-3 text-[#886364] font-medium">
                                    清除
                                </button>
                                <button id="search-btn" class="px-8 py-3 bg-[#181111] text-white rounded-xl font-medium">
                                    搜尋
                                </button>
                            </div>
                        </div>
                        
                        <!-- 日期選擇模態框 -->
                        <div id="search-date-modal" class="modal-overlay hidden">
                            <div class="modal-content max-w-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-[#181111]">選擇日期</h3>
                                    <button id="close-date-modal" class="text-2xl text-gray-400">&times;</button>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">入住日期</label>
                                        <input type="date" id="search-checkin-date" class="form-input-styled w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">退房日期</label>
                                        <input type="date" id="search-checkout-date" class="form-input-styled w-full">
                                    </div>
                                    <button id="confirm-date" class="btn-main w-full">確認</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 寵物數量選擇模態框 -->
                        <div id="pet-count-modal" class="modal-overlay hidden">
                            <div class="modal-content max-w-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-[#181111]">寵物數量</h3>
                                    <button id="close-pet-count-modal" class="text-2xl text-gray-400">&times;</button>
                                </div>
                                <div class="text-center">
                                    <div class="flex items-center justify-center mb-6">
                                        <button id="decrease-pet-count" class="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center text-xl">-</button>
                                        <span id="pet-count-value" class="mx-6 text-2xl font-bold">1</span>
                                        <button id="increase-pet-count" class="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center text-xl">+</button>
                                    </div>
                                    <button id="confirm-pet-count" class="btn-main w-full">確認</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 服務類型選擇模態框 -->
                        <div id="service-type-modal" class="modal-overlay hidden">
                            <div class="modal-content max-w-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-[#181111]">服務類型</h3>
                                    <button id="close-service-type-modal" class="text-2xl text-gray-400">&times;</button>
                                </div>
                                <div class="space-y-3">
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="radio" name="service-type" value="overnight" class="mr-3" checked>
                                        <div>
                                            <div class="font-medium text-[#181111]">寄宿過夜</div>
                                            <div class="text-sm text-gray-500">24小時住宿服務</div>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="radio" name="service-type" value="daycare" class="mr-3">
                                        <div>
                                            <div class="font-medium text-[#181111]">日間安親</div>
                                            <div class="text-sm text-gray-500">白天托育服務</div>
                                        </div>
                                    </label>
                                </div>
                                <button id="confirm-service-type" class="btn-main w-full mt-4">確認</button>
                            </div>
                        </div>
                        
                        <!-- 寵物種類選擇模態框 -->
                        <div id="pet-type-modal" class="modal-overlay hidden">
                            <div class="modal-content max-w-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-[#181111]">寵物種類</h3>
                                    <button id="close-pet-type-modal" class="text-2xl text-gray-400">&times;</button>
                                </div>
                                <div class="space-y-3">
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="checkbox" name="pet-type" value="dog" class="mr-3" checked>
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                            <span class="font-medium text-[#181111]">犬</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="checkbox" name="pet-type" value="cat" class="mr-3" checked>
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                            <span class="font-medium text-[#181111]">貓</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="checkbox" name="pet-type" value="rabbit" class="mr-3">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                            <span class="font-medium text-[#181111]">兔子</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="checkbox" name="pet-type" value="bird" class="mr-3">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                            <span class="font-medium text-[#181111]">鳥類</span>
                                        </div>
                                    </label>
                                    <label class="flex items-center p-3 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-colors">
                                        <input type="checkbox" name="pet-type" value="other" class="mr-3">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                            </svg>
                                            <span class="font-medium text-[#181111]">其他</span>
                                        </div>
                                    </label>
                                </div>
                                <button id="confirm-pet-type" class="btn-main w-full mt-4">確認</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 綁定事件
                attachSearchPageListeners();
            }
            
            // 綁定搜尋頁面事件
            function attachSearchPageListeners() {
                // 返回按鈕
                document.getElementById('search-back-btn')?.addEventListener('click', function() {
                    showPage('home');
                });
                
                // 日期篩選
                document.getElementById('date-filter')?.addEventListener('click', function() {
                    document.getElementById('search-date-modal').classList.remove('hidden');
                });
                
                // 寵物數量篩選
                document.getElementById('pet-count-filter')?.addEventListener('click', function() {
                    document.getElementById('pet-count-modal').classList.remove('hidden');
                });
                
                // 服務類型篩選
                document.getElementById('service-type-filter')?.addEventListener('click', function() {
                    document.getElementById('service-type-modal').classList.remove('hidden');
                });
                
                // 寵物種類篩選
                document.getElementById('pet-type-filter')?.addEventListener('click', function() {
                    document.getElementById('pet-type-modal').classList.remove('hidden');
                });
                
                // 日期模態框事件
                document.getElementById('close-date-modal')?.addEventListener('click', function() {
                    document.getElementById('search-date-modal').classList.add('hidden');
                });
                
                document.getElementById('confirm-date')?.addEventListener('click', function() {
                    const checkinDate = document.getElementById('search-checkin-date').value;
                    const checkoutDate = document.getElementById('search-checkout-date').value;
                    
                    if (checkinDate && checkoutDate) {
                        const checkin = new Date(checkinDate);
                        const checkout = new Date(checkoutDate);
                        const dateDisplay = document.getElementById('date-display');
                        
                        const formatDate = (date) => {
                            const month = date.getMonth() + 1;
                            const day = date.getDate();
                            const weekdays = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                            const weekday = weekdays[date.getDay()];
                            return `${month}月${day}日 ${weekday}`;
                        };
                        
                        dateDisplay.textContent = `${formatDate(checkin)} - ${formatDate(checkout)}`;
                        document.getElementById('search-date-modal').classList.add('hidden');
                    }
                });
                
                // 寵物數量模態框事件
                document.getElementById('close-pet-count-modal')?.addEventListener('click', function() {
                    document.getElementById('pet-count-modal').classList.add('hidden');
                });
                
                let petCount = 1;
                document.getElementById('decrease-pet-count')?.addEventListener('click', function() {
                    if (petCount > 1) {
                        petCount--;
                        document.getElementById('pet-count-value').textContent = petCount;
                    }
                });
                
                document.getElementById('increase-pet-count')?.addEventListener('click', function() {
                    if (petCount < 10) {
                        petCount++;
                        document.getElementById('pet-count-value').textContent = petCount;
                    }
                });
                
                document.getElementById('confirm-pet-count')?.addEventListener('click', function() {
                    document.getElementById('pet-count-display').textContent = petCount;
                    document.getElementById('pet-count-modal').classList.add('hidden');
                });
                
                // 服務類型模態框事件
                document.getElementById('close-service-type-modal')?.addEventListener('click', function() {
                    document.getElementById('service-type-modal').classList.add('hidden');
                });
                
                document.getElementById('confirm-service-type')?.addEventListener('click', function() {
                    const selectedType = document.querySelector('input[name="service-type"]:checked');
                    if (selectedType) {
                        const displayText = selectedType.value === 'overnight' ? '寄宿過夜' : '日間安親';
                        document.getElementById('service-type-display').textContent = displayText;
                        document.getElementById('service-type-modal').classList.add('hidden');
                    }
                });
                
                // 寵物種類模態框事件
                document.getElementById('close-pet-type-modal')?.addEventListener('click', function() {
                    document.getElementById('pet-type-modal').classList.add('hidden');
                });
                
                document.getElementById('confirm-pet-type')?.addEventListener('click', function() {
                    const selectedTypes = Array.from(document.querySelectorAll('input[name="pet-type"]:checked'))
                        .map(input => {
                            const typeMap = {
                                'dog': '犬',
                                'cat': '貓',
                                'rabbit': '兔子',
                                'bird': '鳥類',
                                'other': '其他'
                            };
                            return typeMap[input.value] || input.value;
                        });
                    
                    if (selectedTypes.length > 0) {
                        document.getElementById('pet-type-display').textContent = selectedTypes.join('、');
                        document.getElementById('pet-type-modal').classList.add('hidden');
                    }
                });
                
                // 清除按鈕
                document.getElementById('clear-search-btn')?.addEventListener('click', function() {
                    // 重置所有搜尋條件
                    document.getElementById('search-location-input').value = '';
                    document.getElementById('date-display').textContent = '8月20日 週三 - 8月23日 週五';
                    document.getElementById('pet-count-display').textContent = '1';
                    document.getElementById('service-type-display').textContent = '寄宿過夜';
                    document.getElementById('pet-type-display').textContent = '犬、貓';
                    
                    // 重置模態框中的值
                    petCount = 1;
                    document.getElementById('pet-count-value').textContent = '1';
                    document.querySelector('input[name="service-type"][value="overnight"]').checked = true;
                    document.querySelectorAll('input[name="pet-type"]').forEach(input => {
                        input.checked = (input.value === 'dog' || input.value === 'cat');
                    });
                });
                
                // 搜尋按鈕
                document.getElementById('search-btn')?.addEventListener('click', function() {
                    const searchData = {
                        location: document.getElementById('search-location-input').value,
                        petCount: parseInt(document.getElementById('pet-count-display').textContent),
                        serviceType: document.querySelector('input[name="service-type"]:checked')?.value || 'overnight',
                        petTypes: Array.from(document.querySelectorAll('input[name="pet-type"]:checked')).map(input => input.value)
                    };
                    
                    console.log('搜尋條件:', searchData);
                    
                    // 跳轉到搜尋結果頁面
                    showPage('searchResults', { searchData });
                });
                
                // 最近搜尋點擊事件
                document.querySelectorAll('.flex.items-center.text-\\[\\#886364\\].cursor-pointer').forEach(item => {
                    if (item.textContent.includes('台北市中山區') || item.textContent.includes('台北101')) {
                        item.addEventListener('click', function() {
                            const location = this.textContent.trim();
                            document.getElementById('search-location-input').value = location;
                        });
                    }
                });
                
                // 附近區域點擊事件
                document.querySelector('.flex.items-center.text-\\[\\#886364\\].cursor-pointer')?.addEventListener('click', function() {
                    if (this.textContent.includes('附近區域')) {
                        // 實作附近區域搜尋邏輯
                        alert('附近區域搜尋功能開發中...');
                    }
                });
            }
            
            // 搜尋結果頁面
            function renderSearchResultsPage(state) {
                const container = pages.searchResults;
                const searchData = state?.searchData || {};
                
                // 根據搜尋條件篩選旅館
                let filteredHotels = mockHotels.filter(hotel => {
                    // 根據寵物種類篩選
                    if (searchData.petTypes && searchData.petTypes.length > 0) {
                        const hasMatchingPetType = searchData.petTypes.some(type => 
                            hotel.petTypes.includes(type)
                        );
                        if (!hasMatchingPetType) return false;
                    }
                    
                    // 根據服務類型篩選
                    if (searchData.serviceType) {
                        if (!hotel.services.includes(searchData.serviceType)) return false;
                    }
                    
                    // 根據地點篩選（簡單的字串匹配）
                    if (searchData.location) {
                        if (!hotel.location.includes(searchData.location)) return false;
                    }
                    
                    return true;
                });
                
                // 如果沒有搜尋條件，顯示所有旅館
                if (!searchData.petTypes || searchData.petTypes.length === 0) {
                    filteredHotels = mockHotels;
                }
                
                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="search-results-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">搜尋結果</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>
                        
                        <!-- 搜尋條件顯示 -->
                        <div class="bg-white border-b border-gray-100 px-4 py-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600">找到</span>
                                    <span class="text-sm font-bold text-[#181111]">${filteredHotels.length}</span>
                                    <span class="text-sm text-gray-600">間旅館</span>
                                </div>
                                <button id="filter-btn" class="flex items-center space-x-1 text-sm text-[#181111]">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                    </svg>
                                    <span>篩選</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 搜尋結果列表 -->
                        <div class="p-4 pb-20">
                            ${filteredHotels.length === 0 ? `
                                <div class="text-center py-12">
                                    <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-600 mb-2">找不到符合條件的旅館</h3>
                                    <p class="text-sm text-gray-500 mb-4">請嘗試調整搜尋條件</p>
                                    <button id="adjust-search-btn" class="px-6 py-2 bg-[#181111] text-white rounded-xl text-sm">
                                        調整搜尋條件
                                    </button>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${filteredHotels.map(hotel => `
                                        <div class="bg-white rounded-xl border border-gray-100 overflow-hidden cursor-pointer hover:shadow-lg transition-shadow" data-hotel-id="${hotel.id}">
                                            <div class="flex">
                                                <!-- 旅館圖片 -->
                                                <div class="w-24 h-24 bg-cover bg-center flex-shrink-0" style="background-image: url('${hotel.imageUrl}')"></div>
                                                
                                                <!-- 旅館資訊 -->
                                                <div class="flex-1 p-4">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <h3 class="font-bold text-[#181111] text-base">${hotel.name}</h3>
                                                        <div class="flex items-center space-x-1">
                                                            <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                                            </svg>
                                                            <span class="text-sm font-medium text-gray-800">${hotel.rating}</span>
                                                            <span class="text-xs text-gray-500">(${hotel.reviewCount})</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <p class="text-sm text-gray-600 mb-1">${hotel.location}</p>
                                                    <p class="text-xs text-gray-500 mb-2">${hotel.distance}</p>
                                                    
                                                    <!-- 寵物種類標籤 -->
                                                    <div class="flex flex-wrap gap-1 mb-2">
                                                        ${hotel.petTypes.map(type => {
                                                            const typeMap = {
                                                                'dog': { name: '犬', color: 'bg-orange-100 text-orange-800' },
                                                                'cat': { name: '貓', color: 'bg-blue-100 text-blue-800' },
                                                                'rabbit': { name: '兔子', color: 'bg-gray-100 text-gray-800' },
                                                                'bird': { name: '鳥類', color: 'bg-yellow-100 text-yellow-800' },
                                                                'other': { name: '其他', color: 'bg-green-100 text-green-800' }
                                                            };
                                                            const typeInfo = typeMap[type] || { name: type, color: 'bg-gray-100 text-gray-800' };
                                                            return `<span class="px-2 py-1 rounded-full text-xs ${typeInfo.color}">${typeInfo.name}</span>`;
                                                        }).join('')}
                                                    </div>
                                                    
                                                    <!-- 特色功能 -->
                                                    <div class="flex flex-wrap gap-1 mb-3">
                                                        ${hotel.features.slice(0, 2).map(feature => 
                                                            `<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs">${feature}</span>`
                                                        ).join('')}
                                                    </div>
                                                    
                                                    <!-- 價格和按鈕 -->
                                                    <div class="flex justify-between items-center">
                                                        <div>
                                                            <span class="text-lg font-bold text-[#181111]">NT$ ${hotel.price.toLocaleString()}</span>
                                                            <span class="text-sm text-gray-500">/晚起</span>
                                                        </div>
                                                        <button class="px-4 py-2 bg-[#181111] text-white rounded-lg text-sm font-medium">
                                                            查看詳情
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                // 綁定事件
                attachSearchResultsListeners(searchData);
            }
            
            // 綁定搜尋結果頁面事件
            function attachSearchResultsListeners(searchData) {
                // 返回按鈕
                document.getElementById('search-results-back-btn')?.addEventListener('click', function() {
                    showPage('searchResult');
                });
                
                // 調整搜尋條件按鈕
                document.getElementById('adjust-search-btn')?.addEventListener('click', function() {
                    showPage('searchResult');
                });
                
                // 篩選按鈕
                document.getElementById('filter-btn')?.addEventListener('click', function() {
                    // 這裡可以實作篩選功能
                    alert('篩選功能開發中...');
                });
                
                // 旅館卡片點擊事件
                document.querySelectorAll('[data-hotel-id]').forEach(card => {
                    card.addEventListener('click', function() {
                        const hotelId = parseInt(this.dataset.hotelId);
                        const hotel = mockHotels.find(h => h.id === hotelId);
                        if (hotel) {
                            showPage('detail', { hotel: hotel });
                        }
                    });
                });
            }
            
            function renderHomePage() {
                const container = pages.home;
                if (!container) {
                    console.error('Home page container not found');
                    return;
                }
                container.innerHTML = `
                <!-- 頁首 -->
                <div class="flex items-center bg-white p-4 pb-2 justify-between sticky top-0 z-10 border-b border-gray-100">
                    <div class="flex w-12 items-center justify-start">
                        <button id="chat-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H40A16,16,0,0,0,24,64V224a15.84,15.84,0,0,0,9.37,14.66A16,16,0,0,0,40,240a15.82,15.82,0,0,0,10.63-4.37L82.37,204H216a16,16,0,0,0,16-16V64A16,16,0,0,0,216,48ZM128,144a8,8,0,1,1,8-8A8,8,0,0,1,128,144Zm40,0a8,8,0,1,1,8-8A8,8,0,0,1,168,144ZM88,144a8,8,0,1,1,8-8A8,8,0,0,1,88,144Z"></path></svg>
                        </button>
                    </div>
                    <h2 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Paw Pad</h2>
                    <div class="flex w-12 items-center justify-end">
                        <button id="profile-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
                        </button>
                    </div>
                </div>
                <!-- 搜尋框 -->
                <div class="px-4 py-3">
                    <div class="flex w-full flex-1 items-stretch rounded-xl h-12">
                        <div class="text-[#886364] flex border-none bg-[#f4f0f0] items-center justify-center pl-4 rounded-l-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                        </div>
                        <input id="home-search-input" placeholder="搜尋地點、寵物旅館或保母..." class="form-input-styled placeholder:text-[#886364] px-4 rounded-l-none pl-2 text-base font-normal leading-normal" />
                    </div>
                </div>
                
                <!-- 公告跑馬燈 -->
                <div class="px-4 mb-4">
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-3 cursor-pointer hover:bg-gradient-to-r hover:from-red-100 hover:to-orange-100 transition-colors" onclick="showAnnouncementDetail('spring-service')">
                        <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center font-bold text-xs flex-shrink-0">🔔</div>
                            <div class="flex-1 overflow-hidden">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-semibold text-red-600 bg-red-100 px-2 py-0.5 rounded-full">重要</span>
                                    <span class="text-sm font-medium text-[#181111] truncate">春節期間服務時間調整</span>
                                </div>
                            </div>
                            <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <!-- 廣告橫幅 -->
                <div class="px-4 mb-4">
                    <div class="relative w-full bg-center bg-no-repeat aspect-[2/1] bg-cover rounded-xl flex flex-col justify-end p-4 text-white" style='background-image: linear-gradient(to top, rgba(0,0,0,0.6), transparent), url("https://images.unsplash.com/photo-1552053831-71594a27632d?q=80&w=1000");'>
                         <h3 class="font-bold text-lg">夏日優惠</h3>
                         <p class="text-sm">立即預訂，享 85 折優惠！</p>
                    </div>
                </div>

                <!-- 推薦區塊 -->
                <h2 class="text-[#181111] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-2">推薦給您</h2>
                <div class="px-4 space-y-4">
                    <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.8 • 120 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">快樂爪子旅館</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">台北市 • 接受犬、貓</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$800/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.9 • 150 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">貓語天堂</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">新北市 • 僅接受貓</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$650/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.7 • 85 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">汪星人度假村</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">台中市 • 僅接受犬</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$950/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600");'></div>
                    </div>
                </div>
                `;
            }
            
            function renderChatPage(state) {
                const merchant = state?.merchant;
                const order = state?.order;
                
                if (merchant && order) {
                    // 顯示特定商家的聊天室
                    pages.chat.innerHTML = `
                        <div class="min-h-full bg-gray-50">
                            <!-- 聊天室標題列 -->
                            <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                                <div class="px-4 py-3 flex items-center justify-between">
                                    <button id="chat-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="flex items-center space-x-3">
                                        <img src="${merchant.imageUrl}" class="w-10 h-10 rounded-full object-cover">
                                        <div>
                                            <h1 class="text-lg font-bold text-[#181111]">${merchant.name}</h1>
                                            <p class="text-sm text-gray-500">${merchant.location}</p>
                                        </div>
                                    </div>
                                    <div class="w-8"></div>
                                </div>
                            </div>
                            
                            <!-- 訂單資訊 -->
                            <div class="bg-white border-b border-gray-100 px-4 py-3">
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-sm font-medium text-blue-800">訂單 ${order.id}</span>
                                    </div>
                                    <p class="text-sm text-blue-700">${order.date} • ${order.pet}</p>
                                </div>
                            </div>
                            
                            <!-- 聊天訊息區域 -->
                            <div class="flex-1 p-4 pb-20">
                                <div class="space-y-4">
                                    <!-- 系統訊息 -->
                                    <div class="text-center py-4">
                                        <div class="inline-block bg-gray-100 rounded-lg px-4 py-2">
                                            <p class="text-sm text-gray-600">您已與 ${merchant.name} 建立聯繫</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 商家歡迎訊息 -->
                                    <div class="flex items-start space-x-3">
                                        <img src="${merchant.imageUrl}" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                                        <div class="bg-white rounded-lg p-3 max-w-xs">
                                            <p class="text-sm text-gray-800">您好！我是 ${merchant.name} 的客服人員，有什麼可以為您服務的嗎？</p>
                                            <p class="text-xs text-gray-500 mt-1">剛剛</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 用戶訊息範例 -->
                                    <div class="flex justify-end">
                                        <div class="bg-[#181111] rounded-lg p-3 max-w-xs">
                                            <p class="text-sm text-white">您好，我想詢問關於訂單 ${order.id} 的入住時間</p>
                                            <p class="text-xs text-gray-300 mt-1">剛剛</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 輸入區域 -->
                            <div class="bg-white border-t border-gray-100 p-4 fixed bottom-0 left-0 right-0">
                                <div class="flex items-center space-x-3">
                                    <input type="text" placeholder="輸入訊息..." class="flex-1 border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-[#181111]">
                                    <button class="bg-[#181111] text-white rounded-lg p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // 顯示一般的訊息中心
                    pages.chat.innerHTML = `
                        <h1 class="text-2xl font-bold mb-4 text-center text-[#181111] p-4">訊息中心</h1>
                        
                        <!-- 公告區域 -->
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 mx-4 rounded-xl border border-blue-200 mb-4">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-sm">📢</div>
                                <h3 class="font-bold text-[#181111]">平台公告</h3>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">NEW</span>
                            </div>
                            <div class="space-y-2">
                                <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" onclick="showAnnouncementDetail('spring-service')">
                                    <div class="flex justify-between items-start">
                                        <p class="text-sm font-medium text-[#181111]">春節期間服務時間調整</p>
                                        <span class="text-xs text-gray-500">2小時前</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1">2/10-2/17 客服時間調整為 9:00-18:00</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" onclick="showAnnouncementDetail('health-record')">
                                    <div class="flex justify-between items-start">
                                        <p class="text-sm font-medium text-[#181111]">新功能上線：寵物健康記錄</p>
                                        <span class="text-xs text-gray-500">1天前</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1">現在可以為您的毛孩建立健康檔案</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors" onclick="showAnnouncementDetail('payment-update')">
                                    <div class="flex justify-between items-start">
                                        <p class="text-sm font-medium text-[#181111]">支付系統優化完成</p>
                                        <span class="text-xs text-gray-500">3天前</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mt-1">提升支付成功率，新增多種支付方式</p>
                                </div>
                            </div>
                            <button class="w-full mt-3 text-sm text-blue-600 font-medium hover:text-blue-800 transition-colors" onclick="showAnnouncementList()">
                                查看所有公告 →
                            </button>
                        </div>
                        
                        <div class="space-y-3 px-4">
                            <!-- 置頂聊天項目 -->
                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 flex items-center gap-4 cursor-pointer">
                                <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">P</div>
                                <div class="flex-1 overflow-hidden">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-[#181111]">Paw Pad 官方客服</p>
                                        <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full flex-shrink-0">置頂</span>
                                    </div>
                                    <div class="flex justify-between items-end mt-1">
                                        <p class="text-sm text-[#886364] truncate">歡迎使用！有任何問題隨時與我們聯繫。</p>
                                    </div>
                                </div>
                            </div>
                            <!-- 一般聊天項目 -->
                            <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                                <img src="https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                                <div class="flex-1 overflow-hidden">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-[#181111]">快樂爪子旅館</p>
                                        <p class="text-xs text-[#886364]">昨天</p>
                                    </div>
                                    <div class="flex justify-between items-end mt-1">
                                        <p class="text-sm text-[#886364] truncate">好的，您的預訂已確認！</p>
                                        <span class="bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">2</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                                <img src="https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                                <div class="flex-1 overflow-hidden">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-[#181111]">貓語天堂</p>
                                        <p class="text-xs text-[#886364]">2天前</p>
                                    </div>
                                    <div class="flex justify-between items-end mt-1">
                                        <p class="text-sm text-[#886364] truncate">不客氣！</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 綁定聊天室事件
                attachChatListeners();
            }
            
            // 綁定聊天室事件
            function attachChatListeners() {
                // 返回按鈕
                document.getElementById('chat-back-btn')?.addEventListener('click', function() {
                    showPage('orders');
                });
            }

            function renderDetailPage() {
                pages.detail.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">快樂爪子旅館</h1>
                    <div class="w-full bg-center bg-no-repeat aspect-[4/3] bg-cover rounded-xl" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    
                    <div id="about-section" class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">關於</p>
                         <p class="text-[#886364] text-sm mt-2">提供最溫馨舒適的環境，讓您的寵物如同在家一般自在。我們有專業的照護人員與寬敞的活動空間。</p>
                    </div>

                    <!-- 預訂區塊 -->
                    <div id="booking-section" class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">預訂服務</h2>
                        
                        <!-- 步驟指示器 -->
                        <div class="mb-4">
                            <div class="flex items-center justify-center flex-wrap gap-x-0.5 gap-y-1.5">
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-[#181111] text-white flex items-center justify-center text-xs font-bold">1</div>
                                    <span class="ml-1 text-xs font-medium text-[#181111] whitespace-nowrap">服務類型</span>
                                </div>
                                <div class="w-4 h-0.5 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">2</div>
                                    <span class="ml-1 text-xs font-medium text-gray-500 whitespace-nowrap">選擇房型</span>
                                </div>
                                <div class="w-4 h-0.5 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">3</div>
                                    <span class="ml-1 text-xs font-medium text-gray-500 whitespace-nowrap">選擇時段</span>
                                </div>
                                <div class="w-4 h-0.5 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">4</div>
                                    <span class="ml-1 text-xs font-medium text-gray-500 whitespace-nowrap">選擇寵物</span>
                                </div>
                                <div class="w-4 h-0.5 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">5</div>
                                    <span class="ml-1 text-xs font-medium text-gray-500 whitespace-nowrap">確認明細</span>
                                </div>
                                <div class="w-4 h-0.5 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-6 h-6 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-xs font-bold">6</div>
                                    <span class="ml-1 text-xs font-medium text-gray-500 whitespace-nowrap">付款</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步驟 1: 服務類型選擇 -->
                        <div id="step-1-service-type" class="booking-step">
                            <h3 class="font-medium text-[#181111] mb-4 text-center">請選擇您需要的服務類型</h3>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button id="select-overnight" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="overnight">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">🏠</div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">寄宿過夜</div>
                                    <div class="text-sm text-gray-600 mb-3">適合出差旅行、度假時使用</div>
                                    <div class="text-xs text-blue-600 font-medium">24小時專業照護</div>
                                </button>
                                <button id="select-daycare" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="daycare">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">⏰</div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">日間安親</div>
                                    <div class="text-sm text-gray-600 mb-3">上班時間的專業陪伴</div>
                                    <div class="text-xs text-green-600 font-medium">彈性時段選擇</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 步驟 2: 方案選擇 -->
                        <div id="step-2-plan-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇方案</h3>
                                <button id="back-to-service-type" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 寄宿過夜方案 -->
                            <div id="overnight-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="standard" data-price="1200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">標準套房</div>
                                            <div class="text-sm text-gray-600">舒適單人房，適合小型寵物</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,200</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="deluxe" data-price="1800">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">豪華套房</div>
                                            <div class="text-sm text-gray-600">寬敞雙人房，含獨立陽台</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,800</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="premium" data-price="2500">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">頂級套房</div>
                                            <div class="text-sm text-gray-600">總統級待遇，含專屬管家</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 2,500</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 日間安親方案 -->
                            <div id="daycare-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="1小時方案" data-price="150">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">1小時方案</div>
                                            <div class="text-sm text-gray-600">基本陪伴與照護服務</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 150</div>
                                            <div class="text-xs text-gray-500">1小時</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="2小時方案" data-price="300">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">2小時方案</div>
                                            <div class="text-sm text-gray-600">含戶外活動與營養餐點</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 300</div>
                                            <div class="text-xs text-gray-500">2小時</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="4小時方案" data-price="540">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">4小時方案</div>
                                            <div class="text-sm text-gray-600">含洗澡、美容等增值服務</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 540</div>
                                            <div class="text-xs text-gray-500">4小時</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步驟 2: 房型選擇 -->
                        <div id="step-2-room-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇房型</h3>
                                <button id="back-to-service-type-from-room" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <div id="room-selection-list" class="space-y-3">
                                <!-- 房型列表將由 JavaScript 動態生成 -->
                            </div>
                        </div>
                        
                        <!-- 步驟 3: 時段選擇 -->
                        <div id="step-3-time-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇時段</h3>
                                <button id="back-to-service-type" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 寄宿過夜的日期選擇 -->
                            <div id="overnight-date-selection" class="space-y-4 hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">入住日期</label>
                                        <input type="date" id="detail-checkin-date" class="form-input-styled text-center w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">退房日期</label>
                                        <input type="date" id="detail-checkout-date" class="form-input-styled text-center w-full">
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-sm text-blue-800">
                                        <span class="font-medium">入住天數：</span>
                                        <span id="stay-duration">請選擇日期</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 日間安親的日期+時段選擇 -->
                            <div id="daycare-date-selection" class="space-y-4 hidden">
                                <div class="mb-4">
                                    <label class="text-sm text-gray-600 block mb-2 font-medium">服務日期</label>
                                    <input type="date" id="detail-service-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <!-- 時段選擇 -->
                                <div class="daycare-time-selection">
                                    <h4 class="font-medium text-[#181111] mb-3">選擇服務時段</h4>
                                    
                                    <!-- 自由時段選擇 -->
                                    <div class="flexible-time-selection space-y-4">
                                        <!-- 時段可用性概覽 -->
                                        <div class="time-availability-overview mb-4 p-4 bg-white rounded-lg border border-gray-200">
                                            <h5 class="text-sm font-medium text-gray-700 mb-3">今日時段可用性概覽</h5>
                                            
                                            <!-- 時間軸容器 -->
                                            <div class="timeline-container mb-4">
                                                <!-- 時間軸主線 -->
                                                <div class="timeline-line">
                                                    <!-- 可用時段：8:00-11:00 -->
                                                    <div class="timeline-segment available" data-start="8" data-end="11" style="width: 25%;">
                                                        <div class="segment-time">08:00-11:00</div>
                                                    </div>
                                                    <!-- 不可用時段：11:00-12:00 -->
                                                    <div class="timeline-segment unavailable" data-start="11" data-end="12" style="width: 8.33%;">
                                                        <div class="segment-time">11:00-12:00</div>
                                                    </div>
                                                    <!-- 可用時段：12:00-19:00 -->
                                                    <div class="timeline-segment available" data-start="12" data-end="19" style="width: 58.33%;">
                                                        <div class="segment-time">12:00-19:00</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="text-xs text-gray-500 text-center">
                                                <span class="inline-block w-4 h-4 bg-green-500 rounded mr-2"></span>可訂購時段
                                                <span class="inline-block w-4 h-4 bg-red-500 rounded ml-4 mr-2"></span>額滿時段
                                            </div>
                                        </div>
                                        
                                        <!-- 時段選擇器 -->
                                        <div class="time-range-selector p-4 bg-gray-50 rounded-lg">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">開始時間</label>
                                                    <select id="start-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="8">08:00</option>
                                                        <option value="9">09:00</option>
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">結束時間</label>
                                                    <select id="end-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                        <option value="18">18:00</option>
                                                        <option value="19">19:00</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- 方案時長提示 -->
                                            <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                                <div class="text-sm text-blue-800">
                                                    <span class="font-medium">方案時長：</span>
                                                    <span id="plan-duration-hint">請先選擇方案</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 時段資訊顯示 -->
                                            <div class="mt-4 p-3 bg-white rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-sm text-gray-600">服務時長</span>
                                                    <span class="font-medium text-[#181111]" id="flexible-duration-display">請選擇時段</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-gray-600">預估費用</span>
                                                    <span class="font-bold text-green-600" id="flexible-price-display">請選擇時段</span>
                                                </div>
                                            </div>
                                        </div>
                                        

                                        
                                        <!-- 時段可用性顯示 -->
                                        <div class="availability-display mt-4">
                                            <div id="availability-result" class="mt-3 p-3 rounded-lg">
                                                <!-- 可用性結果將在這裡顯示 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 錯誤處理區域 -->
                        <div id="booking-errors" class="error-handling hidden">
                            <!-- 錯誤訊息將在這裡動態生成 -->
                        </div>
                        
                        <!-- 價格透明度改進 -->
                        <div id="price-transparency" class="price-transparency hidden">
                            <h3 class="font-bold text-[#181111] mb-3">價格明細</h3>
                            <div class="price-breakdown">
                                <div class="price-item">
                                    <span class="item-label">房型費用</span>
                                    <span class="item-detail" id="room-price-detail">請選擇房型</span>
                                    <span class="item-price" id="room-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="duration-item" style="display: none;">
                                    <span class="item-label">服務時長</span>
                                    <span class="item-detail" id="duration-detail">請選擇時段</span>
                                    <span class="item-price" id="duration-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="pet-count-item" style="display: none;">
                                    <span class="item-label">寵物數量</span>
                                    <span class="item-detail" id="pet-count-detail">1 隻</span>
                                    <span class="item-price" id="pet-count-price">× 1</span>
                                </div>
                                <div id="addon-items">
                                    <!-- 加購服務項目將在這裡動態生成 -->
                                </div>
                                <div class="price-total">
                                    <span class="total-label">總計</span>
                                    <span class="total-price" id="total-price">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 繼續預訂按鈕 -->
                        <div id="continue-booking-section" class="mt-4 hidden">
                            <button id="continue-booking-btn" class="btn-main w-full h-12 text-base">
                                繼續預訂
                            </button>
                        </div>
                        
                        <!-- == START: 新增的選擇寵物步驟 == -->
                        <div id="step-pet-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇入住的寵物</h3>
                                <button id="back-to-time-selection-from-pet" class="text-sm text-blue-600 hover:text-blue-800">← 返回</button>
                            </div>
                            <div id="pet-selection-list" class="space-y-3 mb-4">
                                <!-- 寵物列表將由 JS 動態生成 -->
                            </div>
                            
                            <!-- 新增寵物表單（隱藏狀態） -->
                            <div id="add-pet-form-container" class="hidden mb-4">
                                <div class="bg-white rounded-xl border-2 border-gray-200 p-4">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-medium text-[#181111]">新增寵物</h4>
                                        <button id="close-add-pet-form" class="text-gray-500 hover:text-gray-700">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <form id="add-pet-form" class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">寵物名稱 *</label>
                                            <input type="text" id="new-pet-name" class="form-input-styled w-full" required placeholder="請輸入寵物名稱">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">品種 *</label>
                                            <input type="text" id="new-pet-breed" class="form-input-styled w-full" required placeholder="請輸入品種">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">年齡</label>
                                                <input type="number" id="new-pet-age" class="form-input-styled w-full" placeholder="歲" min="0">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">性別</label>
                                                <select id="new-pet-gender" class="form-input-styled w-full">
                                                    <option value="">請選擇</option>
                                                    <option value="male">公</option>
                                                    <option value="female">母</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">照片</label>
                                            <div class="flex flex-col items-center">
                                                <img id="new-pet-photo-preview" src="https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center" class="w-20 h-20 rounded-full object-cover border-2 border-gray-200 mb-2">
                                                <input type="file" id="new-pet-photo-input" accept="image/*" class="hidden">
                                                <button type="button" id="select-pet-photo-btn" class="text-sm text-blue-600 hover:text-blue-800 px-4 py-2 border border-blue-300 rounded-lg hover:bg-blue-50">
                                                    從相簿選擇照片
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 pt-2">
                                            <button type="submit" class="btn-main flex-1">確認新增</button>
                                            <button type="button" id="cancel-add-pet" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <button id="continue-to-confirmation-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>下一步：確認訂單</button>
                        </div>
                        <!-- == END: 新增的選擇寵物步驟 == -->
                        
                        <!-- 步驟 4: 完整明細確認 -->
                        <div id="step-4-order-confirmation" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">確認訂單明細</h3>
                                <button id="back-to-time-selection" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 訂單明細卡片 -->
                            <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                                <!-- 旅館資訊 -->
                                <div class="border-b border-gray-100 pb-4 mb-4">
                                    <h4 class="font-semibold text-[#181111] mb-2">🏨 快樂爪子旅館</h4>
                                    <p class="text-sm text-gray-600">台北市信義區信義路五段7號</p>
                                </div>
                                
                                <!-- 服務明細 -->
                                <div class="space-y-4">
                                    <!-- 服務類型 -->
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="font-medium text-[#181111]">服務類型</span>
                                            <p class="text-sm text-gray-600" id="confirmation-service-type">寄宿過夜</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 方案選擇 -->
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="font-medium text-[#181111]">選擇方案</span>
                                            <p class="text-sm text-gray-600" id="confirmation-plan">標準套房</p>
                                        </div>
                                        <span class="font-semibold text-green-600" id="confirmation-plan-price">NT$ 1,200</span>
                                    </div>
                                    
                                    <!-- 日期時間 -->
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <span class="font-medium text-[#181111]">入住時間</span>
                                            <p class="text-sm text-gray-600" id="confirmation-dates">2024年1月15日 - 2024年1月16日</p>
                                        </div>
                                        <span class="text-sm text-gray-500" id="confirmation-duration">1 晚</span>
                                    </div>
                                    
                                    <!-- 寵物資訊 -->
                                    <div class="border-t border-gray-100 pt-4">
                                        <h5 class="font-medium text-[#181111] mb-3">🐕 寵物資訊</h5>
                                        <div class="space-y-3">
                                            <div class="flex items-center space-x-3">
                                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <span class="text-lg">🐕</span>
                                                </div>
                                                <div class="flex-1">
                                                    <p class="font-medium text-[#181111]" id="confirmation-pet-name">小白</p>
                                                    <p class="text-sm text-gray-600" id="confirmation-pet-details">柴犬 • 3歲 • 公</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 特殊需求 -->
                                    <div class="border-t border-gray-100 pt-4">
                                        <h5 class="font-medium text-[#181111] mb-2">📝 特殊需求</h5>
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <textarea id="special-requirements" placeholder="請輸入特殊需求或注意事項..." class="w-full bg-transparent border-none resize-none text-sm text-gray-600 focus:outline-none" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 取消政策 -->
                            <div class="bg-blue-50 rounded-xl p-4 mb-6">
                                <h4 class="font-semibold text-blue-800 mb-2">📋 取消政策</h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    <li>• 入住前24小時內取消：收取50%費用</li>
                                    <li>• 入住當天取消：收取100%費用</li>
                                    <li>• 提前24小時以上取消：全額退款</li>
                                </ul>
                            </div>
                            
                            <!-- 確認並付款按鈕 -->
                            <button id="confirm-and-pay-btn" class="btn-main w-full h-12 text-base">
                                確認並前往付款
                            </button>
                        </div>
                        
                        <!-- 步驟 5: 藍星支付頁面 -->
                        <div id="step-5-payment" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">藍星支付</h3>
                                <button id="back-to-confirmation" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 付款資訊卡片 -->
                            <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                                <!-- 藍星支付標誌 -->
                                <div class="text-center mb-6">
                                    <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span class="text-white text-2xl font-bold">藍</span>
                                    </div>
                                    <h4 class="font-semibold text-[#181111] mb-2">藍星支付</h4>
                                    <p class="text-sm text-gray-600">安全、快速、便捷的第三方支付服務</p>
                                </div>
                                
                                <!-- 訂單資訊 -->
                                <div class="border-b border-gray-100 pb-4 mb-4">
                                    <h5 class="font-medium text-[#181111] mb-3">📋 訂單資訊</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">訂單編號</span>
                                            <span class="font-mono text-gray-800" id="order-number">PTH20250115001</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">服務項目</span>
                                            <span class="text-gray-800" id="payment-service-type">寄宿過夜</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">方案</span>
                                            <span class="text-gray-800" id="payment-plan">頂級套房</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">入住時間</span>
                                            <span class="text-gray-800" id="payment-dates">2025年9月13日 - 2025年9月14日</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 付款金額 -->
                                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-medium text-[#181111]">應付金額</span>
                                        <span class="text-2xl font-bold text-green-600" id="payment-amount">NT$ 2,500</span>
                                    </div>
                                </div>
                                
                                <!-- 付款方式選擇 -->
                                <div class="mb-6">
                                    <h5 class="font-medium text-[#181111] mb-3">💳 選擇付款方式</h5>
                                    <div class="space-y-3">
                                        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                            <input type="radio" name="payment-method" value="credit-card" class="mr-3" checked>
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">💳</span>
                                                <div>
                                                    <div class="font-medium text-[#181111]">信用卡</div>
                                                    <div class="text-sm text-gray-600">Visa、Mastercard、JCB</div>
                                                </div>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                            <input type="radio" name="payment-method" value="bank-transfer" class="mr-3">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">🏦</span>
                                                <div>
                                                    <div class="font-medium text-[#181111]">銀行轉帳</div>
                                                    <div class="text-sm text-gray-600">ATM、網路銀行、臨櫃</div>
                                                </div>
                                            </div>
                                        </label>
                                        
                                        <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                            <input type="radio" name="payment-method" value="mobile-payment" class="mr-3">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">📱</span>
                                                <div>
                                                    <div class="font-medium text-[#181111]">行動支付</div>
                                                    <div class="text-sm text-gray-600">Apple Pay、Google Pay</div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 安全提示 -->
                                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                                    <div class="flex items-start">
                                        <span class="text-blue-600 mr-2">🔒</span>
                                        <div class="text-sm text-blue-800">
                                            <div class="font-medium mb-1">安全保證</div>
                                            <ul class="space-y-1">
                                                <li>• 採用SSL加密技術保護您的資料</li>
                                                <li>• 符合PCI DSS國際安全標準</li>
                                                <li>• 24小時監控系統安全</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 付款按鈕 -->
                                <button id="process-payment-btn" class="btn-main w-full h-12 text-base">
                                    <span id="payment-btn-text">確認付款 NT$ 2,500</span>
                                    <span id="payment-loading" class="hidden">
                                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        處理中...
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>

                     <div id="user-reviews-section" class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">用戶評價</p>
                         <div class="mt-2 space-y-3">
                            <div class="border-b pb-2">
                                <p class="font-bold text-sm">王小明 <span class="text-xs text-gray-500 ml-2">⭐️⭐️⭐️⭐️⭐️</span></p>
                                <p class="text-[#886364] text-sm mt-1">環境很乾淨，狗狗玩得很開心！</p>
                            </div>
                             <div class="border-b pb-2">
                                <p class="font-bold text-sm">陳太太 <span class="text-xs text-gray-500 ml-2">⭐️⭐️⭐️⭐️</span></p>
                                <p class="text-[#886364] text-sm mt-1">貓咪很適應，只是房間隔音可以再加強。</p>
                            </div>
                         </div>
                    </div>

                    <!-- 位置地圖 -->
                    <div id="location-section" class="p-4 rounded-xl border border-gray-100 bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-[#181111] text-lg font-bold">位置資訊</p>
                            <button id="open-map-btn" class="text-sm bg-[#181111] text-white px-3 py-1 rounded-full hover:bg-gray-800 transition-colors">
                                導航
                            </button>
                        </div>
                        <div class="mb-3">
                            <p class="text-sm text-[#886364] mb-1">📍 台北市信義區信義路五段7號</p>
                            <p class="text-xs text-gray-500">距離捷運市政府站 5分鐘步行</p>
                        </div>
                        <div id="hotel-map" class="h-48 rounded-lg bg-gray-100 relative overflow-hidden">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                                <span class="text-sm">載入地圖中...</span>
                            </div>
                            <!-- 地圖交互提示 -->
                            <div id="map-interaction-hint" class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded hidden">
                                點擊地圖啟用交互
                            </div>
                        </div>
                    </div>
                </div>`;
                
                const style = document.createElement('style');
                style.innerHTML = `
                    .daycare-time-btn { padding: 6px 12px; border-radius: 9999px; background-color: #f4f0f0; color: #886364; font-size: 0.875rem; transition: all 0.2s; border:none; }
                    .daycare-time-btn.active { background-color: #181111; color: white; }
                    
                    /* 滿房狀態樣式 */
                    .unavailable {
                        opacity: 0.6;
                        background-color: #f8f9fa;
                    }
                    
                    .unavailable .package-item {
                        background-color: #f1f3f4 !important;
                        border: 1px solid #e0e0e0 !important;
                        cursor: not-allowed !important;
                    }
                    
                    .unavailable .package-item:hover {
                        background-color: #f1f3f4 !important;
                        transform: none !important;
                    }
                    
                    .package-item {
                        transition: all 0.2s ease;
                        border: 1px solid transparent;
                    }
                    
                    .package-item:hover:not([style*="opacity: 0.5"]) {
                        background-color: #f8f9fa;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .package-item.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .package-item.selected:hover {
                        background-color: #181111 !important;
                        transform: none !important;
                    }
                    
                    /* 時段按鈕樣式 */
                    .time-slot-btn {
                        background-color: #fff;
                        color: #374151;
                    }
                    
                    .time-slot-btn:hover:not(:disabled) {
                        background-color: #f3f4f6;
                        border-color: #6b7280;
                    }
                    
                    .time-slot-btn.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .time-slot-btn:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    
                    /* 訂房流程樣式 */
                    .service-type-card {
                        transition: all 0.2s ease;
                    }
                    
                    .service-type-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    
                    .time-slot-option {
                        transition: all 0.2s ease;
                    }
                    
                    .time-slot-option:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .room-selection-card {
                        transition: all 0.2s ease;
                    }
                    
                    .room-selection-card:hover:not([data-unavailable="true"]) {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                `;
                document.head.appendChild(style);

                // 新增服務選擇事件監聽器
                attachDetailPageListeners();
            }

            // 詳情頁面事件監聽器
            function attachDetailPageListeners() {
                initHotelMap();
                attachMapListeners();
                attachDetailDateListeners();
            }

            // 綁定詳情頁日期選擇事件
            function attachDetailDateListeners() {
                // 設定預設日期
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                
                // 更新全域變數
                selectedCheckinDate = today;
                selectedCheckoutDate = tomorrow;
                
                // 綁定服務類型選擇
                attachServiceTypeListeners();
                
                // 設定過夜寄宿的預設日期
                const checkinInput = document.getElementById('detail-checkin-date');
                const checkoutInput = document.getElementById('detail-checkout-date');
                const serviceDateInput = document.getElementById('detail-service-date');
                
                if (checkinInput && checkoutInput) {
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // 設定預設日期後，自動計算入住天數
                    bookingData.checkinDate = today.toISOString().split('T')[0];
                    bookingData.checkoutDate = tomorrow.toISOString().split('T')[0];
                    bookingData.stayDuration = 1; // 預設1晚
                    
                    console.log('預設日期已設定:', { 
                        checkin: bookingData.checkinDate, 
                        checkout: bookingData.checkoutDate, 
                        duration: bookingData.stayDuration 
                    });
                    
                    // 如果有選擇房型，自動更新價格顯示
                    if (bookingData.roomId) {
                        console.log('檢測到已選擇房型，自動更新價格顯示');
                        updatePriceTransparency();
                    }
                    
                    checkinInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            selectedCheckoutDate = nextDay;
                        }
                        checkCanContinueBooking();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        selectedCheckoutDate = new Date(this.value);
                        checkCanContinueBooking();
                    });
                }
                
                // 設定日間安親的預設日期
                if (serviceDateInput) {
                    serviceDateInput.value = today.toISOString().split('T')[0];
                    serviceDateInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        
                        // 重置後續選擇
                        bookingData.duration = '';
                        bookingData.timeSlot = '';
                        bookingData.preferredRoomId = null;
                        
                        // 隱藏房型選項
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) roomServiceList.classList.add('hidden');
                        
                        // 清除時段選擇
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 重置滑桿到預設值
                        const startTimeSlider = document.getElementById('start-time-slider');
                        const endTimeSlider = document.getElementById('end-time-slider');
                        if (startTimeSlider) startTimeSlider.value = 9;
                        if (endTimeSlider) endTimeSlider.value = 13;
                        
                        // 隱藏自訂時段選擇
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // 重置自訂時段按鈕
                        const customToggle = document.querySelector('.custom-time-toggle');
                        if (customToggle) {
                            customToggle.classList.remove('active');
                            customToggle.innerHTML = '<span>自訂時段</span>';
                        }
                        
                        checkCanContinueBooking();
                    });
                }
                
                // 綁定時段選擇
                attachTimeSlotListeners();
                
                // 初始化其他訂房功能
                initializeBookingFunctions();
            }

            // 綁定服務類型選擇事件 - 修正為：服務類型 -> 房型選擇 -> 時段選擇
            function attachServiceTypeListeners() {
                const overnightBtn = document.getElementById('select-overnight');
                const daycareBtn = document.getElementById('select-daycare');
                
                overnightBtn?.addEventListener('click', function() {
                    console.log('寄宿過夜按鈕被點擊');
                    
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-room-selection');
                    
                    if (step1 && step2) {
                        step1.style.display = 'none';
                        step2.style.display = 'block';
                        
                        // 更新預訂資料
                        bookingData.serviceType = 'overnight';
                        console.log('預訂資料已更新:', bookingData);
                        
                        // 渲染房型選擇列表
                        renderRoomSelectionInDetail();
                        
                        // 更新步驟指示器到步驟2
                        updateStepIndicator(2);
                    }
                });
                
                daycareBtn?.addEventListener('click', function() {
                    console.log('日間安親按鈕被點擊');
                    
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-room-selection');
                    
                    if (step1 && step2) {
                        step1.style.display = 'none';
                        step2.style.display = 'block';
                        
                        // 更新預訂資料
                        bookingData.serviceType = 'daycare';
                        console.log('預訂資料已更新:', bookingData);
                        
                        // 渲染房型選擇列表
                        renderRoomSelectionInDetail();
                        
                        // 更新步驟指示器到步驟2
                        updateStepIndicator(2);
                    }
                });
                
                // 綁定返回按鈕（從房型選擇返回服務類型選擇）
                document.getElementById('back-to-service-type-from-room')?.addEventListener('click', function() {
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-room-selection');
                    
                    if (step1 && step2) {
                        step1.style.display = 'block';
                        step2.style.display = 'none';
                        updateStepIndicator(1);
                        
                        // 重置預訂資料
                        bookingData.serviceType = null;
                        bookingData.roomId = null;
                    }
                });
                
                // 綁定返回按鈕（從時段選擇返回房型選擇）
                document.getElementById('back-to-service-type')?.addEventListener('click', function() {
                    const step2 = document.getElementById('step-2-room-selection');
                    const step3 = document.getElementById('step-3-time-selection');
                    
                    if (step2 && step3) {
                        step2.style.display = 'block';
                        step3.style.display = 'none';
                        updateStepIndicator(2);
                    }
                });
            }
            
            // 在詳情頁預訂流程中渲染房型選擇
            function renderRoomSelectionInDetail() {
                const container = document.getElementById('room-selection-list');
                if (!container) return;
                
                // 過濾符合服務類型的房型
                const availableRooms = mockRoomTypes.filter(room => 
                    room.status === 'active' && room.serviceType === bookingData.serviceType
                );
                
                if (availableRooms.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-4">暫無可用的房型</p>';
                    return;
                }
                
                let html = '';
                availableRooms.forEach(room => {
                    // 根據服務類型顯示價格
                    let priceDisplay = '';
                    if (room.serviceType === 'overnight' && room.basePrice) {
                        priceDisplay = `NT$ ${room.basePrice.toLocaleString()} / 晚`;
                    } else if (room.serviceType === 'daycare' && room.hourlyRate) {
                        const minPrice = room.hourlyRate * (room.minHours || 4);
                        priceDisplay = `NT$ ${minPrice.toLocaleString()}起 (${room.hourlyRate.toLocaleString()}/小時，最小${room.minHours || 4}小時)`;
                    }
                    
                    html += `
                        <div class="room-option-card p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-[#181111] transition-all" data-room-id="${room.id}">
                            <div class="flex items-start">
                                <img src="${room.imageUrl}" alt="${room.name}" class="w-20 h-20 rounded-lg object-cover mr-4 flex-shrink-0">
                                <div class="flex-1">
                                    <h4 class="font-bold text-[#181111] mb-1">${room.name}</h4>
                                    <p class="text-sm text-gray-600 mb-2">${room.description}</p>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-500">${room.serviceType === 'overnight' ? '日租' : '時租'}</span>
                                        <span class="font-bold text-[#181111]">${priceDisplay}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // 綁定房型選擇事件
                document.querySelectorAll('.room-option-card').forEach(card => {
                    card.addEventListener('click', function() {
                        // 移除其他卡片的選中狀態
                        document.querySelectorAll('.room-option-card').forEach(c => {
                            c.classList.remove('border-[#181111]', 'bg-gray-50');
                            c.classList.add('border-gray-200');
                        });
                        
                        // 選中當前卡片
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-gray-50');
                        
                        // 更新預訂資料
                        bookingData.roomId = parseInt(this.dataset.roomId);
                        
                        // 自動跳轉到時段選擇
                        setTimeout(() => {
                            const step2 = document.getElementById('step-2-room-selection');
                            const step3 = document.getElementById('step-3-time-selection');
                            
                            if (step2 && step3) {
                                step2.style.display = 'none';
                                step3.style.display = 'block';
                                
                                // 顯示對應的日期/時段選擇
                                const overnightDateSelection = document.getElementById('overnight-date-selection');
                                const daycareDateSelection = document.getElementById('daycare-date-selection');
                                if (overnightDateSelection && daycareDateSelection) {
                                    if (bookingData.serviceType === 'overnight') {
                                        overnightDateSelection.style.display = 'block';
                                        daycareDateSelection.style.display = 'none';
                                    } else {
                                        overnightDateSelection.style.display = 'none';
                                        daycareDateSelection.style.display = 'block';
                                    }
                                }
                                
                                // 重新綁定時段選擇事件監聽器
                                attachTimeSelectionListeners();
                                
                                // 初始化日期（如果是日租）
                                if (bookingData.serviceType === 'overnight') {
                                    const checkinInput = document.getElementById('detail-checkin-date');
                                    const checkoutInput = document.getElementById('detail-checkout-date');
                                    if (checkinInput && checkoutInput) {
                                        const today = new Date();
                                        const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                                        checkinInput.value = today.toISOString().split('T')[0];
                                        checkoutInput.value = tomorrow.toISOString().split('T')[0];
                                        
                                        // 更新預訂資料
                                        bookingData.dates.checkin = checkinInput.value;
                                        bookingData.dates.checkout = checkoutInput.value;
                                        
                                        // 觸發更新
                                        updateStayDuration();
                                    }
                                }
                                
                                // 更新步驟指示器到步驟3
                                updateStepIndicator(3);
                                
                                // 檢查是否可以繼續
                                checkCurrentStepCanContinue();
                            }
                        }, 300); // 短暫延遲以顯示選中效果
                    });
                });
            }
            
            // 更新步驟指示器
            function updateStepIndicator(currentStep) {
                console.log('更新步驟指示器到步驟:', currentStep);
                
                // 修正選擇器：找到步驟指示器容器下的每個步驟
                const stepIndicators = document.querySelectorAll('.mb-4 .flex.items-center.justify-center.flex-wrap > .flex.items-center');
                console.log('找到步驟指示器:', stepIndicators.length);
                
                stepIndicators.forEach((indicator, index) => {
                    const stepNumber = indicator.querySelector('.w-6.h-6');
                    const stepText = indicator.querySelector('span');
                    
                    console.log(`步驟 ${index + 1}:`, { stepNumber, stepText });
                    
                    if (index + 1 < currentStep) {
                        // 已完成的步驟
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else if (index + 1 === currentStep) {
                        // 當前步驟
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else {
                        // 未完成的步驟
                        stepNumber.classList.remove('bg-[#181111]', 'text-white');
                        stepNumber.classList.add('bg-gray-300', 'text-gray-600');
                        stepText.classList.remove('text-[#181111]');
                        stepText.classList.add('text-gray-500');
                    }
                });
                
                // 更新連接線
                const connectors = document.querySelectorAll('.mb-4 .flex.items-center.justify-center.flex-wrap > .w-4.h-0\\.5');
                console.log('找到連接線:', connectors.length);
                
                connectors.forEach((connector, index) => {
                    if (index + 1 < currentStep) {
                        connector.classList.remove('bg-gray-300');
                        connector.classList.add('bg-[#181111]');
                    } else {
                        connector.classList.remove('bg-[#181111]');
                        connector.classList.add('bg-gray-300');
                    }
                });
                
                console.log('步驟指示器更新完成');
            }
            
            // 方案選擇步驟已移除 - attachPlanSelectionListeners 函數已不再需要
            
            // 綁定時段選擇事件 - 簡化為兩步驟流程
            function attachTimeSelectionListeners() {
                // 返回按鈕現在已在 attachServiceTypeListeners 中處理
                
                // 綁定寄宿過夜的日期選擇（使用命名函數避免重複綁定）
                const checkinDate = document.getElementById('detail-checkin-date');
                const checkoutDate = document.getElementById('detail-checkout-date');
                
                if (checkinDate && checkoutDate) {
                    // 移除舊的監聽器（如果存在）
                    checkinDate.removeEventListener('change', handleCheckinChange);
                    checkoutDate.removeEventListener('change', handleCheckoutChange);
                    
                    // 添加新的監聽器
                    checkinDate.addEventListener('change', handleCheckinChange);
                    checkoutDate.addEventListener('change', handleCheckoutChange);
                }
                
                // 綁定日間安親的時段選擇
                bindFlexibleTimeSelection();
            }
            
            // 命名函數用於處理日期變更（避免重複綁定）
            function handleCheckinChange() {
                const checkinDate = document.getElementById('detail-checkin-date').value;
                const checkoutDate = document.getElementById('detail-checkout-date').value;
                
                if (checkinDate) {
                    bookingData.dates.checkin = checkinDate;
                    bookingData.checkinDate = checkinDate;
                    
                    // 如果退房日期早於或等於入住日期，自動調整為次日
                    if (checkoutDate && checkoutDate <= checkinDate) {
                        const nextDay = new Date(checkinDate);
                        nextDay.setDate(nextDay.getDate() + 1);
                        const checkoutInput = document.getElementById('detail-checkout-date');
                        if (checkoutInput) {
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            bookingData.dates.checkout = checkoutInput.value;
                            bookingData.checkoutDate = checkoutInput.value;
                        }
                    }
                }
                
                updateStayDuration();
            }
            
            function handleCheckoutChange() {
                const checkoutDate = document.getElementById('detail-checkout-date').value;
                if (checkoutDate) {
                    bookingData.dates.checkout = checkoutDate;
                    bookingData.checkoutDate = checkoutDate;
                }
                updateStayDuration();
            }
            
            // 命名函數用於處理時段選擇變更（避免重複綁定）
            function handleStartTimeChange() {
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                if (startTimeSelect && endTimeSelect) {
                    updateEndTimeOptions();
                    updateFlexibleTimeInfo();
                }
            }
            
            function handleEndTimeChange() {
                updateFlexibleTimeInfo();
            }
            
            function handleServiceDateChange() {
                const serviceDateInput = document.getElementById('detail-service-date');
                if (serviceDateInput) {
                    bookingData.serviceDate = serviceDateInput.value;
                    bookingData.dates.checkin = serviceDateInput.value;
                    console.log('服務日期已更新:', serviceDateInput.value);
                    // 觸發時段可用性檢查
                    checkTimeSlotAvailability();
                }
            }
            
            // 更新結束時間選項的輔助函數（需要在外部可訪問）
            function updateEndTimeOptions() {
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                if (!startTimeSelect || !endTimeSelect) return;
                
                const startHour = parseInt(startTimeSelect.value);
                const minHours = getMinHours();
                
                // 清空現有選項
                endTimeSelect.innerHTML = '';
                
                // 根據最小時數添加選項（最小時數後，之後以每小時為單位）
                // 先添加最小時數的選項
                if (startHour + minHours <= 19) {
                    const option = document.createElement('option');
                    option.value = startHour + minHours;
                    option.textContent = `${(startHour + minHours).toString().padStart(2, '0')}:00`;
                    endTimeSelect.appendChild(option);
                }
                // 之後以每小時為單位添加選項
                for (let hour = startHour + minHours + 1; hour <= 19; hour++) {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    endTimeSelect.appendChild(option);
                }
                
                // 設定預設結束時間
                if (endTimeSelect.options.length > 0) {
                    endTimeSelect.value = endTimeSelect.options[0].value;
                }
            }
            
            // 更新時段資訊顯示的輔助函數（需要在外部可訪問）
            function updateFlexibleTimeInfo() {
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                const durationDisplay = document.getElementById('flexible-duration-display');
                const priceDisplay = document.getElementById('flexible-price-display');
                
                if (!startTimeSelect || !endTimeSelect) return;
                
                const startHour = parseInt(startTimeSelect.value);
                const endHour = parseInt(endTimeSelect.value);
                const duration = endHour - startHour;
                
                console.log('更新時段資訊:', { startHour, endHour, duration });
                
                if (duration > 0 && durationDisplay && priceDisplay) {
                    // 更新顯示
                    durationDisplay.textContent = `${duration} 小時`;
                    
                    // 計算價格（基於房型的每小時價格）
                    let price = 0;
                    if (bookingData.roomId) {
                        const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                        if (selectedRoom && selectedRoom.serviceType === 'daycare') {
                            const hourlyRate = selectedRoom.hourlyRate || 0;
                            const minHours = selectedRoom.minHours || 4;
                            
                            // 確保時長不小於最小時數
                            const actualDuration = Math.max(duration, minHours);
                            price = hourlyRate * actualDuration;
                        }
                    }
                    
                    priceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                    
                    // 更新預訂資料
                    bookingData.duration = duration;
                    bookingData.timeSlot = `${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00`;
                    bookingData.timeSlotName = `${duration}小時 (${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00)`;
                    bookingData.customPrice = price;
                    
                    console.log('靈活時段選擇已更新:', { duration, timeSlot: bookingData.timeSlot, price });
                    
                    // 檢查當前步驟是否可以繼續
                    checkCurrentStepCanContinue();
                    
                    // 自動檢查時段可用性
                    checkTimeSlotAvailability();
                    
                    // 更新時段概覽的高亮顯示
                    updateTimeSlotHighlight();
                }
            }
            
            // 綁定靈活時段選擇
            function bindFlexibleTimeSelection() {
                console.log('開始綁定靈活時段選擇');
                
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                const durationDisplay = document.getElementById('flexible-duration-display');
                const priceDisplay = document.getElementById('flexible-price-display');
                const serviceDateInput = document.getElementById('detail-service-date');
                const planDurationHint = document.getElementById('plan-duration-hint');
                
                console.log('找到的元素:', { startTimeSelect, endTimeSelect, durationDisplay, priceDisplay, serviceDateInput, planDurationHint });
                
                if (startTimeSelect && endTimeSelect) {
                    // 移除舊的監聽器（如果存在）
                    startTimeSelect.removeEventListener('change', handleStartTimeChange);
                    endTimeSelect.removeEventListener('change', handleEndTimeChange);
                    if (serviceDateInput) {
                        serviceDateInput.removeEventListener('change', handleServiceDateChange);
                    }
                    
                    // 設定預設值
                    const minHours = getMinHours();
                    startTimeSelect.value = '8';
                    // 設定結束時間為開始時間 + 最小時數
                    const defaultEndHour = Math.min(8 + minHours, 19);
                    endTimeSelect.value = defaultEndHour.toString();
                    
                    // 設定預設服務日期為今天
                    if (serviceDateInput) {
                        const today = new Date();
                        serviceDateInput.value = today.toISOString().split('T')[0];
                        bookingData.serviceDate = today.toISOString().split('T')[0];
                        bookingData.dates.checkin = serviceDateInput.value;
                        console.log('服務日期已設定為:', serviceDateInput.value);
                    }
                    
                    // 更新結束時間選項
                    updateEndTimeOptions();
                    
                    // 更新方案時長提示
                    updatePlanDurationHint();
                    
                    // 立即更新顯示
                    updateFlexibleTimeInfo();
                    
                    // 初始化時檢查可用性
                    setTimeout(() => {
                        checkTimeSlotAvailability();
                    }, 100);
                    
                    // 綁定開始時間變更
                    startTimeSelect.addEventListener('change', handleStartTimeChange);
                    
                    // 綁定結束時間變更
                    endTimeSelect.addEventListener('change', handleEndTimeChange);
                    
                    // 綁定時段概覽點擊事件
                    bindTimeSlotOverviewClick();
                    
                    // 綁定服務日期變更
                    if (serviceDateInput) {
                        serviceDateInput.addEventListener('change', handleServiceDateChange);
                    }
                    
                    console.log('靈活時段選擇綁定完成');
                } else {
                    console.error('找不到時段選擇元素');
                }
                
                // 更新時長提示（基於房型的最小時數）
                function updatePlanDurationHint() {
                    if (planDurationHint) {
                        if (bookingData.roomId) {
                            const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                            if (selectedRoom && selectedRoom.serviceType === 'daycare') {
                                const minHours = selectedRoom.minHours || 4;
                                planDurationHint.textContent = `最小 ${minHours} 小時，之後以每小時為單位選擇`;
                                planDurationHint.className = 'text-blue-800 font-medium';
                            } else {
                                planDurationHint.textContent = '請先選擇時租房型';
                                planDurationHint.className = 'text-gray-600';
                            }
                        } else {
                            planDurationHint.textContent = '請先選擇房型';
                            planDurationHint.className = 'text-gray-600';
                        }
                    }
                }
                
                // 根據房型的最小時數獲取時長（內部函數，在 bindFlexibleTimeSelection 作用域內使用）
                function getMinHours() {
                    if (bookingData.roomId) {
                        const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                        if (selectedRoom && selectedRoom.serviceType === 'daycare') {
                            return selectedRoom.minHours || 4;
                        }
                    }
                    return 4; // 預設4小時
                }
                
                // 公開更新方案時長提示的方法
                window.updateDaycarePlanDuration = updatePlanDurationHint;
                
                // 綁定時段概覽點擊事件
                function bindTimeSlotOverviewClick() {
                    // 先移除舊的監聽器（通過重新綁定所有元素）
                    document.querySelectorAll('.timeline-segment').forEach(segment => {
                        // 創建一個新的元素來替換舊的，這樣可以移除所有監聽器
                        const newSegment = segment.cloneNode(true);
                        segment.parentNode.replaceChild(newSegment, segment);
                    });
                    
                    // 綁定時段片段點擊
                    document.querySelectorAll('.timeline-segment').forEach(segment => {
                        segment.addEventListener('click', function() {
                            const startHour = parseInt(this.dataset.start);
                            const status = this.classList.contains('available');
                            
                            // 只有可用的時段才能點擊
                            if (status) {
                                const startTimeSelect = document.getElementById('start-time-select');
                                const endTimeSelect = document.getElementById('end-time-select');
                                if (startTimeSelect && endTimeSelect) {
                                    // 設定開始時間
                                    startTimeSelect.value = startHour;
                                    
                                    // 根據房型最小時數設定結束時間
                                    const minHours = getMinHours();
                                    const endHour = startHour + minHours;
                                    
                                    if (endHour <= 19) {
                                        endTimeSelect.value = endHour;
                                        
                                        // 觸發更新
                                        startTimeSelect.dispatchEvent(new Event('change'));
                                    }
                                }
                            }
                        });
                    });
                }
            }
            
            // 根據房型的最小時數獲取時長（外部函數，供其他地方使用）
            function getMinHours() {
                if (bookingData.roomId) {
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom && selectedRoom.serviceType === 'daycare') {
                        return selectedRoom.minHours || 4;
                    }
                }
                return 4; // 預設4小時
            }
            

            

            
            // 檢查時段可用性
            function checkTimeSlotAvailability() {
                const startHour = document.getElementById('start-time-select').value;
                const endHour = document.getElementById('end-time-select').value;
                const serviceDate = document.getElementById('detail-service-date').value;
                const resultDiv = document.getElementById('availability-result');
                
                if (!startHour || !endHour || !serviceDate || !resultDiv) {
                    return;
                }
                
                // 模擬可用性資料（實際應用中會從後端獲取）
                const mockAvailability = {
                    '08:00-09:00': { available: true, capacity: 5, booked: 1 },
                    '09:00-10:00': { available: true, capacity: 5, booked: 2 },
                    '10:00-11:00': { available: true, capacity: 5, booked: 3 },
                    '11:00-12:00': { available: false, capacity: 5, booked: 5 },
                    '12:00-13:00': { available: true, capacity: 5, booked: 1 },
                    '13:00-14:00': { available: true, capacity: 5, booked: 0 },
                    '14:00-15:00': { available: true, capacity: 5, booked: 2 },
                    '15:00-16:00': { available: true, capacity: 5, booked: 1 },
                    '16:00-17:00': { available: true, capacity: 5, booked: 0 },
                    '17:00-18:00': { available: true, capacity: 5, booked: 1 },
                    '18:00-19:00': { available: true, capacity: 5, booked: 1 }
                };
                
                // 更新時段概覽的可用性狀態
                updateTimeSlotOverview(mockAvailability);
                
                let allAvailable = true;
                let unavailableSlots = [];
                
                // 檢查選擇時段內的每個小時
                for (let hour = parseInt(startHour); hour < parseInt(endHour); hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00`;
                    const slotInfo = mockAvailability[timeSlot];
                    
                    if (!slotInfo || !slotInfo.available) {
                        allAvailable = false;
                        unavailableSlots.push(timeSlot);
                    }
                }
                
                // 顯示結果
                if (allAvailable) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-green-600 mr-2">✅</span>
                                <span class="text-green-800 font-medium">時段可用</span>
                            </div>
                            <p class="text-green-700 text-sm mt-1">選擇的時段 ${startHour}:00-${endHour}:00 可以預訂</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-red-600 mr-2">❌</span>
                                <span class="text-red-800 font-medium">時段額滿</span>
                            </div>
                            <p class="text-red-700 text-sm mt-1">以下時段已額滿：${unavailableSlots.join(', ')}</p>
                            <p class="text-red-600 text-xs mt-2">建議選擇其他時段或日期</p>
                        </div>
                    `;
                }
                
                resultDiv.classList.remove('hidden');
            }
            
            // 更新時段概覽的可用性狀態
            function updateTimeSlotOverview(availability) {
                // 目前只需要更新時段片段，時間刻度已移除
                // 可以根據需要添加其他邏輯
            }
            
            // 更新時段概覽的高亮顯示
            function updateTimeSlotHighlight() {
                const startHour = parseInt(document.getElementById('start-time-select').value);
                const endHour = parseInt(document.getElementById('end-time-select').value);
                
                // 移除所有高亮
                document.querySelectorAll('.timeline-segment').forEach(segment => {
                    segment.classList.remove('selected');
                });
                
                // 高亮選擇的時段範圍
                document.querySelectorAll('.timeline-segment').forEach(segment => {
                    const segmentStart = parseInt(segment.dataset.start);
                    const segmentEnd = parseInt(segment.dataset.end);
                    
                    if (startHour >= segmentStart && endHour <= segmentEnd) {
                        segment.classList.add('selected');
                    }
                });
            }
            
            // 初始化寄宿過夜的預設日期和入住天數顯示
            function initializeOvernightDates() {
                const checkinInput = document.getElementById('detail-checkin-date');
                const checkoutInput = document.getElementById('detail-checkout-date');
                
                if (checkinInput && checkoutInput) {
                    // 設定預設日期
                    const today = new Date();
                    const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                    
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // 更新預訂資料
                    bookingData.checkinDate = today.toISOString().split('T')[0];
                    bookingData.checkoutDate = tomorrow.toISOString().split('T')[0];
                    bookingData.stayDuration = 1;
                    
                    // 更新入住天數顯示
                    updateStayDuration();
                    
                    console.log('寄宿過夜預設日期已初始化:', {
                        checkin: bookingData.checkinDate,
                        checkout: bookingData.checkoutDate,
                        duration: bookingData.stayDuration
                    });
                }
            }
            
            // 更新訂單確認頁面的明細
            function updateOrderConfirmation() {
                console.log('更新訂單確認頁面明細:', bookingData);
                
                // 隱藏其他不相關的內容
                const aboutSection = document.getElementById('about-section');
                const userReviewsSection = document.getElementById('user-reviews-section');
                const locationSection = document.getElementById('location-section');
                
                // 隱藏步驟1-3的內容
                const step1 = document.getElementById('step-1-service-type');
                const step2 = document.getElementById('step-2-plan-selection');
                const step3 = document.getElementById('step-3-time-selection');
                const continueSection = document.getElementById('continue-booking-section');
                
                if (aboutSection) {
                    aboutSection.style.display = 'none';
                    console.log('關於區塊已隱藏');
                }
                
                if (userReviewsSection) {
                    userReviewsSection.style.display = 'none';
                    console.log('用戶評價區塊已隱藏');
                }
                
                if (locationSection) {
                    locationSection.style.display = 'none';
                    console.log('位置資訊區塊已隱藏');
                }
                    
                // 隱藏步驟1-3和繼續按鈕
                const step4Pet = document.getElementById('step-pet-selection');
                
                if (step1) {
                    step1.style.display = 'none';
                    console.log('步驟1已隱藏');
                }
                
                if (step2) {
                    step2.style.display = 'none';
                    console.log('步驟2已隱藏');
                }
                
                if (step3) {
                    step3.style.display = 'none';
                    console.log('步驟3已隱藏');
                }
                
                if (step4Pet) {
                    step4Pet.style.display = 'none';
                    console.log('步驟4（選擇寵物）已隱藏');
                }
                
                if (continueSection) {
                    continueSection.style.display = 'none';
                    console.log('繼續預訂按鈕已隱藏');
                }
                
                // 隱藏價格透明度區塊
                const priceTransparency = document.getElementById('price-transparency');
                if (priceTransparency) {
                    priceTransparency.style.display = 'none';
                    console.log('價格透明度區塊已隱藏');
                }
                
                // 更新服務類型
                const serviceTypeElement = document.getElementById('confirmation-service-type');
                if (serviceTypeElement) {
                    serviceTypeElement.textContent = bookingData.serviceType === 'overnight' ? '寄宿過夜' : '日間安親';
                }
                
                // 更新房型資訊（移除方案相關）
                const roomElement = document.getElementById('confirmation-room');
                if (roomElement && bookingData.roomId) {
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom) {
                        roomElement.textContent = selectedRoom.name;
                    }
                }
                
                // 更新日期時間
                const datesElement = document.getElementById('confirmation-dates');
                const durationElement = document.getElementById('confirmation-duration');
                if (datesElement && durationElement) {
                    if (bookingData.serviceType === 'overnight') {
                        const checkinDate = new Date(bookingData.checkinDate);
                        const checkoutDate = new Date(bookingData.checkoutDate);
                        datesElement.textContent = `${checkinDate.getFullYear()}年${checkinDate.getMonth() + 1}月${checkinDate.getDate()}日 - ${checkoutDate.getFullYear()}年${checkoutDate.getMonth() + 1}月${checkoutDate.getDate()}日`;
                        durationElement.textContent = `${bookingData.stayDuration} 晚`;
                    } else {
                        const serviceDate = new Date(bookingData.serviceDate);
                        datesElement.textContent = `${serviceDate.getFullYear()}年${serviceDate.getMonth() + 1}月${serviceDate.getDate()}日`;
                        durationElement.textContent = bookingData.duration || '1 小時';
                    }
                }
                
                // 更新寵物資訊
                const petNameEl = document.getElementById('confirmation-pet-name');
                const petDetailsEl = document.getElementById('confirmation-pet-details');

                if (bookingData.petId && petNameEl && petDetailsEl) {
                    // 檢查是否為臨時寵物
                    let selectedPet;
                    if (bookingData.tempPet && bookingData.petId === bookingData.tempPet.id) {
                        selectedPet = bookingData.tempPet;
                    } else {
                        selectedPet = window.mockPets.find(p => p.id === bookingData.petId);
                    }
                    
                    if (selectedPet) {
                        petNameEl.textContent = selectedPet.name;
                        const ageText = selectedPet.age ? `${selectedPet.age}歲` : '';
                        const genderText = selectedPet.gender === 'male' ? '公' : selectedPet.gender === 'female' ? '母' : '';
                        const details = [selectedPet.breed, ageText, genderText].filter(Boolean).join(' • ');
                        petDetailsEl.textContent = details || selectedPet.breed;
                    }
                }
                
                console.log('訂單確認頁面明細更新完成');
            }
            
            // 更新付款頁面的資訊
            function updatePaymentPage() {
                console.log('更新付款頁面資訊:', bookingData);
                
                // 生成訂單編號
                const orderNumber = 'PTH' + new Date().getFullYear() + 
                    String(new Date().getMonth() + 1).padStart(2, '0') + 
                    String(new Date().getDate()).padStart(2, '0') + 
                    String(Math.floor(Math.random() * 1000)).padStart(3, '0');
                
                // 更新訂單資訊
                const orderNumberElement = document.getElementById('order-number');
                const serviceTypeElement = document.getElementById('payment-service-type');
                const planElement = document.getElementById('payment-plan');
                const datesElement = document.getElementById('payment-dates');
                const amountElement = document.getElementById('payment-amount');
                const btnTextElement = document.getElementById('payment-btn-text');
                
                if (orderNumberElement) {
                    orderNumberElement.textContent = orderNumber;
                }
                
                if (serviceTypeElement) {
                    serviceTypeElement.textContent = bookingData.serviceType === 'overnight' ? '寄宿過夜' : '日間安親';
                }
                
                if (planElement) {
                    const planNames = {
                        'standard': '標準套房',
                        'deluxe': '豪華套房',
                        'premium': '頂級套房',
                        'basic': '基礎套房'
                    };
                    planElement.textContent = planNames[bookingData.selectedPlan] || bookingData.selectedPlan;
                }
                
                if (datesElement) {
                    if (bookingData.serviceType === 'overnight') {
                        const checkinDate = new Date(bookingData.checkinDate);
                        const checkoutDate = new Date(bookingData.checkoutDate);
                        datesElement.textContent = `${checkinDate.getFullYear()}年${checkinDate.getMonth() + 1}月${checkinDate.getDate()}日 - ${checkoutDate.getFullYear()}年${checkoutDate.getMonth() + 1}月${checkoutDate.getDate()}日`;
                    } else {
                        const serviceDate = new Date(bookingData.serviceDate);
                        datesElement.textContent = `${serviceDate.getFullYear()}年${serviceDate.getMonth() + 1}月${serviceDate.getDate()}日`;
                    }
                }
                
                if (amountElement && btnTextElement) {
                    const amount = bookingData.planPrice || 0;
                    amountElement.textContent = `NT$ ${amount.toLocaleString()}`;
                    btnTextElement.textContent = `確認付款 NT$ ${amount.toLocaleString()}`;
                }
                
                console.log('付款頁面資訊更新完成');
            }
            
            // 更新入住天數顯示
            function updateStayDuration() {
                const checkinDate = document.getElementById('detail-checkin-date')?.value;
                const checkoutDate = document.getElementById('detail-checkout-date')?.value;
                const durationDisplay = document.getElementById('stay-duration');
                
                if (!durationDisplay) return;
                
                if (checkinDate && checkoutDate) {
                    const checkin = new Date(checkinDate);
                    const checkout = new Date(checkoutDate);
                    const diffTime = Math.abs(checkout - checkin);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0) {
                        durationDisplay.textContent = `${diffDays} 晚`;
                        bookingData.checkinDate = checkinDate;
                        bookingData.checkoutDate = checkoutDate;
                        bookingData.dates.checkin = checkinDate;
                        bookingData.dates.checkout = checkoutDate;
                        bookingData.stayDuration = diffDays;
                        
                        console.log('入住天數已更新:', { checkinDate, checkoutDate, diffDays });
                        
                        // 檢查當前步驟是否可以繼續
                        checkCurrentStepCanContinue();
                    } else {
                        durationDisplay.textContent = '請選擇有效的退房日期';
                    }
                } else {
                    durationDisplay.textContent = '請選擇日期';
                }
            }
            
            // 綁定訂單確認事件 - 步驟4
            function attachOrderConfirmationListeners() {
                // 綁定返回按鈕
                document.getElementById('back-to-time-selection')?.addEventListener('click', function() {
                    console.log('返回時段選擇按鈕被點擊');
                    
                    // 重新顯示其他內容
                    const aboutSection = document.getElementById('about-section');
                    const userReviewsSection = document.getElementById('user-reviews-section');
                    const locationSection = document.getElementById('location-section');
                    
                    if (aboutSection) {
                        aboutSection.style.display = 'block';
                        console.log('關於區塊已顯示');
                    }
                    
                    if (userReviewsSection) {
                        userReviewsSection.style.display = 'block';
                        console.log('用戶評價區塊已顯示');
                    }
                    
                    if (locationSection) {
                        locationSection.style.display = 'block';
                        console.log('位置資訊區塊已顯示');
                    }
                    
                    // 返回步驟4（選擇寵物）
                    const step4Pet = document.getElementById('step-pet-selection');
                    const step5Confirmation = document.getElementById('step-4-order-confirmation');
                    const priceTransparency = document.getElementById('price-transparency');
                    const continueSection = document.getElementById('continue-booking-section');
                    
                    if (step4Pet && step5Confirmation) {
                        // 隱藏步驟5（確認明細）
                        step5Confirmation.style.display = 'none';
                        console.log('步驟5已隱藏');
                        
                        // 顯示步驟4（選擇寵物）
                        step4Pet.style.display = 'block';
                        console.log('步驟4已顯示');
                        
                        // 隱藏價格明細和繼續預訂按鈕（選擇寵物時不應該顯示）
                        if (priceTransparency) {
                            priceTransparency.style.display = 'none';
                        }
                        if (continueSection) {
                            continueSection.style.display = 'none';
                        }
                        
                        // 更新步驟指示器回到步驟4
                        updateStepIndicator(4);
                    }
                });
                
                // 綁定確認並付款按鈕
                document.getElementById('confirm-and-pay-btn')?.addEventListener('click', function() {
                    console.log('確認並付款按鈕被點擊');
                    
                    // 獲取特殊需求
                    const specialRequirements = document.getElementById('special-requirements');
                    if (specialRequirements) {
                        bookingData.specialRequirements = specialRequirements.value;
                    }
                    
                    // 進入步驟6：藍星支付
                    const step5Confirmation = document.getElementById('step-4-order-confirmation');
                    const step6Payment = document.getElementById('step-5-payment');
                    
                    if (step5Confirmation && step6Payment) {
                        // 隱藏步驟5（確認明細）
                        step5Confirmation.style.display = 'none';
                        console.log('步驟5已隱藏');
                        
                        // 顯示步驟6（付款）
                        step6Payment.style.display = 'block';
                        console.log('步驟6已顯示');
                        
                        // 更新步驟指示器到步驟6
                        updateStepIndicator(6);
                        
                        // 更新付款頁面的資訊
                        updatePaymentPage();
                    } else {
                        console.error('找不到步驟5或步驟6元素');
                    }
                });
            }
            
            // 綁定付款頁面事件 - 步驟6
            function attachPaymentListeners() {
                // 綁定返回按鈕
                document.getElementById('back-to-confirmation')?.addEventListener('click', function() {
                    console.log('返回確認明細按鈕被點擊');
                    
                    // 返回步驟5（確認明細）
                    const step5Confirmation = document.getElementById('step-4-order-confirmation');
                    const step6Payment = document.getElementById('step-5-payment');
                    
                    if (step5Confirmation && step6Payment) {
                        // 隱藏步驟6（付款）
                        step6Payment.style.display = 'none';
                        console.log('步驟6已隱藏');
                        
                        // 顯示步驟5（確認明細）
                        step5Confirmation.style.display = 'block';
                        console.log('步驟5已顯示');
                        
                        // 更新步驟指示器回到步驟5
                        updateStepIndicator(5);
                    }
                });
                
                // 綁定付款按鈕
                document.getElementById('process-payment-btn')?.addEventListener('click', function() {
                    console.log('付款按鈕被點擊');
                    
                    // 獲取選擇的付款方式
                    const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');
                    if (!selectedPaymentMethod) {
                        alert('請選擇付款方式');
                        return;
                    }
                    
                    // 顯示載入狀態
                    const btnText = document.getElementById('payment-btn-text');
                    const btnLoading = document.getElementById('payment-loading');
                    
                    if (btnText && btnLoading) {
                        btnText.classList.add('hidden');
                        btnLoading.classList.remove('hidden');
                    }
                    
                    // 模擬付款處理
                    setTimeout(() => {
                        // 模擬付款成功
                        const isSuccess = Math.random() > 0.1; // 90% 成功率
                        
                        if (isSuccess) {
                            // 付款成功 - 生成訂單編號
                            bookingData.orderNumber = 'PAW' + Date.now();
                            
                            // 跳轉到付款成功頁面
                            showPage('paymentSuccess');
                            
                            console.log('付款成功，訂單資料:', bookingData);
                        } else {
                            // 付款失敗
                            alert('付款失敗！\n\n請檢查您的付款資訊或選擇其他付款方式。\n\n如有問題，請聯繫客服。');
                            
                            // 恢復按鈕狀態
                            if (btnText && btnLoading) {
                                btnText.classList.remove('hidden');
                                btnLoading.classList.add('hidden');
                            }
                        }
                    }, 2000); // 模擬2秒處理時間
                });
            }
            
            // 在函數定義完成後，調用必要的初始化函數
            function initializeBookingFunctions() {
                // attachPlanSelectionListeners removed - packages are now integrated into room types
                attachTimeSelectionListeners();
                attachOrderConfirmationListeners();
                attachPaymentListeners();
                
                // 初始化步驟指示器為步驟1
                updateStepIndicator(1);
            }

            // 綁定時段選擇事件
            function attachTimeSlotListeners() {
                // 預設時段選擇
                document.querySelectorAll('.preset-time-slot').forEach(slot => {
                    slot.addEventListener('click', function() {
                        // 移除其他時段的選中狀態
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 選中當前時段
                        this.classList.add('selected');
                        
                        // 更新預訂資料
                        const hours = parseInt(this.dataset.hours);
                        const time = this.dataset.time;
                        const price = parseInt(this.dataset.price);
                        
                        bookingData.duration = hours;
                        bookingData.timeSlot = time;
                        bookingData.timeSlotName = `${hours}小時 (${time})`;
                        bookingData.customPrice = price;
                        
                        // 隱藏自訂時段選擇
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // 顯示房型選項
                        showRoomServiceOptions('daycare');
                        
                        // 更新價格顯示
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // 自訂時段切換
                document.querySelector('.custom-time-toggle')?.addEventListener('click', function() {
                    const timeSliders = document.querySelector('.time-sliders');
                    const isHidden = timeSliders.classList.contains('hidden');
                    
                    if (isHidden) {
                        // 顯示自訂時段選擇
                        timeSliders.classList.remove('hidden');
                        this.classList.add('active');
                        this.innerHTML = '<span>收起自訂時段</span>';
                        
                        // 清除預設時段選擇
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 隱藏房型選項，等待自訂時段選擇完成
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) {
                            roomServiceList.classList.add('hidden');
                        }
                    } else {
                        // 隱藏自訂時段選擇
                        timeSliders.classList.add('hidden');
                        this.classList.remove('active');
                        this.innerHTML = '<span>自訂時段</span>';
                    }
                });
                
                // 滑桿時間選擇 (保留原有功能)
                const startTimeSlider = document.getElementById('start-time-slider');
                const endTimeSlider = document.getElementById('end-time-slider');
                const startTimeDisplay = document.getElementById('start-time-display');
                const endTimeDisplay = document.getElementById('end-time-display');
                const durationDisplay = document.getElementById('duration-display');
                const timePriceDisplay = document.getElementById('time-price-display');
                
                if (!startTimeSlider || !endTimeSlider) return;
                
                // 初始化顯示
                updateTimeDisplays();
                
                // 開始時間滑桿事件
                startTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(this.value);
                    const endHour = parseInt(endTimeSlider.value);
                    
                    // 確保結束時間大於開始時間
                    if (endHour <= startHour) {
                        endTimeSlider.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // 結束時間滑桿事件
                endTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(this.value);
                    
                    // 確保結束時間大於開始時間
                    if (endHour <= startHour) {
                        this.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // 更新時間顯示
                function updateTimeDisplays() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    // 格式化時間顯示
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // 更新顯示元素
                    if (startTimeDisplay) startTimeDisplay.textContent = startTime;
                    if (endTimeDisplay) endTimeDisplay.textContent = endTime;
                    if (durationDisplay) durationDisplay.textContent = `${duration} 小時`;
                    
                    // 計算價格 (每小時150元)
                    const price = duration * 150;
                    if (timePriceDisplay) timePriceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                }
                
                // 更新自訂預訂資料
                function updateCustomBookingData() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // 更新全域預訂資料
                    bookingData.duration = duration;
                    bookingData.timeSlot = `${startTime}-${endTime}`;
                    bookingData.timeSlotName = `${duration}小時 (${startTime}-${endTime})`;
                    bookingData.customPrice = duration * 150;
                    
                    // 顯示房型選項（如果時間已選擇）
                    if (duration > 0) {
                        showRoomServiceOptions('daycare');
                    }
                    
                    // 隱藏自訂時段選擇
                    const timeSliders = document.querySelector('.time-sliders');
                    if (timeSliders) {
                        timeSliders.classList.add('hidden');
                    }
                    
                    updatePriceTransparency();
                    checkCanContinueBooking();
                }
            }
            
            // 顯示可用時段
            function showAvailableTimeSlots(duration) {
                const timeSlotSelection = document.getElementById('time-slot-selection');
                const availableTimeSlots = document.getElementById('available-time-slots');
                
                if (!timeSlotSelection || !availableTimeSlots) return;
                
                // 生成可選的開始時間 (營業時間 9:00-18:00)
                const startHour = 9;
                const endHour = 18;
                const slots = [];
                
                for (let hour = startHour; hour <= endHour - duration; hour++) {
                    const startTime = `${hour.toString().padStart(2, '0')}:00`;
                    const endTime = `${(hour + duration).toString().padStart(2, '0')}:00`;
                    slots.push({
                        start: startTime,
                        end: endTime,
                        display: `${startTime}-${endTime}`
                    });
                }
                
                // 生成HTML
                availableTimeSlots.innerHTML = slots.map(slot => `
                    <button class="time-slot-btn p-2 border-2 border-gray-200 rounded-lg text-center hover:border-[#181111] transition-all text-sm" 
                            data-slot="${slot.display}" data-start="${slot.start}" data-end="${slot.end}">
                        ${slot.display}
                    </button>
                `).join('');
                
                // 綁定時段按鈕事件
                availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 重置所有時段按鈕
                        availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
                            b.classList.remove('border-[#181111]', 'bg-green-50');
                            b.classList.add('border-gray-200');
                        });
                        
                        // 選中當前時段
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-green-50');
                        
                                                 // 保存時段信息
                         bookingData.timeSlot = this.dataset.slot;
                         bookingData.timeSlotName = `${duration}小時 (${this.dataset.slot})`;
                         
                         // 選擇時段後，顯示房型選項
                         showRoomServiceOptions('daycare');
                         
                         checkCanContinueBooking();
                    });
                });
                
                                 // 顯示時段選擇區域
                 timeSlotSelection.classList.remove('hidden');
             }
             
             // 顯示房型服務選項
             function showRoomServiceOptions(serviceType) {
                 const roomServiceList = document.getElementById('room-service-list');
                 if (!roomServiceList) return;
                 
                 // 如果是日間安親，顯示方案選擇界面
                 if (serviceType === 'daycare') {
                     showDaycarePackageSelection();
                     return;
                 }
                 
                 // 整理房型和對應的服務
                 const roomTypeMap = new Map();
                 
                 // 從 mockRoomTypes 直接獲取數據（移除對 mockPackages 的依賴）
                 mockRoomTypes.forEach(room => {
                     if (room.status === 'active' && room.serviceType === serviceType) {
                         roomTypeMap.set(room.id, {
                             name: room.name,
                             description: room.description || '',
                             serviceType: room.serviceType,
                             basePrice: room.serviceType === 'overnight' ? room.basePrice : null,
                             hourlyRate: room.serviceType === 'daycare' ? room.hourlyRate : null,
                             minHours: room.serviceType === 'daycare' ? room.minHours : null
                         });
                     }
                 });

                 let html = '';
                 roomTypeMap.forEach((roomData, roomId) => {
                     const price = serviceType === 'overnight' ? roomData.basePrice : (roomData.hourlyRate * (roomData.minHours || 4));
                     const serviceIcon = serviceType === 'overnight' ? '🏠' : '⏰';
                     const priceUnit = serviceType === 'overnight' ? '/ 晚' : `/ ${roomData.minHours || 4}hr起`;
                     
                     html += `
                         <div class="border border-gray-200 rounded-lg p-4">
                             <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                             <p class="text-sm text-gray-500 mb-2">${roomData.description}</p>
                             <button class="room-service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                     data-service-type="${serviceType}" data-room-id="${roomId}">
                                 <div class="flex justify-between items-center">
                                     <div class="flex items-center">
                                         <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3 text-sm">${serviceIcon}</span>
                                         <div>
                                             <span class="font-medium text-[#181111]">選擇此房型</span>
                                             <p class="text-xs text-gray-500">${serviceType === 'overnight' ? '寄宿過夜服務' : '日間安親服務'}</p>
                                         </div>
                                     </div>
                                     <div class="text-right">
                                         <span class="font-bold text-sm">NT$ ${price.toLocaleString()}${serviceType === 'daycare' ? '起' : ''}</span>
                                         <p class="text-xs text-gray-500">${priceUnit}</p>
                                     </div>
                                 </div>
                             </button>
                         </div>
                     `;
                 });

                 roomServiceList.innerHTML = html;
                 roomServiceList.classList.remove('hidden');
                 
                 // 綁定房型選擇事件
                 attachRoomServiceListeners();
             }
             
             // 顯示日間安親方案選擇
            function showDaycarePackageSelection() {
                // 改為直接顯示時租房型選擇
                showRoomServiceSelection('daycare');
            }
             
             // 綁定房型服務選擇事件
             function attachRoomServiceListeners() {
                 document.querySelectorAll('.room-service-option-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         // 移除其他按鈕的選中狀態
                         document.querySelectorAll('.room-service-option-btn').forEach(b => {
                             b.classList.remove('selected');
                             b.style.borderColor = '#e5e7eb';
                             b.style.backgroundColor = '';
                         });
                         
                         // 選中當前按鈕
                         this.classList.add('selected');
                         this.style.borderColor = '#181111';
                         this.style.backgroundColor = '#f9fafb';
                         
                         const serviceType = this.dataset.serviceType;
                         const roomId = parseInt(this.dataset.roomId);
                         
                         // 設定預訂資料
                         bookingData.preferredRoomId = roomId;
                         
                         checkCanContinueBooking();
                     });
                 });
             }

            // 更新價格透明度顯示
            function updatePriceTransparency() {
                const priceTransparency = document.getElementById('price-transparency');
                const roomPriceDetail = document.getElementById('room-price-detail');
                const roomPrice = document.getElementById('room-price');
                const durationItem = document.getElementById('duration-item');
                const durationDetail = document.getElementById('duration-detail');
                const durationPrice = document.getElementById('duration-price');
                const petCountItem = document.getElementById('pet-count-item');
                const petCountDetail = document.getElementById('pet-count-detail');
                const petCountPrice = document.getElementById('pet-count-price');
                const totalPrice = document.getElementById('total-price');
                
                let total = 0;
                let hasValidData = false;
                
                // 房型費用 (基於房型價格設定)
                if (bookingData.roomId) {
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom) {
                        roomPriceDetail.textContent = selectedRoom.name;
                        
                        // 根據服務類型計算價格
                        if (bookingData.serviceType === 'overnight' && selectedRoom.serviceType === 'overnight') {
                            const basePrice = selectedRoom.basePrice || 0;
                            if (bookingData.stayDuration) {
                                const durationCost = basePrice * bookingData.stayDuration;
                                roomPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                                total += durationCost;
                                hasValidData = true;
                            }
                        } else if (bookingData.serviceType === 'daycare' && selectedRoom.serviceType === 'daycare') {
                            const hourlyRate = selectedRoom.hourlyRate || 0;
                            const duration = bookingData.duration || selectedRoom.minHours || 4;
                            const durationCost = hourlyRate * duration;
                            roomPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                            total += durationCost;
                            hasValidData = true;
                        }
                    }
                } else {
                    roomPriceDetail.textContent = '請選擇房型';
                    roomPrice.textContent = 'NT$ 0';
                }
                
                // 服務時長和費用計算（已整合到上面）
                if (bookingData.serviceType === 'overnight' && bookingData.stayDuration) {
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.stayDuration} 晚`;
                    
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom && selectedRoom.serviceType === 'overnight') {
                        const durationCost = (selectedRoom.basePrice || 0) * bookingData.stayDuration;
                        durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    }
                } else if (bookingData.serviceType === 'daycare' && bookingData.duration) {
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.duration}小時`;
                    
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom && selectedRoom.serviceType === 'daycare') {
                        const durationCost = (selectedRoom.hourlyRate || 0) * bookingData.duration;
                        durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    }
                } else {
                    durationItem.style.display = 'none';
                }
                
                // 寵物數量
                if (bookingData.petCount > 1) {
                    petCountItem.style.display = 'flex';
                    petCountDetail.textContent = `${bookingData.petCount} 隻`;
                    petCountPrice.textContent = `× ${bookingData.petCount}`;
                    total *= bookingData.petCount;
                } else {
                    petCountItem.style.display = 'none';
                }
                
                // 加購服務
                const addonItems = document.getElementById('addon-items');
                addonItems.innerHTML = '';
                bookingData.addons.forEach(addon => {
                    const addonItem = document.createElement('div');
                    addonItem.className = 'price-item addon';
                    addonItem.innerHTML = `
                        <span class="item-label">加購服務</span>
                        <span class="item-detail">${addon.name}</span>
                        <span class="item-price">NT$ ${addon.price.toLocaleString()}</span>
                    `;
                    addonItems.appendChild(addonItem);
                    total += addon.price;
                });
                
                // 更新總價
                if (totalPrice) {
                    totalPrice.textContent = `NT$ ${total.toLocaleString()}`;
                }
                
                // 顯示/隱藏價格透明度區域
                if (hasValidData) {
                    priceTransparency.classList.remove('hidden');
                    console.log('價格透明度區域已顯示，總價:', total);
                } else {
                    priceTransparency.classList.add('hidden');
                    console.log('價格透明度區域已隱藏，沒有有效資料');
                }
            }
            
            // 輔助函數：獲取方案顯示名稱
            function getPlanDisplayName(plan) {
                const planNames = {
                    'standard': '標準',
                    'deluxe': '豪華',
                    'premium': '頂級',
                    'basic': '基礎'
                };
                return planNames[plan] || plan;
            }
            
            // 驗證預訂資料 - 新的三步驟流程
            function validateBookingData() {
                const errors = [];
                
                console.log('驗證預訂資料:', bookingData);
                
                // 檢查服務類型
                if (!bookingData.serviceType) {
                    errors.push('請選擇服務類型');
                }
                
                // 檢查房型選擇
                if (!bookingData.roomId) {
                    errors.push('請選擇房型');
                }
                
                // 根據服務類型檢查時段選擇
                if (bookingData.serviceType === 'overnight') {
                    if (!bookingData.checkinDate) {
                        errors.push('請選擇入住日期');
                    }
                    if (!bookingData.checkoutDate) {
                        errors.push('請選擇退房日期');
                    } else if (new Date(bookingData.checkoutDate) <= new Date(bookingData.checkinDate)) {
                        errors.push('退房日期必須晚於入住日期');
                    }
                } else if (bookingData.serviceType === 'daycare') {
                    if (!bookingData.timeSlot) {
                        errors.push('請選擇服務時段');
                    }
                    if (!bookingData.duration) {
                        errors.push('請選擇服務時長');
                    }
                }
                
                console.log('驗證結果:', errors);
                return errors;
            }
            
            // 輕量級驗證 - 僅檢查當前步驟的資料
            function validateCurrentStep() {
                const errors = [];
                
                // 如果已經選擇了服務類型，檢查房型
                if (bookingData.serviceType && !bookingData.roomId) {
                    errors.push('請選擇房型');
                }
                
                // 如果已經選擇了房型，檢查時段
                if (bookingData.roomId) {
                    if (bookingData.serviceType === 'overnight') {
                        if (!bookingData.checkinDate || !bookingData.checkoutDate) {
                            errors.push('請選擇入住和退房日期');
                        }
                    } else if (bookingData.serviceType === 'daycare') {
                        if (!bookingData.timeSlot || !bookingData.duration) {
                            errors.push('請選擇服務時段');
                        }
                    }
                }
                
                return errors;
            }
            
            // 顯示錯誤訊息
            function showBookingErrors(errors) {
                const errorContainer = document.getElementById('booking-errors');
                if (errors.length > 0) {
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <div class="error-title">
                                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                請修正以下問題：
                            </div>
                            <ul class="error-list">
                                ${errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    errorContainer.classList.remove('hidden');
                } else {
                    errorContainer.classList.add('hidden');
                }
            }
            
            // 檢查是否可以繼續預訂
            function checkCanContinueBooking() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateBookingData();
                
                // 顯示錯誤訊息
                showBookingErrors(errors);
                
                // 更新價格透明度
                updatePriceTransparency();
                
                // 檢查是否可以繼續
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                    
                    // 重新綁定繼續按鈕事件
                    const continueBtn = document.getElementById('continue-booking-btn');
                    continueBtn.replaceWith(continueBtn.cloneNode(true));
                    const newBtn = document.getElementById('continue-booking-btn');
                    newBtn.addEventListener('click', function() {
                        console.log('繼續預訂，前往選擇寵物');
                        
                        // 隱藏步驟3，顯示寵物選擇步驟
                        const step3 = document.getElementById('step-3-time-selection');
                        const petSelectionStep = document.getElementById('step-pet-selection');
                        const priceTransparency = document.getElementById('price-transparency');
                        const continueSection = document.getElementById('continue-booking-section');
                        
                        if (step3 && petSelectionStep) {
                            step3.style.display = 'none';
                            petSelectionStep.style.display = 'block';
                            
                            // 隱藏價格明細和繼續預訂按鈕
                            if (priceTransparency) {
                                priceTransparency.style.display = 'none';
                            }
                            if (continueSection) {
                                continueSection.style.display = 'none';
                            }
                            
                            // 更新步驟指示器到步驟4
                            updateStepIndicator(4);
                            
                            // 渲染寵物選擇列表
                            renderPetSelectionList();
                        }
                    });
                } else {
                    continueSection.classList.add('hidden');
                }
            }
            
            // == START: 新增 renderPetSelectionList 函式 ==
            function renderPetSelectionList() {
                const listContainer = document.getElementById('pet-selection-list');
                
                // 準備所有寵物列表（包括臨時寵物）
                const allPets = [...window.mockPets];
                if (bookingData.tempPet) {
                    allPets.push(bookingData.tempPet);
                }
                
                // 渲染現有寵物列表 + 「+」卡片
                listContainer.innerHTML = allPets.map(pet => {
                    const isSelected = bookingData.petId === pet.id;
                    return `
                    <div class="pet-selection-card p-3 border-2 rounded-xl flex items-center gap-4 cursor-pointer ${isSelected ? 'border-[#181111] bg-gray-50 selected' : 'border-gray-200'}" data-pet-id="${pet.id}">
                        <img src="${pet.photoUrl}" class="w-12 h-12 rounded-full object-cover">
                        <div class="flex-1">
                            <p class="font-bold text-base">${pet.name}</p>
                            <p class="text-sm text-gray-500">${pet.breed}${pet.id && pet.id.toString().startsWith('temp_') ? ' <span class="text-xs text-gray-400">(臨時)</span>' : ''}</p>
                        </div>
                    </div>
                `;
                }).join('') + `
                    <!-- 新增寵物卡片 -->
                    <div id="add-pet-card" class="p-3 border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center gap-2 cursor-pointer hover:border-[#181111] hover:bg-gray-50 transition-colors">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span class="text-gray-500 font-medium">新增寵物</span>
                    </div>
                `;

                // 綁定寵物卡片點擊事件
                document.querySelectorAll('.pet-selection-card').forEach(card => {
                    card.addEventListener('click', function() {
                        // 移除其他卡片的選中樣式
                        document.querySelectorAll('.pet-selection-card').forEach(c => {
                            c.classList.remove('selected', 'border-[#181111]', 'bg-gray-50');
                            c.classList.add('border-gray-200');
                        });
                        // 新增選中樣式
                        this.classList.add('selected', 'border-[#181111]', 'bg-gray-50');
                        this.classList.remove('border-gray-200');
                        
                        // 儲存選擇的寵物ID（可能是數字ID或臨時ID字串）
                        const petId = this.dataset.petId;
                        if (petId.startsWith('temp_')) {
                            bookingData.petId = petId;
                        } else {
                            bookingData.petId = parseInt(petId);
                            bookingData.tempPetId = null; // 清除臨時寵物ID
                        }
                        
                        // 啟用下一步按鈕
                        const nextBtn = document.getElementById('continue-to-confirmation-btn');
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        // 隱藏新增寵物表單
                        const formContainer = document.getElementById('add-pet-form-container');
                        if (formContainer) {
                            formContainer.classList.add('hidden');
                        }
                    });
                });

                // 綁定照片選擇按鈕（先定義變數，以便在後續使用）
                const selectPhotoBtn = document.getElementById('select-pet-photo-btn');
                const photoInput = document.getElementById('new-pet-photo-input');
                const photoPreview = document.getElementById('new-pet-photo-preview');

                // 綁定「+」卡片點擊事件
                const addPetCard = document.getElementById('add-pet-card');
                if (addPetCard) {
                    addPetCard.addEventListener('click', function() {
                        const formContainer = document.getElementById('add-pet-form-container');
                        if (formContainer) {
                            formContainer.classList.remove('hidden');
                            // 重置表單和預覽圖片
                            document.getElementById('add-pet-form').reset();
                            if (photoInput) {
                                photoInput.value = '';
                            }
                            if (photoPreview) {
                                photoPreview.src = 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center';
                            }
                        }
                    });
                }
                
                if (selectPhotoBtn && photoInput) {
                    selectPhotoBtn.addEventListener('click', function() {
                        photoInput.click();
                    });
                }
                
                // 綁定照片選擇事件
                if (photoInput && photoPreview) {
                    photoInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            // 驗證文件類型
                            if (!file.type.startsWith('image/')) {
                                alert('請選擇圖片檔案');
                                return;
                            }
                            
                            // 驗證文件大小（限制為5MB）
                            if (file.size > 5 * 1024 * 1024) {
                                alert('圖片檔案大小不能超過5MB');
                                return;
                            }
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                photoPreview.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }

                // 綁定關閉表單按鈕
                const closeFormBtn = document.getElementById('close-add-pet-form');
                const cancelBtn = document.getElementById('cancel-add-pet');
                [closeFormBtn, cancelBtn].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function() {
                            const formContainer = document.getElementById('add-pet-form-container');
                            if (formContainer) {
                                formContainer.classList.add('hidden');
                                document.getElementById('add-pet-form').reset();
                                // 重置預覽圖片
                                if (photoPreview) {
                                    photoPreview.src = 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center';
                                }
                            }
                        });
                    }
                });

                // 綁定新增寵物表單提交事件
                const addPetForm = document.getElementById('add-pet-form');
                if (addPetForm) {
                    // 移除舊的事件監聽器
                    const newForm = addPetForm.cloneNode(true);
                    addPetForm.replaceWith(newForm);
                    
                    newForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // 獲取表單資料
                        const photoPreviewEl = document.getElementById('new-pet-photo-preview');
                        const photoUrl = photoPreviewEl ? photoPreviewEl.src : 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center';
                        
                        const petData = {
                            name: document.getElementById('new-pet-name').value.trim(),
                            breed: document.getElementById('new-pet-breed').value.trim(),
                            age: parseInt(document.getElementById('new-pet-age').value) || null,
                            gender: document.getElementById('new-pet-gender').value || null,
                            photoUrl: photoUrl
                        };
                        
                        // 驗證必填欄位
                        if (!petData.name || !petData.breed) {
                            alert('請填寫寵物名稱和品種');
                            return;
                        }
                        
                        // 詢問是否要保存到檔案
                        const saveToFile = confirm('是否要將此寵物加入到檔案中？\n\n點擊「確定」：保存到檔案\n點擊「取消」：僅本次訂單使用');
                        
                        let newPetId;
                        
                        if (saveToFile) {
                            // 保存到檔案
                            const newPet = {
                                id: Date.now(),
                                ...petData,
                                weight: null,
                                isNeutered: null,
                                personalityTags: [],
                                vaccines: [],
                                allergies: '',
                                medications: '',
                                specialNeeds: ''
                            };
                            window.mockPets.push(newPet);
                            newPetId = newPet.id;
                            alert('寵物已成功加入到檔案中！');
                        } else {
                            // 僅本次訂單使用（臨時寵物）
                            newPetId = 'temp_' + Date.now();
                            bookingData.tempPet = {
                                id: newPetId,
                                ...petData
                            };
                        }
                        
                        // 選擇新寵物
                        bookingData.petId = newPetId;
                        
                        // 重新渲染寵物列表
                        renderPetSelectionList();
                        
                        // 自動選中新添加的寵物並啟用下一步按鈕
                        setTimeout(() => {
                            const petCard = document.querySelector(`[data-pet-id="${newPetId}"]`);
                            if (petCard) {
                                // 觸發點擊事件以選中寵物
                                petCard.click();
                            } else {
                                // 如果找不到卡片，直接啟用按鈕
                                const nextBtn = document.getElementById('continue-to-confirmation-btn');
                                if (nextBtn) {
                                    nextBtn.disabled = false;
                                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                }
                            }
                        }, 100);
                        
                        // 隱藏表單並重置
                        const formContainer = document.getElementById('add-pet-form-container');
                        if (formContainer) {
                            formContainer.classList.add('hidden');
                            // 重置表單和文件輸入
                            document.getElementById('add-pet-form').reset();
                            if (photoInput) {
                                photoInput.value = '';
                            }
                            if (photoPreview) {
                                photoPreview.src = 'https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center';
                            }
                        }
                    });
                }

                // 移除舊的事件監聽器並重新綁定 "下一步：確認訂單" 按鈕的點擊事件
                const continueBtn = document.getElementById('continue-to-confirmation-btn');
                if (continueBtn) {
                    const newContinueBtn = continueBtn.cloneNode(true);
                    continueBtn.replaceWith(newContinueBtn);
                    newContinueBtn.addEventListener('click', function() {
                         if (bookingData.petId) {
                            document.getElementById('step-pet-selection').style.display = 'none';
                            document.getElementById('step-4-order-confirmation').style.display = 'block';
                            
                            // 更新步驟指示器到步驟5
                            updateStepIndicator(5);
                            
                            updateOrderConfirmation(); // 更新最終確認頁的資訊
                         }
                    });
                    
                    // 如果已經選擇了寵物，啟用按鈕
                    if (bookingData.petId) {
                        newContinueBtn.disabled = false;
                        newContinueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }

                // 移除舊的事件監聽器並重新綁定返回按鈕
                const backBtn = document.getElementById('back-to-time-selection-from-pet');
                if (backBtn) {
                    const newBackBtn = backBtn.cloneNode(true);
                    backBtn.replaceWith(newBackBtn);
                    newBackBtn.addEventListener('click', function() {
                        document.getElementById('step-pet-selection').style.display = 'none';
                        document.getElementById('step-3-time-selection').style.display = 'block';
                        
                        // 重新檢查並顯示價格明細和繼續按鈕（如果需要）
                        checkCanContinueBooking();
                        
                        // 更新步驟指示器回到步驟3
                        updateStepIndicator(3);
                    });
                }
            }
            // == END: 新增 renderPetSelectionList 函式 ==
            
            // 檢查當前步驟是否可以繼續（輕量級檢查）
            function checkCurrentStepCanContinue() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateCurrentStep();
                
                // 顯示錯誤訊息
                showBookingErrors(errors);
                
                // 更新價格透明度
                updatePriceTransparency();
                
                // 檢查是否可以繼續
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                } else {
                    continueSection.classList.add('hidden');
                }
            }



            // 渲染房型與服務列表
            function renderRoomServiceList() {
                const container = document.getElementById('room-service-list');
                if (!container) return;

                // 整理房型和對應的服務（移除對 mockPackages 的依賴）
                const roomTypeMap = new Map();
                
                mockRoomTypes.forEach(room => {
                    if (room.status === 'active') {
                        roomTypeMap.set(room.id, {
                            name: room.name,
                            description: room.description || '',
                            serviceType: room.serviceType,
                            basePrice: room.serviceType === 'overnight' ? room.basePrice : null,
                            hourlyRate: room.serviceType === 'daycare' ? room.hourlyRate : null,
                            minHours: room.serviceType === 'daycare' ? room.minHours : null
                        });
                    }
                });

                let html = '';
                roomTypeMap.forEach((roomData, roomId) => {
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                            <p class="text-sm text-gray-500 mb-3">${roomData.description}</p>
                            <div class="space-y-2">
                    `;
                    
                    // 根據房型的服務類型顯示對應的服務選項
                    if (roomData.serviceType === 'overnight') {
                        const price = roomData.basePrice || 0;
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="overnight" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3 text-sm">🏠</span>
                                        <div>
                                            <span class="font-medium text-[#181111]">寄宿過夜</span>
                                            <p class="text-xs text-gray-500">適合出差旅行</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm price-display">NT$ ${price.toLocaleString()}起</span>
                                        <p class="text-xs text-gray-500">每晚</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    } else if (roomData.serviceType === 'daycare') {
                        const hourlyRate = roomData.hourlyRate || 0;
                        const minHours = roomData.minHours || 4;
                        const minPrice = hourlyRate * minHours;
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="daycare" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3 text-sm">⏰</span>
                                        <div>
                                            <span class="font-medium text-[#181111]">日間安親</span>
                                            <p class="text-xs text-gray-500">專業照護陪伴</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm">NT$ ${minPrice.toLocaleString()}起</span>
                                        <p class="text-xs text-gray-500">/${minHours}hr</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // 綁定點擊事件
                document.querySelectorAll('.service-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 移除其他按鈕的選中狀態
                        document.querySelectorAll('.service-option-btn').forEach(b => {
                            b.classList.remove('selected');
                            b.style.borderColor = '#e5e7eb';
                            b.style.backgroundColor = '';
                        });
                        
                        // 選中當前按鈕
                        this.classList.add('selected');
                        this.style.borderColor = '#181111';
                        this.style.backgroundColor = '#f9fafb';
                        
                        const serviceType = this.dataset.serviceType;
                        const roomId = parseInt(this.dataset.roomId);
                        
                        // 設定預訂資料，使用詳情頁已選擇的日期
                        bookingData.serviceType = serviceType;
                        bookingData.preferredRoomId = roomId;
                        bookingData.dates.checkin = selectedCheckinDate.toISOString().split('T')[0];
                        bookingData.dates.checkout = selectedCheckoutDate.toISOString().split('T')[0];
                        
                        // 直接跳到房型選擇步驟，跳過日期選擇
                        bookingStep = 3;
                        
                        // 更新價格預覽
                        updateDetailPricePreview();
                        
                        // 顯示繼續預訂按鈕
                        showContinueBookingButton();
                    });
                });
            }

            // 地圖相關功能
            let hotelMap = null;
            const hotelLocation = {
                lat: 25.0330,  // 台北市信義區座標
                lng: 121.5654,
                address: "台北市信義區信義路五段7號",
                name: "快樂爪子旅館"
            };

            // 初始化旅館地圖
            function initHotelMap() {
                // 如果Leaflet還沒載入，稍後再試
                if (typeof L === 'undefined') {
                    setTimeout(initHotelMap, 500);
                    return;
                }

                const mapContainer = document.getElementById('hotel-map');
                if (!mapContainer) return;

                try {
                    // 清除載入提示
                    mapContainer.innerHTML = '';

                    // 初始化地圖
                    hotelMap = L.map('hotel-map').setView([hotelLocation.lat, hotelLocation.lng], 16);

                    // 添加地圖圖層 (使用 OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(hotelMap);

                    // 創建自定義圖標
                    const hotelIcon = L.divIcon({
                        html: `
                            <div style="
                                width: 40px; 
                                height: 40px; 
                                background-color: #181111; 
                                border: 3px solid white; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            ">🏠</div>
                        `,
                        className: 'custom-hotel-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });

                    // 添加旅館標記
                    const marker = L.marker([hotelLocation.lat, hotelLocation.lng], { 
                        icon: hotelIcon 
                    }).addTo(hotelMap);

                    // 點擊標記顯示彈出視窗
                    marker.bindPopup(`
                        <div style="padding: 8px; font-family: 'Plus Jakarta Sans', sans-serif; max-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: #181111; font-weight: bold;">${hotelLocation.name}</h3>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${hotelLocation.address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}" 
                               target="_blank" 
                               style="color: #1a73e8; text-decoration: none; font-size: 14px;">
                                📍 開始導航
                            </a>
                        </div>
                    `);

                    // 禁用地圖的一些控制項以符合手機版面
                    hotelMap.scrollWheelZoom.disable();
                    hotelMap.doubleClickZoom.disable();
                    hotelMap.dragging.disable();

                    // 添加地圖點擊事件來啟用交互
                    const hintElement = document.getElementById('map-interaction-hint');
                    if (hintElement) {
                        hintElement.classList.remove('hidden');
                        
                        hotelMap.on('click', function() {
                            hotelMap.dragging.enable();
                            hotelMap.scrollWheelZoom.enable();
                            hotelMap.doubleClickZoom.enable();
                            hintElement.classList.add('hidden');
                        });
                    }

                } catch (error) {
                    console.error('地圖初始化失敗:', error);
                    mapContainer.innerHTML = `
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <span class="text-sm">地圖載入失敗，請稍後再試</span>
                        </div>
                    `;
                }
            }

            // 地圖相關事件監聽器
            function attachMapListeners() {
                // 導航按鈕點擊事件
                document.getElementById('open-map-btn')?.addEventListener('click', function() {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        // 手機端嘗試開啟原生地圖應用
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`;
                        const appleMapsUrl = `http://maps.apple.com/?daddr=${hotelLocation.lat},${hotelLocation.lng}`;
                        
                        // iOS 設備優先使用 Apple Maps
                        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                            window.open(appleMapsUrl, '_system');
                        } else {
                            window.open(googleMapsUrl, '_system');
                        }
                    } else {
                        // 桌面端開啟 Google Maps 網頁版
                        window.open(`https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`, '_blank');
                    }
                });
            }

            function renderUserCenterPage() {
                const container = pages.account;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-center">
                        <h2 class="text-[#181111] text-base font-bold">帳戶</h2>
                    </div>
                </div>

                <div class="px-4 py-3 bg-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="https://images.unsplash.com/photo-1548142813-c348350df52b?q=80&w=200" class="w-12 h-12 rounded-full object-cover" alt="avatar">
                            <div>
                                <p class="font-bold text-[#181111]">James</p>
                                <p class="text-xs text-[#886364]">台北市, 台灣</p>
                            </div>
                        </div>
                        <button id="account-edit-icon" class="p-2 text-[#181111]" aria-label="edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="currentColor"><path d="M227.31,73.37,182.63,28.69a16,16,0,0,0-22.63,0L41.37,147.31A15.86,15.86,0,0,0,36.69,158L24.29,207.14a8,8,0,0,0,9.85,9.85l49.1-12.4a15.86,15.86,0,0,0,10.68-4.68L227.31,96A16,16,0,0,0,227.31,73.37ZM78.4,192.62l-28.2,7.12,7.12-28.2L152,76.86l21.09,21.09ZM197.66,73.37,184,87l-21.09-21.1,13.66-13.66a0,0,0,0,1,0,0L197.66,59.71A0,0,0,0,1,197.66,73.37Z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                ${!isUserMerchant ? `
                <div id="become-merchant-card" class="px-4 py-3 cursor-pointer">
                    <div class="bg-white border border-gray-100 rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-amber-100 flex items_center justify-center">🏪</div>
                        <div class="flex-1">
                            <p class="font-bold text-[#181111]">成為商家</p>
                            <p class="text-xs text-[#886364]">馬上申請成為 Paw Pad 的合作夥伴！</p>
                        </div>
                        <div class="text-[#886364]">›</div>
                    </div>
                </div>
                <div class="px-4 py-2">
                    <button id="quick-merchant-backend-btn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-xl font-medium hover:from-blue-600 hover:to-purple-700 transition-all duration-200 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                            <path d="M208,80H48A16,16,0,0,0,32,96V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V96A16,16,0,0,0,208,80ZM48,96H208V112H48Zm0,32H208v80H48Zm32,48a8,8,0,0,1,8-8h32a8,8,0,0,1,0,16H88A8,8,0,0,1,80,176Zm80-8a8,8,0,0,1,0,16H136a8,8,0,0,1,0-16Z"></path>
                        </svg>
                        直接進入商家後台
                    </button>
                </div>` : `
                <div class="px-4 py-3">
                    <div id="merchant-entry" class="bg-white border border-gray-100 rounded-xl p-4 flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">📊</div><div><p class="font-bold text-[#181111]">商家專區</p><p class="text-xs text-[#886364]">管理訂單、行事曆與方案</p></div></div>
                        <div class="text-[#886364]">›</div>
                    </div>
                    <div class="mt-3">
                        <button id="merchant-backend-btn" class="btn-main h-11">進入商家後台</button>
                    </div>
                </div>`}

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2 space-y-2">
                    <div id="account-profile" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>個人資料</span><span class="text-[#886364]">›</span></div>
                    <!-- == START: 新增我的寵物入口 == -->
                    <div id="my-pets-link" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer">
                        <span>🐾 我的寵物</span>
                        <span class="text-[#886364]">›</span>
                    </div>
                    <!-- == END: 新增我的寵物入口 == -->
                    <div id="account-support" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>聯繫客服</span><span class="text-[#886364]">›</span></div>
                    <div id="account-privacy" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>隱私</span><span class="text-[#886364]">›</span></div>
                    <div id="account-referral" class="bg-white p-4 rounded-xl border border-gray-100 flex justify_between items-center cursor-pointer"><span>我的推薦代碼</span><span class="text-[#886364]">›</span></div>
                    <div id="account-coupons" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>優惠券列表</span><span class="text-[#886364]">›</span></div>
                    <div id="account-settings" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer">
                        <span>設定</span>
                        <span class="text-[#886364]">›</span>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2">
                    <div id="account-logout" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>登出</span><span class="text-[#886364]">›</span></div>
                </div>
                `;

                attachAccountListeners();
            }

            function updateUserCenterOptions() {
                const container = document.getElementById('user-options-list');
                if (!container) return;
                let optionsHTML = `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>我的資料</span><span class="text-[#886364]">></span></div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>設定</span><span class="text-[#886364]">></span></div>`;
                
                if (isUserMerchant) {
                    optionsHTML += `<div id="merchant-entry" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>商家專區</span><span class="text-[#886364]">></span></div>`;
                } else {
                    optionsHTML += `<div id="become-merchant" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>成為商家</span><span class="text-blue-600 font-bold">立即申請</span></div>`;
                }
                container.innerHTML = optionsHTML + `<div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer text-red-600"><span>登出</span></div>`;
            }

            // 帳戶頁：事件與模態
            function attachAccountListeners() {
                document.getElementById('account-edit-icon')?.addEventListener('click', openProfileEditModal);
                document.getElementById('account-profile')?.addEventListener('click', openProfileEditModal);
                
                // == START: 新增我的寵物點擊事件 ==
                document.getElementById('my-pets-link')?.addEventListener('click', () => showPage('myPets', { fromPage: 'account' }));
                // == END: 新增我的寵物點擊事件 ==
                
                document.getElementById('become-merchant-card')?.addEventListener('click', () => { renderMerchantApplicationFlow(); });
                document.getElementById('merchant-entry')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('merchant-backend-btn')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('quick-merchant-backend-btn')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('account-support')?.addEventListener('click', () => showPage('chat'));
                document.getElementById('account-privacy')?.addEventListener('click', openPrivacyModal);
                document.getElementById('account-referral')?.addEventListener('click', openReferralModal);
                document.getElementById('account-coupons')?.addEventListener('click', openCouponsModal);
                document.getElementById('account-settings')?.addEventListener('click', () => showPage('settings'));
                document.getElementById('account-logout')?.addEventListener('click', () => { alert('已登出 (模擬)'); showPage('home'); });
            }

            function openOverlayWithContent(innerHtml) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${innerHtml}</div>`;
                document.body.appendChild(modal);
                modal.addEventListener('click', function(e){ if (e.target === modal || e.target.id === 'modal-close-btn') document.body.removeChild(modal); });
                return modal;
            }

            function openReferralModal() {
                const code = 'PP-JAMES-1234';
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">我的推薦代碼</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <p class="text-sm text-[#886364] mb-3">分享給朋友，雙方皆可獲得優惠。</p>
                    <div class="bg-gray-50 border rounded-xl p-4 text-center mb-3">
                        <p class="text-2xl font-black tracking-widest text-[#181111]">${code}</p>
                    </div>
                    <button id="copy-referral" class="btn-main h-11">複製代碼</button>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#copy-referral')?.addEventListener('click', async () => {
                    try { await navigator.clipboard.writeText(code); alert('已複製'); } catch(_) { alert('複製失敗'); }
                });
            }

            function openCouponsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">優惠券列表</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-2">
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">新用戶 85 折</p><p class="text-xs text-[#886364]">到期日：2025/12/31</p></div>
                            <span class="text-emerald-600 font-bold">可用</span>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">滿 2000 折 200</p><p class="text-xs text-[#886364]">到期日：2025/09/30</p></div>
                            <span class="text-emerald-600 font-bold">可用</span>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：目前房況（圖表示意）
            function openOccupancyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">目前房況</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <p class="mb-2 text-[#886364]">今日整體入住率</p>
                            <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                <div class="bg-emerald-500 h-3" style="width: 68%"></div>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">68%</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            ${mockRoomTypes.filter(r=>r.status==='active').map(r=>`
                                <div class="bg-white border rounded-xl p-3">
                                    <p class="font-medium text-[#181111] mb-1">${r.name}</p>
                                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                        <div class="bg-blue-500 h-2" style="width: ${Math.min(100, Math.round((r.stock-1)/r.stock*100))}%"></div>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-600">可用 ${Math.max(0, r.stock-1)} / ${r.stock}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：金流（請款 / 退款申請審核）
            function openFinanceModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">金流</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="flex gap-2 mb-3 text-sm">
                        <button data-fin-tab="payouts" class="px-3 py-1 rounded-full bg-[#181111] text-white">請款</button>
                        <button data-fin-tab="refunds" class="px-3 py-1 rounded-full bg-gray-100">退款申請審核</button>
                    </div>
                    <div id="finance-content" class="space-y-2 text-sm"></div>
                `;
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#finance-content');
                function render(tab){
                    modal.querySelectorAll('[data-fin-tab]')?.forEach(b=>{
                        const active = b.dataset.finTab===tab;
                        b.classList.toggle('bg-[#181111]', active);
                        b.classList.toggle('text-white', active);
                        b.classList.toggle('bg-gray-100', !active);
                    });
                    if(tab==='refunds'){
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">訂單 #A1029</p>
                                    <p class="text-xs text-[#886364]">原因：臨時取消</p>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <button class="px-3 py-1 bg-gray-200 rounded-full">駁回</button>
                                    <button class="px-3 py-1 bg-emerald-600 text-white rounded-full">同意退款</button>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">可請款金額</p>
                                    <p class="text-xs text-[#886364]">本期：NT$ 42,000</p>
                                </div>
                                <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">申請請款</button>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="font-medium text-[#181111] mb-1">歷史請款紀錄</p>
                                <p class="text-xs text-[#886364]">2025/06/01 NT$ 30,000 - 已匯款</p>
                            </div>
                        `;
                    }
                }
                modal.querySelectorAll('[data-fin-tab]')?.forEach(btn=>btn.addEventListener('click',()=>render(btn.dataset.finTab)));
                render('payouts');
            }

            // 商家中心：報表（下載）
            function openReportsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">報表</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">範圍</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" class="form-input-styled">
                                <input type="date" class="form-input-styled">
                            </div>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>每日收入報表 (CSV)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">下載</button>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>月收入與預約統計 (PDF)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">下載</button>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：優惠券發送與管理
            function openCouponManageModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">優惠券管理</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">新增優惠券</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="new-coupon-name" class="form-input-styled" placeholder="名稱，例如 首購85折">
                                <input id="new-coupon-exp" type="date" class="form-input-styled">
                            </div>
                            <div class="mt-2 flex gap-2">
                                <input id="new-coupon-scope" class="form-input-styled flex-1" placeholder="可用範圍，例如 全館 / 指定房型">
                                <button id="add-coupon-btn" class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">新增</button>
                            </div>
                        </div>
                        <div id="coupon-list" class="space-y-2">
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">新用戶 85 折</p>
                                    <p class="text-xs text-[#886364]">到期：2025/12/31 • 範圍：全館</p>
                                </div>
                                <button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">停用</button>
                            </div>
                        </div>
                    </div>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#add-coupon-btn')?.addEventListener('click', ()=>{
                    const name = modal.querySelector('#new-coupon-name')?.value || '未命名優惠券';
                    const exp = modal.querySelector('#new-coupon-exp')?.value || '—';
                    const scope = modal.querySelector('#new-coupon-scope')?.value || '—';
                    const list = modal.querySelector('#coupon-list');
                    const node = document.createElement('div');
                    node.className = 'bg-white border rounded-xl p-3 flex items-center justify-between';
                    node.innerHTML = `<div><p class="font-medium text-[#181111]">${name}</p><p class="text-xs text-[#886364]">到期：${exp} • 範圍：${scope}</p></div><button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">停用</button>`;
                    list?.prepend(node);
                });
            }

            function openSettingsModal(activeTab = 'general') {
                const html = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#181111]">設定</h2>
                        <button id="modal-close-btn" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    
                    <!-- 設定分類標籤 -->
                    <div class="flex gap-2 mb-6 text-sm overflow-x-auto pb-2">
                        <button data-tab="general" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='general'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">一般設定</button>
                        <button data-tab="notifications" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='notifications'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">通知設定</button>
                        <button data-tab="account" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='account'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">帳號設定</button>
                        <button data-tab="app" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='app'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">應用程式</button>
                        <button data-tab="payment" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='payment'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">付款設定</button>
                        <button data-tab="pets" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='pets'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">寵物設定</button>
                        ${isUserMerchant ? `<button data-tab="merchant" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='merchant'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">商家設定</button>` : ''}
                    </div>
                    
                    <!-- 設定內容區域 -->
                    <div id="settings-content" class="space-y-4 max-h-96 overflow-y-auto"></div>
                `;
                
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#settings-content');

                function renderTab(tab){
                    // 更新標籤狀態
                    modal.querySelectorAll('[data-tab]')?.forEach(btn=>{
                        btn.classList.toggle('bg-[#181111]', btn.dataset.tab===tab);
                        btn.classList.toggle('text-white', btn.dataset.tab===tab);
                        btn.classList.toggle('bg-gray-100', btn.dataset.tab!==tab);
                        btn.classList.toggle('text-gray-600', btn.dataset.tab!==tab);
                        btn.classList.toggle('hover:bg-gray-200', btn.dataset.tab!==tab);
                    });
                    
                    // 渲染對應內容
                    if(tab==='notifications'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">通知偏好設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">推播通知</span>
                                            <p class="text-xs text-gray-500">接收應用程式推播通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">訂單更新</span>
                                            <p class="text-xs text-gray-500">訂單狀態變更通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">優惠活動</span>
                                            <p class="text-xs text-gray-500">限時優惠與活動通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">系統公告</span>
                                            <p class="text-xs text-gray-500">重要系統更新通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">通知時間設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">安靜時間</label>
                                        <div class="flex gap-2 mt-2">
                                            <select class="form-input-styled text-sm">
                                                <option>22:00</option><option>23:00</option><option>00:00</option>
                                            </select>
                                            <span class="text-sm text-gray-500 self-center">至</span>
                                            <select class="form-input-styled text-sm">
                                                <option>07:00</option><option>08:00</option><option>09:00</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='account'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">帳號管理</h3>
                                <div class="space-y-3">
                                    <button id="settings-change-password" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">變更密碼</span>
                                                <p class="text-xs text-gray-500">更新您的登入密碼</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button id="settings-referral-btn" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">查看推薦碼</span>
                                                <p class="text-xs text-gray-500">分享給朋友獲得優惠</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">資料下載</span>
                                                <p class="text-xs text-gray-500">下載您的個人資料</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-red-600">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">刪除帳號</span>
                                                <p class="text-xs text-gray-500">永久刪除您的帳號</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                        content.querySelector('#settings-referral-btn')?.addEventListener('click', () => openReferralModal());
                    } else if(tab==='app'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">應用程式設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動登入</span>
                                            <p class="text-xs text-gray-500">保持登入狀態</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">生物辨識登入</span>
                                            <p class="text-xs text-gray-500">使用指紋或臉部辨識</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">資料同步</span>
                                            <p class="text-xs text-gray-500">跨裝置同步資料</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">快取管理</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">清除快取</span>
                                                <p class="text-xs text-gray-500">釋放儲存空間</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='payment'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">付款設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">預設付款方式</label>
                                        <select class="form-input-styled mt-2">
                                            <option>信用卡 (****1234)</option>
                                            <option>Apple Pay</option>
                                            <option>Google Pay</option>
                                        </select>
                                    </div>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動儲存付款方式</span>
                                            <p class="text-xs text-gray-500">方便下次使用</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">發票設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">發票類型</label>
                                        <select class="form-input-styled mt-2">
                                            <option>電子發票</option>
                                            <option>紙本發票</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">統一編號</label>
                                        <input type="text" class="form-input-styled mt-2" placeholder="選填">
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='pets'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">寵物設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">預設寵物資訊</span>
                                            <p class="text-xs text-gray-500">自動填入寵物資料</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">特殊需求記錄</span>
                                            <p class="text-xs text-gray-500">記住寵物特殊需求</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">過敏資訊提醒</span>
                                            <p class="text-xs text-gray-500">提醒商家注意過敏</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">寵物檔案</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">管理寵物檔案</span>
                                                <p class="text-xs text-gray-500">編輯寵物詳細資訊</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='merchant' && isUserMerchant){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">商家設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動回覆</span>
                                            <p class="text-xs text-gray-500">啟用自動回覆功能</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">營業時間提醒</span>
                                            <p class="text-xs text-gray-500">營業時間變更通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">商家管理</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">營業時間設定</span>
                                                <p class="text-xs text-gray-500">設定每週營業時間</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">價格設定</span>
                                                <p class="text-xs text-gray-500">管理服務價格</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // 一般設定
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">基本設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">語言</label>
                                        <select class="form-input-styled mt-2">
                                            <option>繁體中文</option>
                                            <option>English</option>
                                            <option>日本語</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">地區</label>
                                        <select class="form-input-styled mt-2">
                                            <option>台灣</option>
                                            <option>香港</option>
                                            <option>澳門</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">貨幣</label>
                                        <select class="form-input-styled mt-2">
                                            <option>新台幣 (NT$)</option>
                                            <option>港幣 (HK$)</option>
                                            <option>人民幣 (¥)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">外觀設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">主題</label>
                                        <div class="flex gap-2 mt-2">
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white text-gray-700">淺色</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-800 text-white">深色</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-100 text-gray-700">自動</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">字體大小</label>
                                        <select class="form-input-styled mt-2">
                                            <option>小</option>
                                            <option selected>中</option>
                                            <option>大</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // 綁定標籤點擊事件
                modal.querySelectorAll('[data-tab]')?.forEach(btn=>btn.addEventListener('click', ()=>renderTab(btn.dataset.tab)));
                
                // 初始渲染
                renderTab(activeTab);
            }

            function openPrivacyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">隱私</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="text-sm text-[#886364] space-y-2">
                        <p>我們重視您的隱私，僅於提供服務所需範圍內使用資料。</p>
                        <p>可於「設定 > 帳號」申請資料下載或刪除。</p>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function openProfileEditModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">編輯個人資料</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600">名稱</label>
                            <input class="form-input-styled mt-1" value="James">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">城市</label>
                            <input class="form-input-styled mt-1" value="台北市">
                        </div>
                        <button class="btn-main h-11">儲存</button>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function renderMerchantApplicationFlow() {
                let step = 1;
                const appState = {
                    codeSent: false,
                    smsVerified: false,
                    outcome: 'pending'
                };
                if (!window.merchantApplicationStatus) window.merchantApplicationStatus = 'not_applied';
                if (!window.merchantLastRejectReason) window.merchantLastRejectReason = '';

                function render() {
                    formModal.innerHTML = `
                        <div class="p-4 overflow-y-auto max-h-full">
                            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                                <button id="merchant-back-btn" class="text-lg font-bold p-2">${step===1?'&lt; 返回':'&lt; 上一步'}</button>
                                <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">成為商家</h1>
                                <div class="w-28 text-right text-xs text-[#886364]">${
                                    window.merchantApplicationStatus==='under_review' ? '狀態：審核中' :
                                    window.merchantApplicationStatus==='rejected' ? '狀態：不通過' :
                                    window.merchantApplicationStatus==='re_review' ? '狀態：再次審核中' :
                                    window.merchantApplicationStatus==='approved' ? '狀態：已通過' : ' '}
                                </div>
                            </div>
                            ${step===1 ? renderStep1Info() : ''}
                            ${step===2 ? renderStep2SMS() : ''}
                            ${step===3 ? renderStep3SubmitAndReview() : ''}
                            ${step===4 ? renderStep4Outcome() : ''}
                        </div>
                    `;
                    formModal.classList.remove('hidden');

                    document.getElementById('merchant-back-btn')?.addEventListener('click', () => {
                        if (step === 1) { formModal.classList.add('hidden'); return; }
                        step = Math.max(1, step - 1); render();
                    });

                    document.getElementById('merchant-next-btn')?.addEventListener('click', () => { step = Math.min(4, step + 1); render(); });
                    document.getElementById('merchant-send-code-btn')?.addEventListener('click', () => {
                        appState.codeSent = true; render();
                    });
                    document.getElementById('merchant-verify-code-btn')?.addEventListener('click', () => {
                        appState.smsVerified = true; render();
                    });
                    document.getElementById('merchant-submit-review-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 'under_review';
                        step = 3; render();
                    });
                    document.getElementById('simulate-approve-btn')?.addEventListener('click', () => {
                        appState.outcome = 'approved';
                        window.merchantApplicationStatus = 'approved';
                        step = 4; render();
                    });
                    document.getElementById('simulate-reject-btn')?.addEventListener('click', () => {
                        appState.outcome = 'rejected';
                        window.merchantApplicationStatus = 'rejected';
                        step = 4; render();
                    });
                    document.getElementById('resubmit-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 're_review';
                        step = 1; render();
                    });
                    document.getElementById('go-dashboard-btn')?.addEventListener('click', () => {
                        isUserMerchant = true;
                        formModal.classList.add('hidden');
                        renderUserCenterPage();
                        showPage('merchantDashboard');
                    });
                    document.getElementById('reject-reason-input')?.addEventListener('input', (e) => {
                        window.merchantLastRejectReason = e.target.value || '';
                    });
                }

                function renderStep1Info() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">商家填寫資料（名稱、國家、地區、地址、證件…）</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">店家名稱</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="例如：快樂爪子旅館">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">國家</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="台灣">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">地區</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="台北市/信義區">
                                </div>
                            </div>
                                                        <div>
                                <label class="text-sm font-medium text-[#886364]">地址</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="城市、街道、門牌">
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">身分文件（示意）</p>
                                <div class="grid gap-2 text-sm">
                                    <label class="flex items-center justify-between">身分證<input type="file" class="text-sm"></label>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">選填資料</p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-[#886364]">營業登記證</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-[#886364]">銀行帳戶</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6"><button id="merchant-next-btn" class="btn-main">下一步：簡訊驗證</button></div>
                        </div>`;
                }

                function renderStep2SMS() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">簡訊驗證手機</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">手機號碼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="tel" class="form-input-styled flex-1" placeholder="09xx-xxx-xxx">
                                    <button id="merchant-send-code-btn" class="px-3 h-11 rounded-full bg-gray-100 text-sm">${appState.codeSent?'重新發送':'發送驗證碼'}</button>
                                </div>
                            </div>
                            ${appState.codeSent ? `
                            <div>
                                <label class="text-sm font-medium text-[#886364]">輸入驗證碼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" class="form-input-styled flex-1" placeholder="6 位數碼">
                                    <button id="merchant-verify-code-btn" class="btn-main h-11 px-4">驗證</button>
                                </div>
                                ${appState.smsVerified?'<p class="text-xs text-emerald-600 mt-1">驗證成功</p>':''}
                            </div>` : ''}
                            <div class="mt-6">
                                <button id="merchant-next-btn" class="btn-main" ${appState.smsVerified?'' : 'disabled'}>下一步：送出審核</button>
                            </div>
                        </div>`;
                }

                function renderStep3SubmitAndReview() {
                    const isUnderReview = window.merchantApplicationStatus === 'under_review' || window.merchantApplicationStatus === 're_review';
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">送出審核（狀態：${isUnderReview?'審核中':'尚未送出'}）</div>
                            ${!isUnderReview ? `<button id="merchant-submit-review-btn" class="btn-main w-full">送出審核</button>` : ''}
                            ${isUnderReview ? `
                            <div class="bg-white border rounded-xl p-4 text-sm">
                                <p class="text-[#181111] font-bold mb-1">審核中</p>
                                <p class="text-[#886364]">我們會於 1-3 個工作天完成審核，並以信件通知結果。</p>
                            </div>
                            <div class="text-xs text-[#886364]">（示意）管理者操作：
                                <div class="flex gap-2 mt-2">
                                    <button id="simulate-approve-btn" class="px-3 py-2 rounded-full bg-emerald-100 text-emerald-700">模擬審核通過</button>
                                    <button id="simulate-reject-btn" class="px-3 py-2 rounded-full bg-red-100 text-red-700">模擬退審</button>
                                </div>
                            </div>` : ''}
                        </div>`;
                }

                function renderStep4Outcome() {
                    if (appState.outcome === 'approved') {
                        return `
                            <div class="space-y-4 px-2">
                                <div class="bg-white border rounded-xl p-4">
                                    <p class="text-base font-bold text-[#181111] mb-1">審核通過</p>
                                    <p class="text-sm text-[#886364]">已寄出入駐成功信件，歡迎成為合作商家！</p>
                                </div>
                                <button id="go-dashboard-btn" class="btn-main w-full">進入商家後台</button>
                            </div>`;
                    }
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-white border rounded-xl p-4">
                                <p class="text-base font-bold text-[#181111] mb-1">退審</p>
                                <p class="text-sm text-[#886364] mb-3">以下為不通過原因，請更新資料後再次送出。</p>
                                <textarea id="reject-reason-input" class="form-input-styled w-full" rows="3" placeholder="範例：資料不完整、地址無法驗證等">${window.merchantLastRejectReason}</textarea>
                            </div>
                            <div class="flex gap-2">
                                <button id="resubmit-btn" class="btn-main flex-1">更新資料並再次送出</button>
                            </div>
                        </div>`;
                }

                render();
            }

            function renderOrdersPage() {
                const container = pages.orders;
                container.innerHTML = `
                    <div class="p-4">
                        <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">我的訂單</h1>
                        <div class="flex justify-around bg-[#f4f0f0] rounded-full p-1 mb-5">
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="pending">進行中</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="completed">已完成</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="cancelled">已取消</button>
                        </div>
                        <div id="order-list" class="space-y-4">
                            <!-- 訂單卡片由JS生成 -->
                        </div>
                    </div>
                `;
                renderOrders('pending');
            }

            function renderOrders(filter) {
                const container = document.getElementById('order-list');
                const filterButtons = document.querySelectorAll('.order-filter-btn');
                
                if (!container || !filterButtons) return;

                filterButtons.forEach(btn => {
                    btn.classList.toggle('bg-[#181111]', btn.dataset.filter === filter);
                    btn.classList.toggle('text-white', btn.dataset.filter === filter);
                    btn.classList.toggle('text-[#886364]', btn.dataset.filter !== filter);
                });

                const filteredOrders = mockOrders.filter(order => order.status === filter);
                if (filteredOrders.length === 0) {
                    container.innerHTML = `<p class="text-center text-[#886364]">沒有${filter === 'pending' ? '進行中' : filter === 'completed' ? '已完成' : '已取消'}的訂單。</p>`;
                    return;
                }
                container.innerHTML = filteredOrders.map(order => {
                    let statusBadge;
                    switch(order.status) {
                        case 'pending': statusBadge = `<span class="text-xs font-bold text-white bg-amber-500 px-2 py-1 rounded-full">進行中</span>`; break;
                        case 'completed': statusBadge = `<span class="text-xs font-bold text-white bg-emerald-500 px-2 py-1 rounded-full">已完成</span>`; break;
                        case 'cancelled': statusBadge = `<span class="text-xs font-bold text-white bg-red-500 px-2 py-1 rounded-full">已取消</span>`; break;
                    }
                    return `
                        <div class="bg-white p-4 rounded-xl border border-gray-100">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-base text-[#181111]">${order.name}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-[#886364] mb-1">日期: ${order.date}</p>
                            <p class="text-sm text-[#886364] mb-3">寵物: ${order.pet}</p>
                            <div class="flex justify-between items-center mt-3 border-t pt-3">
                                <span class="text-base font-bold text-[#181111]">總計: NT$ ${order.total.toLocaleString()}</span>
                                <button class="py-2 px-4 bg-[#181111] text-white rounded-full text-sm">查看詳情</button>
                            </div>
                        </div>`;
                }).join('');
                
                // 綁定查看詳情按鈕事件
                attachOrderDetailListeners();
            }
            
            // 訂單詳情頁面
            function renderOrderDetailPage(state) {
                const container = pages.orderDetail;
                const orderId = state?.orderId;
                
                if (!orderId) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">訂單不存在</div>';
                    return;
                }
                
                const order = mockOrders.find(o => o.id === orderId);
                if (!order) {
                    container.innerHTML = '<div class="p-4 text-center text-gray-500">訂單不存在</div>';
                    return;
                }
                
                // 根據訂單狀態決定顯示內容
                let statusInfo = '';
                let actionButtons = '';
                
                switch(order.status) {
                    case 'pending':
                        statusInfo = `
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center mb-2">
                                    <div class="w-3 h-3 bg-amber-500 rounded-full mr-2 animate-pulse"></div>
                                    <span class="font-medium text-amber-800">訂單進行中</span>
                                </div>
                                <p class="text-sm text-amber-700">我們正在為您的寵物準備舒適的住宿環境，請耐心等待確認通知。</p>
                            </div>
                        `;
                        actionButtons = `
                            <div class="space-y-3">
                                <button id="contact-merchant-btn" class="btn-main w-full h-12 text-base">
                                    聯繫商家
                                </button>
                                <button id="cancel-order-btn" class="w-full h-12 border-2 border-red-300 rounded-xl text-red-600 font-medium text-base hover:bg-red-50 transition-colors">
                                    取消訂單
                                </button>
                            </div>
                        `;
                        break;
                    case 'completed':
                        statusInfo = `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center mb-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                    <span class="font-medium text-green-800">訂單已完成</span>
                                </div>
                                <p class="text-sm text-green-700">您的寵物已安全回家，感謝您選擇我們的服務！</p>
                            </div>
                        `;
                        actionButtons = `
                            <div class="space-y-3">
                                <button id="rate-service-btn" class="btn-main w-full h-12 text-base">
                                    評價服務
                                </button>
                                <button id="book-again-btn" class="w-full h-12 border-2 border-gray-300 rounded-xl text-gray-700 font-medium text-base hover:bg-gray-50 transition-colors">
                                    再次預訂
                                </button>
                            </div>
                        `;
                        break;
                    case 'cancelled':
                        statusInfo = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                <div class="flex items-center mb-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                    <span class="font-medium text-red-800">訂單已取消</span>
                                </div>
                                <p class="text-sm text-red-700">此訂單已被取消，如有疑問請聯繫客服。</p>
                            </div>
                        `;
                        actionButtons = `
                            <div class="space-y-3">
                                <button id="contact-support-btn" class="btn-main w-full h-12 text-base">
                                    聯繫客服
                                </button>
                                <button id="book-again-btn" class="w-full h-12 border-2 border-gray-300 rounded-xl text-gray-700 font-medium text-base hover:bg-gray-50 transition-colors">
                                    重新預訂
                                </button>
                            </div>
                        `;
                        break;
                }
                
                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="order-detail-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">訂單詳情</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>
                        
                        <!-- 內容區域 -->
                        <div class="p-4 pb-20">
                            <!-- 狀態資訊 -->
                            ${statusInfo}
                            
                            <!-- 訂單基本資訊 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4 mb-4">
                                <h3 class="font-bold text-[#181111] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    訂單資訊
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">訂單編號</span>
                                        <span class="font-medium text-gray-800">#${order.id.toString().padStart(6, '0')}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">旅館名稱</span>
                                        <span class="font-medium text-gray-800">${order.name}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">預訂日期</span>
                                        <span class="font-medium text-gray-800">${order.date}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">寵物資訊</span>
                                        <span class="font-medium text-gray-800">${order.pet}</span>
                                    </div>
                                    <div class="flex justify-between border-t pt-3">
                                        <span class="text-gray-600 font-medium">總金額</span>
                                        <span class="font-bold text-[#181111] text-lg">NT$ ${order.total.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 服務詳情 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4 mb-4">
                                <h3 class="font-bold text-[#181111] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                    服務詳情
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">服務類型</span>
                                        <span class="font-medium text-gray-800">寵物寄宿</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">房型</span>
                                        <span class="font-medium text-gray-800">標準房</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">特殊需求</span>
                                        <span class="font-medium text-gray-800">無</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 聯繫資訊 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4 mb-6">
                                <h3 class="font-bold text-[#181111] mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    聯繫資訊
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">旅館電話</span>
                                        <a href="tel:02-1234-5678" class="font-medium text-blue-600 hover:underline">02-1234-5678</a>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">客服信箱</span>
                                        <a href="mailto:service@pawpad.com" class="font-medium text-blue-600 hover:underline">service@pawpad.com</a>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">營業時間</span>
                                        <span class="font-medium text-gray-800">24小時</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 操作按鈕 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-4">操作選項</h3>
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
                
                // 綁定事件
                attachOrderDetailPageListeners(order);
            }
            
            // 綁定訂單詳情頁面事件
            function attachOrderDetailPageListeners(order) {
                // 返回按鈕
                document.getElementById('order-detail-back-btn')?.addEventListener('click', function() {
                    showPage('orders');
                });
                
                // 根據訂單狀態綁定不同按鈕
                switch(order.status) {
                    case 'pending':
                        document.getElementById('contact-merchant-btn')?.addEventListener('click', function() {
                            // 根據訂單名稱找到對應的商家資訊
                            const merchantName = order.name;
                            const merchant = mockHotels.find(hotel => hotel.name === merchantName);
                            
                            if (merchant) {
                                // 跳轉到聊天室並傳遞商家資訊
                                showPage('chat', { merchant: merchant, order: order });
                            } else {
                                // 如果找不到商家資訊，使用預設的聊天室
                                showPage('chat');
                            }
                        });
                        document.getElementById('cancel-order-btn')?.addEventListener('click', function() {
                            if (confirm('確定要取消這個訂單嗎？')) {
                                // 這裡可以實作取消訂單的邏輯
                                alert('訂單已取消');
                                showPage('orders');
                            }
                        });
                        break;
                    case 'completed':
                        document.getElementById('rate-service-btn')?.addEventListener('click', function() {
                            alert('評價功能開發中...');
                        });
                        document.getElementById('book-again-btn')?.addEventListener('click', function() {
                            showPage('home');
                        });
                        break;
                    case 'cancelled':
                        document.getElementById('contact-support-btn')?.addEventListener('click', function() {
                            showPage('chat');
                        });
                        document.getElementById('book-again-btn')?.addEventListener('click', function() {
                            showPage('home');
                        });
                        break;
                }
            }
            
            // 綁定訂單列表中的查看詳情按鈕
            function attachOrderDetailListeners() {
                const detailButtons = document.querySelectorAll('.bg-\\[\\#181111\\]');
                detailButtons.forEach(button => {
                    if (button.textContent.trim() === '查看詳情') {
                        button.addEventListener('click', function() {
                            // 找到對應的訂單ID
                            const orderCard = button.closest('.bg-white');
                            const orderName = orderCard.querySelector('h3').textContent;
                            const order = mockOrders.find(o => o.name === orderName);
                            
                            if (order) {
                                showPage('orderDetail', { orderId: order.id });
                            }
                        });
                    }
                });
            }
            
            function renderFavoritesPage() {
                const container = pages.favorites;
                
                if (favoriteHotels.length === 0) {
                    container.innerHTML = `
                        <div class="p-4">
                            <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">我的收藏</h1>
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">還沒有收藏任何旅館</h3>
                                <p class="text-sm text-gray-500 mb-4">開始探索並收藏您喜歡的寵物旅館吧！</p>
                                <button id="explore-hotels-btn" class="px-6 py-2 bg-[#181111] text-white rounded-xl text-sm">
                                    開始探索
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="p-4">
                            <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">我的收藏</h1>
                            <div class="space-y-4">
                                ${favoriteHotels.map(hotel => `
                                    <div class="listing-card" data-hotel-id="${hotel.id}">
                                        <div class="info-section">
                                            <div class="flex flex-col gap-1">
                                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ ${hotel.rating} • ${hotel.reviewCount} 則評價</p>
                                                <p class="text-[#181111] text-base font-bold leading-tight">${hotel.name}</p>
                                                <p class="text-[#886364] text-sm font-normal leading-normal">${hotel.location} • ${hotel.petTypes.map(type => {
                                                    const typeMap = {
                                                        'dog': '僅接受犬',
                                                        'cat': '僅接受貓',
                                                        'rabbit': '僅接受兔子',
                                                        'bird': '僅接受鳥類',
                                                        'other': '僅接受其他'
                                                    };
                                                    return typeMap[type] || type;
                                                }).join('、')}</p>
                                            </div>
                                            <button class="remove-favorite-btn text-sm text-red-600 w-fit" data-hotel-id="${hotel.id}">移除收藏</button>
                                        </div>
                                        <div class="image-section" style='background-image: url("${hotel.imageUrl}");'></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // 綁定事件
                attachFavoritesListeners();
            }
            
            // 綁定收藏頁面事件
            function attachFavoritesListeners() {
                // 開始探索按鈕
                document.getElementById('explore-hotels-btn')?.addEventListener('click', function() {
                    showPage('searchResult');
                });
                
                // 移除收藏按鈕
                document.querySelectorAll('.remove-favorite-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 防止觸發卡片點擊事件
                        const hotelId = parseInt(this.dataset.hotelId);
                        removeFromFavorites(hotelId);
                    });
                });
                
                // 旅館卡片點擊事件
                document.querySelectorAll('.listing-card[data-hotel-id]').forEach(card => {
                    card.addEventListener('click', function() {
                        const hotelId = parseInt(this.dataset.hotelId);
                        const hotel = mockHotels.find(h => h.id === hotelId);
                        if (hotel) {
                            showPage('detail', { hotel: hotel });
                        }
                    });
                });
            }
            
            // 移除收藏功能
            function removeFromFavorites(hotelId) {
                const hotelIndex = favoriteHotels.findIndex(hotel => hotel.id === hotelId);
                if (hotelIndex !== -1) {
                    const hotelName = favoriteHotels[hotelIndex].name;
                    favoriteHotels.splice(hotelIndex, 1);
                    
                    // 重新渲染收藏頁面
                    renderFavoritesPage();
                    
                    // 顯示成功提示
                    showToast(`${hotelName} 已從收藏中移除`, 'success');
                }
            }
            
            // 新增收藏功能
            function addToFavorites(hotelId) {
                const hotel = mockHotels.find(h => h.id === hotelId);
                if (hotel && !favoriteHotels.find(f => f.id === hotelId)) {
                    favoriteHotels.push({
                        id: hotel.id,
                        name: hotel.name,
                        location: hotel.location,
                        rating: hotel.rating,
                        reviewCount: hotel.reviewCount,
                        petTypes: hotel.petTypes,
                        imageUrl: hotel.imageUrl
                    });
                    
                    showToast(`${hotel.name} 已加入收藏`, 'success');
                }
            }
            
            // 顯示提示訊息
            function showToast(message, type = 'info') {
                // 建立提示元素
                const toast = document.createElement('div');
                toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    'bg-blue-500'
                }`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // 3秒後自動移除
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translate(-50%, -100%)';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }

            // 付款成功頁面
            function renderPaymentSuccessPage() {
                const container = pages.paymentSuccess;
                const orderNumber = bookingData.orderNumber || 'PAW' + Date.now();
                
                // 計算總價（基於房型價格設定）
                let amount = 0;
                if (bookingData.roomId) {
                    const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                    if (selectedRoom) {
                        if (bookingData.serviceType === 'overnight' && selectedRoom.serviceType === 'overnight') {
                            const basePrice = selectedRoom.basePrice || 0;
                            if (bookingData.stayDuration) {
                                amount = basePrice * bookingData.stayDuration;
                            }
                        } else if (bookingData.serviceType === 'daycare' && selectedRoom.serviceType === 'daycare') {
                            const hourlyRate = selectedRoom.hourlyRate || 0;
                            const duration = bookingData.duration || selectedRoom.minHours || 4;
                            amount = hourlyRate * duration;
                        }
                    }
                }
                amount *= bookingData.petCount || 1;
                
                const serviceType = bookingData.serviceType === 'overnight' ? '寄宿服務' : '安親服務';
                const checkinDate = bookingData.dates?.checkin || '';
                const checkoutDate = bookingData.dates?.checkout || '';
                
                container.innerHTML = `
                    <div class="min-h-full bg-gradient-to-b from-green-50 to-white flex flex-col">
                        <!-- 成功圖示區域 -->
                        <div class="flex-1 flex flex-col items-center justify-center px-6 py-12">
                            <!-- 成功動畫圖示 -->
                            <div class="relative mb-8">
                                <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center shadow-lg animate-pulse">
                                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <!-- 飄落的愛心動畫 -->
                                <div class="absolute -top-2 -left-2 w-4 h-4 text-pink-400 animate-bounce" style="animation-delay: 0.5s;">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                <div class="absolute -top-1 -right-3 w-3 h-3 text-yellow-400 animate-bounce" style="animation-delay: 1s;">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </div>
                                <div class="absolute -bottom-2 -left-1 w-3 h-3 text-blue-400 animate-bounce" style="animation-delay: 1.5s;">
                                    <svg fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- 成功訊息 -->
                            <div class="text-center mb-8">
                                <h1 class="text-2xl font-bold text-gray-800 mb-2">付款成功！</h1>
                                <p class="text-lg text-gray-600 mb-1">您的寵物住宿預訂已確認</p>
                                <p class="text-sm text-gray-500">我們會盡快與您聯繫確認入住細節</p>
                            </div>
                            
                            <!-- 訂單資訊卡片 -->
                            <div class="w-full max-w-sm bg-white rounded-xl shadow-lg p-6 mb-8">
                                <div class="text-center mb-4">
                                    <h3 class="font-bold text-gray-800 mb-2">訂單資訊</h3>
                                    <div class="w-12 h-0.5 bg-green-500 mx-auto"></div>
                                </div>
                                
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">訂單編號</span>
                                        <span class="font-medium text-gray-800">${orderNumber}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">服務類型</span>
                                        <span class="font-medium text-gray-800">${serviceType}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">入住日期</span>
                                        <span class="font-medium text-gray-800">${checkinDate}</span>
                                    </div>
                                    ${checkoutDate ? `
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">退房日期</span>
                                        <span class="font-medium text-gray-800">${checkoutDate}</span>
                                    </div>
                                    ` : ''}
                                    <div class="flex justify-between border-t pt-3">
                                        <span class="text-gray-600 font-medium">總金額</span>
                                        <span class="font-bold text-green-600 text-lg">NT$ ${amount.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 寵物插圖 -->
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-orange-200 to-pink-200 rounded-full flex items-center justify-center">
                                    <svg class="w-10 h-10 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                    </svg>
                                </div>
                                <p class="text-sm text-gray-500">感謝您選擇快樂爪子旅館！</p>
                            </div>
                        </div>
                        
                        <!-- 底部按鈕區域 -->
                        <div class="px-6 pb-8 pt-4 bg-white border-t border-gray-100">
                            <div class="space-y-3">
                                <button id="view-orders-btn" class="btn-main w-full h-12 text-base">
                                    查看我的訂單
                                </button>
                                <button id="back-to-home-btn" class="w-full h-12 border-2 border-gray-300 rounded-xl text-gray-700 font-medium text-base hover:bg-gray-50 transition-colors">
                                    返回首頁
                                </button>
                            </div>
                            
                            <!-- 客服資訊 -->
                            <div class="text-center mt-6">
                                <p class="text-xs text-gray-500 mb-2">如有任何問題，請聯繫客服</p>
                                <div class="flex justify-center space-x-4">
                                    <a href="tel:02-1234-5678" class="text-xs text-blue-600 hover:underline">📞 02-1234-5678</a>
                                    <a href="mailto:service@pawpad.com" class="text-xs text-blue-600 hover:underline">✉️ service@pawpad.com</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 綁定按鈕事件
                attachPaymentSuccessListeners();
            }
            
            // 綁定付款成功頁面事件
            function attachPaymentSuccessListeners() {
                // 查看訂單按鈕
                document.getElementById('view-orders-btn')?.addEventListener('click', function() {
                    showPage('orders');
                });
                
                // 返回首頁按鈕
                document.getElementById('back-to-home-btn')?.addEventListener('click', function() {
                    showPage('home');
                });
            }

            function renderSettingsPage() {
                const container = pages.settings;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-between">
                        <button id="settings-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                            </svg>
                        </button>
                        <h2 class="text-[#181111] text-base font-bold">設定</h2>
                        <div class="w-8"></div>
                    </div>
                </div>

                <div class="p-4">
                    <!-- 標籤導航 -->
                    <div class="flex gap-2 overflow-x-auto pb-2 mb-4">
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active" data-tab="general">一般設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="notifications">通知設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="profile">個人資料</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="system">系統設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="payment">付款設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="pets">寵物設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="emergency">緊急聯絡</button>

                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="support">支援</button>
                        ${isUserMerchant ? '<button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="merchant">商家設定</button>' : ''}
                    </div>

                    <!-- 設定內容區域 -->
                    <div id="settings-content" class="space-y-6">
                        <!-- 一般設定 -->
                        <div id="general-settings" class="settings-tab-content active">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">一般設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">語言</label>
                                    <select class="form-input-styled">
                                        <option value="zh-TW">繁體中文</option>
                                        <option value="en">English</option>
                                        <option value="ja">日本語</option>
                                    </select>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">主題</label>
                                    <div class="flex gap-2">
                                        <button class="px-4 py-2 rounded-lg bg-[#181111] text-white text-sm font-medium">淺色</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">深色</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">自動</button>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- 通知設定 -->
                        <div id="notifications-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">通知設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">推播通知</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">電子郵件通知</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- 個人資料 -->
                        <div id="profile-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">個人資料</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">姓名</label>
                                    <input type="text" value="James Chen" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">電子郵件</label>
                                    <input type="email" value="james@example.com" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">手機號碼</label>
                                    <input type="tel" value="+886 912-345-678" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">變更密碼</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 系統設定 -->
                        <div id="system-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">系統設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">位置服務</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">相機存取</label>
                                        </div>
                                        <label class="text-sm text-[#886364]">已允許</label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">清除快取</button>
                                </div>
                            </div>
                        </div>

                        <!-- 付款設定 -->
                        <div id="payment-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">付款設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">預設付款方式</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-1" checked>
                                            <label for="card-1" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">💳 Visa ****1234</span>
                                                    <span class="text-xs text-[#886364]">到期日: 12/25</span>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-2">
                                            <label for="card-2" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">💳 Mastercard ****5678</span>
                                                    <span class="text-xs text-[#886364]">到期日: 08/26</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">新增付款方式</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">發票設定</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-1" checked>
                                            <label for="invoice" class="text-sm">電子發票</label>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-2">
                                            <label for="invoice" class="text-sm">紙本發票</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 寵物設定 -->
                        <div id="pets-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">寵物設定</h3>
                            
                            <!-- 寵物選擇器 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-[#181111]">選擇寵物</label>
                                    <button class="add-pet-btn p-2 rounded-full bg-[#181111] text-white hover:bg-gray-800">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active bg-[#181111] text-white" data-pet="pet1">🐕 小黃</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet2">🐱 咪咪</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet3">🐰 小白</button>
                                </div>
                            </div>

                            <!-- 寵物照片 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-[#181111]">寵物照片</h4>
                                    <button class="change-photo-btn px-3 py-1 text-xs bg-[#181111] text-white rounded-full hover:bg-gray-800">更換照片</button>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="relative mb-3">
                                        <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center" 
                                             alt="小黃的照片" 
                                             class="w-32 h-32 rounded-full object-cover border-4 border-gray-100 shadow-lg">
                                        <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-[#181111] rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-sm text-[#886364] text-center">點擊「更換照片」來上傳新的寵物照片</p>
                                </div>
                            </div>

                            <!-- 寵物詳細設定 -->
                            <div class="space-y-4">
                                <!-- 寵物基本資訊 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">基本資訊</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">暱稱</label>
                                            <input type="text" value="小黃" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">品種</label>
                                            <input type="text" value="黃金獵犬" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">年齡</label>
                                            <input type="number" value="3" class="form-input-styled text-sm" min="0" max="30">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">體重 (kg)</label>
                                            <input type="number" value="25" class="form-input-styled text-sm" min="0" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 寵物偏好設定 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">偏好設定</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">喜歡的玩具</label>
                                            <input type="text" value="網球、飛盤" class="form-input-styled text-sm" placeholder="輸入寵物喜歡的玩具...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">喜歡的活動</label>
                                            <input type="text" value="散步、游泳" class="form-input-styled text-sm" placeholder="輸入寵物喜歡的活動...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">飲食偏好</label>
                                            <input type="text" value="乾糧、雞肉" class="form-input-styled text-sm" placeholder="輸入寵物的飲食偏好...">
                                        </div>
                                    </div>
                                </div>

                                <!-- 健康與特殊需求 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">健康與特殊需求</h4>
                                    <div class="space-y-3">
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">健康記錄提醒</label>
                                                    <p class="text-xs text-[#886364]">定期提醒寵物健康檢查</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- 健康提醒詳細設定 -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">疫苗提醒</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="3">每3個月</option>
                                                            <option value="6" selected>每6個月</option>
                                                            <option value="12">每年</option>
                                                            <option value="custom">自訂</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">健康檢查</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="6">每6個月</option>
                                                            <option value="12" selected>每年</option>
                                                            <option value="18">每18個月</option>
                                                            <option value="custom">自訂</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-[#886364] mb-1">下次提醒日期</label>
                                                    <input type="date" value="2025-06-15" class="form-input-styled text-xs">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">寵物檔案同步</label>
                                                    <p class="text-xs text-[#886364]">自動同步寵物資訊到雲端</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- 同步詳細設定 -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">同步頻率</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="realtime">即時同步</option>
                                                            <option value="hourly">每小時</option>
                                                            <option value="daily" selected>每天</option>
                                                            <option value="weekly">每週</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">同步內容</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="all" selected>全部資訊</option>
                                                            <option value="basic">基本資訊</option>
                                                            <option value="health">健康記錄</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <input type="checkbox" id="sync-photos" checked class="w-4 h-4">
                                                    <label for="sync-photos" class="text-xs text-[#886364]">同步寵物照片</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">過敏原</label>
                                            <input type="text" value="海鮮、花生" class="form-input-styled text-sm" placeholder="輸入寵物的過敏原...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">特殊需求</label>
                                            <textarea class="form-input-styled text-sm" rows="2" placeholder="記錄寵物的特殊需求、醫療狀況等...">需要定期服藥，關節較敏感</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 儲存按鈕 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 緊急聯絡設定 -->
                        <div id="emergency-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">緊急聯絡設定</h3>
                            
                            <div class="space-y-4">
                                <!-- 主要聯絡人 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">主要聯絡人</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">姓名</label>
                                            <input type="text" value="王小明" class="form-input-styled text-sm" placeholder="輸入聯絡人姓名">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">電話</label>
                                            <input type="tel" value="+886 912-345-678" class="form-input-styled text-sm" placeholder="輸入聯絡人電話">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">關係</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family">家人</option>
                                                <option value="friend" selected>朋友</option>
                                                <option value="colleague">同事</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- 備用聯絡人 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">備用聯絡人</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">姓名</label>
                                            <input type="text" value="李小華" class="form-input-styled text-sm" placeholder="輸入備用聯絡人姓名">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">電話</label>
                                            <input type="tel" value="+886 987-654-321" class="form-input-styled text-sm" placeholder="輸入備用聯絡人電話">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">關係</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family" selected>家人</option>
                                                <option value="friend">朋友</option>
                                                <option value="colleague">同事</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>





                                <!-- 儲存按鈕 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 支援 -->
                        <div id="support-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">支援</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">幫助中心</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">意見回饋</button>
                                </div>
                            </div>
                        </div>

                        <!-- 商家設定 -->
                        ${isUserMerchant ? `
                        <div id="merchant-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">商家設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">自動確認訂單</label>
                                            <p class="text-xs text-[#886364] mt-1">自動確認符合條件的訂單</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">庫存警告</label>
                                            <p class="text-xs text-[#886364] mt-1">庫存不足時發送通知</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">營業時間</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">開始時間</label>
                                            <input type="time" value="09:00" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">結束時間</label>
                                            <input type="time" value="18:00" class="form-input-styled text-sm">
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">自動回覆訊息</label>
                                    <textarea class="form-input-styled" rows="3" placeholder="設定自動回覆客戶的訊息..."></textarea>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                attachSettingsListeners();
            }

            // == START: 新增 renderMyPetsPage 函式 ==
            function renderMyPetsPage(fromPage = 'account') {
                const container = pages.myPets;
                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="back-to-account-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">我的寵物</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>

                        <!-- 寵物列表 -->
                        <div class="p-4 space-y-3">
                            ${window.mockPets.map(pet => `
                                <div class="pet-card bg-white p-3 rounded-xl border border-gray-200 flex items-center gap-4 cursor-pointer" data-pet-id="${pet.id}">
                                    <img src="${pet.photoUrl}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-100">
                                    <div class="flex-1">
                                        <p class="font-bold text-lg text-[#181111]">${pet.name}</p>
                                        <p class="text-sm text-gray-500">${pet.breed}</p>
                                    </div>
                                    <span class="text-[#886364]">›</span>
                                </div>
                            `).join('')}
                        </div>

                        <!-- 新增按鈕 -->
                        <div class="p-4">
                            <button id="add-new-pet-btn" class="w-full flex items-center justify-center gap-2 py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:bg-gray-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>新增寵物檔案</span>
                            </button>
                        </div>
                    </div>
                `;

                // == START: 使用 addEventListener 綁定事件 ==
                // 返回按鈕
                document.getElementById('back-to-account-btn')?.addEventListener('click', () => {
                    showPage(fromPage);
                });

                // 寵物卡片點擊事件
                container.querySelectorAll('.pet-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const petId = parseInt(this.dataset.petId);
                        showPage('petProfile', { petId: petId, fromPage: 'myPets' });
                    });
                });

                // 新增寵物按鈕
                document.getElementById('add-new-pet-btn')?.addEventListener('click', () => {
                    showPage('petProfile', { petId: null, fromPage: 'myPets' });
                });
                // == END: 使用 addEventListener 綁定事件 ==
            }
            // == END: 新增 renderMyPetsPage 函式 ==

            // == START: 新增 renderPetProfilePage 函式 ==
            function renderPetProfilePage(petId, fromPage = 'myPets') {
                const container = pages.petProfile;
                const isEditing = petId !== null;
                const pet = isEditing ? window.mockPets.find(p => p.id === petId) : {};

                // 為了方便，我們先定義好所有可選的個性標籤
                const allPersonalityTags = ['親人', '親狗', '親貓', '內向', '活潑', '容易焦慮', '會護食', '已定點大小便', '破壞力強', '愛叫', '安靜', '黏人', '獨立', '愛玩', '不愛運動', '社交性強', '怕生'];

                container.innerHTML = `
                    <div class="min-h-full bg-gray-50 pb-20">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="back-to-pets-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">${isEditing ? `編輯 ${pet.name} 的檔案` : '新增寵物檔案'}</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>

                        <div class="p-4 space-y-4">
                            <!-- 基本資料 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-4">
                                <div class="text-center">
                                    <img id="pet-photo-preview" src="${isEditing ? pet.photoUrl : 'https://via.placeholder.com/100'}" class="w-24 h-24 rounded-full object-cover border-4 border-gray-100 mx-auto">
                                    <input type="file" id="pet-photo-input" accept="image/*" class="hidden">
                                    <button id="change-photo-btn" class="text-sm text-blue-600 mt-2">更換照片</button>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">寵物姓名 *</label>
                                    <input type="text" id="pet-name-input" class="form-input-styled mt-1" value="${pet.name || ''}" placeholder="請輸入寵物姓名" required>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">品種 *</label>
                                    <input type="text" id="pet-breed-input" class="form-input-styled mt-1" value="${pet.breed || ''}" placeholder="例如：黃金獵犬、英國短毛貓" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">年齡 *</label>
                                        <input type="number" id="pet-age-input" class="form-input-styled mt-1" value="${pet.age || ''}" placeholder="歲" min="0" max="30" required>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">體重 (kg) *</label>
                                        <input type="number" id="pet-weight-input" step="0.1" class="form-input-styled mt-1" value="${pet.weight || ''}" placeholder="kg" min="0" max="100" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">性別 *</label>
                                        <div class="flex gap-4 mt-2">
                                            <label class="flex items-center"><input type="radio" name="gender" value="male" ${pet.gender === 'male' ? 'checked' : ''}> <span class="ml-1">公</span></label>
                                            <label class="flex items-center"><input type="radio" name="gender" value="female" ${pet.gender === 'female' ? 'checked' : ''}> <span class="ml-1">母</span></label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">是否結紮 *</label>
                                        <div class="flex gap-4 mt-2">
                                            <label class="flex items-center"><input type="radio" name="neutered" value="true" ${pet.isNeutered ? 'checked' : ''}> <span class="ml-1">是</span></label>
                                            <label class="flex items-center"><input type="radio" name="neutered" value="false" ${!pet.isNeutered ? 'checked' : ''}> <span class="ml-1">否</span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 個性與習慣 (結構化標籤) -->
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <h3 class="font-bold text-[#181111] mb-3">個性與習慣</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${allPersonalityTags.map(tag => `
                                        <button class="pet-tag-btn ${pet.personalityTags?.includes(tag) ? 'active' : ''}">${tag}</button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- 健康狀況 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-200 space-y-4">
                                 <h3 class="font-bold text-[#181111] mb-3">健康狀況</h3>
                                 <div>
                                    <label class="text-sm font-medium text-gray-500">疫苗接種紀錄</label>
                                    <div id="vaccine-list" class="space-y-2 mt-1">
                                        ${pet.vaccines?.map((v, index) => `
                                            <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm vaccine-item" data-index="${index}">
                                                <div class="flex-1">
                                                    <span class="font-medium">${v.name}</span>
                                                    <span class="text-gray-500 ml-2">${v.date}</span>
                                                </div>
                                                <button class="text-red-500 text-xs px-2 py-1 hover:bg-red-50 rounded" onclick="removeVaccine(${index})">刪除</button>
                                            </div>
                                        `).join('') || '<p class="text-xs text-gray-400">尚未新增疫苗紀錄</p>'}
                                    </div>
                                    <button id="add-vaccine-btn" class="w-full text-sm py-2 mt-2 bg-gray-100 rounded-lg hover:bg-gray-200">＋ 新增疫苗紀錄</button>
                                    <button id="upload-vaccine-proof-btn" class="w-full text-sm py-2 mt-2 bg-gray-100 rounded-lg hover:bg-gray-200">上傳/查看證明</button>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">過敏原</label>
                                    <input type="text" id="pet-allergies-input" class="form-input-styled mt-1" placeholder="例如：穀物、雞肉、海鮮" value="${pet.allergies || ''}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">用藥提醒</label>
                                    <textarea id="pet-medications-input" class="form-input-styled mt-1" rows="2" placeholder="例如：每日早晚飯後需服用關節保健藥 1 顆">${pet.medications || ''}</textarea>
                                </div>
                                 <div>
                                    <label class="text-sm font-medium text-gray-500">特殊需求</label>
                                    <textarea id="pet-special-needs-input" class="form-input-styled mt-1" rows="2" placeholder="例如：怕打雷、不喜歡被摸尾巴、需要安靜環境">${pet.specialNeeds || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- 未儲存變更提示 -->
                            <div id="unsaved-changes-notice" class="hidden bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-amber-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <span class="text-amber-700 font-medium">您有未儲存的變更</span>
                                </div>
                            </div>
                            
                            <!-- 按鈕 -->
                            <div class="flex gap-3">
                                 ${isEditing ? `<button id="delete-pet-btn" class="w-1/3 py-3 bg-red-100 text-red-600 rounded-full font-bold hover:bg-red-200">刪除</button>` : ''}
                                 <button id="save-pet-btn" class="btn-main flex-1">儲存檔案</button>
                            </div>
                            
                            <!-- 錯誤訊息顯示區域 -->
                            <div id="pet-form-errors" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-red-700 font-medium">請修正以下錯誤：</span>
                                </div>
                                <ul id="error-list" class="mt-2 text-sm text-red-600 list-disc list-inside"></ul>
                            </div>
                        </div>
                    </div>
                `;

                // == START: 使用 addEventListener 綁定事件 ==
                // 返回按鈕
                document.getElementById('back-to-pets-btn')?.addEventListener('click', () => {
                    showPage(fromPage);
                });

                // 綁定標籤點擊事件
                container.querySelectorAll('.pet-tag-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('active');
                    });
                });

                // 綁定照片上傳事件
                document.getElementById('change-photo-btn')?.addEventListener('click', () => {
                    document.getElementById('pet-photo-input').click();
                });

                document.getElementById('pet-photo-input')?.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('pet-photo-preview').src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // 綁定疫苗管理事件
                document.getElementById('add-vaccine-btn')?.addEventListener('click', () => {
                    showVaccineModal();
                });

                document.getElementById('upload-vaccine-proof-btn')?.addEventListener('click', () => {
                    alert('疫苗證明上傳功能開發中...');
                });

                // == START: 監聽表單變更，顯示未儲存變更提示 ==
                const formInputs = container.querySelectorAll('input, textarea, select');
                formInputs.forEach(input => {
                    input.addEventListener('input', showUnsavedChangesNotice);
                    input.addEventListener('change', showUnsavedChangesNotice);
                });

                // 監聽個性標籤變更
                container.querySelectorAll('.pet-tag-btn').forEach(btn => {
                    btn.addEventListener('click', showUnsavedChangesNotice);
                });
                // == END: 監聽表單變更，顯示未儲存變更提示 ==

                // 綁定儲存和刪除事件
                document.getElementById('save-pet-btn')?.addEventListener('click', () => {
                    savePetProfile(petId);
                });

                document.getElementById('delete-pet-btn')?.addEventListener('click', () => {
                    deletePetProfile(petId);
                });
                // == END: 使用 addEventListener 綁定事件 ==
            }
            // == END: 新增 renderPetProfilePage 函式 ==

            // == START: 新增寵物檔案管理輔助函式 ==
            function showVaccineModal() {
                const modalHTML = `
                    <div id="vaccine-modal" class="modal-overlay">
                        <div class="modal-content">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-[#181111]">新增疫苗紀錄</h3>
                                <button id="close-vaccine-modal" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-500">疫苗名稱</label>
                                    <input type="text" id="vaccine-name-input" class="form-input-styled mt-1" placeholder="例如：狂犬病疫苗、八合一疫苗">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">接種日期</label>
                                    <input type="date" id="vaccine-date-input" class="form-input-styled mt-1">
                                </div>
                                <div class="flex gap-3 pt-4">
                                    <button id="cancel-vaccine-btn" class="btn-secondary flex-1">取消</button>
                                    <button id="save-vaccine-btn" class="btn-main flex-1">儲存</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 綁定事件
                document.getElementById('close-vaccine-modal')?.addEventListener('click', closeVaccineModal);
                document.getElementById('cancel-vaccine-btn')?.addEventListener('click', closeVaccineModal);
                document.getElementById('save-vaccine-btn')?.addEventListener('click', saveVaccine);
                
                // 設定預設日期為今天
                document.getElementById('vaccine-date-input').value = new Date().toISOString().split('T')[0];
            }

            function closeVaccineModal() {
                document.getElementById('vaccine-modal')?.remove();
            }

            function saveVaccine() {
                const name = document.getElementById('vaccine-name-input').value.trim();
                const date = document.getElementById('vaccine-date-input').value;
                
                if (!name || !date) {
                    alert('請填寫完整的疫苗資訊');
                    return;
                }
                
                // 新增疫苗到列表
                const vaccineList = document.getElementById('vaccine-list');
                const vaccineHTML = `
                    <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm vaccine-item">
                        <div class="flex-1">
                            <span class="font-medium">${name}</span>
                            <span class="text-gray-500 ml-2">${date}</span>
                        </div>
                        <button class="text-red-500 text-xs px-2 py-1 hover:bg-red-50 rounded" onclick="removeVaccineFromList(this)">刪除</button>
                    </div>
                `;
                
                if (vaccineList.innerHTML.includes('尚未新增疫苗紀錄')) {
                    vaccineList.innerHTML = vaccineHTML;
                } else {
                    vaccineList.insertAdjacentHTML('beforeend', vaccineHTML);
                }
                
                closeVaccineModal();
                
                // 顯示未儲存變更提示
                showUnsavedChangesNotice();
            }

            function removeVaccineFromList(button) {
                button.closest('.vaccine-item').remove();
                
                // 如果沒有疫苗了，顯示預設訊息
                const vaccineList = document.getElementById('vaccine-list');
                if (vaccineList.children.length === 0) {
                    vaccineList.innerHTML = '<p class="text-xs text-gray-400">尚未新增疫苗紀錄</p>';
                }
                
                // 顯示未儲存變更提示
                showUnsavedChangesNotice();
            }

            function savePetProfile(petId) {
                // 收集表單資料
                const formData = {
                    name: document.getElementById('pet-name-input').value.trim(),
                    breed: document.getElementById('pet-breed-input').value.trim(),
                    age: parseInt(document.getElementById('pet-age-input').value),
                    weight: parseFloat(document.getElementById('pet-weight-input').value),
                    gender: document.querySelector('input[name="gender"]:checked')?.value,
                    isNeutered: document.querySelector('input[name="neutered"]:checked')?.value === 'true',
                    allergies: document.getElementById('pet-allergies-input').value.trim(),
                    medications: document.getElementById('pet-medications-input').value.trim(),
                    specialNeeds: document.getElementById('pet-special-needs-input').value.trim(),
                    personalityTags: Array.from(document.querySelectorAll('.pet-tag-btn.active')).map(btn => btn.textContent),
                    vaccines: Array.from(document.querySelectorAll('.vaccine-item')).map(item => ({
                        name: item.querySelector('.font-medium').textContent,
                        date: item.querySelector('.text-gray-500').textContent.trim(),
                        proofUrl: ''
                    }))
                };

                // == START: 優化錯誤反饋 ==
                // 先清除所有欄位的錯誤樣式
                document.querySelectorAll('.form-input-styled').forEach(el => {
                    el.classList.remove('border-red-500', 'border-2');
                });

                // 驗證表單
                const errors = validatePetForm(formData);
                if (errors.length > 0) {
                    showPetFormErrors(errors);

                    // 將有問題的欄位加上紅色框線
                    if (!formData.name) document.getElementById('pet-name-input').classList.add('border-red-500', 'border-2');
                    if (!formData.breed) document.getElementById('pet-breed-input').classList.add('border-red-500', 'border-2');
                    if (!formData.age || formData.age < 0 || formData.age > 30) document.getElementById('pet-age-input').classList.add('border-red-500', 'border-2');
                    if (!formData.weight || formData.weight < 0 || formData.weight > 100) document.getElementById('pet-weight-input').classList.add('border-red-500', 'border-2');
                    if (!formData.gender) {
                        document.querySelectorAll('input[name="gender"]').forEach(radio => {
                            radio.closest('label').classList.add('text-red-500');
                        });
                    }
                    if (formData.isNeutered === undefined) {
                        document.querySelectorAll('input[name="neutered"]').forEach(radio => {
                            radio.closest('label').classList.add('text-red-500');
                        });
                    }
                    return;
                }

                // 隱藏錯誤訊息
                hidePetFormErrors();
                
                // 隱藏未儲存變更提示
                hideUnsavedChangesNotice();
                // == END: 優化錯誤反饋 ==

                // 儲存寵物資料
                if (petId) {
                    // 更新現有寵物
                    const petIndex = window.mockPets.findIndex(p => p.id === petId);
                    if (petIndex !== -1) {
                        window.mockPets[petIndex] = { ...window.mockPets[petIndex], ...formData };
                    }
                } else {
                    // 新增寵物
                    const newPet = {
                        id: Date.now(), // 簡單的ID生成
                        photoUrl: document.getElementById('pet-photo-preview').src,
                        ...formData
                    };
                    window.mockPets.push(newPet);
                }

                alert('寵物檔案儲存成功！');
                showPage('myPets');
            }

            function deletePetProfile(petId) {
                if (confirm('確定要刪除這個寵物檔案嗎？此操作無法復原。')) {
                    const petIndex = window.mockPets.findIndex(p => p.id === petId);
                    if (petIndex !== -1) {
                        window.mockPets.splice(petIndex, 1);
                        alert('寵物檔案已刪除');
                        showPage('myPets');
                    }
                }
            }

            function validatePetForm(data) {
                const errors = [];
                
                if (!data.name) errors.push('請輸入寵物姓名');
                if (!data.breed) errors.push('請輸入寵物品種');
                if (!data.age || data.age < 0 || data.age > 30) errors.push('請輸入有效的年齡（0-30歲）');
                if (!data.weight || data.weight < 0 || data.weight > 100) errors.push('請輸入有效的體重（0-100kg）');
                if (!data.gender) errors.push('請選擇性別');
                if (data.isNeutered === undefined) errors.push('請選擇是否結紮');
                
                return errors;
            }

            function showPetFormErrors(errors) {
                const errorContainer = document.getElementById('pet-form-errors');
                const errorList = document.getElementById('error-list');
                
                errorList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
                errorContainer.classList.remove('hidden');
                
                // 滾動到錯誤訊息
                errorContainer.scrollIntoView({ behavior: 'smooth' });
            }

            function hidePetFormErrors() {
                document.getElementById('pet-form-errors')?.classList.add('hidden');
            }

            function showUnsavedChangesNotice() {
                const notice = document.getElementById('unsaved-changes-notice');
                if (notice) {
                    notice.classList.remove('hidden');
                }
            }

            function hideUnsavedChangesNotice() {
                const notice = document.getElementById('unsaved-changes-notice');
                if (notice) {
                    notice.classList.add('hidden');
                }
            }
            // == END: 新增寵物檔案管理輔助函式 ==

            function attachSettingsListeners() {
                // 返回按鈕
                document.getElementById('settings-back-btn')?.addEventListener('click', () => showPage('account'));
                
                // 標籤切換
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabName = btn.dataset.tab;
                        switchSettingsTab(tabName);
                    });
                });

                // 寵物選擇器
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const petId = btn.dataset.pet;
                        switchPetSettings(petId);
                    });
                });

                // 新增寵物按鈕
                document.querySelector('.add-pet-btn')?.addEventListener('click', () => {
                    addNewPet();
                });

                // 更換照片按鈕
                document.querySelector('.change-photo-btn')?.addEventListener('click', () => {
                    changePetPhoto();
                });
            }

            function switchSettingsTab(activeTab) {
                // 更新標籤按鈕狀態
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === activeTab);
                });
                
                // 隱藏所有內容
                document.querySelectorAll('.settings-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // 顯示選中的內容
                const targetContent = document.getElementById(`${activeTab}-settings`);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }

            function switchPetSettings(petId) {
                // 更新寵物選擇器按鈕狀態
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.pet === petId);
                    if (btn.dataset.pet === petId) {
                        btn.classList.remove('bg-gray-200', 'text-[#181111]');
                        btn.classList.add('bg-[#181111]', 'text-white');
                    } else {
                        btn.classList.remove('bg-[#181111]', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-[#181111]');
                    }
                });

                // 這裡可以根據選擇的寵物更新表單內容
                // 實際應用中會從資料庫或狀態管理中獲取寵物資訊
                console.log('切換到寵物:', petId);
            }

            function addNewPet() {
                // 新增寵物的邏輯
                // 實際應用中會開啟新增寵物的模態視窗或導航到新增頁面
                alert('新增寵物功能 - 這裡會開啟新增寵物的表單');
            }

            function changePetPhoto() {
                // 創建隱藏的文件輸入元素   
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                
                // 監聽文件選擇
                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // 檢查文件類型
                        if (!file.type.startsWith('image/')) {
                            alert('請選擇圖片檔案');
                            return;
                        }
                        
                        // 檢查文件大小 (限制為 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('圖片檔案大小不能超過 5MB');
                            return;
                        }
                        
                        // 創建預覽
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const petPhoto = document.querySelector('#pets-settings img');
                            if (petPhoto) {
                                petPhoto.src = e.target.result;
                                // 這裡可以添加上傳到伺服器的邏輯
                                console.log('寵物照片已更新');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // 觸發文件選擇
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }

            // == START: 新增金流相關的渲染函式 ==

            // 4.1 金流儀表板 (提領主頁)
            function renderFinanceDashboardPage() {
                const container = pages.financeDashboard;
                const hasPayoutAccount = true; // 假設商家已設定帳戶，你可以根據實際狀態切換

                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="back-to-merchant-dashboard-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">金流儀表板</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>

                        <!-- 內容區域 -->
                        <div class="p-4 space-y-4">
                            <!-- 餘額資訊 -->
                            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl p-6 shadow-lg">
                                <p class="text-sm opacity-80">可提領餘額</p>
                                <p class="text-4xl font-bold mt-2">NT$ 15,800</p>
                                <div class="mt-4 pt-4 border-t border-white border-opacity-30 text-sm flex justify-between">
                                    <div>
                                        <p class="opacity-80">待處理餘額</p>
                                        <p class="font-semibold">NT$ 3,200</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="opacity-80">上次提領</p>
                                        <p class="font-semibold">NT$ 5,000 (09/15)</p>
                                    </div>
                                </div>
                            </div>

                            ${!hasPayoutAccount ? `
                            <!-- 設定帳戶提示 -->
                            <div id="setup-account-prompt" class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-yellow-700">您尚未設定收款帳戶。請先完成設定才能提領款項。</p>
                                        <p class="mt-2 text-sm"><a href="#" id="go-to-payout-settings-btn" class="font-medium text-yellow-700 hover:text-yellow-600">前往設定 →</a></p>
                                    </div>
                                </div>
                            </div>
                            ` : `
                            <!-- 提領操作 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">發起提領</h3>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">提領金額</label>
                                    <div class="relative mt-1">
                                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">NT$</span>
                                        <input type="number" id="withdrawal-amount" class="form-input-styled pl-10" placeholder="0">
                                        <button id="withdraw-all-btn" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm font-semibold text-blue-600">全部提領</button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-sm font-medium text-gray-500">收款帳戶</p>
                                    <p class="text-sm text-gray-800 mt-1">中國信託 (822) **** **** 1234</p>
                                </div>
                                <div class="mt-4 text-xs text-gray-500 space-y-1">
                                    <div class="flex justify-between"><span>銀行手續費:</span><span>NT$ 15</span></div>
                                    <div class="flex justify-between"><span>預計 3-5 工作天到帳</span></div>
                                </div>
                                <button id="initiate-withdrawal-btn" class="btn-main w-full mt-4">確認提領</button>
                            </div>
                            `}

                            <!-- 快速連結 -->
                            <div class="grid grid-cols-2 gap-3">
                                <button id="payout-history-link" class="bg-white p-3 rounded-lg border border-gray-200 text-center text-sm font-medium text-gray-700">提領紀錄</button>
                                <button id="payout-settings-link" class="bg-white p-3 rounded-lg border border-gray-200 text-center text-sm font-medium text-gray-700">收款帳戶設定</button>
                            </div>
                        </div>
                    </div>
                `;

                // 綁定事件
                container.querySelector('#back-to-merchant-dashboard-btn').addEventListener('click', () => showPage('merchantDashboard'));
                container.querySelector('#payout-history-link').addEventListener('click', () => showPage('payoutHistory'));
                container.querySelector('#payout-settings-link').addEventListener('click', () => showPage('payoutSettings'));
                container.querySelector('#go-to-payout-settings-btn')?.addEventListener('click', () => showPage('payoutSettings'));
                container.querySelector('#initiate-withdrawal-btn')?.addEventListener('click', openWithdrawalConfirmationModal);
            }

            // 4.2 收款帳戶設定頁
            function renderPayoutSettingsPage() {
                const container = pages.payoutSettings;
                const isAccountSet = true; // 假設已設定，可切換為 false 來測試初始狀態

                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="back-to-finance-dashboard-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                     <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">收款帳戶設定</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>

                        <!-- 內容 -->
                        <div class="p-4 space-y-4">
                            ${isAccountSet ? `
                            <!-- 顯示已設定帳戶 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-4">目前的收款帳戶</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span class="text-gray-500">帳戶戶名</span><span>王*明</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">銀行名稱</span><span>中國信託商業銀行</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">分行</span><span>信義分行</span></div>
                                    <div class="flex justify-between"><span class="text-gray-500">帳戶號碼</span><span>**** **** 1234</span></div>
                                </div>
                                <button id="change-account-btn" class="w-full border-2 border-gray-300 rounded-full py-2 mt-6 text-sm font-bold text-gray-700">更換帳戶</button>
                            </div>
                            ` : `
                            <!-- 新增帳戶表單 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-4">新增收款帳戶</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">帳戶戶名</label>
                                        <input type="text" class="form-input-styled mt-1" value="王小明" disabled>
                                        <p class="text-xs text-gray-500 mt-1">為確保安全，戶名必須與您的註冊姓名一致。</p>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">銀行名稱</label>
                                        <select class="form-input-styled mt-1">
                                            <option>請選擇銀行</option>
                                            <option>822 - 中國信託商業銀行</option>
                                            <option>013 - 國泰世華銀行</option>
                                            <option>004 - 臺灣銀行</option>
                                        </select>
                                    </div>
                                     <div>
                                        <label class="text-sm font-medium text-gray-500">分行名稱</label>
                                        <input type="text" class="form-input-styled mt-1" placeholder="例如：信義分行">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-500">帳戶號碼</label>
                                        <input type="text" class="form-input-styled mt-1" placeholder="輸入您的銀行帳號">
                                    </div>
                                    <button id="save-account-btn" class="btn-main w-full mt-4">儲存帳戶</button>
                                </div>
                            </div>
                            `}
                        </div>
                    </div>
                `;

                // 綁定事件
                container.querySelector('#back-to-finance-dashboard-btn').addEventListener('click', () => showPage('financeDashboard'));
            }

            // 4.3 提領歷史紀錄頁
            function renderPayoutHistoryPage() {
                const container = pages.payoutHistory;
                // 假資料
                const history = [
                    { date: '2025-09-15', amount: 5000, status: 'completed', fee: 15 },
                    { date: '2025-08-28', amount: 8200, status: 'completed', fee: 15 },
                    { date: '2025-08-10', amount: 3500, status: 'failed', fee: 0, reason: '帳戶資訊錯誤' },
                    { date: '2025-07-25', amount: 12000, status: 'completed', fee: 15 },
                ];

                container.innerHTML = `
                    <div class="min-h-full bg-gray-50">
                        <!-- 頁首 -->
                        <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                            <div class="px-4 py-3 flex items-center justify-between">
                                <button id="back-to-finance-dashboard-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                     <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                </button>
                                <h1 class="text-lg font-bold text-[#181111]">提領紀錄</h1>
                                <div class="w-8"></div>
                            </div>
                        </div>

                        <!-- 紀錄列表 -->
                        <div class="p-4 space-y-3">
                            ${history.map(item => `
                                <div class="bg-white p-3 rounded-lg border border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold text-base text-gray-800">NT$ ${item.amount.toLocaleString()}</p>
                                            <p class="text-xs text-gray-500">${item.date}</p>
                                        </div>
                                        ${
                                            item.status === 'completed' ? `<span class="text-xs font-semibold text-green-600 bg-green-100 px-2 py-1 rounded-full">已完成</span>` :
                                            item.status === 'failed' ? `<span class="text-xs font-semibold text-red-600 bg-red-100 px-2 py-1 rounded-full">失敗</span>` :
                                            `<span class="text-xs font-semibold text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full">處理中</span>`
                                        }
                                    </div>
                                    ${item.status === 'failed' ? `<p class="text-xs text-red-500 mt-2">原因：${item.reason}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // 綁定事件
                container.querySelector('#back-to-finance-dashboard-btn').addEventListener('click', () => showPage('financeDashboard'));
            }

            // 輔助函式：開啟提領確認彈窗 (Modal)
            function openWithdrawalConfirmationModal() {
                const amount = document.getElementById('withdrawal-amount').value || '0';
                if (parseInt(amount) <= 0) {
                    alert('請輸入有效的提領金額');
                    return;
                }

                const netAmount = parseInt(amount) - 15;

                const modalHTML = `
                    <div id="withdrawal-confirm-modal" class="modal-overlay">
                        <div class="modal-content">
                            <h3 class="text-lg font-bold text-center mb-4">確認提領資訊</h3>
                            <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
                                <div class="flex justify-between text-sm"><span class="text-gray-500">提領金額</span><span class="font-medium">NT$ ${parseInt(amount).toLocaleString()}</span></div>
                                <div class="flex justify-between text-sm"><span class="text-gray-500">銀行手續費</span><span>- NT$ 15</span></div>
                                <hr>
                                <div class="flex justify-between text-base font-bold"><span class="text-gray-800">實際入帳金額</span><span class="text-blue-600">NT$ ${netAmount.toLocaleString()}</span></div>
                            </div>
                            <div class="mt-4">
                                <label class="text-sm font-medium text-gray-500">請輸入登入密碼以授權</label>
                                <input type="password" class="form-input-styled mt-1" placeholder="********">
                            </div>
                            <div class="flex gap-2 mt-6">
                                <button id="cancel-withdrawal-btn" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-full font-bold">取消</button>
                                <button id="confirm-withdrawal-btn" class="flex-1 py-2 px-4 bg-[#181111] text-white rounded-full font-bold">確認送出</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const modal = document.getElementById('withdrawal-confirm-modal');
                modal.querySelector('#cancel-withdrawal-btn').addEventListener('click', () => modal.remove());
                modal.querySelector('#confirm-withdrawal-btn').addEventListener('click', () => {
                    alert('提領申請已送出！預計 3-5 工作天到帳。');
                    modal.remove();
                    showPage('payoutHistory'); // 提領後跳到歷史紀錄頁
                });
            }

            // == END: 新增金流相關的渲染函式 ==

            function renderMerchantDashboard() {
                const container = pages.merchantDashboard;
                container.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">商家專區</h1>
                    <!-- 儀表板概覽 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">儀表板概覽</h2>
                        <div class="mb-4">
                            <h3 class="text-sm font-medium text-[#181111] mb-3">今日關鍵指標</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <!-- 今日營收 -->
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-blue-700">💰 今日營收</span>
                                        <span class="text-xs text-green-600">↗️ +12%</span>
                                    </div>
                                    <div class="text-lg font-bold text-blue-800">NT$ 8,500</div>
                                    <div class="text-xs text-blue-600 mt-1">目標達成率: 85%</div>
                                </div>
                                
                                <!-- 入住狀況 -->
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-green-700">🏠 入住狀況</span>
                                        <span class="text-xs text-green-600">正常</span>
                                    </div>
                                    <div class="text-lg font-bold text-green-800">68%</div>
                                    <div class="text-xs text-green-600 mt-1">22/32 間已入住</div>
                                </div>
                                
                                <!-- 訂單狀態 -->
                                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-yellow-700">📋 訂單狀態</span>
                                        <span class="text-xs text-yellow-600">⚠️ 5筆待處理</span>
                                    </div>
                                    <div class="text-lg font-bold text-yellow-800">12</div>
                                    <div class="text-xs text-yellow-600 mt-1">今日新增訂單</div>
                                </div>
                                
                                <!-- 客戶滿意度 -->
                                <div class="bg-gradient-to-br    from-purple-50 to-purple-100 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-xs font-medium text-purple-700">😊 客戶滿意度</span>
                                        <span class="text-xs text-green-600">📈 穩定</span>
                                    </div>
                                    <div class="text-lg font-bold text-purple-800">4.8</div>
                                    <div class="text-xs text-purple-600 mt-1">3 則新增評論</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 快速操作 -->
                        <div>
                            <h3 class="text-sm font-medium text-[#181111] mb-3">快速操作</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="view-pending-orders-btn" class="bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showPendingOrdersModal()">
                                    📋 查看待處理訂單
                                </button>
                                <button id="check-room-status-btn" class="bg-green-50 hover:bg-green-100 text-green-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showRoomStatusModal()">
                                    🏠 檢查房況
                                </button>
                                <button id="reply-comments-btn" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showReplyCommentsModal()">
                                    💬 回覆評論
                                </button>
                                <button id="detailed-reports-btn" class="bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showDetailedReportsModal()">
                                    📊 詳細報表
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-6">
                            <button id="manage-calendar-btn" class="btn-main h-10 px-5 text-sm w-full">管理行事曆</button>
                        </div>
                    </div>

                    <!-- 數據分析入口 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50" id="analytics-dashboard-link">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">📊 數據分析</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">營收分析、訂單統計、客戶滿意度等詳細數據</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>

                    <!-- == START: 新增金流管理入口 == -->
                    <div id="finance-dashboard-link" class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">💰 金流管理</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">管理您的收入、提領款項與收款帳戶</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                    <!-- == END: 新增金流管理入口 == -->

                    <!-- 房型與方案管理 -->
                    <div id="manage-rooms-link" class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">房型與方案管理</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">管理您的房型與價格方案</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                     <!-- 訂單管理 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">訂單管理</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">查看與確認所有訂單</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                </div>
                `;
            }

            function renderAnalyticsDashboard() {
                const container = pages.analyticsDashboard;
                container.innerHTML = `
                <div class="p-4 space-y-4">
                    <!-- 頁面標題與返回按鈕 -->
                    <div class="flex items-center gap-3 mb-4">
                        <button id="back-to-merchant-dashboard-btn" class="text-2xl text-[#886364]">‹</button>
                        <h1 class="text-2xl font-bold text-[#181111]">📊 數據分析</h1>
                    </div>

                    <!-- 分析頁簽 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">數據分析</h2>
                            <div class="flex gap-2">
                                <select id="analytics-period-select" class="w-full h-8 px-2 text-xs bg-white text-gray-800 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                    <option value="7">近7天</option>
                                    <option value="30" selected>近30天</option>
                                    <option value="90">近90天</option>
                                    <option value="365">近一年</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 頁簽導航 -->
                        <div class="flex border-b border-gray-200 mb-4">
                            <button id="revenue-tab" class="analytics-tab px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">💰 營收分析</button>
                            <button id="order-tab" class="analytics-tab px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">📋 訂單分析</button>
                            <button id="occupancy-tab" class="analytics-tab px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">🏠 房況分析</button>
                            <button id="satisfaction-tab" class="analytics-tab px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">😊 滿意度</button>
                            <button id="monitoring-tab" class="analytics-tab px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent">📊 即時監控</button>
                        </div>
                        
                        <!-- 營收分析內容 -->
                        <div id="revenue-content" class="analytics-content">
                            <!-- 營收趨勢圖表 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">營收趨勢</h3>
                                <div class="bg-gray-50 rounded-lg p-3 h-40 flex items-end justify-between">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-16 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週一</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週二</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週三</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-28 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週四</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-32 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週五</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-emerald-500 w-4 h-36 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週六</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-emerald-500 w-4 h-40 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週日</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>NT$ 0</span>
                                    <span>NT$ 5,000</span>
                                </div>
                            </div>

                            <!-- 房型營收分析 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">房型營收分析</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">標準犬房</span>
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full" style="width: 45%"></div>
                                            </div>
                                            <span class="text-sm font-medium">NT$ 6,750</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">豪華貓別墅</span>
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div class="bg-pink-500 h-2 rounded-full" style="width: 35%"></div>
                                            </div>
                                            <span class="text-sm font-medium">NT$ 5,250</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">小型寵物寄宿籠</span>
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div class="bg-green-500 h-2 rounded-full" style="width: 20%"></div>
                                            </div>
                                            <span class="text-sm font-medium">NT$ 3,000</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 服務類型營收 -->
                            <div>
                                <h3 class="text-sm font-medium text-[#181111] mb-2">服務類型營收</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-blue-700">NT$ 12,000</div>
                                        <div class="text-xs text-blue-600">過夜住宿</div>
                                        <div class="text-xs text-gray-500">80%</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-green-700">NT$ 3,000</div>
                                        <div class="text-xs text-green-600">日間安親</div>
                                        <div class="text-xs text-gray-500">20%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 訂單分析內容 -->
                        <div id="order-content" class="analytics-content hidden">
                            <!-- 訂單狀態統計 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">訂單狀態分布</h3>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-blue-700">5</div>
                                        <div class="text-xs text-blue-600">待確認</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-green-700">12</div>
                                        <div class="text-xs text-green-600">已確認</div>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-yellow-700">8</div>
                                        <div class="text-xs text-yellow-600">進行中</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-gray-700">25</div>
                                        <div class="text-xs text-gray-600">已完成</div>
                                    </div>
                                </div>
                                
                                <!-- 訂單狀態轉換漏斗 -->
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2">訂單轉換漏斗</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">總訂單</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-gray-500 h-2 rounded-full" style="width: 100%"></div>
                                                </div>
                                                <span class="text-xs font-medium">50</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">已確認</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-blue-500 h-2 rounded-full" style="width: 80%"></div>
                                                </div>
                                                <span class="text-xs font-medium">40</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">已完成</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-green-500 h-2 rounded-full" style="width: 50%"></div>
                                                </div>
                                                <span class="text-xs font-medium">25</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 預約趨勢分析 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">預約趨勢分析</h3>
                                <div class="bg-gray-50 rounded-lg p-3 h-32 flex items-end justify-between mb-2">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-purple-500 w-3 h-12 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">1週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-purple-500 w-3 h-16 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">2週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-purple-500 w-3 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">3週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-purple-500 w-3 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">4週</span>
                                    </div>
                                </div>
                                
                                <!-- 預約取消率 -->
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-red-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-red-700">8%</div>
                                        <div class="text-xs text-red-600">取消率</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-green-700">92%</div>
                                        <div class="text-xs text-green-600">完成率</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 客戶行為分析 -->
                            <div>
                                <h3 class="text-sm font-medium text-[#181111] mb-2">客戶行為分析</h3>
                                
                                <!-- 重複預約客戶 -->
                                <div class="mb-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-gray-600">重複預約客戶</span>
                                        <span class="text-xs font-medium text-green-600">65%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 65%"></div>
                                    </div>
                                </div>
                                
                                <!-- 平均預約天數 -->
                                <div class="mb-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-gray-600">平均預約天數</span>
                                        <span class="text-xs font-medium text-blue-600">3.2 天</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full" style="width: 64%"></div>
                                    </div>
                                </div>
                                
                                <!-- 提前預約天數分布 -->
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2">提前預約天數分布</h4>
                                    <div class="space-y-1">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">當天預約</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-red-400 h-1.5 rounded-full" style="width: 15%"></div>
                                                </div>
                                                <span class="text-xs">15%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">1-3天前</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-yellow-400 h-1.5 rounded-full" style="width: 35%"></div>
                                                </div>
                                                <span class="text-xs">35%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">4-7天前</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-blue-400 h-1.5 rounded-full" style="width: 30%"></div>
                                                </div>
                                                <span class="text-xs">30%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">7天以上</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-green-400 h-1.5 rounded-full" style="width: 20%"></div>
                                                </div>
                                                <span class="text-xs">20%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 房況分析內容 -->
                        <div id="occupancy-content" class="analytics-content hidden">
                            <!-- 整體入住率 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">整體入住率</h3>
                                <div class="bg-gray-50 rounded-lg p-3 h-32 flex items-end justify-between mb-2">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週一</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週二</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-28 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週三</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-32 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週四</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-4 h-36 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週五</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-emerald-500 w-4 h-40 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週六</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-emerald-500 w-4 h-44 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">週日</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0%</span>
                                    <span>100%</span>
                                </div>
                            </div>

                            <!-- 各房型入住率 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">各房型入住率</h3>
                                <div class="space-y-3">
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">標準犬房</span>
                                            <span class="text-sm font-bold text-blue-600">75%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-500 h-2 rounded-full" style="width: 75%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>已入住: 15/20</span>
                                            <span>可用: 5 間</span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">豪華貓別墅</span>
                                            <span class="text-sm font-bold text-pink-600">60%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-pink-500 h-2 rounded-full" style="width: 60%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>已入住: 9/15</span>
                                            <span>可用: 6 間</span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">小型寵物寄宿籠</span>
                                            <span class="text-sm font-bold text-green-600">40%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" style="width: 40%"></div>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>已入住: 8/20</span>
                                            <span>可用: 12 間</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 容量利用率分析 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">容量利用率分析</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-blue-700">68%</div>
                                        <div class="text-xs text-blue-600">平均利用率</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-green-700">32</div>
                                        <div class="text-xs text-green-600">總可用房間</div>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-yellow-700">22</div>
                                        <div class="text-xs text-yellow-600">已入住房間</div>
                                    </div>
                                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-gray-700">10</div>
                                        <div class="text-xs text-gray-600">閒置房間</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 閒置時間分析 -->
                            <div>
                                <h3 class="text-sm font-medium text-[#181111] mb-2">閒置時間分析</h3>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2">各時段閒置率</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">上午 (9-12點)</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-red-400 h-1.5 rounded-full" style="width: 25%"></div>
                                                </div>
                                                <span class="text-xs">25%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">下午 (13-17點)</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-yellow-400 h-1.5 rounded-full" style="width: 15%"></div>
                                                </div>
                                                <span class="text-xs">15%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">晚上 (18-22點)</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-green-400 h-1.5 rounded-full" style="width: 5%"></div>
                                                </div>
                                                <span class="text-xs">5%</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">深夜 (23-8點)</span>
                                            <div class="flex items-center gap-2">
                                                <div class="w-16 bg-gray-200 rounded-full h-1.5">
                                                    <div class="bg-blue-400 h-1.5 rounded-full" style="width: 10%"></div>
                                                </div>
                                                <span class="text-xs">10%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 閒置房間分布 -->
                                <div class="mt-3 bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2">閒置房間分布</h4>
                                    <div class="grid grid-cols-2 gap-2 text-xs">
                                        <div class="bg-white rounded p-2 text-center">
                                            <div class="font-medium text-gray-700">標準犬房</div>
                                            <div class="text-blue-600">5 間閒置</div>
                                        </div>
                                        <div class="bg-white rounded p-2 text-center">
                                            <div class="font-medium text-gray-700">豪華貓別墅</div>
                                            <div class="text-pink-600">6 間閒置</div>
                                        </div>
                                        <div class="bg-white rounded p-2 text-center">
                                            <div class="font-medium text-gray-700">小型寄宿籠</div>
                                            <div class="text-green-600">12 間閒置</div>
                                        </div>
                                        <div class="bg-white rounded p-2 text-center">
                                            <div class="font-medium text-gray-700">其他房型</div>
                                            <div class="text-gray-600">2 間閒置</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 客戶滿意度內容 -->
                        <div id="satisfaction-content" class="analytics-content hidden">
                            <!-- 評分統計 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">平均評分</h3>
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="text-3xl font-bold text-yellow-500">4.8</div>
                                    <div class="flex items-center">
                                        <div class="flex text-yellow-400">
                                            ★★★★★
                                        </div>
                                        <span class="text-sm text-gray-600 ml-2">(156 則評論)</span>
                                    </div>
                                </div>
                                
                                <!-- 評分趨勢 -->
                                <div class="bg-gray-50 rounded-lg p-3 h-32 flex items-end justify-between mb-2">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-yellow-500 w-3 h-16 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">1週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-yellow-500 w-3 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">2週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-yellow-500 w-3 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">3週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-yellow-500 w-3 h-28 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">4週</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>4.0</span>
                                    <span>5.0</span>
                                </div>
                            </div>

                            <!-- 評分分布 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">評分分布</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600 w-8">5★</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 85%"></div>
                                        </div>
                                        <span class="text-xs text-gray-600">85%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600 w-8">4★</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-yellow-400 h-2 rounded-full" style="width: 12%"></div>
                                        </div>
                                        <span class="text-xs text-gray-600">12%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600 w-8">3★</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-400 h-2 rounded-full" style="width: 2%"></div>
                                        </div>
                                        <span class="text-xs text-gray-600">2%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600 w-8">2★</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-400 h-2 rounded-full" style="width: 1%"></div>
                                        </div>
                                        <span class="text-xs text-gray-600">1%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600 w-8">1★</span>
                                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                                            <div class="bg-gray-400 h-2 rounded-full" style="width: 0%"></div>
                                        </div>
                                        <span class="text-xs text-gray-600">0%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 評論分析 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">評論分析</h3>
                                
                                <!-- 評論情感分析 -->
                                <div class="grid grid-cols-3 gap-3 mb-3">
                                    <div class="bg-green-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-green-700">89%</div>
                                        <div class="text-xs text-green-600">正面評論</div>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-yellow-700">8%</div>
                                        <div class="text-xs text-yellow-600">中性評論</div>
                                    </div>
                                    <div class="bg-red-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-red-700">3%</div>
                                        <div class="text-xs text-red-600">負面評論</div>
                                    </div>
                                </div>
                                
                                <!-- 熱門關鍵詞 -->
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-xs font-medium text-gray-600 mb-2">熱門關鍵詞</h4>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">環境舒適</span>
                                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">服務專業</span>
                                        <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">價格合理</span>
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">寵物開心</span>
                                        <span class="bg-pink-100 text-pink-800 text-xs px-2 py-1 rounded-full">設施完善</span>
                                        <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">交通便利</span>
                                    </div>
                                </div>
                            </div>

                            <!-- 情感分析趨勢 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">情感分析趨勢</h3>
                                <div class="bg-gray-50 rounded-lg p-3 h-32 flex items-end justify-between mb-2">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-green-500 w-3 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">1週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-green-500 w-3 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">2週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-green-500 w-3 h-28 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">3週</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-green-500 w-3 h-32 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">4週</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>80%</span>
                                    <span>95%</span>
                                </div>
                            </div>

                            <!-- 各房型滿意度 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">各房型滿意度</h3>
                                <div class="space-y-3">
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">標準犬房</span>
                                            <div class="flex items-center gap-1">
                                                <div class="flex text-yellow-400">
                                                    ★★★★★
                                                </div>
                                                <span class="text-sm font-bold text-yellow-600">4.9</span>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">(45 則評論)</div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">豪華貓別墅</span>
                                            <div class="flex items-center gap-1">
                                                <div class="flex text-yellow-400">
                                                    ★★★★★
                                                </div>
                                                <span class="text-sm font-bold text-yellow-600">4.7</span>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">(32 則評論)</div>
                                    </div>
                                    
                                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="text-sm font-medium text-gray-700">小型寵物寄宿籠</span>
                                            <div class="flex items-center gap-1">
                                                <div class="flex text-yellow-400">
                                                    ★★★★☆
                                                </div>
                                                <span class="text-sm font-bold text-yellow-600">4.5</span>
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500">(28 則評論)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 改進建議 -->
                            <div>
                                <h3 class="text-sm font-medium text-[#181111] mb-2">改進建議</h3>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="space-y-2">
                                        <div class="flex items-start gap-2">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full mt-2"></div>
                                            <div>
                                                <div class="text-xs font-medium text-gray-700">提升服務速度</div>
                                                <div class="text-xs text-gray-500">3% 的評論提到服務速度可以更快</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <div class="w-2 h-2 bg-green-500 rounded-full mt-2"></div>
                                            <div>
                                                <div class="text-xs font-medium text-gray-700">增加戶外活動空間</div>
                                                <div class="text-xs text-gray-500">5% 的評論希望有更多戶外活動</div>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <div class="w-2 h-2 bg-yellow-500 rounded-full mt-2"></div>
                                            <div>
                                                <div class="text-xs font-medium text-gray-700">改善網路連線</div>
                                                <div class="text-xs text-gray-500">2% 的評論提到網路連線不穩定</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 即時監控內容 -->
                        <div id="monitoring-content" class="analytics-content hidden">
                            <!-- 最後更新時間 -->
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm font-medium text-[#181111]">即時監控</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">最後更新: 14:35</span>
                                    <button id="refresh-monitoring-btn" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">🔄 刷新</button>
                                </div>
                            </div>

                            <!-- 今日關鍵指標 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-3">今日關鍵指標</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <!-- 今日營收 -->
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-medium text-blue-700">💰 今日營收</span>
                                            <span class="text-xs text-green-600">↗️ +12%</span>
                                        </div>
                                        <div class="text-lg font-bold text-blue-800">NT$ 8,500</div>
                                        <div class="text-xs text-blue-600 mt-1">目標達成率: 85%</div>
                                    </div>
                                    
                                    <!-- 入住狀況 -->
                                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-medium text-green-700">🏠 入住狀況</span>
                                            <span class="text-xs text-green-600">正常</span>
                                        </div>
                                        <div class="text-lg font-bold text-green-800">68%</div>
                                        <div class="text-xs text-green-600 mt-1">22/32 間已入住</div>
                                    </div>
                                    
                                    <!-- 訂單狀態 -->
                                    <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-medium text-yellow-700">📋 訂單狀態</span>
                                            <span class="text-xs text-yellow-600">⚠️ 5筆待處理</span>
                                        </div>
                                        <div class="text-lg font-bold text-yellow-800">12</div>
                                        <div class="text-xs text-yellow-600 mt-1">今日新增訂單</div>
                                    </div>
                                    
                                    <!-- 客戶滿意度 -->
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-xs font-medium text-purple-700">😊 客戶滿意度</span>
                                            <span class="text-xs text-green-600">📈 穩定</span>
                                        </div>
                                        <div class="text-lg font-bold text-purple-800">4.8</div>
                                        <div class="text-xs text-purple-600 mt-1">3 則新增評論</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 異常警報 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-3">異常警報</h3>
                                <div class="space-y-2">
                                    <!-- 入住率異常警報 -->
                                    <div class="bg-red-50 border-l-4 border-red-400 rounded-lg p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-red-500">⚠️</span>
                                                <div>
                                                    <div class="text-sm font-medium text-red-800">入住率過低</div>
                                                    <div class="text-xs text-red-600">當前入住率僅 45%，低於正常範圍</div>
                                                </div>
                                            </div>
                                            <div class="text-xs text-red-500">14:30</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 正常狀態 -->
                                    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-green-500">✅</span>
                                                <div>
                                                    <div class="text-sm font-medium text-green-800">營收正常</div>
                                                    <div class="text-xs text-green-600">今日營收符合預期，無異常</div>
                                                </div>
                                            </div>
                                            <div class="text-xs text-green-500">14:35</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-green-500">✅</span>
                                                <div>
                                                    <div class="text-sm font-medium text-green-800">客戶滿意度正常</div>
                                                    <div class="text-xs text-green-600">平均評分 4.8，無負面評論</div>
                                                </div>
                                            </div>
                                            <div class="text-xs text-green-500">14:35</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-green-50 border-l-4 border-green-400 rounded-lg p-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <span class="text-green-500">✅</span>
                                                <div>
                                                    <div class="text-sm font-medium text-green-800">系統運作正常</div>
                                                    <div class="text-xs text-green-600">所有系統功能正常，無故障</div>
                                                </div>
                                            </div>
                                            <div class="text-xs text-green-500">14:35</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 即時趨勢圖表 -->
                            <div class="mb-4">
                                <h3 class="text-sm font-medium text-[#181111] mb-2">今日營收趨勢</h3>
                                <div class="bg-gray-50 rounded-lg p-3 h-32 flex items-end justify-between mb-2">
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-8 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">08</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-12 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">10</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-16 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">12</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-20 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">14</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-24 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">16</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-28 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">18</span>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="bg-blue-500 w-3 h-32 rounded-t"></div>
                                        <span class="text-xs text-gray-600 mt-1">20</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>NT$ 0</span>
                                    <span>NT$ 10,000</span>
                                </div>
                            </div>

                            <!-- 快速操作 -->
                            <div>
                                <h3 class="text-sm font-medium text-[#181111] mb-3">快速操作</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="view-pending-orders-btn-2" class="bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showPendingOrdersModal()">
                                        📋 查看待處理訂單
                                    </button>
                                    <button id="check-room-status-btn-2" class="bg-green-50 hover:bg-green-100 text-green-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showRoomStatusModal()">
                                        🏠 檢查房況
                                    </button>
                                    <button id="reply-comments-btn-2" class="bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showReplyCommentsModal()">
                                        💬 回覆評論
                                    </button>
                                    <button id="detailed-reports-btn-2" class="bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg p-3 text-sm font-medium transition-colors" onclick="showDetailedReportsModal()">
                                        📊 詳細報表
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                
                // 綁定快速操作按鈕事件
                attachMerchantDashboardListeners();
            }
            
            // 商家儀表板事件監聽器
            function attachMerchantDashboardListeners() {
                // 使用 setTimeout 確保 DOM 元素已經渲染
                setTimeout(() => {
                    console.log('開始綁定商家儀表板事件監聽器');
                    
                    // 查看待處理訂單按鈕
                    const pendingOrdersBtn1 = document.getElementById('view-pending-orders-btn');
                    const pendingOrdersBtn2 = document.getElementById('view-pending-orders-btn-2');
                    
                    console.log('找到按鈕1:', !!pendingOrdersBtn1);
                    console.log('找到按鈕2:', !!pendingOrdersBtn2);
                    
                    if (pendingOrdersBtn1) {
                        // 移除舊的事件監聽器（如果有的話）
                        pendingOrdersBtn1.replaceWith(pendingOrdersBtn1.cloneNode(true));
                        const newBtn1 = document.getElementById('view-pending-orders-btn');
                        newBtn1.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了查看待處理訂單按鈕');
                            showPendingOrdersModal();
                        });
                    }
                    
                    if (pendingOrdersBtn2) {
                        // 移除舊的事件監聽器（如果有的話）
                        pendingOrdersBtn2.replaceWith(pendingOrdersBtn2.cloneNode(true));
                        const newBtn2 = document.getElementById('view-pending-orders-btn-2');
                        newBtn2.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了查看待處理訂單按鈕-2');
                            showPendingOrdersModal();
                        });
                    }
                    
                    // 檢查房況按鈕
                    const roomStatusBtn1 = document.getElementById('check-room-status-btn');
                    const roomStatusBtn2 = document.getElementById('check-room-status-btn-2');
                    
                    console.log('找到房況按鈕1:', !!roomStatusBtn1);
                    console.log('找到房況按鈕2:', !!roomStatusBtn2);
                    
                    if (roomStatusBtn1) {
                        // 移除舊的事件監聽器（如果有的話）
                        roomStatusBtn1.replaceWith(roomStatusBtn1.cloneNode(true));
                        const newRoomBtn1 = document.getElementById('check-room-status-btn');
                        newRoomBtn1.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了檢查房況按鈕');
                            showRoomStatusModal();
                        });
                    }
                    
                    if (roomStatusBtn2) {
                        // 移除舊的事件監聽器（如果有的話）
                        roomStatusBtn2.replaceWith(roomStatusBtn2.cloneNode(true));
                        const newRoomBtn2 = document.getElementById('check-room-status-btn-2');
                        newRoomBtn2.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了檢查房況按鈕-2');
                            showRoomStatusModal();
                        });
                    }
                    
                    // 回覆評論按鈕
                    const replyCommentsBtn1 = document.getElementById('reply-comments-btn');
                    const replyCommentsBtn2 = document.getElementById('reply-comments-btn-2');
                    
                    console.log('找到回覆評論按鈕1:', !!replyCommentsBtn1);
                    console.log('找到回覆評論按鈕2:', !!replyCommentsBtn2);
                    
                    if (replyCommentsBtn1) {
                        replyCommentsBtn1.replaceWith(replyCommentsBtn1.cloneNode(true));
                        const newReplyBtn1 = document.getElementById('reply-comments-btn');
                        newReplyBtn1.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了回覆評論按鈕');
                            showReplyCommentsModal();
                        });
                    }
                    
                    if (replyCommentsBtn2) {
                        replyCommentsBtn2.replaceWith(replyCommentsBtn2.cloneNode(true));
                        const newReplyBtn2 = document.getElementById('reply-comments-btn-2');
                        newReplyBtn2.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了回覆評論按鈕-2');
                            showReplyCommentsModal();
                        });
                    }
                    
                    // 詳細報表按鈕
                    const detailedReportsBtn1 = document.getElementById('detailed-reports-btn');
                    const detailedReportsBtn2 = document.getElementById('detailed-reports-btn-2');
                    
                    console.log('找到詳細報表按鈕1:', !!detailedReportsBtn1);
                    console.log('找到詳細報表按鈕2:', !!detailedReportsBtn2);
                    
                    if (detailedReportsBtn1) {
                        detailedReportsBtn1.replaceWith(detailedReportsBtn1.cloneNode(true));
                        const newReportsBtn1 = document.getElementById('detailed-reports-btn');
                        newReportsBtn1.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了詳細報表按鈕');
                            showDetailedReportsModal();
                        });
                    }
                    
                    if (detailedReportsBtn2) {
                        detailedReportsBtn2.replaceWith(detailedReportsBtn2.cloneNode(true));
                        const newReportsBtn2 = document.getElementById('detailed-reports-btn-2');
                        newReportsBtn2.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('點擊了詳細報表按鈕-2');
                            showDetailedReportsModal();
                        });
                    }
                }, 100);
            }

            function renderRoomListPage() {
                const container = pages.roomManagement;
                container.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-[#181111]">房型管理</h1>
                            <button id="add-new-room-btn" class="btn-main h-10 px-5 text-sm w-auto">＋ 新增房型</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${mockRoomTypes.map(room => `
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-4">
                                        <img src="${room.imageUrl}" class="w-20 h-20 rounded-lg object-cover">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-[#181111] truncate">${room.name}</h3>
                                                <span class="text-xs font-semibold ${room.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'} px-2 py-0.5 rounded-full">${room.status === 'active' ? '啟用中' : '已禁用'}</span>
                                            </div>
                                            <p class="text-sm text-[#886364] mt-1 truncate">${room.description}</p>
                                            <p class="text-sm font-bold text-[#181111] mt-2">總庫存: ${room.stock} 間</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button class="py-1 px-3 bg-red-100 text-red-600 rounded-full text-xs font-medium">刪除</button>
                                        <button class="edit-room-btn py-1 px-3 bg-gray-200 text-gray-800 rounded-full text-xs font-medium" data-room-id="${room.id}">編輯</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                         <div class="pt-4 mt-2">
                            <button id="back-to-dashboard-btn" class="flex cursor-pointer items-center justify-center w-full h-12 rounded-full bg-gray-200 text-[#181111] font-bold">返回商家專區</button>
                        </div>
                    </div>
                `;
            }

            function renderRoomForm(roomId) {
                const roomData = roomId ? mockRoomTypes.find(r => r.id === roomId) : null;
                const isEditing = !!roomData;
                
                formModal.innerHTML = `
                    <div class="p-4 overflow-y-auto max-h-full">
                         <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                            <button id="cancel-form-btn" class="text-lg font-bold p-2">&lt; 返回</button>
                            <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">${isEditing ? '編輯房型' : '新增房型'}</h1>
                            <div class="w-20"></div>
                        </div>
                        <div class="space-y-4 px-2">
                            <div>
                                <label class="text-sm font-medium text-[#886364]">房型名稱</label>
                                <input type="text" class="form-input-styled mt-1" value="${isEditing ? roomData.name : ''}">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">房型描述</label>
                                <textarea class="form-input-styled mt-1 h-24">${isEditing ? roomData.description : ''}</textarea>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">圖片上傳</label>
                                <div class="mt-1 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                                    <div class="text-center">
                                        <p class="mt-1 text-sm leading-6 text-gray-600">拖曳或點擊上傳</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-[#886364]">適用寵物種類</label>
                                <div class="space-y-2 mt-2">
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-black focus:ring-black" name="pet-type" value="dog"> <span class="ml-2 text-sm">狗</span></label>
                                    <div id="dog-size-options" class="hidden pl-6 space-y-2">
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">小型犬 (0-10公斤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">中型犬 (10-20公斤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">大型犬 (20公斤以上)</span></label>
                                    </div>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">貓</span></label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">可容納寵物數</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? 1 : 1}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">房型總庫存</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? roomData.stock : 1}">
                                </div>
                            </div>
                            
                            <div class="border-t pt-4">
                                <h3 class="text-sm font-bold text-[#181111] mb-2">服務類型與價格設定</h3>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">服務類型</label>
                                    <div class="flex space-x-4 mt-1">
                                        <label class="flex items-center">
                                            <input type="radio" name="service-type" value="overnight" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && roomData.serviceType === 'overnight' ? 'checked' : !isEditing ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                            <span class="ml-2 text-sm">日租 (過夜寄宿)</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="service-type" value="daycare" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && roomData.serviceType === 'daycare' ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                            <span class="ml-2 text-sm">時租 (日間安親)</span>
                                        </label>
                                    </div>
                                    ${isEditing ? '<p class="text-xs text-red-500 mt-1">服務類型儲存後不可修改。</p>' : ''}
                                </div>
                                
                                <!-- 日租價格設定 -->
                                <div id="overnight-pricing-fields" class="${!isEditing || roomData.serviceType === 'overnight' ? '' : 'hidden'} mt-4 space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-[#886364]">每晚價格 (NT$)</label>
                                        <input type="number" class="form-input-styled mt-1" id="base-price-overnight" value="${isEditing && roomData.serviceType === 'overnight' ? roomData.basePrice : ''}" min="0" placeholder="例如：800">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm font-medium text-[#886364]">最短預訂天數</label>
                                            <input type="number" class="form-input-styled mt-1" id="min-nights" value="${isEditing && roomData.serviceType === 'overnight' ? roomData.minNights : 1}" min="1">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-[#886364]">最長預訂天數 (選填)</label>
                                            <input type="number" class="form-input-styled mt-1" id="max-nights" value="${isEditing && roomData.serviceType === 'overnight' ? roomData.maxNights || '' : ''}" min="1" placeholder="無限制">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 時租價格設定 -->
                                <div id="daycare-pricing-fields" class="${isEditing && roomData.serviceType === 'daycare' ? '' : 'hidden'} mt-4 space-y-3">
                                    <div>
                                        <label class="text-sm font-medium text-[#886364]">每小時價格 (NT$)</label>
                                        <input type="number" class="form-input-styled mt-1" id="hourly-rate" value="${isEditing && roomData.serviceType === 'daycare' ? roomData.hourlyRate : ''}" min="0" placeholder="例如：150">
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-[#886364]">最小預訂時數</label>
                                        <input type="number" class="form-input-styled mt-1" id="min-hours" value="${isEditing && roomData.serviceType === 'daycare' ? roomData.minHours : 4}" min="1" placeholder="例如：4">
                                        <p class="text-xs text-gray-500 mt-1">最小時數後，之後以每小時為單位計費</p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="text-sm font-medium text-[#886364]">可預訂開始時間</label>
                                            <input type="time" class="form-input-styled mt-1" id="start-time" value="${isEditing && roomData.serviceType === 'daycare' ? roomData.startTime : '09:00'}">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-[#886364]">可預訂結束時間</label>
                                            <input type="time" class="form-input-styled mt-1" id="end-time" value="${isEditing && roomData.serviceType === 'daycare' ? roomData.endTime : '18:00'}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                             <div class="flex justify-between items-center">
                                <label class="text-sm font-medium text-[#886364]">啟用狀態</label>
                                <label class="toggle-switch"><input type="checkbox" ${isEditing && roomData.status === 'active' ? 'checked' : !isEditing ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="mt-6">
                             <button class="btn-main">儲存房型</button>
                        </div>
                    </div>
                `;
                formModal.classList.remove('hidden');
                
                // 綁定服務類型切換事件
                const serviceTypeRadios = formModal.querySelectorAll('input[name="service-type"]');
                serviceTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const overnightFields = formModal.querySelector('#overnight-pricing-fields');
                        const daycareFields = formModal.querySelector('#daycare-pricing-fields');
                        overnightFields.classList.toggle('hidden', this.value !== 'overnight');
                        daycareFields.classList.toggle('hidden', this.value !== 'daycare');
                    });
                });
            }


            // --- 日曆功能 ---
            function openCalendar() {
                calendarModal.classList.remove('hidden');
                renderCalendar();
            }

            function renderCalendar() {
                const content = calendarModal.querySelector('.modal-content');
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h3 class="font-bold">${currentCalendarDate.getFullYear()}年 ${currentCalendarDate.getMonth() + 1}月</h3>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 text-center text-sm gap-1"></div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="calendar-cancel" class="py-2 px-4 rounded-full bg-gray-200 text-sm">取消</button>
                        <button id="calendar-confirm" class="py-2 px-4 rounded-full bg-[#181111] text-white text-sm">確定</button>
                    </div>`;

                const daysGrid = document.getElementById('calendar-days');
                const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1).getDay();
                const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    daysGrid.innerHTML += `<div></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), i);
                    const today = new Date(); today.setHours(0,0,0,0);
                    let classes = 'calendar-day';
                    if (dayDate < today) classes += ' disabled';
                    if (selectedCheckinDate && dayDate.getTime() === selectedCheckinDate.getTime()) classes += ' range-start';
                    if (selectedCheckoutDate && dayDate.getTime() === selectedCheckoutDate.getTime()) classes += ' range-end';
                    if (selectedCheckinDate && selectedCheckoutDate && dayDate > selectedCheckinDate && dayDate < selectedCheckoutDate) classes += ' in-range';
                    
                    daysGrid.innerHTML += `<div class="${classes}" data-date="${dayDate.toISOString().split('T')[0]}">${i}</div>`;
                }
            }
            
            function handleDateClick(e) {
                if (!e.target.matches('.calendar-day:not(.disabled)')) return;
                const clickedDate = new Date(e.target.dataset.date);
                if (isSelectingCheckin || clickedDate < selectedCheckinDate) {
                    selectedCheckinDate = clickedDate;
                    selectedCheckoutDate = null;
                    isSelectingCheckin = false;
                } else {
                    selectedCheckoutDate = clickedDate;
                    isSelectingCheckin = true;
                }
                renderCalendar();
            }

            function updatePrice() {
                const priceDisplay = document.getElementById('total-price-display');
                if (!priceDisplay) return;

                const selectedPackage = document.querySelector('.package-item.selected');
                if (!selectedPackage) {
                    priceDisplay.textContent = '請選擇房型';
                    return;
                }

                let total = 0;
                const roomId = parseInt(selectedPackage.dataset.roomId);
                const serviceType = selectedPackage.dataset.serviceType;
                const room = mockRoomTypes.find(r => r.id === roomId);
                
                if (!room) {
                    priceDisplay.textContent = '請選擇房型';
                    return;
                }
                
                if (serviceType === 'overnight' && room.serviceType === 'overnight') {
                    // 寄宿方案：根據住宿天數計算
                    if (selectedCheckinDate && selectedCheckoutDate && selectedCheckoutDate > selectedCheckinDate) {
                        const nights = Math.ceil((selectedCheckoutDate - selectedCheckinDate) / (1000 * 60 * 60 * 24));
                        total = (room.basePrice || 0) * nights;
                    } else {
                        priceDisplay.textContent = '請選擇有效日期';
                        return;
                    }
                } else if (serviceType === 'daycare' && room.serviceType === 'daycare') {
                    // 日間安親方案：檢查是否已選擇時段
                    const selectedTimeSlot = document.querySelector('.time-slot-btn.selected');
                    if (!selectedTimeSlot) {
                        priceDisplay.textContent = '請選擇時段';
                        return;
                    }
                    // 日間安親方案：基於時長計算
                    const minHours = room.minHours || 4;
                    const hourlyRate = room.hourlyRate || 0;
                    total = hourlyRate * minHours; // 預設最小時數
                }
                
                const petCount = parseInt(document.getElementById('pet-count')?.value || 1);
                total *= petCount;

                document.querySelectorAll('.addon-service:checked').forEach(cb => {
                    total += parseInt(cb.dataset.price);
                });

                priceDisplay.textContent = `總計: NT$ ${total.toLocaleString()}`;
            }
            
            // 檢查指定日期範圍內的房間庫存
            function checkRoomAvailability(roomId, startDate, endDate) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                if (!room || room.status !== 'active') return 0;
                
                // 計算該日期範圍內的預訂數量
                const conflictingBookings = mockBookings.filter(booking => {
                    if (booking.roomId !== roomId) return false;
                    
                    const bookingStart = new Date(booking.startDate);
                    const bookingEnd = new Date(booking.endDate);
                    const checkStart = new Date(startDate);
                    const checkEnd = new Date(endDate);
                    
                    // 檢查日期重疊
                    return (bookingStart <= checkEnd && bookingEnd >= checkStart);
                });
                
                const usedCapacity = conflictingBookings.length;
                return Math.max(0, room.stock - usedCapacity);
            }
            
            // 渲染房型選項
            function renderRoomOptions() {
                const container = document.getElementById('room-options-container');
                if (!container) return;
                
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                const startDate = selectedCheckinDate ? selectedCheckinDate.toISOString().split('T')[0] : today.toISOString().split('T')[0];
                const endDate = selectedCheckoutDate ? selectedCheckoutDate.toISOString().split('T')[0] : tomorrow.toISOString().split('T')[0];
                
                let roomOptionsHTML = '';
                
                // 根據假資料渲染房型（直接使用 mockRoomTypes）
                mockRoomTypes.filter(room => room.status === 'active').forEach((room, roomIndex) => {
                    const availableStock = checkRoomAvailability(room.id, startDate, endDate);
                    const isAvailable = availableStock > 0;
                    const isFirstRoom = roomIndex === 0;
                    
                    // 根據服務類型顯示價格
                    let priceDisplay = '';
                    let priceUnit = '';
                    if (room.serviceType === 'overnight' && room.basePrice) {
                        priceDisplay = room.basePrice.toLocaleString();
                        priceUnit = '/ 晚';
                    } else if (room.serviceType === 'daycare' && room.hourlyRate) {
                        const minPrice = room.hourlyRate * (room.minHours || 4);
                        priceDisplay = minPrice.toLocaleString();
                        priceUnit = `/ ${room.minHours || 4}hr起`;
                    }
                    
                    if (!priceDisplay) return; // 跳過沒有價格設定的房型
                    
                    roomOptionsHTML += `
                        <div class="p-3 rounded-lg border-2 border-transparent ${!isAvailable ? 'unavailable' : ''}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-sm ${!isAvailable ? 'text-gray-400' : 'text-[#181111]'}">${room.name}</p>
                                    <p class="text-xs text-gray-500 mt-1">${room.description}</p>
                                    ${!isAvailable ? '<p class="text-xs text-red-500 mt-1">❌ 已滿房</p>' : `<p class="text-xs text-green-600 mt-1">✅ 可訂房 (剩餘 ${availableStock} 間)</p>`}
                                </div>
                            </div>
                            <div class="space-y-2 mt-2">
                                <div class="package-wrapper">
                                    <div class="package-item p-3 rounded-lg ${isAvailable ? 'cursor-pointer' : ''} ${isFirstRoom && isAvailable ? 'selected' : ''}" 
                                         data-room-id="${room.id}"
                                         data-service-type="${room.serviceType}"
                                         ${!isAvailable ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm">${room.serviceType === 'overnight' ? '日租' : '時租'}</span>
                                            <span class="font-bold text-sm">NT$ ${priceDisplay} ${priceUnit}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = roomOptionsHTML;
                
                // 重新綁定事件監聽器
                attachRoomOptionListeners();
            }
            
            // 訂房流程相關變數
            let bookingStep = 1;
            let bookingData = {
                serviceType: '',
                dates: { checkin: null, checkout: null },
                timeSlot: '',
                roomId: null,
                preferredRoomId: null, // 用戶偏好的房型
                petCount: 1,
                addons: [],
                serviceDate: null, // 日間安親的服務日期
                checkinDate: null, // 入住日期
                checkoutDate: null, // 退房日期
                stayDuration: null, // 入住天數
                duration: null, // 日間安親時長（小時）
                startTime: null, // 時租開始時間
                endTime: null, // 時租結束時間
                customPrice: null, // 自訂價格
                timeSlotName: null // 時段名稱
            };
            
            // 渲染訂房流程頁面
            function renderBookingFlowPage() {
                const container = pages.bookingFlow;
                
                if (bookingStep === 4) {
                    renderConfirmationStep();
                } else {
                    // 如果出現其他步驟，回到詳情頁
                    showPage('detail');
                }
            }
            

            
            // 步驟2: 選擇日期時間
            function renderDateTimeStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- 標題與進度 -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">選擇${isOvernight ? '日期' : '日期與時段'}</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">步驟 1/3</p>
                            </div>
                        </div>
                        
                        <!-- 日期選擇 -->
                        <div class="space-y-4 mb-8">
                            ${isOvernight ? `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">入住/退房日期</h3>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="booking-checkin" class="form-input-styled text-center flex-1">
                                        <span class="text-gray-400">-</span>
                                        <input type="date" id="booking-checkout" class="form-input-styled text-center flex-1">
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">選擇日期</h3>
                                    <input type="date" id="booking-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">選擇時段</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-13:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">上午時段</span>
                                                <span class="text-sm text-gray-500">09:00-13:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="14:00-18:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">下午時段</span>
                                                <span class="text-sm text-gray-500">14:00-18:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-17:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">全日時段</span>
                                                <span class="text-sm text-gray-500">09:00-17:00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <!-- 底部按鈕 -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                繼續
                            </button>
                        </div>
                    </div>
                `;
                
                attachDateTimeListeners();
            }
            
            // 綁定日期時間選擇事件
            function attachDateTimeListeners() {
                const isOvernight = bookingData.serviceType === 'overnight';
                
                if (isOvernight) {
                    // 寄宿服務的日期處理
                    const checkinInput = document.getElementById('booking-checkin');
                    const checkoutInput = document.getElementById('booking-checkout');
                    
                    // 設定預設日期
                    const today = new Date();
                    const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // 立即更新資料並啟用按鈕
                    bookingData.dates.checkin = checkinInput.value;
                    bookingData.dates.checkout = checkoutInput.value;
                    enableNextButton();
                    
                    checkinInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        // 確保退房日期不早於入住日期
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            bookingData.dates.checkout = checkoutInput.value;
                        }
                        checkDatesValid();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        bookingData.dates.checkout = this.value;
                        checkDatesValid();
                    });
                    
                } else {
                    // 安親服務的日期和時段處理
                    const dateInput = document.getElementById('booking-date');
                    const today = new Date();
                    dateInput.value = today.toISOString().split('T')[0];
                    bookingData.dates.checkin = dateInput.value;
                    
                    dateInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        checkDatesValid();
                    });
                    
                    // 時段選擇
                    document.querySelectorAll('.time-slot-option').forEach(option => {
                        option.addEventListener('click', function() {
                            // 移除其他選項的選中狀態
                            document.querySelectorAll('.time-slot-option').forEach(opt => {
                                opt.classList.remove('border-[#181111]', 'bg-gray-50');
                                opt.classList.add('border-gray-200');
                            });
                            
                            // 選中當前選項
                            this.classList.remove('border-gray-200');
                            this.classList.add('border-[#181111]', 'bg-gray-50');
                            
                            bookingData.timeSlot = this.dataset.slot;
                            checkDatesValid();
                        });
                    });
                }
                
                function checkDatesValid() {
                    const nextBtn = document.getElementById('next-step-btn');
                    if (isOvernight) {
                        if (bookingData.dates.checkin && bookingData.dates.checkout) {
                            enableNextButton();
                        }
                    } else {
                        if (bookingData.dates.checkin && bookingData.timeSlot) {
                            enableNextButton();
                        }
                    }
                }
                
                function enableNextButton() {
                    const nextBtn = document.getElementById('next-step-btn');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // 繼續按鈕事件
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 3;
                        renderBookingFlowPage();
                    }
                });
                
                // 返回按鈕事件
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    showPage('detail');
                });
            }
            
            // 步驟3: 選擇房型
            function renderRoomSelectionStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 根據服務類型過濾房型，並根據用戶偏好排序
                let availableRooms = mockRoomTypes.filter(room => room.status === 'active');
                
                // 如果用戶有偏好房型，優先顯示
                if (bookingData.preferredRoomId) {
                    availableRooms = availableRooms.sort((a, b) => {
                        if (a.id === bookingData.preferredRoomId) return -1;
                        if (b.id === bookingData.preferredRoomId) return 1;
                        return 0;
                    });
                }
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- 標題與進度 -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">選擇房型</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">步驟 1/2</p>
                            </div>
                        </div>
                        
                        <!-- 選擇摘要 -->
                        <div class="bg-blue-50 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-800">
                                <span class="font-medium">${isOvernight ? '寄宿過夜' : '日間安親'}</span>
                                ${isOvernight ? 
                                    ` • ${bookingData.dates.checkin} 至 ${bookingData.dates.checkout}` :
                                    ` • ${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                }
                            </p>
                        </div>
                        
                        <!-- 房型選擇 -->
                        <div class="space-y-4 mb-8">
                            <h2 class="text-lg font-bold text-[#181111]">選擇適合的房型</h2>
                            
                            <div class="space-y-3">
                                ${availableRooms.map(room => {
                                    // 只顯示符合服務類型的房型
                                    if (room.serviceType !== bookingData.serviceType) return '';
                                    
                                    const startDate = bookingData.dates.checkin;
                                    const endDate = bookingData.dates.checkout || startDate;
                                    const availableStock = checkRoomAvailability(room.id, startDate, endDate);
                                    const isAvailable = availableStock > 0;
                                    
                                    const isPreferred = room.id === bookingData.preferredRoomId;
                                    
                                    // 根據服務類型顯示價格
                                    let priceDisplay = '';
                                    if (room.serviceType === 'overnight' && room.basePrice) {
                                        priceDisplay = `NT$ ${room.basePrice.toLocaleString()} / 晚`;
                                    } else if (room.serviceType === 'daycare' && room.hourlyRate) {
                                        priceDisplay = `NT$ ${room.hourlyRate.toLocaleString()} / 小時 (最小 ${room.minHours || 4} 小時)`;
                                    }
                                    
                                    return `
                                        <div class="room-selection-card p-4 rounded-xl border-2 ${isPreferred ? 'border-blue-400 bg-blue-50' : 'border-gray-200'} ${isAvailable ? 'cursor-pointer hover:border-[#181111]' : 'opacity-60'} transition-all" 
                                             data-room-id="${room.id}" 
                                             ${!isAvailable ? 'data-unavailable="true"' : ''}>
                                            <div class="flex items-start">
                                                <img src="${room.imageUrl}" alt="${room.name}" class="w-20 h-20 rounded-lg object-cover mr-4">
                                                <div class="flex-1">
                                                    <h3 class="font-bold text-[#181111] mb-1">
                                                        ${room.name}
                                                        ${isPreferred ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full ml-2">推薦</span>' : ''}
                                                    </h3>
                                                    <p class="text-sm text-gray-500 mb-2">${room.description}</p>
                                                    ${isAvailable ? 
                                                        `<p class="text-xs text-green-600">✅ 可訂房 (剩餘 ${availableStock} 間)</p>` :
                                                        `<p class="text-xs text-red-500">❌ 已滿房</p>`
                                                    }
                                                    <div class="mt-2">
                                                        <div class="text-sm">
                                                            <span class="font-medium">${room.serviceType === 'overnight' ? '日租' : '時租'}</span>
                                                            <span class="text-[#181111] font-bold ml-2">${priceDisplay}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).filter(html => html).join('')}
                            </div>
                        </div>
                        
                        <!-- 底部按鈕 -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                繼續
                            </button>
                        </div>
                    </div>
                `;
                
                attachRoomSelectionListeners();
            }
            
            // 綁定房型選擇事件
            function attachRoomSelectionListeners() {
                document.querySelectorAll('.room-selection-card').forEach(card => {
                    card.addEventListener('click', function() {
                        if (this.dataset.unavailable === 'true') return;
                        
                        // 移除其他卡片的選中狀態
                        document.querySelectorAll('.room-selection-card').forEach(c => {
                            c.classList.remove('border-[#181111]', 'bg-gray-50');
                            c.classList.add('border-gray-200');
                        });
                        
                        // 選中當前卡片
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-gray-50');
                        
                        // 更新資料
                        bookingData.roomId = parseInt(this.dataset.roomId);
                        
                        // 啟用繼續按鈕
                        const nextBtn = document.getElementById('next-step-btn');
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                });
                
                // 繼續按鈕事件
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 4;
                        renderBookingFlowPage();
                    }
                });
                
                // 返回按鈕事件
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // 從房型選擇返回詳情頁
                    showPage('detail');
                });
                        }
            
            // 步驟4: 確認訂單
            function renderConfirmationStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 取得選中的房型資訊
                const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                
                // 計算價格
                let basePrice = 0;
                let totalPrice = 0;
                
                if (selectedRoom) {
                    if (isOvernight && selectedRoom.serviceType === 'overnight') {
                        basePrice = selectedRoom.basePrice || 0;
                        if (bookingData.dates.checkin && bookingData.dates.checkout) {
                            const checkinDate = new Date(bookingData.dates.checkin);
                            const checkoutDate = new Date(bookingData.dates.checkout);
                            const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                            totalPrice = basePrice * nights;
                        }
                    } else if (!isOvernight && selectedRoom.serviceType === 'daycare') {
                        basePrice = selectedRoom.hourlyRate || 0;
                        const minHours = selectedRoom.minHours || 4;
                        const duration = bookingData.duration || minHours;
                        totalPrice = basePrice * duration;
                    }
                }
                
                totalPrice *= bookingData.petCount;
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">確認訂單</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">確認您的預訂資訊</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-8">
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">訂單詳情</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">服務類型</span>
                                        <span class="font-medium">${isOvernight ? '寄宿過夜' : '日間安親'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">日期時間</span>
                                        <span class="font-medium">
                                            ${isOvernight ? 
                                                `${bookingData.dates.checkin} 至 ${bookingData.dates.checkout}` :
                                                `${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                            }
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">房型</span>
                                        <span class="font-medium">${selectedRoom ? selectedRoom.name : ''}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">服務類型</span>
                                        <span class="font-medium">${selectedRoom && selectedRoom.serviceType === 'overnight' ? '日租' : '時租'}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">住宿天數</span>
                                            <span class="font-medium">${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} 晚</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- 寵物數量和加購服務 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">其他選項</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">寵物數量</label>
                                        <div class="flex items-center border-2 border-[#f4f0f0] rounded-full p-1 w-fit">
                                            <button id="decrease-pet-count" class="px-3 py-1 text-lg font-bold">-</button>
                                            <input type="text" id="pet-count" value="${bookingData.petCount}" readonly class="w-10 text-center bg-transparent font-bold">
                                            <button id="increase-pet-count" class="px-3 py-1 text-lg font-bold">+</button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">加購服務</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">寵物洗澡 (NT$ 300)</span>
                                                <input type="checkbox" data-price="300" data-name="寵物洗澡" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">專人陪玩 (NT$ 200)</span>
                                                <input type="checkbox" data-price="200" data-name="專人陪玩" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">美容修剪 (NT$ 400)</span>
                                                <input type="checkbox" data-price="400" data-name="美容修剪" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="font-bold text-[#181111] mb-3">價格明細</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span>${selectedPackage ? selectedPackage.name : ''}</span>
                                        <span>NT$ ${basePrice.toLocaleString()}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between text-sm text-gray-600">
                                            <span>住宿天數</span>
                                            <span>× ${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} 晚</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>寵物數量</span>
                                        <span>× ${bookingData.petCount}</span>
                                    </div>
                                    <div id="addon-prices"></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>總計</span>
                                        <span id="final-total">NT$ ${totalPrice.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="confirm-booking-btn" class="btn-main w-full">
                                確認預訂
                            </button>
                        </div>
                    </div>
                `;
                
                attachConfirmationListeners();
            }
            
            // 綁定確認頁面事件
            function attachConfirmationListeners() {
                // 寵物數量調整
                document.getElementById('decrease-pet-count')?.addEventListener('click', function() {
                    if (bookingData.petCount > 1) {
                        bookingData.petCount--;
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    }
                });
                
                document.getElementById('increase-pet-count')?.addEventListener('click', function() {
                    bookingData.petCount++;
                    updatePriceTransparency();
                    checkCanContinueBooking();
                });
                
                // 加購服務
                document.querySelectorAll('.addon-service').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const price = parseInt(this.dataset.price);
                        const name = this.dataset.name;
                        
                        if (this.checked) {
                            bookingData.addons.push({ name, price });
                        } else {
                            bookingData.addons = bookingData.addons.filter(addon => addon.name !== name);
                        }
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // 確認預訂按鈕
                document.getElementById('confirm-booking-btn')?.addEventListener('click', function() {
                    // 顯示載入狀態
                    this.textContent = '處理中...';
                    this.disabled = true;
                    this.classList.add('opacity-50');
                    
                    // 模擬處理時間
                    setTimeout(() => {
                        alert('預訂成功！感謝您的預訂。');
                        showPage('detail');
                    }, 1500);
                });
                
                // 返回按鈕事件  
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // 返回詳情頁重新選擇
                    showPage('detail');
                });
            }
            
            // 更新確認頁面的顯示
            function updateConfirmationDisplay() {
                const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 更新寵物數量顯示
                const petCountInput = document.getElementById('pet-count');
                if (petCountInput) {
                    petCountInput.value = bookingData.petCount;
                }
                
                // 計算新的總價格（基於房型價格設定）
                let basePrice = 0;
                let totalPrice = 0;
                
                if (selectedRoom) {
                    if (isOvernight && selectedRoom.serviceType === 'overnight') {
                        basePrice = selectedRoom.basePrice || 0;
                        if (bookingData.dates.checkin && bookingData.dates.checkout) {
                            const checkinDate = new Date(bookingData.dates.checkin);
                            const checkoutDate = new Date(bookingData.dates.checkout);
                            const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                            totalPrice = basePrice * nights;
                        }
                    } else if (!isOvernight && selectedRoom.serviceType === 'daycare') {
                        basePrice = selectedRoom.hourlyRate || 0;
                        const minHours = selectedRoom.minHours || 4;
                        const duration = bookingData.duration || minHours;
                        totalPrice = basePrice * duration;
                    }
                }
                
                totalPrice *= bookingData.petCount;
                
                // 加購服務價格
                const addonTotal = bookingData.addons.reduce((sum, addon) => sum + addon.price, 0);
                totalPrice += addonTotal;
                
                // 更新價格顯示
                const totalElement = document.querySelector('#final-total');
                if (totalElement) {
                    totalElement.textContent = `NT$ ${totalPrice.toLocaleString()}`;
                }
                
                // 更新加購服務顯示
                const addonPricesElement = document.getElementById('addon-prices');
                if (addonPricesElement) {
                    addonPricesElement.innerHTML = bookingData.addons.map(addon => `
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${addon.name}</span>
                            <span>NT$ ${addon.price.toLocaleString()}</span>
                        </div>
                    `).join('');
                }
            }
            
            function renderCalendarManagementPage() {
                const container = pages.calendarManagement;
                const activeRooms = mockRoomTypes.filter(room => room.status === 'active');
                const selectedRoom = activeRooms.find(r => r.id === currentManagementRoomId) || activeRooms[0];

                
                if (!selectedRoom) {
                    container.innerHTML = `
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-4">
                                <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                                <h1 class="text-xl font-bold text-[#181111]">管理行事曆</h1>
                                <div class="w-8"></div>
                            </div>
                            <div class="text-center text-gray-500 mt-20">
                                <p>您還沒有建立任何房型</p>
                                <button class="btn-main mt-4" onclick="showPage('roomManagement')">前往建立房型</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="p-4">
                        <!-- 頁面標題與返回按鈕 -->
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                            <h1 class="text-xl font-bold text-[#181111]">管理行事曆</h1>
                            <div class="w-8"></div>
                        </div>

                        <!-- 房型選擇 -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">選擇房型</label>
                            <select id="room-type-select" class="form-input-styled">
                                ${activeRooms.map(room => `
                                    <option value="${room.id}" ${room.id === selectedRoom.id ? 'selected' : ''}>
                                        ${room.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <!-- 顯示模式選擇 -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">顯示模式</label>
                            <select id="view-mode-select" class="form-input-styled">
                                <option value="monthly" ${managementViewMode === 'monthly' ? 'selected' : ''}>月曆模式</option>
                                <option value="daily" ${managementViewMode === 'daily' ? 'selected' : ''}>時程模式</option>
                            </select>
                        </div>

                        <!-- 日曆區域 -->
                        <div id="calendar-container" class="bg-white rounded-xl border border-gray-100 p-4">
                            ${renderCalendarView(null, selectedRoom)}
                        </div>
                    </div>
                `;

                // 綁定事件監聽器
                attachCalendarManagementListeners();
            }

            function renderCalendarView(selectedPackage, selectedRoom) {
                const currentDate = managementCalendarDate;
                
                if (managementViewMode === 'monthly') {
                    return renderMonthlyCalendar(currentDate, selectedRoom);
                } else {
                    // 時程模式：直接從房型獲取時間設定
                    const daycareConfig = selectedRoom && selectedRoom.serviceType === 'daycare' ? {
                        startTime: selectedRoom.startTime || '09:00',
                        endTime: selectedRoom.endTime || '18:00',
                        name: '日間安親'
                    } : {
                        startTime: '09:00',
                        endTime: '18:00',
                        name: '日間安親'
                    };
                    return renderWeeklyCalendar(currentDate, daycareConfig, selectedRoom);
                }
            }

            function renderMonthlyCalendar(currentDate, selectedRoom) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-month-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${year}年 ${month + 1}月</h3>
                            <button id="next-month-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                `;

                // 填充月初空白
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div class="h-16"></div>';
                }

                // 生成日期格子
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isPast = date < today;
                    const stockInfo = calculateDailyStock(date, selectedRoom);
                    const stockClass = getStockColorClass(stockInfo.available);
                    
                    calendarHTML += `
                        <div class="calendar-day-cell h-16 border border-gray-200 rounded-lg p-1 cursor-pointer ${isPast ? 'opacity-50' : ''} ${stockClass}" 
                             data-date="${date.toISOString().split('T')[0]}" 
                             data-room-id="${selectedRoom.id}" 
                             data-view-mode="monthly">
                            <div class="text-xs font-medium">${day}</div>
                            <div class="text-xs ${stockInfo.available === 0 ? 'text-red-600' : 'text-gray-600'}">
                                ${stockInfo.available > 0 ? `空房 ${stockInfo.available}` : '已滿'}
                            </div>
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                return calendarHTML;
            }

            function renderWeeklyCalendar(currentDate, selectedPackage, selectedRoom) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // 生成詳細時間段 (每15分鐘一個時段)
                const timeSlots = generateTimeSlots(selectedPackage);
                
                // 生成房間列表，使用實際的房間庫存數量
                const rooms = Array.from({length: selectedRoom.stock}, (_, i) => ({
                    id: i + 1,
                    name: `${selectedRoom.name}`,
                    roomNumber: `${i + 1}號房`,
                    type: selectedRoom.name
                }));

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-day-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${formatDate(currentDate)}</h3>
                            <button id="next-day-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                        <div class="text-sm text-gray-600 text-center">
                            ${selectedRoom.name} (總計 ${selectedRoom.stock} 間)
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-96">
                        <div class="flex">
                            <!-- 時間軸 -->
                            <div class="flex-shrink-0 w-16 bg-gray-50 border-r">
                                <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium">時間</div>
                                ${timeSlots.map((slot, index) => `
                                    <div class="h-8 border-b flex items-center justify-center text-xs font-medium text-gray-800" style="min-height: 32px;">
                                        ${slot.startTime}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- 房間列 -->
                            ${rooms.map(room => `
                                <div class="flex-1 border-r min-w-0">
                                    <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium px-1">
                                        <div class="text-center w-full">
                                            <div class="text-xs font-medium">${room.roomNumber}</div>
                                        </div>
                                    </div>
                                    ${generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                return calendarHTML;
            }

            function generateTimeSlots(selectedPackage) {
                const slots = [];
                const startTime = selectedPackage.startTime || '09:00';
                const endTime = selectedPackage.endTime || '18:00';
                
                // 解析開始和結束時間
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // 以整點為單位生成時段 (例如 9:00-10:00, 10:00-11:00)
                for (let hour = startHour; hour < endHour; hour++) {
                    const startTimeStr = `${hour.toString().padStart(2, '0')}:00`;
                    const endTimeStr = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    
                    slots.push({
                        startTime: startTimeStr,
                        endTime: endTimeStr,
                        display: `${startTimeStr}`,
                        minutes: hour * 60 // 添加分鐘數便於計算
                    });
                }
                
                return slots;
            }

            function isPastTime(timeStr) {
                const now = new Date();
                const [hour, min] = timeStr.split(':').map(Number);
                const timeToCheck = new Date();
                timeToCheck.setHours(hour, min, 0, 0);
                return now > timeToCheck;
            }

            function isCurrentTimeSlot(startTime, endTime) {
                const now = new Date();
                const currentHour = now.getHours();
                
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // 檢查當前小時是否在這個整點時段內
                return currentHour >= startHour && currentHour < endHour;
            }

            function generateRoomTimeline(currentDate, room, timeSlots, selectedPackage, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // 獲取該房間的所有預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                let timelineHTML = '';
                let skipSlots = 0; // 用於跳過已被合併的時段
                
                for (let index = 0; index < timeSlots.length; index++) {
                    const slot = timeSlots[index];
                    
                    // 如果這個時段已被前面的預訂合併，跳過
                    if (skipSlots > 0) {
                        skipSlots--;
                        continue;
                    }
                    
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    
                    // 檢查是否有預訂覆蓋這個時段
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    if (booking) {
                        // 計算這個預訂跨越多少個時段
                        const bookingSpan = calculateBookingSpan(booking.timeSlot, timeSlots, index);
                        skipSlots = bookingSpan - 1; // 跳過後續的時段
                        
                        // 生成跨越多個時段的預訂格子
                        timelineHTML += `
                            <td class="border-r border-gray-200 h-10 cursor-pointer relative bg-red-400" 
                                colspan="${bookingSpan}"
                                data-date="${dateStr}"
                                data-time-slot="${booking.timeSlot}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                <div class="text-xs text-white text-center font-medium leading-tight px-1" style="font-size: 10px;">
                                    ${booking.customer}
                                </div>
                                <div class="text-xs text-red-100 text-center leading-tight px-1" style="font-size: 9px;">
                                    ${booking.timeSlot}
                                </div>
                            </td>
                        `;
                    } else {
                        // 生成空的可預訂格子
                        let cellClass = 'border-r border-gray-200 h-10 cursor-pointer relative bg-green-100 hover:bg-green-200';
                        let cellContent = '<div class="text-xs text-green-700 text-center mt-2" style="font-size: 9px;">可預訂</div>';
                        
                        // 添加當前時間線
                        if (isCurrentTime) {
                            cellContent += '<div class="absolute inset-0 border-l-4 border-green-500 current-time-line pointer-events-none"></div>';
                            cellContent += '<div class="absolute top-0 left-0 w-1 h-full bg-green-500 current-time-line pointer-events-none"></div>';
                        }
                        
                        timelineHTML += `
                            <td class="${cellClass}"
                                data-date="${dateStr}"
                                data-time-slot="${slot.startTime}-${slot.endTime}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                ${cellContent}
                            </td>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // 獲取該房間的所有預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // 創建時段狀態陣列
                const slotStates = timeSlots.map((slot, index) => {
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    return {
                        slot,
                        index,
                        isCurrentTime,
                        booking,
                        isBooked: !!booking,
                        processed: false
                    };
                });
                
                let timelineHTML = '';
                
                for (let i = 0; i < slotStates.length; i++) {
                    const currentState = slotStates[i];
                    
                    if (currentState.processed) {
                        continue;
                    }
                    
                    if (currentState.isBooked) {
                        // 處理預訂時段
                        const bookingSpan = calculateBookingSpan(currentState.booking.timeSlot, timeSlots, i);
                        
                        // 標記相關時段為已處理
                        for (let j = i; j < i + bookingSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = bookingSpan * 32; // 每個整點時段32px高度
                        
                        timelineHTML += `
                            <div class="border-b bg-red-400 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${currentState.booking.timeSlot}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-white font-medium leading-tight" style="font-size: 10px;">
                                        ${currentState.booking.customer}
                                    </div>
                                    <div class="text-xs text-red-100 leading-tight" style="font-size: 9px;">
                                        ${currentState.booking.timeSlot}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // 處理可預訂時段 - 尋找連續的可預訂時段
                        let availableSpan = 1;
                        let hasCurrentTime = currentState.isCurrentTime;
                        
                        // 計算連續的可預訂時段數量
                        for (let j = i + 1; j < slotStates.length; j++) {
                            if (slotStates[j].isBooked || slotStates[j].processed) {
                                break;
                            }
                            availableSpan++;
                            if (slotStates[j].isCurrentTime) {
                                hasCurrentTime = true;
                            }
                        }
                        
                        // 標記相關時段為已處理
                        for (let j = i; j < i + availableSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = availableSpan * 32; // 每個整點時段32px高度
                        
                        // 計算時間範圍顯示
                        const startTime = currentState.slot.startTime;
                        const endTime = timeSlots[i + availableSpan - 1]?.endTime || currentState.slot.endTime;
                        const timeRange = availableSpan > 1 ? `${startTime}-${endTime}` : `${startTime}-${currentState.slot.endTime}`;
                        
                        timelineHTML += `
                            <div class="border-b bg-green-100 hover:bg-green-200 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${timeRange}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-green-700 font-medium" style="font-size: 9px;">
                                        可預訂
                                    </div>
                                    ${availableSpan > 2 ? `<div class="text-xs text-green-600 leading-tight" style="font-size: 8px;">${timeRange}</div>` : ''}
                                </div>
                                ${hasCurrentTime ? '<div class="absolute left-0 top-0 w-full h-1 bg-green-500 current-time-line"></div>' : ''}
                            </div>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function getRoomBookings(dateStr, roomId) {
                // 模擬多天的預訂資料 (以整點為單位)
                const allBookings = {
                    // 今天 - 比較滿的一天
                    [getTodayString()]: [
                        { roomId: 1, timeSlot: '09:00-11:00', customer: '王小明', pet: '黃金獵犬' },
                        { roomId: 1, timeSlot: '14:00-16:00', customer: '李小華', pet: '英短貓' },
                        { roomId: 2, timeSlot: '10:00-12:00', customer: '陳大同', pet: '柴犬' },
                        { roomId: 2, timeSlot: '15:00-17:00', customer: '周雅婷', pet: '貴賓狗' },
                        { roomId: 3, timeSlot: '09:00-10:00', customer: '張美玲', pet: '波斯貓' },
                        { roomId: 3, timeSlot: '13:00-15:00', customer: '劉志明', pet: '哈士奇' },
                        // 4號房和5號房空房
                    ],
                    // 明天 - 輕鬆的一天
                    [getTomorrowString()]: [
                        { roomId: 1, timeSlot: '10:00-12:00', customer: '林美惠', pet: '摺耳貓' },
                        { roomId: 3, timeSlot: '14:00-16:00', customer: '張志偉', pet: '柯基犬' },
                        // 其他房間空房
                    ],
                    // 後天 - 忙碌的一天
                    [getDateString(2)]: [
                        { roomId: 1, timeSlot: '09:00-12:00', customer: '吳雅玲', pet: '哈士奇' },
                        { roomId: 1, timeSlot: '15:00-17:00', customer: '黃志明', pet: '貴賓狗' },
                        { roomId: 2, timeSlot: '09:00-11:00', customer: '陳佳慧', pet: '拉布拉多' },
                        { roomId: 2, timeSlot: '13:00-16:00', customer: '劉建國', pet: '黃金獵犬' },
                        { roomId: 3, timeSlot: '10:00-13:00', customer: '許雅婷', pet: '博美犬' },
                        { roomId: 4, timeSlot: '11:00-14:00', customer: '王大明', pet: '柴犬' },
                        { roomId: 5, timeSlot: '09:00-11:00', customer: '李小芳', pet: '英短貓' },
                        { roomId: 5, timeSlot: '16:00-18:00', customer: '蔡志豪', pet: '米克斯' },
                    ],
                    // 大後天 - 週末滿房
                    [getDateString(3)]: [
                        { roomId: 1, timeSlot: '09:00-13:00', customer: '周美玲', pet: '薩摩耶' },
                        { roomId: 1, timeSlot: '14:00-18:00', customer: '張家豪', pet: '阿拉斯加' },
                        { roomId: 2, timeSlot: '09:00-12:00', customer: '林志玲', pet: '吉娃娃' },
                        { roomId: 2, timeSlot: '13:00-17:00', customer: '王建民', pet: '法鬥' },
                        { roomId: 3, timeSlot: '09:00-14:00', customer: '陳美華', pet: '瑪爾濟斯' },
                        { roomId: 3, timeSlot: '15:00-18:00', customer: '劉德華', pet: '約克夏' },
                        { roomId: 4, timeSlot: '09:00-15:00', customer: '蔡依林', pet: '邊境牧羊犬' },
                        { roomId: 4, timeSlot: '16:00-18:00', customer: '郭富城', pet: '史賓格' },
                        { roomId: 5, timeSlot: '09:00-16:00', customer: '周杰倫', pet: '德國牧羊犬' },
                        { roomId: 5, timeSlot: '17:00-18:00', customer: '林俊傑', pet: '威爾斯柯基' },
                    ],
                    // 第五天 - 普通工作日
                    [getDateString(4)]: [
                        { roomId: 2, timeSlot: '10:00-13:00', customer: '何佳玲', pet: '雪納瑞' },
                        { roomId: 4, timeSlot: '14:00-17:00', customer: '呂志偉', pet: '西高地白梗' },
                    ],
                };
                
                const dayBookings = allBookings[dateStr] || [];
                return dayBookings.filter(b => b.roomId === roomId).map(b => ({
                    ...b,
                    date: dateStr
                }));
            }
            
            // 輔助函數：取得日期字串
            function getTodayString() {
                return new Date().toISOString().split('T')[0];
            }
            
            function getTomorrowString() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow.toISOString().split('T')[0];
            }
            
            function getDateString(daysFromNow) {
                const date = new Date();
                date.setDate(date.getDate() + daysFromNow);
                return date.toISOString().split('T')[0];
            }

            function calculateBookingSpan(bookingTimeSlot, timeSlots, startIndex) {
                const [bookingStart, bookingEnd] = bookingTimeSlot.split('-');
                const bookingStartMinutes = timeToMinutes(bookingStart);
                const bookingEndMinutes = timeToMinutes(bookingEnd);
                
                let span = 0;
                for (let i = startIndex; i < timeSlots.length; i++) {
                    const slot = timeSlots[i];
                    const slotStartMinutes = timeToMinutes(slot.startTime);
                    const slotEndMinutes = timeToMinutes(slot.endTime);
                    
                    // 如果時段與預訂有重疊，增加跨度
                    if (slotStartMinutes < bookingEndMinutes && slotEndMinutes > bookingStartMinutes) {
                        span++;
                    } else if (slotStartMinutes >= bookingEndMinutes) {
                        // 如果時段開始時間已經超過預訂結束時間，停止計算
                        break;
                    }
                }
                
                return Math.max(1, span); // 至少跨越1個時段
            }

            function timeToMinutes(timeStr) {
                const [hour, min] = timeStr.split(':').map(Number);
                return hour * 60 + min;
            }

            function getRoomBookingInfo(date, timeSlot, room, selectedPackage) {
                // 模擬預訂資料 - 根據房間ID和時間段生成一些預訂
                const dateStr = date.toISOString().split('T')[0];
                const timeKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                
                // 獲取房間預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // 檢查是否有預訂衝突
                const booking = roomBookings.find(b => 
                    isTimeSlotOverlap(b.timeSlot, timeKey)
                );
                
                if (booking) {
                    return {
                        isBooked: true,
                        customerName: booking.customer,
                        petInfo: booking.pet,
                        timeSlot: booking.timeSlot
                    };
                }
                
                return {
                    isBooked: false,
                    customerName: null,
                    petInfo: null,
                    timeSlot: null
                };
            }

            function isTimeSlotOverlap(bookedSlot, checkSlot) {
                // 簡化的時間重疊檢查
                const [bookedStart, bookedEnd] = bookedSlot.split('-');
                const [checkStart, checkEnd] = checkSlot.split('-');
                
                const bookedStartMin = timeToMinutes(bookedStart);
                const bookedEndMin = timeToMinutes(bookedEnd);
                const checkStartMin = timeToMinutes(checkStart);
                const checkEndMin = timeToMinutes(checkEnd);
                
                // 檢查是否有重疊
                return !(bookedEndMin <= checkStartMin || bookedStartMin >= checkEndMin);
            }

            function calculateDailyStock(date, room) {
                const totalStock = room.stock;
                const dateStr = date.toISOString().split('T')[0];
                
                // 計算當天有預訂的房間數量（每個房間只要有任何時段預訂就算佔用一間）
                const occupiedRooms = new Set(); // 使用 Set 來避免重複計算同一房間
                
                // 檢查每個房間是否在當天有任何預訂
                for (let roomNumber = 1; roomNumber <= totalStock; roomNumber++) {
                    const roomBookings = getRoomBookings(dateStr, roomNumber);
                    if (roomBookings.length > 0) {
                        occupiedRooms.add(roomNumber);
                    }
                }
                
                const bookedCount = occupiedRooms.size;
                const available = Math.max(0, totalStock - bookedCount);
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: available
                };
            }

            function calculateHourlyStock(date, timeSlot, room) {
                // 模擬計算邏輯
                const totalStock = room.stock;
                
                // 處理新的時間段格式
                let timeSlotKey;
                if (typeof timeSlot === 'object') {
                    timeSlotKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                } else {
                    timeSlotKey = timeSlot;
                }
                
                const bookings = mockBookings.filter(b => 
                    b.roomId === room.id && 
                    new Date(b.startDate).toDateString() === date.toDateString()
                );
                
                // 根據時間段和日期計算預訂數量
                const bookedCount = Math.min(bookings.length, Math.floor(Math.random() * 3)); // 模擬時段預訂
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: Math.max(0, totalStock - bookedCount)
                };
            }

            function getStockColorClass(available) {
                if (available === 0) return 'bg-red-100';
                if (available <= 2) return 'bg-yellow-100';
                return 'bg-green-100';
            }

            function formatDate(date) {
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }

            function updateCalendarView(isRoomChange = false) {
                const roomId = currentManagementRoomId;
                const selectedRoom = mockRoomTypes.find(r => r.id === roomId);
                
                // 移除方案選擇邏輯，直接使用房型設定
                const calendarContainer = document.getElementById('calendar-container');
                if (calendarContainer) {
                    calendarContainer.innerHTML = renderCalendarView(null, selectedRoom);
                }
            }

            function attachCalendarManagementListeners() {
                // 房型選擇
                document.getElementById('room-type-select')?.addEventListener('change', function() {
                    currentManagementRoomId = parseInt(this.value);
                    updateCalendarView(true); // 傳入 true 表示是房型改變
                });

                // 顯示模式選擇
                document.getElementById('view-mode-select')?.addEventListener('change', function() {
                    managementViewMode = this.value;
                    updateCalendarView(false);
                });

                // 月曆導航
                document.getElementById('prev-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() - 1);
                    updateCalendarView(false); // 導航不改變房型或方案
                });

                document.getElementById('next-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() + 1);
                    updateCalendarView(false); // 導航不改變房型或方案
                });

                // 日期導航
                document.getElementById('prev-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() - 1);
                    updateCalendarView(false);
                });

                document.getElementById('next-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() + 1);
                    updateCalendarView(false);
                });

                // 日期/時段點擊事件
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.calendar-day-cell, td[data-date], div[data-date]')) {
                        const element = e.target.closest('.calendar-day-cell, td[data-date], div[data-date]');
                        const date = element.dataset.date;
                        const roomId = parseInt(element.dataset.roomId);
                        const viewMode = element.dataset.viewMode;
                        const timeSlot = element.dataset.timeSlot;
                        
                        showAvailabilityModal(date, roomId, viewMode, timeSlot);
                    }
                });
            }

            function showAvailabilityModal(date, roomId, viewMode, timeSlot) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                const stockInfo = timeSlot ? 
                    calculateHourlyStock(new Date(date), timeSlot, room) :
                    calculateDailyStock(new Date(date), room);
                
                const modalTitle = timeSlot ? 
                    `管理 ${formatDate(new Date(date))} ${timeSlot} 時段可用性` :
                    `管理 ${formatDate(new Date(date))} 日期可用性`;

                const serviceTypeText = viewMode === 'monthly' ? '過夜寄宿' : '日間安親';

                const modalContent = `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">${modalTitle}</h2>
                            <button id="close-availability-modal" class="text-2xl">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">服務類型：${serviceTypeText}</p>
                                <p class="text-sm text-gray-600">房型：${room.name}</p>
                                <p class="text-sm text-gray-600">當前剩餘空房</p>
                                <p class="text-lg font-bold text-[#181111]">${stockInfo.available} / ${stockInfo.total}</p>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">手動調整可用數量</label>
                                <input type="number" id="manual-stock-input" class="form-input-styled mt-1" 
                                       value="${stockInfo.available}" min="0" max="${stockInfo.total}">
                                <p class="text-xs text-gray-500 mt-1">設定為 0 表示完全不可預訂</p>
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-[#886364]">設為不可預訂</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="unavailable-toggle" ${stockInfo.available === 0 ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">備註 (選填)</label>
                                <textarea id="availability-note" class="form-input-styled mt-1 h-20" 
                                          placeholder="例如：因消毒關閉、員工不足等"></textarea>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button id="clear-manual-settings" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-full text-sm">
                                    清除手動設定
                                </button>
                                <button id="save-availability" class="flex-1 py-2 px-4 bg-[#181111] text-white rounded-full text-sm">
                                    儲存
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // 創建模態框
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content max-w-md w-full">
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);

                // 綁定模態框事件
                modal.querySelector('#close-availability-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.querySelector('#unavailable-toggle').addEventListener('change', function() {
                    const stockInput = modal.querySelector('#manual-stock-input');
                    stockInput.value = this.checked ? '0' : stockInfo.available;
                });

                modal.querySelector('#save-availability').addEventListener('click', () => {
                    alert('可用性設定已儲存 (模擬)');
                    document.body.removeChild(modal);
                });

                modal.querySelector('#clear-manual-settings').addEventListener('click', () => {
                    modal.querySelector('#manual-stock-input').value = stockInfo.available;
                    modal.querySelector('#unavailable-toggle').checked = false;
                    modal.querySelector('#availability-note').value = '';
                });
            }

            // --- 事件監聽器綁定 ---
            function attachBookingModuleListeners() {
                document.getElementById('checkin-date')?.addEventListener('click', openCalendar);
                document.getElementById('checkout-date')?.addEventListener('click', openCalendar);
                document.getElementById('decrease-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    let count = parseInt(input.value);
                    if (count > 1) input.value = count - 1;
                    updatePrice();
                });
                document.getElementById('increase-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    input.value = parseInt(input.value) + 1;
                    updatePrice();
                });
                document.querySelectorAll('.addon-service').forEach(el => el.addEventListener('change', updatePrice));
            }
            
            // 綁定房型選項事件監聽器
            function attachRoomOptionListeners() {
                document.querySelectorAll('.package-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // 檢查是否為不可用的房型
                        if(this.style.opacity === '0.5' || this.style.pointerEvents === 'none') return;
                        
                        // 移除所有選中的房型
                        document.querySelectorAll('.package-item.selected').forEach(p => p.classList.remove('selected'));
                        
                        // 選中當前房型
                        this.classList.add('selected');
                        
                        // 更新預訂資料
                        const roomId = parseInt(this.dataset.roomId);
                        if (roomId) {
                            bookingData.roomId = roomId;
                        }
                        
                        updatePrice();
                    });
                });
                
                // 時段按鈕事件已移除（時段選擇現在在預訂流程中處理）
            }

            // 更新數據分析圖表
            function updateAnalyticsCharts() {
                const periodSelect = document.getElementById('analytics-period-select');
                if (!periodSelect) return;
                
                const period = periodSelect.value;
                
                // 更新營收趨勢圖表
                const revenueChartContainer = document.querySelector('.bg-gray-50.rounded-lg.p-3.h-40');
                if (revenueChartContainer) {
                    let chartData = [];
                    let labels = [];
                    
                    if (period === '7') {
                        // 近7天數據
                        labels = ['週一', '週二', '週三', '週四', '週五', '週六', '週日'];
                        chartData = [1600, 2000, 2400, 2800, 3200, 3600, 4000];
                    } else if (period === '30') {
                        // 近30天數據 (週平均)
                        labels = ['第1週', '第2週', '第3週', '第4週'];
                        chartData = [2500, 3000, 2800, 3200];
                    } else if (period === '90') {
                        // 近90天數據 (月平均)
                        labels = ['1月', '2月', '3月'];
                        chartData = [2800, 3200, 3000];
                    } else if (period === '365') {
                        // 近一年數據 (季平均)
                        labels = ['Q1', 'Q2', 'Q3', 'Q4'];
                        chartData = [3000, 3500, 3200, 3800];
                    }
                    
                    // 更新營收圖表
                    revenueChartContainer.innerHTML = chartData.map((height, index) => `
                        <div class="flex flex-col items-center">
                            <div class="w-4 rounded-t ${index >= 5 ? 'bg-emerald-500' : 'bg-blue-500'}" style="height: ${height/100}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${labels[index]}</span>
                        </div>
                    `).join('');
                }
                
                // 更新預約趨勢圖表 (訂單分析中的)
                const bookingChartContainers = document.querySelectorAll('.bg-gray-50.rounded-lg.p-3.h-32');
                bookingChartContainers.forEach((bookingChartContainer, containerIndex) => {
                    // 跳過營收圖表容器
                    if (bookingChartContainer === revenueChartContainer) return;
                    
                    let bookingData = [];
                    let bookingLabels = [];
                    
                    if (period === '7') {
                        bookingLabels = ['週一', '週二', '週三', '週四', '週五', '週六', '週日'];
                        bookingData = [3, 4, 5, 6, 7, 8, 9];
                    } else if (period === '30') {
                        bookingLabels = ['第1週', '第2週', '第3週', '第4週'];
                        bookingData = [15, 18, 16, 20];
                    } else if (period === '90') {
                        bookingLabels = ['1月', '2月', '3月'];
                        bookingData = [65, 72, 68];
                    } else if (period === '365') {
                        bookingLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
                        bookingData = [200, 250, 220, 280];
                    }
                    
                    // 更新預約圖表
                    bookingChartContainer.innerHTML = bookingData.map((height, index) => `
                        <div class="flex flex-col items-center">
                            <div class="bg-purple-500 w-3 rounded-t" style="height: ${height*2}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${bookingLabels[index]}</span>
                        </div>
                    `).join('');
                });
                
                // 更新房況分析圖表
                const occupancyChartContainer = document.querySelector('#occupancy-content .bg-gray-50.rounded-lg.p-3.h-32');
                if (occupancyChartContainer) {
                    let occupancyData = [];
                    let occupancyLabels = [];
                    
                    if (period === '7') {
                        occupancyLabels = ['週一', '週二', '週三', '週四', '週五', '週六', '週日'];
                        occupancyData = [60, 65, 70, 75, 80, 85, 90]; // 入住率百分比
                    } else if (period === '30') {
                        occupancyLabels = ['第1週', '第2週', '第3週', '第4週'];
                        occupancyData = [70, 75, 72, 78];
                    } else if (period === '90') {
                        occupancyLabels = ['1月', '2月', '3月'];
                        occupancyData = [68, 72, 75];
                    } else if (period === '365') {
                        occupancyLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
                        occupancyData = [65, 70, 75, 80];
                    }
                    
                    // 更新入住率圖表
                    occupancyChartContainer.innerHTML = occupancyData.map((height, index) => `
                        <div class="flex flex-col items-center">
                            <div class="w-4 rounded-t ${index >= 5 ? 'bg-emerald-500' : 'bg-blue-500'}" style="height: ${height/2.5}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${occupancyLabels[index]}</span>
                        </div>
                    `).join('');
                }
                
                // 更新客戶滿意度分析圖表
                const satisfactionChartContainers = document.querySelectorAll('#satisfaction-content .bg-gray-50.rounded-lg.p-3.h-32');
                satisfactionChartContainers.forEach((chartContainer, index) => {
                    let satisfactionData = [];
                    let satisfactionLabels = [];
                    
                    if (period === '7') {
                        satisfactionLabels = ['週一', '週二', '週三', '週四', '週五', '週六', '週日'];
                        if (index === 0) {
                            // 評分趨勢
                            satisfactionData = [4.5, 4.6, 4.7, 4.8, 4.8, 4.9, 4.9];
                        } else {
                            // 情感分析趨勢
                            satisfactionData = [85, 87, 88, 89, 90, 92, 93];
                        }
                    } else if (period === '30') {
                        satisfactionLabels = ['第1週', '第2週', '第3週', '第4週'];
                        if (index === 0) {
                            satisfactionData = [4.6, 4.7, 4.8, 4.8];
                        } else {
                            satisfactionData = [87, 89, 90, 92];
                        }
                    } else if (period === '90') {
                        satisfactionLabels = ['1月', '2月', '3月'];
                        if (index === 0) {
                            satisfactionData = [4.5, 4.7, 4.8];
                        } else {
                            satisfactionData = [85, 88, 91];
                        }
                    } else if (period === '365') {
                        satisfactionLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
                        if (index === 0) {
                            satisfactionData = [4.4, 4.6, 4.7, 4.8];
                        } else {
                            satisfactionData = [82, 86, 89, 92];
                        }
                    }
                    
                    // 更新滿意度圖表
                    chartContainer.innerHTML = satisfactionData.map((height, chartIndex) => `
                        <div class="flex flex-col items-center">
                            <div class="w-3 rounded-t ${index === 0 ? 'bg-yellow-500' : 'bg-green-500'}" style="height: ${index === 0 ? height*6 : height/3}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${satisfactionLabels[chartIndex]}</span>
                        </div>
                    `).join('');
                });
                
                // 更新即時監控的今日營收趨勢圖表
                const monitoringChartContainer = document.querySelector('#monitoring-content .bg-gray-50.rounded-lg.p-3.h-32');
                if (monitoringChartContainer) {
                    const hours = ['08', '10', '12', '14', '16', '18', '20'];
                    const heights = hours.map(() => Math.floor(Math.random() * 25) + 8);
                    
                    monitoringChartContainer.innerHTML = heights.map((height, index) => `
                        <div class="flex flex-col items-center">
                            <div class="bg-blue-500 w-3 rounded-t" style="height: ${height}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${hours[index]}</span>
                        </div>
                    `).join('');
                }
            }

            // 切換數據分析頁簽
            function switchAnalyticsTab(tabName) {
                // 隱藏所有內容
                document.querySelectorAll('.analytics-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // 重置所有頁簽樣式
                document.querySelectorAll('.analytics-tab').forEach(tab => {
                    tab.classList.remove('text-blue-600', 'border-blue-600');
                    tab.classList.add('text-gray-500', 'border-transparent');
                });
                
                // 顯示選中的內容
                const contentId = tabName + '-content';
                const content = document.getElementById(contentId);
                if (content) {
                    content.classList.remove('hidden');
                }
                
                // 更新選中的頁簽樣式
                const tabId = tabName + '-tab';
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.classList.remove('text-gray-500', 'border-transparent');
                    tab.classList.add('text-blue-600', 'border-blue-600');
                }
            }

            // 刷新即時監控數據
            function refreshMonitoringData() {
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                // 更新最後更新時間
                const timeElement = document.querySelector('#monitoring-content .text-xs.text-gray-500');
                if (timeElement) {
                    timeElement.textContent = `最後更新: ${timeString}`;
                }
                
                // 模擬數據更新
                const revenueElement = document.querySelector('#monitoring-content .text-lg.font-bold.text-blue-800');
                if (revenueElement) {
                    const currentRevenue = parseInt(revenueElement.textContent.replace(/[^\d]/g, ''));
                    const newRevenue = currentRevenue + Math.floor(Math.random() * 500) + 100;
                    revenueElement.textContent = `NT$ ${newRevenue.toLocaleString()}`;
                }
                
                // 更新入住率
                const occupancyElement = document.querySelector('#monitoring-content .text-lg.font-bold.text-green-800');
                if (occupancyElement) {
                    const newOccupancy = Math.floor(Math.random() * 20) + 60; // 60-80%
                    occupancyElement.textContent = `${newOccupancy}%`;
                }
                
                // 更新今日新增訂單
                const orderElement = document.querySelector('#monitoring-content .text-lg.font-bold.text-yellow-800');
                if (orderElement) {
                    const newOrders = parseInt(orderElement.textContent) + Math.floor(Math.random() * 3);
                    orderElement.textContent = newOrders.toString();
                }
                
                // 更新評分
                const ratingElement = document.querySelector('#monitoring-content .text-lg.font-bold.text-purple-800');
                if (ratingElement) {
                    const currentRating = parseFloat(ratingElement.textContent);
                    const newRating = (currentRating + (Math.random() - 0.5) * 0.2).toFixed(1);
                    ratingElement.textContent = newRating;
                }
                
                // 更新今日營收趨勢圖表
                const chartContainer = document.querySelector('#monitoring-content .bg-gray-50.rounded-lg.p-3.h-32');
                if (chartContainer) {
                    const hours = ['08', '10', '12', '14', '16', '18', '20'];
                    const heights = hours.map(() => Math.floor(Math.random() * 25) + 8);
                    
                    chartContainer.innerHTML = heights.map((height, index) => `
                        <div class="flex flex-col items-center">
                            <div class="bg-blue-500 w-3 rounded-t" style="height: ${height}px"></div>
                            <span class="text-xs text-gray-600 mt-1">${hours[index]}</span>
                        </div>
                    `).join('');
                }
                
                // 顯示刷新成功提示
                const refreshBtn = document.getElementById('refresh-monitoring-btn');
                if (refreshBtn) {
                    const originalText = refreshBtn.textContent;
                    refreshBtn.textContent = '✅ 已更新';
                    refreshBtn.classList.add('bg-green-100', 'text-green-600');
                    refreshBtn.classList.remove('bg-blue-100', 'text-blue-600');
                    
                    setTimeout(() => {
                        refreshBtn.textContent = originalText;
                        refreshBtn.classList.remove('bg-green-100', 'text-green-600');
                        refreshBtn.classList.add('bg-blue-100', 'text-blue-600');
                    }, 2000);
                }
            }

            document.body.addEventListener('click', function(e) {
                // 頁面切換
                if (e.target.closest('.nav-item')) showPage(e.target.closest('.nav-item').dataset.page);
                if (e.target.closest('#profile-icon-button')) showPage('account');
                if (e.target.closest('.listing-card')) showPage('detail');
                if (e.target.closest('#chat-icon-button')) showPage('chat');
                // 搜尋框
                if (e.target.id === 'home-search-input') showPage('searchResult');
                // 會員中心
                if (e.target.closest('#become-merchant')) {
                    alert('感謝您的申請！您現在是商家了。');
                    isUserMerchant = true;
                    updateUserCenterOptions();
                }
                if (e.target.closest('#merchant-entry')) showPage('merchantDashboard');
                if (e.target.closest('#back-to-dashboard-btn')) showPage('merchantDashboard');
                if (e.target.closest('#analytics-dashboard-link')) {
                    renderAnalyticsDashboard();
                    showPage('analyticsDashboard');
                }
                // == START: 新增金流儀表板點擊事件 ==
                if (e.target.closest('#finance-dashboard-link')) {
                    showPage('financeDashboard');
                }
                // == END: 新增金流儀表板點擊事件 ==
                if (e.target.closest('#back-to-merchant-dashboard-btn')) showPage('merchantDashboard');
                if (e.target.closest('#manage-rooms-link')) showPage('roomManagement');
                if (e.target.closest('#manage-calendar-btn')) showPage('calendarManagement');
                // 新增：商家中心各入口
                if (e.target.closest('#md-orders')) {
                    alert('訂單管理（示意）：顯示顧客資訊與寵物需求');
                }
                if (e.target.closest('#md-occupancy')) {
                    openOccupancyModal();
                }
                if (e.target.closest('#md-finance')) {
                    openFinanceModal();
                }
                if (e.target.closest('#md-reports')) {
                    openReportsModal();
                }
                if (e.target.closest('#md-chat')) {
                    showPage('chat');
                }
                if (e.target.closest('#md-coupons')) {
                    openCouponManageModal();
                }
                // 數據分析時間範圍選擇器
                if (e.target.closest('#analytics-period-select')) {
                    updateAnalyticsCharts();
                }
                // 數據分析頁簽切換
                if (e.target.closest('#revenue-tab')) {
                    switchAnalyticsTab('revenue');
                }
                if (e.target.closest('#order-tab')) {
                    switchAnalyticsTab('order');
                }
                if (e.target.closest('#occupancy-tab')) {
                    switchAnalyticsTab('occupancy');
                }
                if (e.target.closest('#satisfaction-tab')) {
                    switchAnalyticsTab('satisfaction');
                }
                if (e.target.closest('#monitoring-tab')) {
                    switchAnalyticsTab('monitoring');
                }
                // 即時監控刷新按鈕
                if (e.target.closest('#refresh-monitoring-btn')) {
                    refreshMonitoringData();
                }
                if (e.target.closest('#add-new-room-btn')) renderRoomForm();
                if (e.target.closest('.edit-room-btn')) {
                    const roomId = parseInt(e.target.closest('.edit-room-btn').dataset.roomId);
                    renderRoomForm(roomId);
                }
                if (e.target.closest('#cancel-form-btn')) {
                     formModal.classList.add('hidden');
                     showPage('roomManagement');
                }

                // 訂單篩選
                if (e.target.closest('.order-filter-btn')) renderOrders(e.target.closest('.order-filter-btn').dataset.filter);
                // 日曆
                if (e.target.closest('#prev-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
                if (e.target.closest('#next-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }
                if (e.target.closest('#calendar-cancel')) calendarModal.classList.add('hidden');
                if (e.target.closest('#calendar-confirm')) {
                    const checkinInput = document.getElementById('checkin-date');
                    const checkoutInput = document.getElementById('checkout-date');
                    if(selectedCheckinDate) checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                    if(selectedCheckoutDate) checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
                    updatePrice();
                    calendarModal.classList.add('hidden');
                }
                if (e.target.closest('#calendar-days')) handleDateClick(e);
                // 管理行事曆 - 移除全域事件監聽器，改由 attachCalendarManagementListeners 處理
                // 房型表單中的寵物類型
                if (e.target.matches('input[name="pet-type"][value="dog"]')) {
                    document.getElementById('dog-size-options').classList.toggle('hidden', !e.target.checked);
                }
                // Package management removed - packages are now integrated into room types
            });

            // --- 公告功能相關函數已移至全局作用域 ---

            // --- 初始化 ---
            showPage('home');
            
            // 設定入住/退房日期預設為今天
            const today = new Date();
            selectedCheckinDate = today;
            selectedCheckoutDate = new Date(today.getTime() + (24 * 60 * 60 * 1000)); // 明天
            
            // 更新日期輸入框顯示
            const checkinInput = document.getElementById('checkin-date');
            const checkoutInput = document.getElementById('checkout-date');
            if(checkinInput && checkoutInput) {
                checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
            }

            // Leaflet 地圖無需全局回調，直接在頁面載入時初始化
            
            // --- 導航欄點擊事件監聽器 ---
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageKey = this.dataset.page;
                    if (pageKey) {
                        showPage(pageKey);
                    }
                });
            });
        });

        // --- 全局公告功能函數 ---
        
        // 全局函數：更新導航欄活躍狀態
        function updateNavActiveState(activePageKey) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const page = item.dataset.page;
                item.classList.toggle('active', page === activePageKey);
            });
        }
        
        // 全局函數：返回聊天頁面
        function returnToChatPage() {
            // 使用 classList 方式切換頁面，與 showPage 函數保持一致
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.add('hidden'));
            document.getElementById('chat-page').classList.remove('hidden');
            
            // 恢復聊天頁面的原始內容
            const chatPage = document.getElementById('chat-page');
            chatPage.innerHTML = `
                <h1 class="text-2xl font-bold mb-4 text-center text-[#181111] p-4">訊息中心</h1>
                
                <!-- 公告區域 -->
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 mx-4 rounded-xl border border-blue-200 mb-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-sm">📢</div>
                        <h3 class="font-bold text-[#181111]">平台公告</h3>
                        <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">NEW</span>
                    </div>
                    <div class="space-y-2">
                        <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${isAnnouncementRead('spring-service') ? 'opacity-75' : ''}" onclick="showAnnouncementDetail('spring-service')">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-medium text-[#181111] ${isAnnouncementRead('spring-service') ? 'text-gray-500' : ''}">春節期間服務時間調整</p>
                                    ${!isAnnouncementRead('spring-service') ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                <span class="text-xs text-gray-500">2小時前</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">2/10-2/17 客服時間調整為 9:00-18:00</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${isAnnouncementRead('health-record') ? 'opacity-75' : ''}" onclick="showAnnouncementDetail('health-record')">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-medium text-[#181111] ${isAnnouncementRead('health-record') ? 'text-gray-500' : ''}">新功能上線：寵物健康記錄</p>
                                    ${!isAnnouncementRead('health-record') ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                <span class="text-xs text-gray-500">1天前</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">現在可以為您的毛孩建立健康檔案</p>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition-colors ${isAnnouncementRead('payment-update') ? 'opacity-75' : ''}" onclick="showAnnouncementDetail('payment-update')">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-2">
                                    <p class="text-sm font-medium text-[#181111] ${isAnnouncementRead('payment-update') ? 'text-gray-500' : ''}">支付系統優化完成</p>
                                    ${!isAnnouncementRead('payment-update') ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                <span class="text-xs text-gray-500">3天前</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">提升支付成功率，新增多種支付方式</p>
                        </div>
                    </div>
                    <button class="w-full mt-3 text-sm text-blue-600 font-medium hover:text-blue-800 transition-colors" onclick="showAnnouncementList()">
                        查看所有公告 →
                    </button>
                </div>
                
                <div class="space-y-3 px-4">
                    <!-- 置頂聊天項目 -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 flex items-center gap-4 cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">P</div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">Paw Pad 官方客服</p>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full flex-shrink-0">置頂</span>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">歡迎使用！有任何問題隨時與我們聯繫。</p>
                            </div>
                        </div>
                    </div>
                    <!-- 一般聊天項目 -->
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">快樂爪子旅館</p>
                                <p class="text-xs text-[#886364]">昨天</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">好的，您的預訂已確認！</p>
                                <span class="bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">2</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">貓咪天堂</p>
                                <p class="text-xs text-[#886364]">3天前</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">感謝您的預訂，期待為您的愛貓服務！</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1583337130417-3346a1be7dee?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">毛孩之家</p>
                                <p class="text-xs text-[#886364]">1週前</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">您的寵物在這裡過得很開心！</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 更新導航欄的活躍狀態
            updateNavActiveState('chat');
        }

        // 全局函數：管理公告已讀狀態
        function getReadAnnouncements() {
            const readAnnouncements = localStorage.getItem('readAnnouncements');
            return readAnnouncements ? JSON.parse(readAnnouncements) : [];
        }

        function markAnnouncementAsRead(announcementId) {
            const readAnnouncements = getReadAnnouncements();
            if (!readAnnouncements.includes(announcementId)) {
                readAnnouncements.push(announcementId);
                localStorage.setItem('readAnnouncements', JSON.stringify(readAnnouncements));
            }
        }

        function isAnnouncementRead(announcementId) {
            const readAnnouncements = getReadAnnouncements();
            return readAnnouncements.includes(announcementId);
        }

        // 全局函數：顯示分享模態框
        function showShareModal(announcement) {
            // 創建分享模態框
            const shareModal = document.createElement('div');
            shareModal.id = 'share-modal';
            shareModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            shareModal.innerHTML = `
                <div class="bg-white rounded-xl p-6 mx-4 max-w-sm w-full">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-[#181111]">分享公告</h3>
                        <button id="close-share-modal" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-semibold text-[#181111] mb-2">${announcement.title}</h4>
                        <p class="text-sm text-gray-600">${announcement.summary || announcement.content.substring(0, 100) + '...'}</p>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="copy-link-btn" class="w-full flex items-center justify-center gap-3 p-3 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            <span class="font-medium">複製連結</span>
                        </button>
                        
                        <button id="share-facebook-btn" class="w-full flex items-center justify-center gap-3 p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                            <span class="font-medium">分享到 Facebook</span>
                        </button>
                        
                        <button id="share-line-btn" class="w-full flex items-center justify-center gap-3 p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .63.285.63.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                            </svg>
                            <span class="font-medium">分享到 LINE</span>
                        </button>
                        
                        <button id="share-email-btn" class="w-full flex items-center justify-center gap-3 p-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <span class="font-medium">透過 Email 分享</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(shareModal);
            
            // 添加事件監聽器
            document.getElementById('close-share-modal').addEventListener('click', function() {
                document.body.removeChild(shareModal);
            });
            
            document.getElementById('copy-link-btn').addEventListener('click', function() {
                const link = `${window.location.origin}${window.location.pathname}#announcement/${announcement.id || 'spring-service'}`;
                navigator.clipboard.writeText(link).then(() => {
                    alert('連結已複製到剪貼簿！');
                    document.body.removeChild(shareModal);
                }).catch(() => {
                    alert('複製失敗，請手動複製連結');
                });
            });
            
            document.getElementById('share-facebook-btn').addEventListener('click', function() {
                const url = encodeURIComponent(`${window.location.origin}${window.location.pathname}#announcement/${announcement.id || 'spring-service'}`);
                const text = encodeURIComponent(`${announcement.title} - ${announcement.summary || announcement.content.substring(0, 100)}`);
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
                document.body.removeChild(shareModal);
            });
            
            document.getElementById('share-line-btn').addEventListener('click', function() {
                const url = encodeURIComponent(`${window.location.origin}${window.location.pathname}#announcement/${announcement.id || 'spring-service'}`);
                const text = encodeURIComponent(`${announcement.title}\n\n${announcement.summary || announcement.content.substring(0, 100)}`);
                window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${text}`, '_blank');
                document.body.removeChild(shareModal);
            });
            
            document.getElementById('share-email-btn').addEventListener('click', function() {
                const subject = encodeURIComponent(`PawPad 公告：${announcement.title}`);
                const body = encodeURIComponent(`您好，\n\n我想與您分享這個 PawPad 的公告：\n\n${announcement.title}\n\n${announcement.summary || announcement.content.substring(0, 200)}\n\n詳細內容請查看：${window.location.origin}${window.location.pathname}#announcement/${announcement.id || 'spring-service'}\n\n祝好！`);
                window.open(`mailto:?subject=${subject}&body=${body}`);
                document.body.removeChild(shareModal);
            });
            
            // 點擊背景關閉模態框
            shareModal.addEventListener('click', function(e) {
                if (e.target === shareModal) {
                    document.body.removeChild(shareModal);
                }
            });
        }
        
        // 公告詳情頁面
        function showAnnouncementDetail(announcementId) {
            console.log('showAnnouncementDetail called with:', announcementId);
            const announcements = {
                'spring-service': {
                    title: '春節期間服務時間調整',
                    date: '2024-02-08',
                    type: 'system',
                    priority: 'high',
                    author: 'Paw Pad 營運團隊',
                    readTime: '2 分鐘',
                    content: `
                        <div class="space-y-4">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center gap-2">
                                    <span>📅</span>
                                    <span>服務時間調整</span>
                                </h4>
                                <p class="text-sm text-yellow-700 mb-3">春節期間（2/10-2/17）客服服務時間調整如下：</p>
                                <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                                    <li class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full"></span>
                                        <span>客服時間：09:00 - 18:00</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full"></span>
                                        <span>緊急聯絡：24小時服務</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <span class="w-1.5 h-1.5 bg-yellow-600 rounded-full"></span>
                                        <span>訂房服務：正常運作</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                                    <span>💡</span>
                                    <span>溫馨提醒</span>
                                </h4>
                                <p class="text-sm text-blue-700">春節期間訂房需求較高，建議提前預訂以確保有合適的房間。</p>
                            </div>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                    <span>📞</span>
                                    <span>聯絡方式</span>
                                </h4>
                                <div class="text-sm text-gray-700 space-y-1">
                                    <p>客服專線：0800-123-456</p>
                                    <p>緊急聯絡：0900-789-012</p>
                                    <p>Email：service@pawpad.com</p>
                                </div>
                            </div>
                        </div>
                    `
                },
                'health-record': {
                    title: '新功能上線：寵物健康記錄',
                    date: '2024-02-07',
                    type: 'feature',
                    priority: 'medium',
                    author: 'Paw Pad 開發團隊',
                    readTime: '3 分鐘',
                    content: `
                        <div class="space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2 flex items-center gap-2">
                                    <span>🐾</span>
                                    <span>新功能介紹</span>
                                </h4>
                                <p class="text-sm text-green-700 mb-3">現在您可以為您的毛孩建立完整的健康檔案！</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="text-center">
                                            <div class="text-2xl mb-1">💉</div>
                                            <p class="text-xs text-green-700 font-medium">疫苗記錄</p>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="text-center">
                                            <div class="text-2xl mb-1">🏥</div>
                                            <p class="text-xs text-green-700 font-medium">健康檢查</p>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="text-center">
                                            <div class="text-2xl mb-1">⚠️</div>
                                            <p class="text-xs text-green-700 font-medium">過敏資訊</p>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-lg p-3 border border-green-200">
                                        <div class="text-center">
                                            <div class="text-2xl mb-1">📝</div>
                                            <p class="text-xs text-green-700 font-medium">特殊需求</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h4 class="font-semibold text-purple-800 mb-2 flex items-center gap-2">
                                    <span>🎯</span>
                                    <span>使用方式</span>
                                </h4>
                                <div class="text-sm text-purple-700 space-y-2">
                                    <div class="flex items-start gap-2">
                                        <span class="w-5 h-5 bg-purple-200 rounded-full flex items-center justify-center text-xs font-bold text-purple-700 flex-shrink-0 mt-0.5">1</span>
                                        <span>進入「我的寵物」頁面</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="w-5 h-5 bg-purple-200 rounded-full flex items-center justify-center text-xs font-bold text-purple-700 flex-shrink-0 mt-0.5">2</span>
                                        <span>點擊「健康記錄」按鈕</span>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <span class="w-5 h-5 bg-purple-200 rounded-full flex items-center justify-center text-xs font-bold text-purple-700 flex-shrink-0 mt-0.5">3</span>
                                        <span>開始建立您的寵物健康檔案</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                                    <span>🔒</span>
                                    <span>隱私保護</span>
                                </h4>
                                <p class="text-sm text-blue-700">所有健康資料均經過加密處理，只有您和授權的寵物旅館可以查看。</p>
                            </div>
                        </div>
                    `
                },
                'payment-update': {
                    title: '支付系統優化完成',
                    date: '2024-02-05',
                    type: 'system',
                    priority: 'medium',
                    author: 'Paw Pad 技術團隊',
                    readTime: '2 分鐘',
                    content: `
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center gap-2">
                                    <span>💳</span>
                                    <span>支付優化</span>
                                </h4>
                                <p class="text-sm text-blue-700 mb-3">我們已完成支付系統的全面優化：</p>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                                        <span class="text-sm text-blue-700">支付成功率</span>
                                        <span class="text-sm font-bold text-green-600">99.5%</span>
                                    </div>
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                                        <span class="text-sm text-blue-700">Apple Pay</span>
                                        <span class="text-sm font-bold text-green-600">✅ 已支援</span>
                                    </div>
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                                        <span class="text-sm text-blue-700">Google Pay</span>
                                        <span class="text-sm font-bold text-green-600">✅ 已支援</span>
                                    </div>
                                    <div class="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-200">
                                        <span class="text-sm text-blue-700">信用卡驗證</span>
                                        <span class="text-sm font-bold text-green-600">✅ 已優化</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                                    <span>🔒</span>
                                    <span>安全升級</span>
                                </h4>
                                <p class="text-sm text-gray-700 mb-2">所有支付資料均採用銀行級加密技術保護，確保您的交易安全。</p>
                                <div class="flex items-center gap-2 text-xs text-gray-600">
                                    <span>🛡️</span>
                                    <span>SSL 256位加密</span>
                                    <span>•</span>
                                    <span>PCI DSS 合規</span>
                                    <span>•</span>
                                    <span>定期安全檢測</span>
                                </div>
                            </div>
                        </div>
                    `
                }
            };

            const announcement = announcements[announcementId];
            if (!announcement) return;

            // 標記公告為已讀
            markAnnouncementAsRead(announcementId);

            // 先切換到聊天頁面
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.add('hidden'));
            document.getElementById('chat-page').classList.remove('hidden');

            // 獲取 pages 對象
            const pages = {
                chat: document.getElementById('chat-page')
            };

            // 創建公告詳情頁面
            pages.chat.innerHTML = `
                <div class="min-h-full bg-gray-50">
                    <!-- 標題列 -->
                    <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <button id="announcement-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h1 class="text-lg font-bold text-[#181111]">公告詳情</h1>
                            <button id="announcement-share-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 公告標題區域 -->
                    <div class="bg-white border-b border-gray-100 p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <h2 class="text-xl font-bold text-[#181111] mb-2 leading-tight">${announcement.title}</h2>
                                <div class="flex items-center gap-3 text-sm text-gray-500">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>${announcement.date}</span>
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        <span>${announcement.author}</span>
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>${announcement.readTime}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    announcement.type === 'system' ? 'bg-blue-100 text-blue-600' :
                                    announcement.type === 'feature' ? 'bg-green-100 text-green-600' :
                                    announcement.type === 'promotion' ? 'bg-purple-100 text-purple-600' :
                                    'bg-gray-100 text-gray-600'
                                }">
                                    ${announcement.type === 'system' ? '系統公告' :
                                      announcement.type === 'feature' ? '功能更新' :
                                      announcement.type === 'promotion' ? '優惠活動' : '其他'}
                                </span>
                                ${announcement.priority === 'high' ? '<span class="text-xs text-red-500 font-medium">🔴 重要</span>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 公告內容 -->
                    <div class="p-4">
                        <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                            <div class="prose prose-sm max-w-none">
                                ${announcement.content}
                            </div>
                        </div>
                        
                        <!-- 互動區域 -->
                        <div class="bg-white rounded-xl border border-gray-200 p-4">
                            <h3 class="font-semibold text-[#181111] mb-3">這則公告對您有幫助嗎？</h3>
                            <div class="flex gap-3 mb-4">
                                <button id="useful-btn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                                    </svg>
                                    <span>有用</span>
                                </button>
                                <button id="bottom-share-btn" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    <span>分享</span>
                                </button>
                            </div>
                            
                            <!-- 相關公告 -->
                            <div class="border-t border-gray-200 pt-4">
                                <h4 class="font-medium text-[#181111] mb-3">相關公告</h4>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-[#181111]">支付安全指南</p>
                                            <p class="text-xs text-gray-500">如何保護您的支付資訊</p>
                                        </div>
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-[#181111]">客服時間說明</p>
                                            <p class="text-xs text-gray-500">了解我們的服務時間</p>
                                        </div>
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 添加事件監聽器
            document.getElementById('announcement-back-btn').addEventListener('click', function() {
                // 調用全局函數返回聊天頁面
                returnToChatPage();
            });

            document.getElementById('announcement-share-btn').addEventListener('click', function() {
                showShareModal(announcement);
            });

            // 底部分享按鈕事件
            document.getElementById('bottom-share-btn').addEventListener('click', function() {
                showShareModal(announcement);
            });

            // 有用按鈕事件
            document.getElementById('useful-btn').addEventListener('click', function() {
                const btn = this;
                const originalText = btn.querySelector('span').textContent;
                
                // 防止重複點擊
                if (btn.disabled) return;
                
                btn.disabled = true;
                btn.querySelector('span').textContent = '已感謝';
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                btn.classList.add('bg-gray-400');
                
                // 顯示感謝訊息
                setTimeout(() => {
                    alert('感謝您的反饋！這將幫助我們改進服務品質。');
                }, 100);
            });
        }

        // 公告列表頁面
        function showAnnouncementList() {
            console.log('showAnnouncementList called');
            const announcements = [
                {
                    id: 'spring-service',
                    title: '春節期間服務時間調整',
                    summary: '2/10-2/17 客服時間調整為 9:00-18:00',
                    date: '2小時前',
                    type: 'system',
                    priority: 'high'
                },
                {
                    id: 'health-record',
                    title: '新功能上線：寵物健康記錄',
                    summary: '現在可以為您的毛孩建立健康檔案',
                    date: '1天前',
                    type: 'feature',
                    priority: 'medium'
                },
                {
                    id: 'payment-update',
                    title: '支付系統優化完成',
                    summary: '提升支付成功率，新增多種支付方式',
                    date: '3天前',
                    type: 'system',
                    priority: 'medium'
                },
                {
                    id: 'winter-promotion',
                    title: '冬季優惠活動開始',
                    summary: '預訂冬季住宿享8折優惠，限時一個月',
                    date: '1週前',
                    type: 'promotion',
                    priority: 'low'
                },
                {
                    id: 'app-update',
                    title: 'APP版本更新',
                    summary: '修復已知問題，提升使用體驗',
                    date: '2週前',
                    type: 'system',
                    priority: 'low'
                }
            ];

            // 先切換到聊天頁面
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => page.classList.add('hidden'));
            document.getElementById('chat-page').classList.remove('hidden');

            // 獲取 pages 對象
            const pages = {
                chat: document.getElementById('chat-page')
            };

            pages.chat.innerHTML = `
                <div class="min-h-full bg-gray-50">
                    <!-- 標題列 -->
                    <div class="bg-white border-b border-gray-100 sticky top-0 z-10">
                        <div class="px-4 py-3 flex items-center justify-between">
                            <button id="announcement-list-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h1 class="text-lg font-bold text-[#181111]">所有公告</h1>
                            <div class="w-8"></div>
                        </div>
                    </div>
                    
                    <!-- 篩選標籤 -->
                    <div class="p-4 bg-white border-b border-gray-100">
                        <div class="flex gap-2 overflow-x-auto">
                            <button id="filter-all" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-full whitespace-nowrap">全部</button>
                            <button id="filter-system" class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full whitespace-nowrap">系統公告</button>
                            <button id="filter-feature" class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full whitespace-nowrap">功能更新</button>
                            <button id="filter-promotion" class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full whitespace-nowrap">優惠活動</button>
                        </div>
                    </div>
                    
                    <!-- 公告列表 -->
                    <div class="p-4 space-y-3">
                        ${announcements.map(announcement => `
                            <div class="bg-white rounded-xl border border-gray-200 p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="showAnnouncementDetail('${announcement.id}')">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="font-semibold text-[#181111] text-sm">${announcement.title}</h3>
                                    <span class="text-xs text-gray-500">${announcement.date}</span>
                                </div>
                                <p class="text-xs text-gray-600 mb-2">${announcement.summary}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs px-2 py-1 rounded-full ${
                                        announcement.type === 'system' ? 'bg-blue-100 text-blue-600' :
                                        announcement.type === 'feature' ? 'bg-green-100 text-green-600' :
                                        announcement.type === 'promotion' ? 'bg-purple-100 text-purple-600' :
                                        'bg-gray-100 text-gray-600'
                                    }">
                                        ${announcement.type === 'system' ? '系統公告' :
                                          announcement.type === 'feature' ? '功能更新' :
                                          announcement.type === 'promotion' ? '優惠活動' : '其他'}
                                    </span>
                                    ${announcement.priority === 'high' ? '<span class="text-xs text-red-500">🔴 重要</span>' : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // 添加返回按鈕事件
            document.getElementById('announcement-list-back-btn').addEventListener('click', function() {
                // 調用全局函數返回聊天頁面
                returnToChatPage();
            });

            // 添加篩選功能
            let currentFilter = 'all';
            const filterButtons = {
                'all': document.getElementById('filter-all'),
                'system': document.getElementById('filter-system'),
                'feature': document.getElementById('filter-feature'),
                'promotion': document.getElementById('filter-promotion')
            };

            // 篩選按鈕事件
            Object.keys(filterButtons).forEach(filterType => {
                filterButtons[filterType].addEventListener('click', function() {
                    // 更新按鈕樣式
                    Object.keys(filterButtons).forEach(key => {
                        if (key === filterType) {
                            filterButtons[key].className = 'px-3 py-1 bg-blue-500 text-white text-sm rounded-full whitespace-nowrap';
                        } else {
                            filterButtons[key].className = 'px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full whitespace-nowrap';
                        }
                    });
                    
                    // 更新當前篩選
                    currentFilter = filterType;
                    
                    // 重新渲染公告列表
                    renderFilteredAnnouncements(announcements, filterType);
                });
            });

            // 渲染篩選後的公告列表
            function renderFilteredAnnouncements(announcements, filterType) {
                const filteredAnnouncements = filterType === 'all' 
                    ? announcements 
                    : announcements.filter(announcement => announcement.type === filterType);
                
                const announcementsContainer = document.querySelector('.p-4.space-y-3');
                announcementsContainer.innerHTML = filteredAnnouncements.map(announcement => {
                    const isRead = isAnnouncementRead(announcement.id);
                    return `
                        <div class="bg-white rounded-xl border border-gray-200 p-4 cursor-pointer hover:bg-gray-50 transition-colors ${isRead ? 'opacity-75' : ''}" onclick="showAnnouncementDetail('${announcement.id}')">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-semibold text-[#181111] text-sm ${isRead ? 'text-gray-500' : ''}">${announcement.title}</h3>
                                    ${!isRead ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                                </div>
                                <span class="text-xs text-gray-500">${announcement.date}</span>
                            </div>
                            <p class="text-xs text-gray-600 mb-2">${announcement.summary}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    announcement.type === 'system' ? 'bg-blue-100 text-blue-600' :
                                    announcement.type === 'feature' ? 'bg-green-100 text-green-600' :
                                    announcement.type === 'promotion' ? 'bg-purple-100 text-purple-600' :
                                    'bg-gray-100 text-gray-600'
                                }">
                                    ${announcement.type === 'system' ? '系統公告' :
                                      announcement.type === 'feature' ? '功能更新' :
                                      announcement.type === 'promotion' ? '優惠活動' : '其他'}
                                </span>
                                <div class="flex items-center gap-2">
                                    ${announcement.priority === 'high' ? '<span class="text-xs text-red-500">🔴 重要</span>' : ''}
                                    ${isRead ? '<span class="text-xs text-gray-400">✓ 已讀</span>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
        }
        
        // 將全局函數移到script標籤的最外層
        window.showPendingOrdersModal = function() {
            console.log('showPendingOrdersModal 被調用');
            // 篩選出待處理的訂單
            const pendingOrders = window.mockOrders.filter(order => order.status === 'pending');
            console.log('待處理訂單數量:', pendingOrders.length);
            
            const modalHTML = `
                <div id="pending-orders-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">📋 待處理訂單</h2>
                            <button id="close-pending-orders-modal" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        </div>
                        
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${pendingOrders.length === 0 ? 
                                '<div class="text-center text-gray-500 py-8">🎉 目前沒有待處理的訂單</div>' :
                                pendingOrders.map(order => `
                                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="font-semibold text-[#181111]">${order.name}</h3>
                                            <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">待處理</span>
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">
                                            <div>📅 ${order.date}</div>
                                            <div>🐕 ${order.pet}</div>
                                            <div>💰 NT$ ${order.total}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="flex-1 bg-green-500 text-white text-xs py-2 rounded-lg hover:bg-green-600 transition-colors" onclick="confirmOrder(${order.id})">
                                                ✓ 確認訂單
                                            </button>
                                            <button class="flex-1 bg-red-500 text-white text-xs py-2 rounded-lg hover:bg-red-600 transition-colors" onclick="rejectOrder(${order.id})">
                                                ✗ 拒絕訂單
                                            </button>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button id="view-all-orders-btn" class="w-full bg-[#181111] text-white py-2 rounded-lg hover:bg-gray-800 transition-colors">
                                查看所有訂單
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除現有的模態框（如果有的話）
            const existingModal = document.getElementById('pending-orders-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模態框到頁面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 綁定關閉事件
            document.getElementById('close-pending-orders-modal')?.addEventListener('click', function() {
                document.getElementById('pending-orders-modal')?.remove();
            });
            
            document.getElementById('view-all-orders-btn')?.addEventListener('click', function() {
                document.getElementById('pending-orders-modal')?.remove();
                showPage('orders');
            });
            
            // 點擊背景關閉模態框
            document.getElementById('pending-orders-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        };
        
        window.showRoomStatusModal = function() {
            console.log('showRoomStatusModal 被調用');
            const modalHTML = `
                <div id="room-status-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">🏠 房況檢查</h2>
                            <button id="close-room-status-modal" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        </div>
                        
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${window.mockRoomTypes.map(room => {
                                // 計算該房型的預訂情況
                                const roomBookings = window.mockBookings.filter(booking => booking.roomId === room.id);
                                const today = new Date().toISOString().split('T')[0];
                                const todayBookings = roomBookings.filter(booking => 
                                    booking.startDate <= today && booking.endDate >= today
                                );
                                const availableCount = room.stock - todayBookings.length;
                                const occupancyRate = Math.round((todayBookings.length / room.stock) * 100);
                                
                                return `
                                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="font-semibold text-[#181111]">${room.name}</h3>
                                            <span class="text-xs px-2 py-1 rounded-full ${
                                                room.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                                            }">
                                                ${room.status === 'active' ? '啟用中' : '已禁用'}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">
                                            <div>📊 總庫存: ${room.stock} 間</div>
                                            <div>✅ 今日可用: ${availableCount} 間</div>
                                            <div>🏠 入住率: ${occupancyRate}%</div>
                                            <div>📅 今日入住: ${todayBookings.length} 間</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button class="flex-1 bg-blue-500 text-white text-xs py-2 rounded-lg hover:bg-blue-600 transition-colors" onclick="viewRoomDetails(${room.id})">
                                                📋 查看詳情
                                            </button>
                                            <button class="flex-1 bg-green-500 text-white text-xs py-2 rounded-lg hover:bg-green-600 transition-colors" onclick="manageRoomCalendar(${room.id})">
                                                📅 管理行事曆
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button id="view-room-management-btn" class="w-full bg-[#181111] text-white py-2 rounded-lg hover:bg-gray-800 transition-colors">
                                前往房型管理
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除現有的模態框（如果有的話）
            const existingModal = document.getElementById('room-status-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模態框到頁面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 綁定關閉事件
            document.getElementById('close-room-status-modal')?.addEventListener('click', function() {
                document.getElementById('room-status-modal')?.remove();
            });
            
            document.getElementById('view-room-management-btn')?.addEventListener('click', function() {
                document.getElementById('room-status-modal')?.remove();
                showPage('roomManagement');
            });
            
            // 點擊背景關閉模態框
            document.getElementById('room-status-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        };
        
        window.confirmOrder = function(orderId) {
            const order = window.mockOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'completed';
                alert(`訂單 ${order.name} 已確認！`);
                // 重新顯示模態框以更新列表
                showPendingOrdersModal();
            }
        };
        
        window.rejectOrder = function(orderId) {
            const order = window.mockOrders.find(o => o.id === orderId);
            if (order) {
                order.status = 'cancelled';
                alert(`訂單 ${order.name} 已拒絕！`);
                // 重新顯示模態框以更新列表
                showPendingOrdersModal();
            }
        };
        
        window.viewRoomDetails = function(roomId) {
            document.getElementById('room-status-modal')?.remove();
            // Package management removed - packages are now integrated into room types
        };
        
        window.manageRoomCalendar = function(roomId) {
            document.getElementById('room-status-modal')?.remove();
            currentManagementRoomId = roomId;
            showPage('calendarManagement');
        };
        
        window.showReplyCommentsModal = function() {
            console.log('showReplyCommentsModal 被調用');
            // 篩選出待回覆的評論
            const pendingComments = window.mockComments.filter(comment => comment.status === 'pending');
            console.log('待回覆評論數量:', pendingComments.length);
            
            const modalHTML = `
                <div id="reply-comments-modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">💬 回覆評論</h2>
                            <button id="close-reply-comments-modal" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        </div>
                        
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            ${pendingComments.length === 0 ? 
                                '<div class="text-center text-gray-500 py-8">🎉 目前沒有待回覆的評論</div>' :
                                pendingComments.map(comment => `
                                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                        <div class="flex justify-between items-start mb-3">
                                            <div>
                                                <h3 class="font-semibold text-[#181111]">${comment.customer}</h3>
                                                <div class="flex items-center gap-2 mt-1">
                                                    <div class="flex text-yellow-400">
                                                        ${'★'.repeat(comment.rating)}${'☆'.repeat(5-comment.rating)}
                                                    </div>
                                                    <span class="text-xs text-gray-500">${comment.date}</span>
                                                </div>
                                            </div>
                                            <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">待回覆</span>
                                        </div>
                                        <div class="text-sm text-gray-700 mb-3">
                                            <div class="mb-2">📝 ${comment.comment}</div>
                                            <div class="text-xs text-gray-500">🏠 ${comment.roomType}</div>
                                        </div>
                                        <div class="space-y-2">
                                            <textarea id="reply-${comment.id}" class="w-full p-2 border border-gray-300 rounded-lg text-sm resize-none" rows="2" placeholder="回覆此評論..."></textarea>
                                            <div class="flex gap-2">
                                                <button class="flex-1 bg-blue-500 text-white text-xs py-2 rounded-lg hover:bg-blue-600 transition-colors" onclick="submitReply(${comment.id})">
                                                    📤 發送回覆
                                                </button>
                                                <button class="flex-1 bg-gray-500 text-white text-xs py-2 rounded-lg hover:bg-gray-600 transition-colors" onclick="skipComment(${comment.id})">
                                                    ⏭️ 稍後處理
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button id="view-all-comments-btn" class="w-full bg-[#181111] text-white py-2 rounded-lg hover:bg-gray-800 transition-colors">
                                查看所有評論
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除現有的模態框（如果有的話）
            const existingModal = document.getElementById('reply-comments-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模態框到頁面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 綁定關閉事件
            document.getElementById('close-reply-comments-modal')?.addEventListener('click', function() {
                document.getElementById('reply-comments-modal')?.remove();
            });
            
            document.getElementById('view-all-comments-btn')?.addEventListener('click', function() {
                document.getElementById('reply-comments-modal')?.remove();
                // 這裡可以跳轉到評論管理頁面
                alert('跳轉到評論管理頁面');
            });
            
            // 點擊背景關閉模態框
            document.getElementById('reply-comments-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        };
        
        window.showDetailedReportsModal = function() {
            console.log('showDetailedReportsModal 被調用');
            
            // 計算一些基本統計數據
            const totalOrders = window.mockOrders.length;
            const completedOrders = window.mockOrders.filter(order => order.status === 'completed').length;
            const pendingOrders = window.mockOrders.filter(order => order.status === 'pending').length;
            const cancelledOrders = window.mockOrders.filter(order => order.status === 'cancelled').length;
            const totalRevenue = window.mockOrders.filter(order => order.status === 'completed').reduce((sum, order) => sum + order.total, 0);
            const averageRating = window.mockComments.reduce((sum, comment) => sum + comment.rating, 0) / window.mockComments.length;
            
            const modalHTML = `
                <div id="detailed-reports-modal" class="modal-overlay">
                    <div class="modal-content max-w-4xl">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">📊 詳細報表</h2>
                            <button id="close-detailed-reports-modal" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- 訂單統計 -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h3 class="font-semibold text-blue-800 mb-3">📋 訂單統計</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>總訂單數:</span>
                                        <span class="font-medium">${totalOrders}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>已完成:</span>
                                        <span class="font-medium text-green-600">${completedOrders}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>待處理:</span>
                                        <span class="font-medium text-yellow-600">${pendingOrders}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>已取消:</span>
                                        <span class="font-medium text-red-600">${cancelledOrders}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 營收統計 -->
                            <div class="bg-green-50 rounded-lg p-4">
                                <h3 class="font-semibold text-green-800 mb-3">💰 營收統計</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>總營收:</span>
                                        <span class="font-medium text-green-600">NT$ ${totalRevenue.toLocaleString()}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>平均訂單金額:</span>
                                        <span class="font-medium">NT$ ${completedOrders > 0 ? Math.round(totalRevenue / completedOrders).toLocaleString() : 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>完成率:</span>
                                        <span class="font-medium">${totalOrders > 0 ? Math.round((completedOrders / totalOrders) * 100) : 0}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 客戶滿意度 -->
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <h3 class="font-semibold text-yellow-800 mb-3">⭐ 客戶滿意度</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>平均評分:</span>
                                        <span class="font-medium">${averageRating.toFixed(1)} / 5.0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>總評論數:</span>
                                        <span class="font-medium">${window.mockComments.length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>已回覆:</span>
                                        <span class="font-medium text-green-600">${window.mockComments.filter(c => c.status === 'replied').length}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>待回覆:</span>
                                        <span class="font-medium text-yellow-600">${window.mockComments.filter(c => c.status === 'pending').length}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 房型使用率 -->
                            <div class="bg-purple-50 rounded-lg p-4">
                                <h3 class="font-semibold text-purple-800 mb-3">🏠 房型使用率</h3>
                                <div class="space-y-2 text-sm">
                                    ${window.mockRoomTypes.map(room => {
                                        const roomBookings = window.mockBookings.filter(booking => booking.roomId === room.id);
                                        const occupancyRate = room.stock > 0 ? Math.round((roomBookings.length / room.stock) * 100) : 0;
                                        return `
                                            <div class="flex justify-between">
                                                <span>${room.name}:</span>
                                                <span class="font-medium">${occupancyRate}%</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button id="view-analytics-dashboard-btn" class="w-full bg-[#181111] text-white py-2 rounded-lg hover:bg-gray-800 transition-colors">
                                前往數據分析頁面
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除現有的模態框（如果有的話）
            const existingModal = document.getElementById('detailed-reports-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新模態框到頁面
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 綁定關閉事件
            document.getElementById('close-detailed-reports-modal')?.addEventListener('click', function() {
                document.getElementById('detailed-reports-modal')?.remove();
            });
            
            document.getElementById('view-analytics-dashboard-btn')?.addEventListener('click', function() {
                document.getElementById('detailed-reports-modal')?.remove();
                // 跳轉到數據分析頁面
                const analyticsLink = document.getElementById('analytics-dashboard-link');
                if (analyticsLink) {
                    analyticsLink.click();
                }
            });
            
            // 點擊背景關閉模態框
            document.getElementById('detailed-reports-modal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.remove();
                }
            });
        };
        
        window.submitReply = function(commentId) {
            const replyTextarea = document.getElementById(`reply-${commentId}`);
            const replyText = replyTextarea.value.trim();
            
            if (!replyText) {
                alert('請輸入回覆內容');
                return;
            }
            
            const comment = window.mockComments.find(c => c.id === commentId);
            if (comment) {
                comment.reply = replyText;
                comment.status = 'replied';
                alert(`已回覆 ${comment.customer} 的評論！`);
                // 重新顯示模態框以更新列表
                showReplyCommentsModal();
            }
        };
        
        window.skipComment = function(commentId) {
            const comment = window.mockComments.find(c => c.id === commentId);
            if (comment) {
                alert(`已標記 ${comment.customer} 的評論為稍後處理`);
                // 這裡可以添加標記邏輯
            }
        };
    </script>
</body>
</html>

