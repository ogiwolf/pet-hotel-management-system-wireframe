<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw Pad App</title>
    <!-- å¼•å…¥æ–°è¨­è¨ˆçš„å­—é«” -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Leaflet åœ°åœ– (å…è²»æ›¿ä»£æ–¹æ¡ˆ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* åŒ¹é…æ–°è¨­è¨ˆçš„åŸºç¤æ¨£å¼ */
        body {
            font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
            background-color: #f0f2f5; /* æ•´é«”èƒŒæ™¯è‰² */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
        }

        .phone-mockup {
            width: 375px;
            min-height: 667px;
            background-color: #fff;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* ç‚ºåº•éƒ¨å°èˆªé ç•™ç©ºé–“ */
            position: relative; /* ç‚ºè¨‚æˆ¿æµç¨‹çš„absoluteå®šä½æä¾›åƒè€ƒ */
        }

        /* éš±è—æ»¾å‹•æ¢ */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* æ–°è¨­è¨ˆé¢¨æ ¼çš„æŒ‰éˆ• */
        .btn-main {
             display: flex;
             cursor: pointer;
             align-items: center;
             justify-content: center;
             overflow: hidden;
             border-radius: 9999px; /* rounded-full */
             height: 48px; /* h-12 */
             padding-left: 24px; /* px-6 */
             padding-right: 24px;
             background-color: #181111;
             color: #ffffff;
             font-size: 1rem; /* text-base */
             font-weight: 700; /* font-bold */
             line-height: 1.5; /* leading-normal */
             border: none;
             width: 100%;
        }
        .btn-main:hover {
            background-color: #333;
        }
        
        /* è¡¨å–®è¼¸å…¥æ¡†æ¨£å¼ */
        .form-input-styled {
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            color: #181111;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            padding: 0.75rem;
            font-size: 1rem;
        }
        .form-input-styled:focus {
            outline: none;
            box-shadow: 0 0 0 2px #181111;
            border-color: #181111;
        }
        
        /* å¡ç‰‡æ¨£å¼ */
        .listing-card {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 1rem; /* gap-4 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            border: 1px solid #f4f0f0;
            background-color: #fff;
        }
        
        .listing-card .info-section {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* gap-4 */
            flex: 2 1 0%;
        }
        
        .listing-card .image-section {
            width: 100%;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1 / 1;
            background-size: cover;
            border-radius: 0.75rem; /* rounded-xl */
            flex: 1.5 1 0%;
        }
        
        /* åº•éƒ¨å°èˆªé …ç›® */
        .nav-item .icon-wrapper { color: #886364; }
        .nav-item p { color: #886364; }
        .nav-item.active .icon-wrapper { color: #181111; }
        .nav-item.active p { color: #181111; }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 15px; width: 90%; max-width: 360px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .calendar-day {
            padding: 8px 0; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.selected { background-color: #181111; color: #fff; }
        .calendar-day.in-range { background-color: #e5e7eb; color: #181111; border-radius: 0; }
        .calendar-day.range-start { background-color: #181111; color: #fff; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .calendar-day.range-end { background-color: #181111; color: #fff; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        
        /* æœå‹™é¡å‹åˆ‡æ› */
        .service-type-toggle button {
            transition: all 0.2s ease-in-out;
        }
        .service-type-toggle button.active {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #181111;
        }
        .service-type-toggle button:not(.active) {
            color: #886364;
        }
        
        /* æ–¹æ¡ˆæ¨£å¼ */
        .package-item {
            border: 2px solid #f4f0f0;
            transition: all 0.2s ease-in-out;
        }
        .package-item.selected {
            border-color: #181111;
            background-color: #f9fafb;
        }
        .package-item.unavailable {
            opacity: 0.5;
            background-color: #f9fafb;
            cursor: not-allowed;
        }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #181111; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        
        /* æ™‚é–“æ»‘æ¡¿æ¨£å¼ */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e5e7eb;
            outline: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .slider:hover {
            background: #d1d5db;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-moz-range-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        /* æ™‚é–“é¡¯ç¤ºæ¨™ç±¤æ¨£å¼ */
        #start-time-display {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        #end-time-display {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        /* ç®¡ç†è¡Œäº‹æ›†æ¨£å¼ */
        .mgmt-calendar-cell.blocked {
            background-image: repeating-linear-gradient(45deg, #e5e7eb, #e5e7eb 5px, #f9fafb 5px, #f9fafb 10px);
        }

        /* ç•¶å‰æ™‚é–“ç·šå‹•ç•« */
        .current-time-line {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* UIå„ªåŒ–ï¼šéš±è—çµæŸæ™‚é–“æ»‘æ¡¿ï¼Œåªä¿ç•™é–‹å§‹æ™‚é–“é¸æ“‡ */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }
        
        /* å„ªåŒ–æ™‚é•·é¡¯ç¤ºå€åŸŸ */
        #daycare-date-selection .bg-gray-50 {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
        }

        /* ç¾åŒ–æ™‚é–“é¸æ“‡å€åŸŸ */
        #daycare-date-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        #daycare-date-selection .mb-4 {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        #daycare-date-selection .bg-gray-50 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* ç¢ºä¿æ‰€æœ‰æ™‚é–“æ»‘æ¡¿éƒ½é¡¯ç¤º - è¦†è“‹ä¹‹å‰çš„éš±è—è¦å‰‡ */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }

        /* æ›´å¼·åˆ¶çš„é¡¯ç¤ºè¦å‰‡ */
        #end-time-slider,
        #end-time-display {
            display: block !important;
            visibility: visible !important;
        }
        
        /* ç¢ºä¿çµæŸæ™‚é–“å€åŸŸé¡¯ç¤º */
        #daycare-date-selection div:has(#end-time-slider) {
            display: block !important;
            opacity: 1 !important;
        }

        /* è¨­å®šé é¢æ¨™ç±¤æ¨£å¼ */
        .settings-tab-btn {
            background-color: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        
        .settings-tab-btn.active {
            background-color: #181111;
            color: white;
        }
        
        .settings-tab-btn:hover:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .settings-tab-content {
            transition: opacity 0.3s ease;
        }

        /* æ—¥é–“å®‰è¦ªæ™‚é–“é¸æ“‡å„ªåŒ– */
        .daycare-time-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        /* ç¢ºä¿æ™‚æ®µé¸æ“‡å™¨æ–‡å­—å¯è¦‹ */
        .time-range-selector {
            background: white !important;
            border: 2px solid #e5e7eb !important;
        }
        
        .time-range-selector select {
            color: #181111 !important;
            background: white !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector label {
            color: #374151 !important;
            font-weight: 600 !important;
        }
        
        /* æ™‚æ®µè³‡è¨Šé¡¯ç¤ºå€åŸŸ */
        .time-range-selector .bg-white {
            background: #f9fafb !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector .bg-white span {
            color: #181111 !important;
        }
        

        
        .preset-time-slots {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .preset-time-slot {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .preset-time-slot:hover {
            border-color: #181111;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preset-time-slot.selected {
            border-color: #181111;
            background-color: #f9fafb;
            box-shadow: 0 2px 8px rgba(24, 17, 17, 0.15);
        }
        
        .preset-time-slot .time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .time-label {
            font-weight: 600;
            color: #181111;
            font-size: 16px;
        }
        
        .preset-time-slot .price {
            font-weight: 700;
            color: #059669;
            font-size: 18px;
        }
        
        .preset-time-slot .time-detail {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .preset-time-slot .feature-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        /* åƒ¹æ ¼é€æ˜åº¦æ”¹é€² */
        .price-transparency {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .price-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .price-item:last-child {
            border-bottom: none;
        }
        
        .price-item.addon {
            background: #f9fafb;
            margin: 8px -12px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .price-item .item-label {
            color: #374151;
            font-size: 14px;
        }
        
        .price-item .item-detail {
            color: #6b7280;
            font-size: 13px;
        }
        
        .price-item .item-price {
            font-weight: 600;
            color: #181111;
        }
        
        .price-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }
        
        .price-total .total-label {
            font-weight: 700;
            color: #181111;
            font-size: 16px;
        }
        
        .price-total .total-price {
            font-weight: 700;
            color: #059669;
            font-size: 20px;
        }
        
        /* éŒ¯èª¤è™•ç†æ©Ÿåˆ¶å„ªåŒ– */
        .error-handling {
            margin: 16px 0;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        
        .error-message .error-title {
            color: #dc2626;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message .error-list {
            color: #7f1d1d;
            font-size: 13px;
            margin: 0;
            padding-left: 20px;
        }
        
        .error-message .error-list li {
            margin-bottom: 4px;
        }
        
        .validation-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .validation-indicator.valid {
            color: #059669;
        }
        
        .validation-indicator.invalid {
            color: #dc2626;
        }
        
        .validation-indicator .icon {
            width: 16px;
            height: 16px;
        }
        
        /* è‡ªè¨‚æ™‚æ®µé¸æ“‡å„ªåŒ– */
        .custom-time-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
            margin-top: 16px;
        }
        
        .custom-time-toggle {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .custom-time-toggle:hover {
            border-color: #181111;
            color: #181111;
        }
        
        .custom-time-toggle.active {
            background: #181111;
            color: white;
            border-color: #181111;
        }
        
        .time-sliders {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .time-sliders.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="phone-mockup">
        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div id="main-content" class="content-area no-scrollbar">

            <!-- æ‰€æœ‰é é¢å®¹å™¨ -->
            <div id="home-page" class="page-content"></div>
            <div id="search-result-page" class="page-content hidden"></div>
            <div id="detail-page" class="page-content hidden"></div>
            <div id="favorites-page" class="page-content hidden"></div>
            <div id="orders-page" class="page-content hidden"></div>
            <div id="user-center-page" class="page-content hidden"></div>
            <div id="merchant-dashboard-page" class="page-content hidden"></div>
            <div id="room-management-page" class="page-content hidden"></div>
            <div id="package-management-page" class="page-content hidden"></div>
            <div id="chat-page" class="page-content hidden"></div>
            <div id="calendar-management-page" class="page-content hidden"></div>
            <div id="booking-flow-page" class="page-content hidden"></div>
            <div id="settings-page" class="page-content hidden"></div>
        </div>

        <!-- å…¨è¢å¹•æ¨¡æ…‹æ¡† (ç”¨æ–¼æ–°å¢/ç·¨è¼¯) -->
        <div id="form-modal" class="absolute inset-0 bg-gray-50 z-20 hidden page-content no-scrollbar">
            <!-- å…§å®¹ç”±JSå‹•æ…‹ç”Ÿæˆ -->
        </div>

        <!-- æ—¥æ›† Modal -->
        <div id="calendar-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <!-- æ—¥æ›†å…§å®¹ç”±JSç”Ÿæˆ -->
            </div>
        </div>

        <!-- åº•éƒ¨å°è¦½åˆ— -->
        <div class="absolute bottom-0 left-0 right-0 z-10">
            <div class="flex gap-2 border-t border-[#f4f0f0] bg-white px-4 pb-3 pt-2">
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="home">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l80-75.48.11-.11a16,16,0,0,1,21.53,0,1.14,1.14,0,0,0,.11.11l80,75.48A16,16,0,0,1,224,115.55Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">é¦–é </p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="favorites">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,16V161.57l-51.77-32.35a8,8,0,0,0-8.48,0L72,161.56V48Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">æˆ‘çš„æ”¶è—</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="orders">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,48H48A16,16,0,0,0,32,64V192a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V64A16,16,0,0,0,208,48Zm-40,96H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Zm0-32H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">è¨‚å–®</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="account">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">æˆ‘çš„å¸³æˆ¶</p>
                </a>
            </div>
            <div class="h-5 bg-white"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ç‹€æ…‹èˆ‡è³‡æ–™ ---
            let isUserMerchant = false;
            let currentCalendarDate = new Date();
            let selectedCheckinDate = null;
            let selectedCheckoutDate = null;
            let isSelectingCheckin = true;
            let managementCalendarDate = new Date();
            let currentManagementRoomId = 1;
            let managementViewMode = 'monthly'; // 'monthly' or 'daily'


            const mockOrders = [
                { id: 1, name: 'å¿«æ¨‚çˆªå­æ—…é¤¨', date: '2025/07/10 - 2025/07/12', pet: '1 çŠ¬', total: 1600, status: 'pending' },
                { id: 2, name: 'è²“èªå¤©å ‚', date: '2025/06/01 - 2025/06/05', pet: '2 è²“', total: 3250, status: 'completed' },
                { id: 3, name: 'å¯µç‰©æ¨‚åœ’', date: '2025/05/20 - 2025/05/22', pet: '1 çŠ¬', total: 1800, status: 'cancelled' },
                { id: 4, name: 'æ±ªæ˜Ÿäººåº¦å‡æ‘', date: '2025-07-01 - 2025-07-03', pet: '1 çŠ¬', total: 2850, status: 'pending' },
                { id: 5, name: 'å¿«æ¨‚çˆªå­æ—…é¤¨', date: '2025-04-10 - 2025-04-12', pet: '1 è²“', total: 1300, status: 'completed' },
            ];
            
            let mockRoomTypes = [
                { id: 1, name: 'æ¨™æº–çŠ¬æˆ¿', description: 'èˆ’é©çš„æ¨™æº–æˆ¿ï¼Œé©åˆä¸­å°å‹çŠ¬ã€‚', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 5, status: 'active' },
                { id: 2, name: 'è±ªè¯è²“åˆ¥å¢…', description: 'å¯¬æ•çš„è±ªè¯åˆ¥å¢…ï¼Œé™„æœ‰è²“è·³å°èˆ‡ç¨ç«‹é€šé¢¨ã€‚', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 3, status: 'active' },
                { id: 3, name: 'å°å‹å¯µç‰©å¯„å®¿ç± ', description: 'å®‰å…¨èˆ’é©çš„å¯„å®¿ç± ï¼Œé©åˆå…”å­ã€å€‰é¼ ç­‰ã€‚', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 10, status: 'disabled' },
                { id: 4, name: 'é™½å…‰è±ªè¯é›™äººæˆ¿', description: 'é™„æœ‰é™½å°çš„é›™å¯µç‰©è±ªè¯æˆ¿ã€‚', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 2, status: 'active' }
            ];
            
            let mockPackages = [
                { id: 101, roomId: 1, name: 'æ¨™æº–æ—¥ç§Ÿæ–¹æ¡ˆ', description: 'æä¾›æ¨™æº–èˆ’é©éå¤œå¯„å®¿æœå‹™ã€‚', type: 'overnight', basePrice: 800, min: 1, max: 30, quota: 3, status: 'active', startDate: '', endDate: '', color: 'bg-blue-400' },
                { id: 102, roomId: 1, name: 'å®‰è¦ªæ–¹æ¡ˆA', description: 'æ—¥é–“å®‰è¦ªï¼Œå››å°æ™‚æ–¹æ¡ˆã€‚', type: 'daycare', basePrice: 150, daycareLengths: '4', startTime: '09:00', endTime: '18:00', overtimeRate: 180, quota: 2, status: 'active', startDate: '', endDate: '', color: 'bg-green-400' },
                { id: 103, roomId: 1, name: 'å®‰è¦ªæ–¹æ¡ˆB', description: 'æ—¥é–“å®‰è¦ªï¼Œå…«å°æ™‚æ–¹æ¡ˆã€‚', type: 'daycare', basePrice: 120, daycareLengths: '8', startTime: '09:00', endTime: '18:00', overtimeRate: 150, quota: 1, status: 'disabled', startDate: '', endDate: '', color: 'bg-yellow-400' },
                { id: 201, roomId: 2, name: 'è±ªè¯è²“åˆ¥å¢…æ—¥ç§Ÿ', description: 'å°ˆå±¬è±ªè¯ç©ºé–“ï¼Œè²“å’ªæœ€æ„›ã€‚', type: 'overnight', basePrice: 1500, min: 1, max: 15, quota: 3, status: 'active', startDate: '', endDate: '', color: 'bg-pink-400' },
            ];
            
            let mockBookings = [
                { id: 1, roomId: 1, packageId: 101, customer: 'é™³å…ˆç”Ÿ', startDate: '2025-07-10', endDate: '2025-07-12' },
                { id: 2, roomId: 2, packageId: 201, customer: 'æ—å°å§', startDate: '2025-07-15', endDate: '2025-07-18' },
                { id: 3, roomId: 1, packageId: 101, customer: 'ç‹å°å§', startDate: '2025-07-20', endDate: '2025-07-25' },
                { id: 4, roomId: 1, packageId: 102, customer: 'æå…ˆç”Ÿ', startDate: '2025-07-05', endDate: '2025-07-05' },
                { id: 5, roomId: 2, packageId: 201, customer: 'å¼µå¤ªå¤ª', startDate: '2025-07-01', endDate: '2025-07-03' },
                { id: 6, roomId: 1, packageId: 102, customer: 'å³å…ˆç”Ÿ', startDate: '2025-07-14', endDate: '2025-07-14' },
                { id: 7, roomId: 4, customer: 'è”¡å°å§', startDate: '2025-07-22', endDate: '2025-07-23' },
                { id: 8, roomId: 4, customer: 'é„­å…ˆç”Ÿ', startDate: '2025-07-08', endDate: '2025-07-11' },
                { id: 9, roomId: 1, packageId: 101, customer: 'è¶™å°å§', startDate: '2025-07-10', endDate: '2025-07-11' },
                // æ–°å¢æ›´å¤šé è¨‚ä¾†æ¨¡æ“¬æ»¿æˆ¿æƒ…æ³
                { id: 10, roomId: 1, packageId: 101, customer: 'åŠ‰å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 11, roomId: 1, packageId: 101, customer: 'é»ƒå°å§', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 12, roomId: 1, packageId: 101, customer: 'å‘¨å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 13, roomId: 1, packageId: 101, customer: 'å³å¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 14, roomId: 1, packageId: 101, customer: 'æ—å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 15, roomId: 3, packageId: 103, customer: 'é™³å¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-20' },
                { id: 16, roomId: 3, packageId: 103, customer: 'å¼µå…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 17, roomId: 3, packageId: 103, customer: 'æå°å§', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 18, roomId: 3, packageId: 103, customer: 'ç‹å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-19' },
                { id: 19, roomId: 3, packageId: 103, customer: 'åŠ‰å¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 20, roomId: 3, packageId: 103, customer: 'é»ƒå…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 21, roomId: 3, packageId: 103, customer: 'å‘¨å¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 22, roomId: 3, packageId: 103, customer: 'å³å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-20' },
                { id: 23, roomId: 3, packageId: 103, customer: 'æ—å¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 24, roomId: 3, packageId: 103, customer: 'é™³å…ˆç”Ÿ', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 25, roomId: 3, packageId: 103, customer: 'å¼µå¤ªå¤ª', startDate: '2025-01-15', endDate: '2025-01-19' },
            ];

            // --- å…ƒç´ é¸æ“‡ ---
            const navItems = document.querySelectorAll('.nav-item');
            const mainContent = document.getElementById('main-content');
            const pages = {
                home: document.getElementById('home-page'),
                searchResult: document.getElementById('search-result-page'),
                detail: document.getElementById('detail-page'),
                favorites: document.getElementById('favorites-page'),
                orders: document.getElementById('orders-page'),
                account: document.getElementById('user-center-page'),
                chat: document.getElementById('chat-page'),
                merchantDashboard: document.getElementById('merchant-dashboard-page'),
                roomManagement: document.getElementById('room-management-page'),
                packageManagement: document.getElementById('package-management-page'),
                calendarManagement: document.getElementById('calendar-management-page'),
                bookingFlow: document.getElementById('booking-flow-page'),
                settings: document.getElementById('settings-page'),
            };
            const calendarModal = document.getElementById('calendar-modal');
            const formModal = document.getElementById('form-modal');

            // --- æ ¸å¿ƒåŠŸèƒ½ï¼šé é¢åˆ‡æ› ---
            function showPage(pageKey, state = {}) {
                Object.values(pages).forEach(page => page && page.classList.add('hidden'));
                
                const targetPage = pages[pageKey];
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    if (pageKey === 'detail') renderDetailPage(state);
                    if (pageKey === 'orders') renderOrdersPage();
                    if (pageKey === 'account') renderUserCenterPage();
                    if (pageKey === 'merchantDashboard') renderMerchantDashboard();
                    if (pageKey === 'roomManagement') renderRoomListPage();
                    if (pageKey === 'packageManagement') renderPackageListPage(state.roomId);
                    if (pageKey === 'chat') renderChatPage();
                    if (pageKey === 'home') renderHomePage();
                    if (pageKey === 'favorites') renderFavoritesPage();
                    if (pageKey === 'calendarManagement') renderCalendarManagementPage();
                    if (pageKey === 'bookingFlow') renderBookingFlowPage();
                    if (pageKey === 'settings') renderSettingsPage();
                }
                updateNavActiveState(pageKey);
            }

            function updateNavActiveState(activePageKey) {
                navItems.forEach(item => {
                    const page = item.dataset.page;
                    item.classList.toggle('active', page === activePageKey);
                });
            }

            // --- æ¸²æŸ“å‡½å¼ ---
            function renderHomePage() {
                const container = pages.home;
                container.innerHTML = `
                <!-- é é¦– -->
                <div class="flex items-center bg-white p-4 pb-2 justify-between sticky top-0 z-10 border-b border-gray-100">
                    <div class="flex w-12 items-center justify-start">
                        <button id="chat-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H40A16,16,0,0,0,24,64V224a15.84,15.84,0,0,0,9.37,14.66A16,16,0,0,0,40,240a15.82,15.82,0,0,0,10.63-4.37L82.37,204H216a16,16,0,0,0,16-16V64A16,16,0,0,0,216,48ZM128,144a8,8,0,1,1,8-8A8,8,0,0,1,128,144Zm40,0a8,8,0,1,1,8-8A8,8,0,0,1,168,144ZM88,144a8,8,0,1,1,8-8A8,8,0,0,1,88,144Z"></path></svg>
                        </button>
                    </div>
                    <h2 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Paw Pad</h2>
                    <div class="flex w-12 items-center justify-end">
                        <button id="profile-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
                        </button>
                    </div>
                </div>
                <!-- æœå°‹æ¡† -->
                <div class="px-4 py-3">
                    <div class="flex w-full flex-1 items-stretch rounded-xl h-12">
                        <div class="text-[#886364] flex border-none bg-[#f4f0f0] items-center justify-center pl-4 rounded-l-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                        </div>
                        <input id="home-search-input" placeholder="æœå°‹åœ°é»ã€å¯µç‰©æ—…é¤¨æˆ–ä¿æ¯..." class="form-input-styled placeholder:text-[#886364] px-4 rounded-l-none pl-2 text-base font-normal leading-normal" />
                    </div>
                </div>
                
                <!-- å»£å‘Šæ©«å¹… -->
                <div class="px-4 mb-4">
                    <div class="relative w-full bg-center bg-no-repeat aspect-[2/1] bg-cover rounded-xl flex flex-col justify-end p-4 text-white" style='background-image: linear-gradient(to top, rgba(0,0,0,0.6), transparent), url("https://images.unsplash.com/photo-1552053831-71594a27632d?q=80&w=1000");'>
                         <h3 class="font-bold text-lg">å¤æ—¥å„ªæƒ </h3>
                         <p class="text-sm">ç«‹å³é è¨‚ï¼Œäº« 85 æŠ˜å„ªæƒ ï¼</p>
                    </div>
                </div>

                <!-- æ¨è–¦å€å¡Š -->
                <h2 class="text-[#181111] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-2">æ¨è–¦çµ¦æ‚¨</h2>
                <div class="px-4 space-y-4">
                    <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">â­ï¸ 4.8 â€¢ 120 å‰‡è©•åƒ¹</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">å¿«æ¨‚çˆªå­æ—…é¤¨</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">å°åŒ—å¸‚ â€¢ æ¥å—çŠ¬ã€è²“</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$800/æ™š èµ·</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">â­ï¸ 4.9 â€¢ 150 å‰‡è©•åƒ¹</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">è²“èªå¤©å ‚</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">æ–°åŒ—å¸‚ â€¢ åƒ…æ¥å—è²“</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$650/æ™š èµ·</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">â­ï¸ 4.7 â€¢ 85 å‰‡è©•åƒ¹</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">æ±ªæ˜Ÿäººåº¦å‡æ‘</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">å°ä¸­å¸‚ â€¢ åƒ…æ¥å—çŠ¬</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$950/æ™š èµ·</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600");'></div>
                    </div>
                </div>
                `;
            }
            
            function renderChatPage() {
                pages.chat.innerHTML = `
                 <h1 class="text-2xl font-bold mb-4 text-center text-[#181111] p-4">è¨Šæ¯ä¸­å¿ƒ</h1>
                 <div class="space-y-3 px-4">
                    <!-- ç½®é ‚èŠå¤©é …ç›® -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 flex items-center gap-4 cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">P</div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">Paw Pad å®˜æ–¹å®¢æœ</p>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full flex-shrink-0">ç½®é ‚</span>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">æ­¡è¿ä½¿ç”¨ï¼æœ‰ä»»ä½•å•é¡Œéš¨æ™‚èˆ‡æˆ‘å€‘è¯ç¹«ã€‚</p>
                            </div>
                        </div>
                    </div>
                    <!-- ä¸€èˆ¬èŠå¤©é …ç›® -->
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">å¿«æ¨‚çˆªå­æ—…é¤¨</p>
                                <p class="text-xs text-[#886364]">æ˜¨å¤©</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">å¥½çš„ï¼Œæ‚¨çš„é è¨‚å·²ç¢ºèªï¼</p>
                                <span class="bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">2</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">è²“èªå¤©å ‚</p>
                                <p class="text-xs text-[#886364]">2å¤©å‰</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">ä¸å®¢æ°£ï¼</p>
                            </div>
                        </div>
                    </div>
                 </div>`;
            }

            function renderDetailPage() {
                pages.detail.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">å¿«æ¨‚çˆªå­æ—…é¤¨</h1>
                    <div class="w-full bg-center bg-no-repeat aspect-[4/3] bg-cover rounded-xl" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">é—œæ–¼</p>
                         <p class="text-[#886364] text-sm mt-2">æä¾›æœ€æº«é¦¨èˆ’é©çš„ç’°å¢ƒï¼Œè®“æ‚¨çš„å¯µç‰©å¦‚åŒåœ¨å®¶ä¸€èˆ¬è‡ªåœ¨ã€‚æˆ‘å€‘æœ‰å°ˆæ¥­çš„ç…§è­·äººå“¡èˆ‡å¯¬æ•çš„æ´»å‹•ç©ºé–“ã€‚</p>
                    </div>

                    <!-- é è¨‚å€å¡Š -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">é è¨‚æœå‹™</h2>
                        
                        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
                        <div class="mb-6">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-[#181111] text-white flex items-center justify-center text-sm font-bold">1</div>
                                    <span class="ml-2 text-sm font-medium text-[#181111]">æœå‹™é¡å‹</span>
                                </div>
                                <div class="w-8 h-1 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold">2</div>
                                    <span class="ml-2 text-sm font-medium text-gray-500">é¸æ“‡æ–¹æ¡ˆ</span>
                                </div>
                                <div class="w-8 h-1 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold">3</div>
                                    <span class="ml-2 text-sm font-medium text-gray-500">é¸æ“‡æ™‚æ®µ</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ­¥é©Ÿ 1: æœå‹™é¡å‹é¸æ“‡ -->
                        <div id="step-1-service-type" class="booking-step">
                            <h3 class="font-medium text-[#181111] mb-4 text-center">è«‹é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™é¡å‹</h3>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button id="select-overnight" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="overnight">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">ğŸ </div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">å¯„å®¿éå¤œ</div>
                                    <div class="text-sm text-gray-600 mb-3">é©åˆå‡ºå·®æ—…è¡Œã€åº¦å‡æ™‚ä½¿ç”¨</div>
                                    <div class="text-xs text-blue-600 font-medium">24å°æ™‚å°ˆæ¥­ç…§è­·</div>
                                </button>
                                <button id="select-daycare" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="daycare">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">â°</div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">æ—¥é–“å®‰è¦ª</div>
                                    <div class="text-sm text-gray-600 mb-3">ä¸Šç­æ™‚é–“çš„å°ˆæ¥­é™ªä¼´</div>
                                    <div class="text-xs text-green-600 font-medium">å½ˆæ€§æ™‚æ®µé¸æ“‡</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- æ­¥é©Ÿ 2: æ–¹æ¡ˆé¸æ“‡ -->
                        <div id="step-2-plan-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">é¸æ“‡æ–¹æ¡ˆ</h3>
                                <button id="back-to-service-type" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">â†</span> è¿”å›
                                </button>
                            </div>
                            
                            <!-- å¯„å®¿éå¤œæ–¹æ¡ˆ -->
                            <div id="overnight-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="standard" data-price="1200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">æ¨™æº–å¥—æˆ¿</div>
                                            <div class="text-sm text-gray-600">èˆ’é©å–®äººæˆ¿ï¼Œé©åˆå°å‹å¯µç‰©</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,200</div>
                                            <div class="text-xs text-gray-500">æ¯æ™š</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="deluxe" data-price="1800">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">è±ªè¯å¥—æˆ¿</div>
                                            <div class="text-sm text-gray-600">å¯¬æ•é›™äººæˆ¿ï¼Œå«ç¨ç«‹é™½å°</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,800</div>
                                            <div class="text-xs text-gray-500">æ¯æ™š</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="premium" data-price="2500">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">é ‚ç´šå¥—æˆ¿</div>
                                            <div class="text-sm text-gray-600">ç¸½çµ±ç´šå¾…é‡ï¼Œå«å°ˆå±¬ç®¡å®¶</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 2,500</div>
                                            <div class="text-xs text-gray-500">æ¯æ™š</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ—¥é–“å®‰è¦ªæ–¹æ¡ˆ -->
                            <div id="daycare-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="1å°æ™‚æ–¹æ¡ˆ" data-price="150">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">1å°æ™‚æ–¹æ¡ˆ</div>
                                            <div class="text-sm text-gray-600">åŸºæœ¬é™ªä¼´èˆ‡ç…§è­·æœå‹™</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 150</div>
                                            <div class="text-xs text-gray-500">1å°æ™‚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="2å°æ™‚æ–¹æ¡ˆ" data-price="300">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">2å°æ™‚æ–¹æ¡ˆ</div>
                                            <div class="text-sm text-gray-600">å«æˆ¶å¤–æ´»å‹•èˆ‡ç‡Ÿé¤Šé¤é»</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 300</div>
                                            <div class="text-xs text-gray-500">2å°æ™‚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="4å°æ™‚æ–¹æ¡ˆ" data-price="540">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">4å°æ™‚æ–¹æ¡ˆ</div>
                                            <div class="text-sm text-gray-600">å«æ´—æ¾¡ã€ç¾å®¹ç­‰å¢å€¼æœå‹™</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 540</div>
                                            <div class="text-xs text-gray-500">4å°æ™‚</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ­¥é©Ÿ 3: æ™‚æ®µé¸æ“‡ -->
                        <div id="step-3-time-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">é¸æ“‡æ™‚æ®µ</h3>
                                <button id="back-to-plan-selection" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">â†</span> è¿”å›
                                </button>
                            </div>
                            
                            <!-- å¯„å®¿éå¤œçš„æ—¥æœŸé¸æ“‡ -->
                            <div id="overnight-date-selection" class="space-y-4 hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">å…¥ä½æ—¥æœŸ</label>
                                        <input type="date" id="detail-checkin-date" class="form-input-styled text-center w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">é€€æˆ¿æ—¥æœŸ</label>
                                        <input type="date" id="detail-checkout-date" class="form-input-styled text-center w-full">
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-sm text-blue-800">
                                        <span class="font-medium">å…¥ä½å¤©æ•¸ï¼š</span>
                                        <span id="stay-duration">è«‹é¸æ“‡æ—¥æœŸ</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ—¥é–“å®‰è¦ªçš„æ—¥æœŸ+æ™‚æ®µé¸æ“‡ -->
                            <div id="daycare-date-selection" class="space-y-4 hidden">
                                <div class="mb-4">
                                    <label class="text-sm text-gray-600 block mb-2 font-medium">æœå‹™æ—¥æœŸ</label>
                                    <input type="date" id="detail-service-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <!-- æ™‚æ®µé¸æ“‡ -->
                                <div class="daycare-time-selection">
                                    <h4 class="font-medium text-[#181111] mb-3">é¸æ“‡æœå‹™æ™‚æ®µ</h4>
                                    
                                    <!-- è‡ªç”±æ™‚æ®µé¸æ“‡ -->
                                    <div class="flexible-time-selection space-y-4">
                                        <!-- æ™‚æ®µé¸æ“‡å™¨ -->
                                        <div class="time-range-selector p-4 bg-gray-50 rounded-lg">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">é–‹å§‹æ™‚é–“</label>
                                                    <select id="start-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="8">08:00</option>
                                                        <option value="9">09:00</option>
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">çµæŸæ™‚é–“</label>
                                                    <select id="end-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                        <option value="18">18:00</option>
                                                        <option value="19">19:00</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- æ–¹æ¡ˆæ™‚é•·æç¤º -->
                                            <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                                <div class="text-sm text-blue-800">
                                                    <span class="font-medium">æ–¹æ¡ˆæ™‚é•·ï¼š</span>
                                                    <span id="plan-duration-hint">è«‹å…ˆé¸æ“‡æ–¹æ¡ˆ</span>
                                                </div>
                                            </div>
                                            
                                            <!-- æ™‚æ®µè³‡è¨Šé¡¯ç¤º -->
                                            <div class="mt-4 p-3 bg-white rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-sm text-gray-600">æœå‹™æ™‚é•·</span>
                                                    <span class="font-medium text-[#181111]" id="flexible-duration-display">è«‹é¸æ“‡æ™‚æ®µ</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-gray-600">é ä¼°è²»ç”¨</span>
                                                    <span class="font-bold text-green-600" id="flexible-price-display">è«‹é¸æ“‡æ™‚æ®µ</span>
                                                </div>
                                            </div>
                                        </div>
                                        

                                        
                                        <!-- æ™‚æ®µå¯ç”¨æ€§æª¢æŸ¥ -->
                                        <div class="availability-check mt-4">
                                            <button id="check-availability-btn" class="w-full p-3 bg-[#181111] text-white rounded-lg hover:bg-gray-800 transition-colors">
                                                æª¢æŸ¥æ™‚æ®µå¯ç”¨æ€§
                                            </button>
                                            <div id="availability-result" class="mt-3 p-3 rounded-lg hidden">
                                                <!-- å¯ç”¨æ€§çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- éŒ¯èª¤è™•ç†å€åŸŸ -->
                        <div id="booking-errors" class="error-handling hidden">
                            <!-- éŒ¯èª¤è¨Šæ¯å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        
                        <!-- åƒ¹æ ¼é€æ˜åº¦æ”¹é€² -->
                        <div id="price-transparency" class="price-transparency hidden">
                            <h3 class="font-bold text-[#181111] mb-3">åƒ¹æ ¼æ˜ç´°</h3>
                            <div class="price-breakdown">
                                <div class="price-item">
                                    <span class="item-label">æˆ¿å‹è²»ç”¨</span>
                                    <span class="item-detail" id="room-price-detail">è«‹é¸æ“‡æˆ¿å‹</span>
                                    <span class="item-price" id="room-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="duration-item" style="display: none;">
                                    <span class="item-label">æœå‹™æ™‚é•·</span>
                                    <span class="item-detail" id="duration-detail">è«‹é¸æ“‡æ™‚æ®µ</span>
                                    <span class="item-price" id="duration-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="pet-count-item" style="display: none;">
                                    <span class="item-label">å¯µç‰©æ•¸é‡</span>
                                    <span class="item-detail" id="pet-count-detail">1 éš»</span>
                                    <span class="item-price" id="pet-count-price">Ã— 1</span>
                                </div>
                                <div id="addon-items">
                                    <!-- åŠ è³¼æœå‹™é …ç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                                </div>
                                <div class="price-total">
                                    <span class="total-label">ç¸½è¨ˆ</span>
                                    <span class="total-price" id="total-price">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç¹¼çºŒé è¨‚æŒ‰éˆ• -->
                        <div id="continue-booking-section" class="mt-4 hidden">
                            <button id="continue-booking-btn" class="btn-main w-full h-12 text-base">
                                ç¹¼çºŒé è¨‚
                            </button>
                        </div>
                    </div>

                     <div class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">ç”¨æˆ¶è©•åƒ¹</p>
                         <div class="mt-2 space-y-3">
                            <div class="border-b pb-2">
                                <p class="font-bold text-sm">ç‹å°æ˜ <span class="text-xs text-gray-500 ml-2">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</span></p>
                                <p class="text-[#886364] text-sm mt-1">ç’°å¢ƒå¾ˆä¹¾æ·¨ï¼Œç‹—ç‹—ç©å¾—å¾ˆé–‹å¿ƒï¼</p>
                            </div>
                             <div class="border-b pb-2">
                                <p class="font-bold text-sm">é™³å¤ªå¤ª <span class="text-xs text-gray-500 ml-2">â­ï¸â­ï¸â­ï¸â­ï¸</span></p>
                                <p class="text-[#886364] text-sm mt-1">è²“å’ªå¾ˆé©æ‡‰ï¼Œåªæ˜¯æˆ¿é–“éš”éŸ³å¯ä»¥å†åŠ å¼·ã€‚</p>
                            </div>
                         </div>
                    </div>

                    <!-- ä½ç½®åœ°åœ– -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-[#181111] text-lg font-bold">ä½ç½®è³‡è¨Š</p>
                            <button id="open-map-btn" class="text-sm bg-[#181111] text-white px-3 py-1 rounded-full hover:bg-gray-800 transition-colors">
                                å°èˆª
                            </button>
                        </div>
                        <div class="mb-3">
                            <p class="text-sm text-[#886364] mb-1">ğŸ“ å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ</p>
                            <p class="text-xs text-gray-500">è·é›¢æ·é‹å¸‚æ”¿åºœç«™ 5åˆ†é˜æ­¥è¡Œ</p>
                        </div>
                        <div id="hotel-map" class="h-48 rounded-lg bg-gray-100 relative overflow-hidden">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                                <span class="text-sm">è¼‰å…¥åœ°åœ–ä¸­...</span>
                            </div>
                            <!-- åœ°åœ–äº¤äº’æç¤º -->
                            <div id="map-interaction-hint" class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded hidden">
                                é»æ“Šåœ°åœ–å•Ÿç”¨äº¤äº’
                            </div>
                        </div>
                    </div>
                </div>`;
                
                const style = document.createElement('style');
                style.innerHTML = `
                    .daycare-time-btn { padding: 6px 12px; border-radius: 9999px; background-color: #f4f0f0; color: #886364; font-size: 0.875rem; transition: all 0.2s; border:none; }
                    .daycare-time-btn.active { background-color: #181111; color: white; }
                    
                    /* æ»¿æˆ¿ç‹€æ…‹æ¨£å¼ */
                    .unavailable {
                        opacity: 0.6;
                        background-color: #f8f9fa;
                    }
                    
                    .unavailable .package-item {
                        background-color: #f1f3f4 !important;
                        border: 1px solid #e0e0e0 !important;
                        cursor: not-allowed !important;
                    }
                    
                    .unavailable .package-item:hover {
                        background-color: #f1f3f4 !important;
                        transform: none !important;
                    }
                    
                    .package-item {
                        transition: all 0.2s ease;
                        border: 1px solid transparent;
                    }
                    
                    .package-item:hover:not([style*="opacity: 0.5"]) {
                        background-color: #f8f9fa;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .package-item.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .package-item.selected:hover {
                        background-color: #181111 !important;
                        transform: none !important;
                    }
                    
                    /* æ™‚æ®µæŒ‰éˆ•æ¨£å¼ */
                    .time-slot-btn {
                        background-color: #fff;
                        color: #374151;
                    }
                    
                    .time-slot-btn:hover:not(:disabled) {
                        background-color: #f3f4f6;
                        border-color: #6b7280;
                    }
                    
                    .time-slot-btn.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .time-slot-btn:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    
                    /* è¨‚æˆ¿æµç¨‹æ¨£å¼ */
                    .service-type-card {
                        transition: all 0.2s ease;
                    }
                    
                    .service-type-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    
                    .time-slot-option {
                        transition: all 0.2s ease;
                    }
                    
                    .time-slot-option:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .room-selection-card {
                        transition: all 0.2s ease;
                    }
                    
                    .room-selection-card:hover:not([data-unavailable="true"]) {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                `;
                document.head.appendChild(style);

                // æ–°å¢æœå‹™é¸æ“‡äº‹ä»¶ç›£è½å™¨
                attachDetailPageListeners();
            }

            // è©³æƒ…é é¢äº‹ä»¶ç›£è½å™¨
            function attachDetailPageListeners() {
                initHotelMap();
                attachMapListeners();
                attachDetailDateListeners();
            }

            // ç¶å®šè©³æƒ…é æ—¥æœŸé¸æ“‡äº‹ä»¶
            function attachDetailDateListeners() {
                // è¨­å®šé è¨­æ—¥æœŸ
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                
                // æ›´æ–°å…¨åŸŸè®Šæ•¸
                selectedCheckinDate = today;
                selectedCheckoutDate = tomorrow;
                
                // ç¶å®šæœå‹™é¡å‹é¸æ“‡
                attachServiceTypeListeners();
                
                // è¨­å®šéå¤œå¯„å®¿çš„é è¨­æ—¥æœŸ
                const checkinInput = document.getElementById('detail-checkin-date');
                const checkoutInput = document.getElementById('detail-checkout-date');
                const serviceDateInput = document.getElementById('detail-service-date');
                
                if (checkinInput && checkoutInput) {
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // è¨­å®šé è¨­æ—¥æœŸå¾Œï¼Œè‡ªå‹•è¨ˆç®—å…¥ä½å¤©æ•¸
                    bookingData.checkinDate = today.toISOString().split('T')[0];
                    bookingData.checkoutDate = tomorrow.toISOString().split('T')[0];
                    bookingData.stayDuration = 1; // é è¨­1æ™š
                    
                    console.log('é è¨­æ—¥æœŸå·²è¨­å®š:', { 
                        checkin: bookingData.checkinDate, 
                        checkout: bookingData.checkoutDate, 
                        duration: bookingData.stayDuration 
                    });
                    
                    // å¦‚æœæœ‰é¸æ“‡æ–¹æ¡ˆï¼Œè‡ªå‹•æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
                    if (bookingData.selectedPlan && bookingData.planPrice) {
                        console.log('æª¢æ¸¬åˆ°å·²é¸æ“‡æ–¹æ¡ˆï¼Œè‡ªå‹•æ›´æ–°åƒ¹æ ¼é¡¯ç¤º');
                        updatePriceTransparency();
                    }
                    
                    checkinInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            selectedCheckoutDate = nextDay;
                        }
                        checkCanContinueBooking();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        selectedCheckoutDate = new Date(this.value);
                        checkCanContinueBooking();
                    });
                }
                
                // è¨­å®šæ—¥é–“å®‰è¦ªçš„é è¨­æ—¥æœŸ
                if (serviceDateInput) {
                    serviceDateInput.value = today.toISOString().split('T')[0];
                    serviceDateInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        
                        // é‡ç½®å¾ŒçºŒé¸æ“‡
                        bookingData.duration = '';
                        bookingData.timeSlot = '';
                        bookingData.preferredRoomId = null;
                        
                        // éš±è—æˆ¿å‹é¸é …
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) roomServiceList.classList.add('hidden');
                        
                        // æ¸…é™¤æ™‚æ®µé¸æ“‡
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // é‡ç½®æ»‘æ¡¿åˆ°é è¨­å€¼
                        const startTimeSlider = document.getElementById('start-time-slider');
                        const endTimeSlider = document.getElementById('end-time-slider');
                        if (startTimeSlider) startTimeSlider.value = 9;
                        if (endTimeSlider) endTimeSlider.value = 13;
                        
                        // éš±è—è‡ªè¨‚æ™‚æ®µé¸æ“‡
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // é‡ç½®è‡ªè¨‚æ™‚æ®µæŒ‰éˆ•
                        const customToggle = document.querySelector('.custom-time-toggle');
                        if (customToggle) {
                            customToggle.classList.remove('active');
                            customToggle.innerHTML = '<span>è‡ªè¨‚æ™‚æ®µ</span>';
                        }
                        
                        checkCanContinueBooking();
                    });
                }
                
                // ç¶å®šæ™‚æ®µé¸æ“‡
                attachTimeSlotListeners();
                
                // åˆå§‹åŒ–å…¶ä»–è¨‚æˆ¿åŠŸèƒ½
                initializeBookingFunctions();
            }

            // ç¶å®šæœå‹™é¡å‹é¸æ“‡äº‹ä»¶ - æ–°çš„ä¸‰æ­¥é©Ÿæµç¨‹
            function attachServiceTypeListeners() {
                const overnightBtn = document.getElementById('select-overnight');
                const daycareBtn = document.getElementById('select-daycare');
                
                overnightBtn?.addEventListener('click', function() {
                    console.log('å¯„å®¿éå¤œæŒ‰éˆ•è¢«é»æ“Š');
                    
                    // ç°¡å–®æ¸¬è©¦ï¼šç›´æ¥åˆ‡æ›æ­¥é©Ÿ
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    console.log('æ‰¾åˆ°çš„å…ƒç´ :', { step1, step2 });
                    
                    if (step1 && step2) {
                        // éš±è—æ­¥é©Ÿ1
                        step1.style.display = 'none';
                        console.log('æ­¥é©Ÿ1å·²éš±è—');
                        
                        // é¡¯ç¤ºæ­¥é©Ÿ2
                        step2.style.display = 'block';
                        console.log('æ­¥é©Ÿ2å·²é¡¯ç¤º');
                        
                        // é¡¯ç¤ºå¯„å®¿éå¤œæ–¹æ¡ˆ
                        const overnightPlans = document.getElementById('overnight-plans');
                        const daycarePlans = document.getElementById('daycare-plans');
                        
                        if (overnightPlans && daycarePlans) {
                            overnightPlans.style.display = 'block';
                            daycarePlans.style.display = 'none';
                            console.log('æ–¹æ¡ˆé¡¯ç¤ºåˆ‡æ›å®Œæˆ');
                        }
                        
                        // æ›´æ–°é è¨‚è³‡æ–™
                        bookingData.serviceType = 'overnight';
                        console.log('é è¨‚è³‡æ–™å·²æ›´æ–°:', bookingData);
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿå…ƒç´ ');
                    }
                });
                
                daycareBtn?.addEventListener('click', function() {
                    console.log('æ—¥é–“å®‰è¦ªæŒ‰éˆ•è¢«é»æ“Š');
                    
                    // ç°¡å–®æ¸¬è©¦ï¼šç›´æ¥åˆ‡æ›æ­¥é©Ÿ
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    console.log('æ‰¾åˆ°çš„å…ƒç´ :', { step1, step2 });
                    
                    if (step1 && step2) {
                        // éš±è—æ­¥é©Ÿ1
                        step1.style.display = 'none';
                        console.log('æ­¥é©Ÿ1å·²éš±è—');
                        
                        // é¡¯ç¤ºæ­¥é©Ÿ2
                        step2.style.display = 'block';
                        console.log('æ­¥é©Ÿ2å·²é¡¯ç¤º');
                        
                        // é¡¯ç¤ºæ—¥é–“å®‰è¦ªæ–¹æ¡ˆ
                        const daycarePlans = document.getElementById('daycare-plans');
                        const overnightPlans = document.getElementById('overnight-plans');
                        
                        if (daycarePlans && overnightPlans) {
                            daycarePlans.style.display = 'block';
                            overnightPlans.style.display = 'none';
                            console.log('æ–¹æ¡ˆé¡¯ç¤ºåˆ‡æ›å®Œæˆ');
                        }
                        
                        // æ›´æ–°é è¨‚è³‡æ–™
                        bookingData.serviceType = 'daycare';
                        console.log('é è¨‚è³‡æ–™å·²æ›´æ–°:', bookingData);
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿå…ƒç´ ');
                    }
                });
            }
            
            // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
            function updateStepIndicator(currentStep) {
                console.log('æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨åˆ°æ­¥é©Ÿ:', currentStep);
                
                // ä¿®æ­£é¸æ“‡å™¨ï¼šæ‰¾åˆ°æ­¥é©ŸæŒ‡ç¤ºå™¨å®¹å™¨ä¸‹çš„æ¯å€‹æ­¥é©Ÿ
                const stepIndicators = document.querySelectorAll('.mb-6 .flex.items-center.justify-center.space-x-2 > .flex.items-center');
                console.log('æ‰¾åˆ°æ­¥é©ŸæŒ‡ç¤ºå™¨:', stepIndicators.length);
                
                stepIndicators.forEach((indicator, index) => {
                    const stepNumber = indicator.querySelector('.w-8.h-8');
                    const stepText = indicator.querySelector('span');
                    
                    console.log(`æ­¥é©Ÿ ${index + 1}:`, { stepNumber, stepText });
                    
                    if (index + 1 < currentStep) {
                        // å·²å®Œæˆçš„æ­¥é©Ÿ
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else if (index + 1 === currentStep) {
                        // ç•¶å‰æ­¥é©Ÿ
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else {
                        // æœªå®Œæˆçš„æ­¥é©Ÿ
                        stepNumber.classList.remove('bg-[#181111]', 'text-white');
                        stepNumber.classList.add('bg-gray-300', 'text-gray-600');
                        stepText.classList.remove('text-[#181111]');
                        stepText.classList.add('text-gray-500');
                    }
                });
                
                // æ›´æ–°é€£æ¥ç·š
                const connectors = document.querySelectorAll('.mb-6 .flex.items-center.justify-center.space-x-2 > .w-8.h-1');
                console.log('æ‰¾åˆ°é€£æ¥ç·š:', connectors.length);
                
                connectors.forEach((connector, index) => {
                    if (index + 1 < currentStep) {
                        connector.classList.remove('bg-gray-300');
                        connector.classList.add('bg-[#181111]');
                    } else {
                        connector.classList.remove('bg-[#181111]');
                        connector.classList.add('bg-gray-300');
                    }
                });
                
                console.log('æ­¥é©ŸæŒ‡ç¤ºå™¨æ›´æ–°å®Œæˆ');
            }
            
            // ç¶å®šæ–¹æ¡ˆé¸æ“‡äº‹ä»¶ - æ–°çš„ä¸‰æ­¥é©Ÿæµç¨‹
            function attachPlanSelectionListeners() {
                // ç¶å®šè¿”å›æŒ‰éˆ•
                document.getElementById('back-to-service-type')?.addEventListener('click', function() {
                    console.log('è¿”å›æŒ‰éˆ•è¢«é»æ“Š');
                    
                    // è¿”å›æ­¥é©Ÿ1
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    if (step1 && step2) {
                        // éš±è—æ­¥é©Ÿ2
                        step2.style.display = 'none';
                        console.log('æ­¥é©Ÿ2å·²éš±è—');
                        
                        // é¡¯ç¤ºæ­¥é©Ÿ1
                        step1.style.display = 'block';
                        console.log('æ­¥é©Ÿ1å·²é¡¯ç¤º');
                        
                        // é‡ç½®æ–¹æ¡ˆé¸æ“‡ç‹€æ…‹
                        document.querySelectorAll('.plan-option').forEach(option => {
                            option.classList.remove('border-[#181111]', 'bg-blue-50');
                            option.classList.add('border-gray-200');
                        });
                        
                        console.log('æ–¹æ¡ˆé¸æ“‡ç‹€æ…‹å·²é‡ç½®');
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿå…ƒç´ ');
                    }
                });
                
                // ç¶å®šæ–¹æ¡ˆé¸é …é»æ“Šäº‹ä»¶
                document.querySelectorAll('.plan-option').forEach(option => {
                    option.addEventListener('click', function() {
                        console.log('æ–¹æ¡ˆè¢«é¸æ“‡:', this.dataset.plan);
                        
                        // ç§»é™¤å…¶ä»–æ–¹æ¡ˆçš„é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.plan-option').forEach(opt => {
                            opt.classList.remove('border-[#181111]', 'bg-blue-50');
                            opt.classList.add('border-gray-200');
                        });
                        
                        // é¸ä¸­ç•¶å‰æ–¹æ¡ˆ
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-blue-50');
                        
                        // æ›´æ–°é è¨‚è³‡æ–™
                        const plan = this.dataset.plan;
                        const price = parseInt(this.dataset.price);
                        bookingData.selectedPlan = plan;
                        bookingData.planPrice = price;
                        
                        console.log('é è¨‚è³‡æ–™å·²æ›´æ–°:', { plan, price });
                        
                        // å¦‚æœæ˜¯æ—¥é–“å®‰è¦ªï¼Œæ›´æ–°æ™‚æ®µé¸æ“‡
                        if (bookingData.serviceType === 'daycare') {
                            // æ›´æ–°æ–¹æ¡ˆæ™‚é•·æç¤º
                            if (window.updateDaycarePlanDuration) {
                                window.updateDaycarePlanDuration();
                            }
                            // æ›´æ–°çµæŸæ™‚é–“é¸é …
                            const startTimeSelect = document.getElementById('start-time-select');
                            if (startTimeSelect) {
                                startTimeSelect.dispatchEvent(new Event('change'));
                            }
                        }
                        
                        // ç«‹å³æ›´æ–°åƒ¹æ ¼é¡¯ç¤ºï¼ˆå¦‚æœæœ‰é è¨­æ—¥æœŸï¼‰
                        if (bookingData.checkinDate && bookingData.checkoutDate) {
                            console.log('æª¢æ¸¬åˆ°é è¨­æ—¥æœŸï¼Œç«‹å³æ›´æ–°åƒ¹æ ¼é¡¯ç¤º');
                            updatePriceTransparency();
                        }
                        
                        // å»¶é²ä¸€ä¸‹å†é€²å…¥ä¸‹ä¸€æ­¥ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°é¸ä¸­æ•ˆæœ
                        setTimeout(() => {
                            // é€²å…¥æ­¥é©Ÿ3
                            const step2 = document.getElementById('step-2-plan-selection');
                            const step3 = document.getElementById('step-3-time-selection');
                            
                            if (step2 && step3) {
                                // éš±è—æ­¥é©Ÿ2
                                step2.style.display = 'none';
                                console.log('æ­¥é©Ÿ2å·²éš±è—');
                                
                                // é¡¯ç¤ºæ­¥é©Ÿ3
                                step3.style.display = 'block';
                                console.log('æ­¥é©Ÿ3å·²é¡¯ç¤º');
                                
                                // æ ¹æ“šæœå‹™é¡å‹é¡¯ç¤ºå°æ‡‰çš„æ™‚æ®µé¸æ“‡
                                if (bookingData.serviceType === 'overnight') {
                                    const overnightDateSelection = document.getElementById('overnight-date-selection');
                                    const daycareDateSelection = document.getElementById('daycare-date-selection');
                                    
                                    if (overnightDateSelection && daycareDateSelection) {
                                        overnightDateSelection.style.display = 'block';
                                        daycareDateSelection.style.display = 'none';
                                        console.log('å¯„å®¿éå¤œæ—¥æœŸé¸æ“‡å·²é¡¯ç¤º');
                                    }
                                } else {
                                    const daycareDateSelection = document.getElementById('daycare-date-selection');
                                    const overnightDateSelection = document.getElementById('overnight-date-selection');
                                    
                                    if (daycareDateSelection && overnightDateSelection) {
                                        daycareDateSelection.style.display = 'block';
                                        overnightDateSelection.style.display = 'none';
                                        console.log('æ—¥é–“å®‰è¦ªæ—¥æœŸé¸æ“‡å·²é¡¯ç¤º');
                                    }
                                }
                            } else {
                                console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿ3å…ƒç´ ');
                            }
                        }, 300);
                    });
                });
            }
            
            // ç¶å®šæ™‚æ®µé¸æ“‡äº‹ä»¶ - æ–°çš„ä¸‰æ­¥é©Ÿæµç¨‹
            function attachTimeSelectionListeners() {
                // ç¶å®šè¿”å›æŒ‰éˆ•
                document.getElementById('back-to-plan-selection')?.addEventListener('click', function() {
                    console.log('è¿”å›æ–¹æ¡ˆé¸æ“‡æŒ‰éˆ•è¢«é»æ“Š');
                    
                    // è¿”å›æ­¥é©Ÿ2
                    const step2 = document.getElementById('step-2-plan-selection');
                    const step3 = document.getElementById('step-3-time-selection');
                    
                    if (step2 && step3) {
                        // éš±è—æ­¥é©Ÿ3
                        step3.style.display = 'none';
                        console.log('æ­¥é©Ÿ3å·²éš±è—');
                        
                        // é¡¯ç¤ºæ­¥é©Ÿ2
                        step2.style.display = 'block';
                        console.log('æ­¥é©Ÿ2å·²é¡¯ç¤º');
                        
                        // é‡ç½®æ™‚æ®µé¸æ“‡ç‹€æ…‹
                        if (bookingData.serviceType === 'overnight') {
                            const checkinDate = document.getElementById('detail-checkin-date');
                            const checkoutDate = document.getElementById('detail-checkout-date');
                            const stayDuration = document.getElementById('stay-duration');
                            
                            if (checkinDate && checkoutDate && stayDuration) {
                                checkinDate.value = '';
                                checkoutDate.value = '';
                                stayDuration.textContent = 'è«‹é¸æ“‡æ—¥æœŸ';
                                console.log('å¯„å®¿éå¤œæ—¥æœŸé¸æ“‡å·²é‡ç½®');
                            }
                        } else {
                            const serviceDate = document.getElementById('detail-service-date');
                            if (serviceDate) {
                                serviceDate.value = '';
                                console.log('æ—¥é–“å®‰è¦ªæ—¥æœŸå·²é‡ç½®');
                            }
                            
                            document.querySelectorAll('.preset-time-slot').forEach(slot => {
                                slot.classList.remove('border-[#181111]', 'bg-blue-50');
                                slot.classList.add('border-gray-200');
                            });
                            console.log('æ™‚æ®µé¸æ“‡ç‹€æ…‹å·²é‡ç½®');
                        }
                    } else {
                        console.error('æ‰¾ä¸åˆ°æ­¥é©Ÿå…ƒç´ ');
                    }
                });
                
                // ç¶å®šå¯„å®¿éå¤œçš„æ—¥æœŸé¸æ“‡
                const checkinDate = document.getElementById('detail-checkin-date');
                const checkoutDate = document.getElementById('detail-checkout-date');
                
                if (checkinDate && checkoutDate) {
                    checkinDate.addEventListener('change', updateStayDuration);
                    checkoutDate.addEventListener('change', updateStayDuration);
                }
                
                // ç¶å®šæ—¥é–“å®‰è¦ªçš„æ™‚æ®µé¸æ“‡
                bindFlexibleTimeSelection();
                
                // ç¶å®šå¯ç”¨æ€§æª¢æŸ¥
                bindAvailabilityCheck();
            }
            
            // ç¶å®šéˆæ´»æ™‚æ®µé¸æ“‡
            function bindFlexibleTimeSelection() {
                console.log('é–‹å§‹ç¶å®šéˆæ´»æ™‚æ®µé¸æ“‡');
                
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                const durationDisplay = document.getElementById('flexible-duration-display');
                const priceDisplay = document.getElementById('flexible-price-display');
                const serviceDateInput = document.getElementById('detail-service-date');
                const planDurationHint = document.getElementById('plan-duration-hint');
                
                console.log('æ‰¾åˆ°çš„å…ƒç´ :', { startTimeSelect, endTimeSelect, durationDisplay, priceDisplay, serviceDateInput, planDurationHint });
                
                if (startTimeSelect && endTimeSelect) {
                    // è¨­å®šé è¨­å€¼
                    startTimeSelect.value = '8';
                    endTimeSelect.value = '9';
                    
                    // è¨­å®šé è¨­æœå‹™æ—¥æœŸç‚ºä»Šå¤©
                    if (serviceDateInput) {
                        const today = new Date();
                        serviceDateInput.value = today.toISOString().split('T')[0];
                        bookingData.serviceDate = today.toISOString().split('T')[0];
                        console.log('æœå‹™æ—¥æœŸå·²è¨­å®šç‚º:', serviceDateInput.value);
                    }
                    
                    // æ›´æ–°æ–¹æ¡ˆæ™‚é•·æç¤º
                    updatePlanDurationHint();
                    
                    // ç«‹å³æ›´æ–°é¡¯ç¤º
                    if (durationDisplay && priceDisplay) {
                        durationDisplay.textContent = '1 å°æ™‚';
                        priceDisplay.textContent = 'NT$ 150';
                        console.log('é è¨­é¡¯ç¤ºå·²æ›´æ–°');
                    }
                    
                    updateFlexibleTimeInfo();
                    
                    // ç¶å®šé–‹å§‹æ™‚é–“è®Šæ›´
                    startTimeSelect.addEventListener('change', function() {
                        updateEndTimeOptions();
                        updateFlexibleTimeInfo();
                    });
                    
                    // ç¶å®šçµæŸæ™‚é–“è®Šæ›´
                    endTimeSelect.addEventListener('change', function() {
                        updateFlexibleTimeInfo();
                    });
                    
                    // ç¶å®šæœå‹™æ—¥æœŸè®Šæ›´
                    if (serviceDateInput) {
                        serviceDateInput.addEventListener('change', function() {
                            bookingData.serviceDate = this.value;
                            console.log('æœå‹™æ—¥æœŸå·²æ›´æ–°:', this.value);
                        });
                    }
                    
                    console.log('éˆæ´»æ™‚æ®µé¸æ“‡ç¶å®šå®Œæˆ');
                } else {
                    console.error('æ‰¾ä¸åˆ°æ™‚æ®µé¸æ“‡å…ƒç´ ');
                }
                
                // æ›´æ–°æ–¹æ¡ˆæ™‚é•·æç¤º
                function updatePlanDurationHint() {
                    if (planDurationHint) {
                        if (bookingData.selectedPlan) {
                            const planHours = getPlanHours(bookingData.selectedPlan);
                            planDurationHint.textContent = `${planHours}å°æ™‚ (${planHours}å°æ™‚ç‚ºå–®ä½é¸æ“‡)`;
                            planDurationHint.className = 'text-blue-800 font-medium';
                        } else {
                            planDurationHint.textContent = 'è«‹å…ˆé¸æ“‡æ–¹æ¡ˆ';
                            planDurationHint.className = 'text-gray-600';
                        }
                    }
                }
                
                // æ ¹æ“šæ–¹æ¡ˆå°æ™‚æ•¸ç²å–æ™‚é•·
                function getPlanHours(planName) {
                    const planMap = {
                        '1å°æ™‚æ–¹æ¡ˆ': 1,
                        '2å°æ™‚æ–¹æ¡ˆ': 2,
                        '4å°æ™‚æ–¹æ¡ˆ': 4,
                        '6å°æ™‚æ–¹æ¡ˆ': 6,
                        '8å°æ™‚æ–¹æ¡ˆ': 8
                    };
                    return planMap[planName] || 1; // é è¨­1å°æ™‚
                }
                
                // æ›´æ–°çµæŸæ™‚é–“é¸é …
                function updateEndTimeOptions() {
                    const startHour = parseInt(startTimeSelect.value);
                    const planHours = getPlanHours(bookingData.selectedPlan || '2å°æ™‚æ–¹æ¡ˆ');
                    
                    // æ¸…ç©ºç¾æœ‰é¸é …
                    endTimeSelect.innerHTML = '';
                    
                    // æ ¹æ“šæ–¹æ¡ˆå°æ™‚æ•¸æ·»åŠ é¸é …
                    for (let hour = startHour + planHours; hour <= 19; hour += planHours) {
                        const option = document.createElement('option');
                        option.value = hour;
                        option.textContent = `${hour.toString().padStart(2, '0')}:00`;
                        endTimeSelect.appendChild(option);
                    }
                    
                    // è¨­å®šé è¨­çµæŸæ™‚é–“
                    if (endTimeSelect.options.length > 0) {
                        endTimeSelect.value = endTimeSelect.options[0].value;
                    }
                }
                
                // æ›´æ–°æ™‚æ®µè³‡è¨Šé¡¯ç¤º
                function updateFlexibleTimeInfo() {
                    const startHour = parseInt(startTimeSelect.value);
                    const endHour = parseInt(endTimeSelect.value);
                    const duration = endHour - startHour;
                    
                    console.log('æ›´æ–°æ™‚æ®µè³‡è¨Š:', { startHour, endHour, duration });
                    
                    if (duration > 0 && durationDisplay && priceDisplay) {
                        // æ›´æ–°é¡¯ç¤º
                        durationDisplay.textContent = `${duration} å°æ™‚`;
                        
                        // è¨ˆç®—åƒ¹æ ¼ï¼ˆæ¯å°æ™‚150å…ƒï¼Œ4å°æ™‚ä»¥ä¸Šæœ‰å„ªæƒ ï¼‰
                        let price = duration * 150;
                        if (duration >= 4) {
                            price = Math.floor(price * 0.9); // 9æŠ˜å„ªæƒ 
                        }
                        if (duration >= 8) {
                            price = Math.floor(price * 0.85); // 85æŠ˜å„ªæƒ 
                        }
                        
                        priceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                        
                        // æ›´æ–°é è¨‚è³‡æ–™
                        bookingData.duration = duration;
                        bookingData.timeSlot = `${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00`;
                        bookingData.timeSlotName = `${duration}å°æ™‚ (${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00)`;
                        bookingData.customPrice = price;
                        
                        console.log('éˆæ´»æ™‚æ®µé¸æ“‡å·²æ›´æ–°:', { duration, timeSlot: bookingData.timeSlot, price });
                        
                        // æª¢æŸ¥ç•¶å‰æ­¥é©Ÿæ˜¯å¦å¯ä»¥ç¹¼çºŒ
                        checkCurrentStepCanContinue();
                    }
                }
                
                // å…¬é–‹æ›´æ–°æ–¹æ¡ˆæ™‚é•·æç¤ºçš„æ–¹æ³•
                window.updateDaycarePlanDuration = updatePlanDurationHint;
            }
            

            
            // ç¶å®šå¯ç”¨æ€§æª¢æŸ¥
            function bindAvailabilityCheck() {
                const checkBtn = document.getElementById('check-availability-btn');
                const resultDiv = document.getElementById('availability-result');
                
                if (checkBtn && resultDiv) {
                    checkBtn.addEventListener('click', function() {
                        const startHour = document.getElementById('start-time-select').value;
                        const endHour = document.getElementById('end-time-select').value;
                        const serviceDate = document.getElementById('detail-service-date').value;
                        
                        if (!serviceDate) {
                            alert('è«‹å…ˆé¸æ“‡æœå‹™æ—¥æœŸ');
                            return;
                        }
                        
                        // æ¨¡æ“¬æª¢æŸ¥å¯ç”¨æ€§ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒèª¿ç”¨APIï¼‰
                        checkTimeSlotAvailability(serviceDate, startHour, endHour, resultDiv);
                    });
                }
            }
            
            // æª¢æŸ¥æ™‚æ®µå¯ç”¨æ€§
            function checkTimeSlotAvailability(date, startHour, endHour, resultDiv) {
                // æ¨¡æ“¬å¯ç”¨æ€§è³‡æ–™ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æœƒå¾å¾Œç«¯ç²å–ï¼‰
                const mockAvailability = {
                    '09:00-10:00': { available: true, capacity: 5, booked: 2 },
                    '10:00-11:00': { available: true, capacity: 5, booked: 3 },
                    '11:00-12:00': { available: false, capacity: 5, booked: 5 },
                    '12:00-13:00': { available: true, capacity: 5, booked: 1 },
                    '13:00-14:00': { available: true, capacity: 5, booked: 0 },
                    '14:00-15:00': { available: true, capacity: 5, booked: 2 },
                    '15:00-16:00': { available: true, capacity: 5, booked: 1 },
                    '16:00-17:00': { available: true, capacity: 5, booked: 0 },
                    '17:00-18:00': { available: true, capacity: 5, booked: 1 }
                };
                
                let allAvailable = true;
                let unavailableSlots = [];
                
                // æª¢æŸ¥é¸æ“‡æ™‚æ®µå…§çš„æ¯å€‹å°æ™‚
                for (let hour = parseInt(startHour); hour < parseInt(endHour); hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00`;
                    const slotInfo = mockAvailability[timeSlot];
                    
                    if (!slotInfo || !slotInfo.available) {
                        allAvailable = false;
                        unavailableSlots.push(timeSlot);
                    }
                }
                
                // é¡¯ç¤ºçµæœ
                if (allAvailable) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-green-600 mr-2">âœ…</span>
                                <span class="text-green-800 font-medium">æ™‚æ®µå¯ç”¨</span>
                            </div>
                            <p class="text-green-700 text-sm mt-1">é¸æ“‡çš„æ™‚æ®µ ${startHour}:00-${endHour}:00 å¯ä»¥é è¨‚</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-red-600 mr-2">âŒ</span>
                                <span class="text-red-800 font-medium">æ™‚æ®µé¡æ»¿</span>
                            </div>
                            <p class="text-red-700 text-sm mt-1">ä»¥ä¸‹æ™‚æ®µå·²é¡æ»¿ï¼š${unavailableSlots.join(', ')}</p>
                            <p class="text-red-600 text-xs mt-2">å»ºè­°é¸æ“‡å…¶ä»–æ™‚æ®µæˆ–æ—¥æœŸ</p>
                        </div>
                    `;
                }
                
                resultDiv.classList.remove('hidden');
            }
            
            // æ›´æ–°å…¥ä½å¤©æ•¸é¡¯ç¤º
            function updateStayDuration() {
                const checkinDate = document.getElementById('detail-checkin-date').value;
                const checkoutDate = document.getElementById('detail-checkout-date').value;
                const durationDisplay = document.getElementById('stay-duration');
                
                if (checkinDate && checkoutDate) {
                    const checkin = new Date(checkinDate);
                    const checkout = new Date(checkoutDate);
                    const diffTime = Math.abs(checkout - checkin);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0) {
                        durationDisplay.textContent = `${diffDays} æ™š`;
                        bookingData.checkinDate = checkinDate;
                        bookingData.checkoutDate = checkoutDate;
                        bookingData.stayDuration = diffDays;
                        
                        console.log('å…¥ä½å¤©æ•¸å·²æ›´æ–°:', { checkinDate, checkoutDate, diffDays });
                        
                        // æª¢æŸ¥ç•¶å‰æ­¥é©Ÿæ˜¯å¦å¯ä»¥ç¹¼çºŒ
                        checkCurrentStepCanContinue();
                    } else {
                        durationDisplay.textContent = 'è«‹é¸æ“‡æœ‰æ•ˆçš„é€€æˆ¿æ—¥æœŸ';
                    }
                }
            }
            
            // åœ¨å‡½æ•¸å®šç¾©å®Œæˆå¾Œï¼Œèª¿ç”¨å¿…è¦çš„åˆå§‹åŒ–å‡½æ•¸
            function initializeBookingFunctions() {
                attachPlanSelectionListeners();
                attachTimeSelectionListeners();
            }

            // ç¶å®šæ™‚æ®µé¸æ“‡äº‹ä»¶
            function attachTimeSlotListeners() {
                // é è¨­æ™‚æ®µé¸æ“‡
                document.querySelectorAll('.preset-time-slot').forEach(slot => {
                    slot.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–æ™‚æ®µçš„é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // é¸ä¸­ç•¶å‰æ™‚æ®µ
                        this.classList.add('selected');
                        
                        // æ›´æ–°é è¨‚è³‡æ–™
                        const hours = parseInt(this.dataset.hours);
                        const time = this.dataset.time;
                        const price = parseInt(this.dataset.price);
                        
                        bookingData.duration = hours;
                        bookingData.timeSlot = time;
                        bookingData.timeSlotName = `${hours}å°æ™‚ (${time})`;
                        bookingData.customPrice = price;
                        
                        // éš±è—è‡ªè¨‚æ™‚æ®µé¸æ“‡
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // é¡¯ç¤ºæˆ¿å‹é¸é …
                        showRoomServiceOptions('daycare');
                        
                        // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // è‡ªè¨‚æ™‚æ®µåˆ‡æ›
                document.querySelector('.custom-time-toggle')?.addEventListener('click', function() {
                    const timeSliders = document.querySelector('.time-sliders');
                    const isHidden = timeSliders.classList.contains('hidden');
                    
                    if (isHidden) {
                        // é¡¯ç¤ºè‡ªè¨‚æ™‚æ®µé¸æ“‡
                        timeSliders.classList.remove('hidden');
                        this.classList.add('active');
                        this.innerHTML = '<span>æ”¶èµ·è‡ªè¨‚æ™‚æ®µ</span>';
                        
                        // æ¸…é™¤é è¨­æ™‚æ®µé¸æ“‡
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // éš±è—æˆ¿å‹é¸é …ï¼Œç­‰å¾…è‡ªè¨‚æ™‚æ®µé¸æ“‡å®Œæˆ
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) {
                            roomServiceList.classList.add('hidden');
                        }
                    } else {
                        // éš±è—è‡ªè¨‚æ™‚æ®µé¸æ“‡
                        timeSliders.classList.add('hidden');
                        this.classList.remove('active');
                        this.innerHTML = '<span>è‡ªè¨‚æ™‚æ®µ</span>';
                    }
                });
                
                // æ»‘æ¡¿æ™‚é–“é¸æ“‡ (ä¿ç•™åŸæœ‰åŠŸèƒ½)
                const startTimeSlider = document.getElementById('start-time-slider');
                const endTimeSlider = document.getElementById('end-time-slider');
                const startTimeDisplay = document.getElementById('start-time-display');
                const endTimeDisplay = document.getElementById('end-time-display');
                const durationDisplay = document.getElementById('duration-display');
                const timePriceDisplay = document.getElementById('time-price-display');
                
                if (!startTimeSlider || !endTimeSlider) return;
                
                // åˆå§‹åŒ–é¡¯ç¤º
                updateTimeDisplays();
                
                // é–‹å§‹æ™‚é–“æ»‘æ¡¿äº‹ä»¶
                startTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(this.value);
                    const endHour = parseInt(endTimeSlider.value);
                    
                    // ç¢ºä¿çµæŸæ™‚é–“å¤§æ–¼é–‹å§‹æ™‚é–“
                    if (endHour <= startHour) {
                        endTimeSlider.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // çµæŸæ™‚é–“æ»‘æ¡¿äº‹ä»¶
                endTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(this.value);
                    
                    // ç¢ºä¿çµæŸæ™‚é–“å¤§æ–¼é–‹å§‹æ™‚é–“
                    if (endHour <= startHour) {
                        this.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // æ›´æ–°æ™‚é–“é¡¯ç¤º
                function updateTimeDisplays() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // æ›´æ–°é¡¯ç¤ºå…ƒç´ 
                    if (startTimeDisplay) startTimeDisplay.textContent = startTime;
                    if (endTimeDisplay) endTimeDisplay.textContent = endTime;
                    if (durationDisplay) durationDisplay.textContent = `${duration} å°æ™‚`;
                    
                    // è¨ˆç®—åƒ¹æ ¼ (æ¯å°æ™‚150å…ƒ)
                    const price = duration * 150;
                    if (timePriceDisplay) timePriceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                }
                
                // æ›´æ–°è‡ªè¨‚é è¨‚è³‡æ–™
                function updateCustomBookingData() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // æ›´æ–°å…¨åŸŸé è¨‚è³‡æ–™
                    bookingData.duration = duration;
                    bookingData.timeSlot = `${startTime}-${endTime}`;
                    bookingData.timeSlotName = `${duration}å°æ™‚ (${startTime}-${endTime})`;
                    bookingData.customPrice = duration * 150;
                    
                    // é¡¯ç¤ºæˆ¿å‹é¸é …ï¼ˆå¦‚æœæ™‚é–“å·²é¸æ“‡ï¼‰
                    if (duration > 0) {
                        showRoomServiceOptions('daycare');
                    }
                    
                    // éš±è—è‡ªè¨‚æ™‚æ®µé¸æ“‡
                    const timeSliders = document.querySelector('.time-sliders');
                    if (timeSliders) {
                        timeSliders.classList.add('hidden');
                    }
                    
                    updatePriceTransparency();
                    checkCanContinueBooking();
                }
            }
            
            // é¡¯ç¤ºå¯ç”¨æ™‚æ®µ
            function showAvailableTimeSlots(duration) {
                const timeSlotSelection = document.getElementById('time-slot-selection');
                const availableTimeSlots = document.getElementById('available-time-slots');
                
                if (!timeSlotSelection || !availableTimeSlots) return;
                
                // ç”Ÿæˆå¯é¸çš„é–‹å§‹æ™‚é–“ (ç‡Ÿæ¥­æ™‚é–“ 9:00-18:00)
                const startHour = 9;
                const endHour = 18;
                const slots = [];
                
                for (let hour = startHour; hour <= endHour - duration; hour++) {
                    const startTime = `${hour.toString().padStart(2, '0')}:00`;
                    const endTime = `${(hour + duration).toString().padStart(2, '0')}:00`;
                    slots.push({
                        start: startTime,
                        end: endTime,
                        display: `${startTime}-${endTime}`
                    });
                }
                
                // ç”ŸæˆHTML
                availableTimeSlots.innerHTML = slots.map(slot => `
                    <button class="time-slot-btn p-2 border-2 border-gray-200 rounded-lg text-center hover:border-[#181111] transition-all text-sm" 
                            data-slot="${slot.display}" data-start="${slot.start}" data-end="${slot.end}">
                        ${slot.display}
                    </button>
                `).join('');
                
                // ç¶å®šæ™‚æ®µæŒ‰éˆ•äº‹ä»¶
                availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // é‡ç½®æ‰€æœ‰æ™‚æ®µæŒ‰éˆ•
                        availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
                            b.classList.remove('border-[#181111]', 'bg-green-50');
                            b.classList.add('border-gray-200');
                        });
                        
                        // é¸ä¸­ç•¶å‰æ™‚æ®µ
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-green-50');
                        
                                                 // ä¿å­˜æ™‚æ®µä¿¡æ¯
                         bookingData.timeSlot = this.dataset.slot;
                         bookingData.timeSlotName = `${duration}å°æ™‚ (${this.dataset.slot})`;
                         
                         // é¸æ“‡æ™‚æ®µå¾Œï¼Œé¡¯ç¤ºæˆ¿å‹é¸é …
                         showRoomServiceOptions('daycare');
                         
                         checkCanContinueBooking();
                    });
                });
                
                                 // é¡¯ç¤ºæ™‚æ®µé¸æ“‡å€åŸŸ
                 timeSlotSelection.classList.remove('hidden');
             }
             
             // é¡¯ç¤ºæˆ¿å‹æœå‹™é¸é …
             function showRoomServiceOptions(serviceType) {
                 const roomServiceList = document.getElementById('room-service-list');
                 if (!roomServiceList) return;
                 
                 // å¦‚æœæ˜¯æ—¥é–“å®‰è¦ªï¼Œé¡¯ç¤ºæ–¹æ¡ˆé¸æ“‡ç•Œé¢
                 if (serviceType === 'daycare') {
                     showDaycarePackageSelection();
                     return;
                 }
                 
                 // æ•´ç†æˆ¿å‹å’Œå°æ‡‰çš„æœå‹™
                 const roomTypeMap = new Map();
                 
                 // å¾ mockRoomTypes å’Œ mockPackages æ•´ç†æ•¸æ“š
                 mockRoomTypes.forEach(room => {
                     if (room.status === 'active') {
                         const packages = mockPackages.filter(pkg => 
                             pkg.roomId === room.id && 
                             pkg.status === 'active' && 
                             pkg.type === serviceType
                         );
                         
                         if (packages.length > 0) {
                             roomTypeMap.set(room.id, {
                                 name: room.name,
                                 description: room.description || '',
                                 packages: packages
                             });
                         }
                     }
                 });

                 let html = '';
                 roomTypeMap.forEach((roomData, roomId) => {
                     const minPrice = Math.min(...roomData.packages.map(pkg => pkg.basePrice));
                     const serviceIcon = serviceType === 'overnight' ? 'ğŸ ' : 'â°';
                     const priceUnit = serviceType === 'overnight' ? '/ æ™š' : '/ æ¬¡';
                     
                     // é¡¯ç¤ºå¯ç”¨çš„æ–¹æ¡ˆ
                     const packageNames = roomData.packages.map(pkg => pkg.name).join('ã€');
                     
                     html += `
                         <div class="border border-gray-200 rounded-lg p-4">
                             <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                             <p class="text-sm text-gray-500 mb-2">${roomData.description}</p>
                             <p class="text-xs text-blue-600 mb-3">å¯é¸æ–¹æ¡ˆï¼š${packageNames}</p>
                             <button class="room-service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                     data-service-type="${serviceType}" data-room-id="${roomId}">
                                 <div class="flex justify-between items-center">
                                     <div class="flex items-center">
                                         <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3 text-sm">${serviceIcon}</span>
                                         <div>
                                             <span class="font-medium text-[#181111]">é¸æ“‡æ­¤æˆ¿å‹</span>
                                             <p class="text-xs text-gray-500">${serviceType === 'overnight' ? 'å¯„å®¿éå¤œæœå‹™' : 'æ—¥é–“å®‰è¦ªæœå‹™'}</p>
                                         </div>
                                     </div>
                                     <div class="text-right">
                                         <span class="font-bold text-sm">NT$ ${minPrice.toLocaleString()}èµ·</span>
                                         <p class="text-xs text-gray-500">${priceUnit}</p>
                                     </div>
                                 </div>
                             </button>
                         </div>
                     `;
                 });

                 roomServiceList.innerHTML = html;
                 roomServiceList.classList.remove('hidden');
                 
                 // ç¶å®šæˆ¿å‹é¸æ“‡äº‹ä»¶
                 attachRoomServiceListeners();
             }
             
             // é¡¯ç¤ºæ—¥é–“å®‰è¦ªæ–¹æ¡ˆé¸æ“‡
             function showDaycarePackageSelection() {
                 const roomServiceList = document.getElementById('room-service-list');
                 if (!roomServiceList) return;
                 
                 // ç²å–æ‰€æœ‰æ—¥é–“å®‰è¦ªæ–¹æ¡ˆ
                 const daycarePackages = mockPackages.filter(pkg => 
                     pkg.type === 'daycare' && pkg.status === 'active'
                 );
                 
                 let html = '<h4 class="font-medium text-[#181111] mb-3">é¸æ“‡æ—¥é–“å®‰è¦ªæ–¹æ¡ˆ</h4>';
                 
                 daycarePackages.forEach(pkg => {
                     const roomData = mockRoomTypes.find(room => room.id === pkg.roomId);
                     if (!roomData) return;
                     
                     html += `
                         <div class="border border-gray-200 rounded-lg p-4 mb-3">
                             <div class="flex justify-between items-start mb-2">
                                 <div>
                                     <h5 class="font-medium text-[#181111]">${pkg.name}</h5>
                                     <p class="text-sm text-gray-600">${roomData.name}</p>
                                     <p class="text-xs text-gray-500 mt-1">${pkg.description}</p>
                                 </div>
                                 <div class="text-right">
                                     <div class="font-bold text-lg">NT$ ${pkg.basePrice}</div>
                                     <div class="text-xs text-gray-500">/ ${pkg.daycareLengths}å°æ™‚</div>
                                 </div>
                             </div>
                             <button class="daycare-package-btn w-full p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-all" 
                                     data-package-id="${pkg.id}">
                                 é¸æ“‡æ­¤æ–¹æ¡ˆ
                             </button>
                         </div>
                     `;
                 });
                 
                 roomServiceList.innerHTML = html;
                 roomServiceList.classList.remove('hidden');
                 
                 // ç¶å®šæ–¹æ¡ˆé¸æ“‡äº‹ä»¶
                 document.querySelectorAll('.daycare-package-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         // é¸ä¸­ç•¶å‰æ–¹æ¡ˆ
                         document.querySelectorAll('.daycare-package-btn').forEach(b => {
                             b.classList.remove('border-blue-300', 'bg-blue-50');
                             b.classList.add('border-gray-200');
                         });
                         this.classList.remove('border-gray-200');
                         this.classList.add('border-blue-300', 'bg-blue-50');
                         
                         // é¸æ“‡æ–¹æ¡ˆå¾Œé¡¯ç¤ºæ™‚é–“æ»‘æ¡¿
                         const daycareDateSection = document.getElementById('daycare-date-selection');
                         if (daycareDateSection) {
                             daycareDateSection.classList.remove('hidden');
                         }
                         
                         checkCanContinueBooking();
                     });
                 });
             }
             
             // ç¶å®šæˆ¿å‹æœå‹™é¸æ“‡äº‹ä»¶
             function attachRoomServiceListeners() {
                 document.querySelectorAll('.room-service-option-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         // ç§»é™¤å…¶ä»–æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
                         document.querySelectorAll('.room-service-option-btn').forEach(b => {
                             b.classList.remove('selected');
                             b.style.borderColor = '#e5e7eb';
                             b.style.backgroundColor = '';
                         });
                         
                         // é¸ä¸­ç•¶å‰æŒ‰éˆ•
                         this.classList.add('selected');
                         this.style.borderColor = '#181111';
                         this.style.backgroundColor = '#f9fafb';
                         
                         const serviceType = this.dataset.serviceType;
                         const roomId = parseInt(this.dataset.roomId);
                         
                         // è¨­å®šé è¨‚è³‡æ–™
                         bookingData.preferredRoomId = roomId;
                         
                         checkCanContinueBooking();
                     });
                 });
             }

            // æ›´æ–°åƒ¹æ ¼é€æ˜åº¦é¡¯ç¤º
            function updatePriceTransparency() {
                const priceTransparency = document.getElementById('price-transparency');
                const roomPriceDetail = document.getElementById('room-price-detail');
                const roomPrice = document.getElementById('room-price');
                const durationItem = document.getElementById('duration-item');
                const durationDetail = document.getElementById('duration-detail');
                const durationPrice = document.getElementById('duration-price');
                const petCountItem = document.getElementById('pet-count-item');
                const petCountDetail = document.getElementById('pet-count-detail');
                const petCountPrice = document.getElementById('pet-count-price');
                const totalPrice = document.getElementById('total-price');
                
                let total = 0;
                let hasValidData = false;
                
                // æ–¹æ¡ˆè²»ç”¨ (æ–°çš„é‚è¼¯)
                if (bookingData.selectedPlan && bookingData.planPrice) {
                    // æ ¹æ“šæœå‹™é¡å‹é¡¯ç¤ºä¸åŒçš„æ¨™ç±¤
                    if (bookingData.serviceType === 'overnight') {
                        roomPriceDetail.textContent = `${getPlanDisplayName(bookingData.selectedPlan)}å¥—æˆ¿`;
                    } else {
                        roomPriceDetail.textContent = `${getPlanDisplayName(bookingData.selectedPlan)}ç…§è­·`;
                    }
                    
                    roomPrice.textContent = `NT$ ${bookingData.planPrice.toLocaleString()}`;
                    total += bookingData.planPrice;
                    hasValidData = true;
                    
                    console.log('æ–¹æ¡ˆè²»ç”¨å·²è¨ˆç®—:', { plan: bookingData.selectedPlan, price: bookingData.planPrice });
                } else {
                    roomPriceDetail.textContent = 'è«‹é¸æ“‡æ–¹æ¡ˆ';
                    roomPrice.textContent = 'NT$ 0';
                }
                
                // æœå‹™æ™‚é•·å’Œè²»ç”¨è¨ˆç®—
                if (bookingData.serviceType === 'overnight' && bookingData.stayDuration) {
                    // å¯„å®¿éå¤œï¼šæŒ‰å¤©æ•¸è¨ˆç®—
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.stayDuration} æ™š`;
                    
                    const durationCost = bookingData.planPrice * bookingData.stayDuration;
                    durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    total = durationCost; // ç¸½åƒ¹å°±æ˜¯å¤©æ•¸ Ã— æ¯æ™šåƒ¹æ ¼
                    hasValidData = true;
                    
                    console.log('å¯„å®¿éå¤œè²»ç”¨å·²è¨ˆç®—:', { days: bookingData.stayDuration, totalCost: durationCost });
                } else if (bookingData.serviceType === 'daycare' && bookingData.duration) {
                    // æ—¥é–“å®‰è¦ªï¼šæŒ‰æ™‚æ•¸è¨ˆç®—
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.duration}å°æ™‚`;
                    
                    const durationCost = bookingData.customPrice || (bookingData.duration * 150);
                    durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    total = durationCost; // ç¸½åƒ¹å°±æ˜¯æ™‚æ®µè²»ç”¨
                    hasValidData = true;
                    
                    console.log('æ—¥é–“å®‰è¦ªè²»ç”¨å·²è¨ˆç®—:', { hours: bookingData.duration, totalCost: durationCost });
                } else {
                    durationItem.style.display = 'none';
                }
                
                // å¯µç‰©æ•¸é‡
                if (bookingData.petCount > 1) {
                    petCountItem.style.display = 'flex';
                    petCountDetail.textContent = `${bookingData.petCount} éš»`;
                    petCountPrice.textContent = `Ã— ${bookingData.petCount}`;
                    total *= bookingData.petCount;
                } else {
                    petCountItem.style.display = 'none';
                }
                
                // åŠ è³¼æœå‹™
                const addonItems = document.getElementById('addon-items');
                addonItems.innerHTML = '';
                bookingData.addons.forEach(addon => {
                    const addonItem = document.createElement('div');
                    addonItem.className = 'price-item addon';
                    addonItem.innerHTML = `
                        <span class="item-label">åŠ è³¼æœå‹™</span>
                        <span class="item-detail">${addon.name}</span>
                        <span class="item-price">NT$ ${addon.price.toLocaleString()}</span>
                    `;
                    addonItems.appendChild(addonItem);
                    total += addon.price;
                });
                
                // æ›´æ–°ç¸½åƒ¹
                if (totalPrice) {
                    totalPrice.textContent = `NT$ ${total.toLocaleString()}`;
                }
                
                // é¡¯ç¤º/éš±è—åƒ¹æ ¼é€æ˜åº¦å€åŸŸ
                if (hasValidData) {
                    priceTransparency.classList.remove('hidden');
                    console.log('åƒ¹æ ¼é€æ˜åº¦å€åŸŸå·²é¡¯ç¤ºï¼Œç¸½åƒ¹:', total);
                } else {
                    priceTransparency.classList.add('hidden');
                    console.log('åƒ¹æ ¼é€æ˜åº¦å€åŸŸå·²éš±è—ï¼Œæ²’æœ‰æœ‰æ•ˆè³‡æ–™');
                }
            }
            
            // è¼”åŠ©å‡½æ•¸ï¼šç²å–æ–¹æ¡ˆé¡¯ç¤ºåç¨±
            function getPlanDisplayName(plan) {
                const planNames = {
                    'standard': 'æ¨™æº–',
                    'deluxe': 'è±ªè¯',
                    'premium': 'é ‚ç´š',
                    'basic': 'åŸºç¤'
                };
                return planNames[plan] || plan;
            }
            
            // é©—è­‰é è¨‚è³‡æ–™ - æ–°çš„ä¸‰æ­¥é©Ÿæµç¨‹
            function validateBookingData() {
                const errors = [];
                
                console.log('é©—è­‰é è¨‚è³‡æ–™:', bookingData);
                
                // æª¢æŸ¥æœå‹™é¡å‹
                if (!bookingData.serviceType) {
                    errors.push('è«‹é¸æ“‡æœå‹™é¡å‹');
                }
                
                // æª¢æŸ¥æ–¹æ¡ˆé¸æ“‡
                if (!bookingData.selectedPlan) {
                    errors.push('è«‹é¸æ“‡æ–¹æ¡ˆ');
                }
                
                // æ ¹æ“šæœå‹™é¡å‹æª¢æŸ¥æ™‚æ®µé¸æ“‡
                if (bookingData.serviceType === 'overnight') {
                    if (!bookingData.checkinDate) {
                        errors.push('è«‹é¸æ“‡å…¥ä½æ—¥æœŸ');
                    }
                    if (!bookingData.checkoutDate) {
                        errors.push('è«‹é¸æ“‡é€€æˆ¿æ—¥æœŸ');
                    } else if (new Date(bookingData.checkoutDate) <= new Date(bookingData.checkinDate)) {
                        errors.push('é€€æˆ¿æ—¥æœŸå¿…é ˆæ™šæ–¼å…¥ä½æ—¥æœŸ');
                    }
                } else if (bookingData.serviceType === 'daycare') {
                    if (!bookingData.timeSlot) {
                        errors.push('è«‹é¸æ“‡æœå‹™æ™‚æ®µ');
                    }
                    if (!bookingData.duration) {
                        errors.push('è«‹é¸æ“‡æœå‹™æ™‚é•·');
                    }
                }
                
                console.log('é©—è­‰çµæœ:', errors);
                return errors;
            }
            
            // è¼•é‡ç´šé©—è­‰ - åƒ…æª¢æŸ¥ç•¶å‰æ­¥é©Ÿçš„è³‡æ–™
            function validateCurrentStep() {
                const errors = [];
                
                // å¦‚æœå·²ç¶“é¸æ“‡äº†æœå‹™é¡å‹ï¼Œæª¢æŸ¥æ–¹æ¡ˆ
                if (bookingData.serviceType && !bookingData.selectedPlan) {
                    errors.push('è«‹é¸æ“‡æ–¹æ¡ˆ');
                }
                
                // å¦‚æœå·²ç¶“é¸æ“‡äº†æ–¹æ¡ˆï¼Œæª¢æŸ¥æ™‚æ®µ
                if (bookingData.selectedPlan) {
                    if (bookingData.serviceType === 'overnight') {
                        if (!bookingData.checkinDate || !bookingData.checkoutDate) {
                            errors.push('è«‹é¸æ“‡å…¥ä½å’Œé€€æˆ¿æ—¥æœŸ');
                        }
                    } else if (bookingData.serviceType === 'daycare') {
                        if (!bookingData.timeSlot || !bookingData.duration) {
                            errors.push('è«‹é¸æ“‡æœå‹™æ™‚æ®µ');
                        }
                    }
                }
                
                return errors;
            }
            
            // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
            function showBookingErrors(errors) {
                const errorContainer = document.getElementById('booking-errors');
                if (errors.length > 0) {
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <div class="error-title">
                                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                è«‹ä¿®æ­£ä»¥ä¸‹å•é¡Œï¼š
                            </div>
                            <ul class="error-list">
                                ${errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    errorContainer.classList.remove('hidden');
                } else {
                    errorContainer.classList.add('hidden');
                }
            }
            
            // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç¹¼çºŒé è¨‚
            function checkCanContinueBooking() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateBookingData();
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                showBookingErrors(errors);
                
                // æ›´æ–°åƒ¹æ ¼é€æ˜åº¦
                updatePriceTransparency();
                
                // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç¹¼çºŒ
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                    
                    // é‡æ–°ç¶å®šç¹¼çºŒæŒ‰éˆ•äº‹ä»¶
                    const continueBtn = document.getElementById('continue-booking-btn');
                    continueBtn.replaceWith(continueBtn.cloneNode(true));
                    const newBtn = document.getElementById('continue-booking-btn');
                    newBtn.addEventListener('click', function() {
                        // ç¢ºä¿é¸ä¸­çš„æˆ¿å‹è³‡æ–™å®Œæ•´
                        const selectedRoomBtn = document.querySelector('.room-service-option-btn.selected');
                        if (selectedRoomBtn) {
                            const roomId = parseInt(selectedRoomBtn.dataset.roomId);
                            const serviceType = selectedRoomBtn.dataset.serviceType;
                            
                            // æ‰¾åˆ°å°æ‡‰çš„æ–¹æ¡ˆ
                            const selectedPackage = mockPackages.find(pkg => 
                                pkg.roomId === roomId && 
                                pkg.type === serviceType && 
                                pkg.status === 'active'
                            );
                            
                            if (selectedPackage) {
                                bookingData.roomId = roomId;
                                bookingData.packageId = selectedPackage.id;
                            }
                        }
                        
                        // ç›´æ¥è·³åˆ°ç¢ºèªè¨‚å–®æ­¥é©Ÿ
                        bookingStep = 4;
                        showPage('bookingFlow');
                    });
                } else {
                    continueSection.classList.add('hidden');
                }
            }
            
            // æª¢æŸ¥ç•¶å‰æ­¥é©Ÿæ˜¯å¦å¯ä»¥ç¹¼çºŒï¼ˆè¼•é‡ç´šæª¢æŸ¥ï¼‰
            function checkCurrentStepCanContinue() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateCurrentStep();
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                showBookingErrors(errors);
                
                // æ›´æ–°åƒ¹æ ¼é€æ˜åº¦
                updatePriceTransparency();
                
                // æª¢æŸ¥æ˜¯å¦å¯ä»¥ç¹¼çºŒ
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                } else {
                    continueSection.classList.add('hidden');
                }
            }



            // æ¸²æŸ“æˆ¿å‹èˆ‡æœå‹™åˆ—è¡¨
            function renderRoomServiceList() {
                const container = document.getElementById('room-service-list');
                if (!container) return;

                // æ•´ç†æˆ¿å‹å’Œå°æ‡‰çš„æœå‹™
                const roomTypeMap = new Map();
                
                // å¾ mockRoomTypes å’Œ mockPackages æ•´ç†æ•¸æ“š
                mockRoomTypes.forEach(room => {
                    if (room.status === 'active') {
                        const packages = mockPackages.filter(pkg => 
                            pkg.roomId === room.id && pkg.status === 'active'
                        );
                        
                        if (packages.length > 0) {
                            roomTypeMap.set(room.id, {
                                name: room.name,
                                description: room.description || '',
                                packages: packages
                            });
                        }
                    }
                });

                let html = '';
                roomTypeMap.forEach((roomData, roomId) => {
                    // åˆ†é¡æœå‹™é¡å‹
                    const overnightPackages = roomData.packages.filter(pkg => pkg.type === 'overnight');
                    const daycarePackages = roomData.packages.filter(pkg => pkg.type === 'daycare');
                    
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                            <p class="text-sm text-gray-500 mb-3">${roomData.description}</p>
                            <div class="space-y-2">
                    `;
                    
                    // éå¤œæœå‹™
                    if (overnightPackages.length > 0) {
                        const minPrice = Math.min(...overnightPackages.map(pkg => pkg.basePrice));
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="overnight" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3 text-sm">ğŸ </span>
                                        <div>
                                            <span class="font-medium text-[#181111]">å¯„å®¿éå¤œ</span>
                                            <p class="text-xs text-gray-500">é©åˆå‡ºå·®æ—…è¡Œ</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm price-display">NT$ ${minPrice.toLocaleString()}èµ·</span>
                                        <p class="text-xs text-gray-500">æ¯æ™š</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }
                    
                    // æ—¥é–“å®‰è¦ªæœå‹™
                    if (daycarePackages.length > 0) {
                        const minPrice = Math.min(...daycarePackages.map(pkg => pkg.basePrice));
                        const minDuration = Math.min(...daycarePackages.map(pkg => parseInt(pkg.daycareLengths) || 4));
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="daycare" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3 text-sm">â°</span>
                                        <div>
                                            <span class="font-medium text-[#181111]">æ—¥é–“å®‰è¦ª</span>
                                            <p class="text-xs text-gray-500">å°ˆæ¥­ç…§è­·é™ªä¼´</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm">NT$ ${minPrice.toLocaleString()}èµ·</span>
                                        <p class="text-xs text-gray-500">/${minDuration}hr</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // ç¶å®šé»æ“Šäº‹ä»¶
                document.querySelectorAll('.service-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // ç§»é™¤å…¶ä»–æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.service-option-btn').forEach(b => {
                            b.classList.remove('selected');
                            b.style.borderColor = '#e5e7eb';
                            b.style.backgroundColor = '';
                        });
                        
                        // é¸ä¸­ç•¶å‰æŒ‰éˆ•
                        this.classList.add('selected');
                        this.style.borderColor = '#181111';
                        this.style.backgroundColor = '#f9fafb';
                        
                        const serviceType = this.dataset.serviceType;
                        const roomId = parseInt(this.dataset.roomId);
                        
                        // è¨­å®šé è¨‚è³‡æ–™ï¼Œä½¿ç”¨è©³æƒ…é å·²é¸æ“‡çš„æ—¥æœŸ
                        bookingData.serviceType = serviceType;
                        bookingData.preferredRoomId = roomId;
                        bookingData.dates.checkin = selectedCheckinDate.toISOString().split('T')[0];
                        bookingData.dates.checkout = selectedCheckoutDate.toISOString().split('T')[0];
                        
                        // ç›´æ¥è·³åˆ°æˆ¿å‹é¸æ“‡æ­¥é©Ÿï¼Œè·³éæ—¥æœŸé¸æ“‡
                        bookingStep = 3;
                        
                        // æ›´æ–°åƒ¹æ ¼é è¦½
                        updateDetailPricePreview();
                        
                        // é¡¯ç¤ºç¹¼çºŒé è¨‚æŒ‰éˆ•
                        showContinueBookingButton();
                    });
                });
            }

            // åœ°åœ–ç›¸é—œåŠŸèƒ½
            let hotelMap = null;
            const hotelLocation = {
                lat: 25.0330,  // å°åŒ—å¸‚ä¿¡ç¾©å€åº§æ¨™
                lng: 121.5654,
                address: "å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ7è™Ÿ",
                name: "å¿«æ¨‚çˆªå­æ—…é¤¨"
            };

            // åˆå§‹åŒ–æ—…é¤¨åœ°åœ–
            function initHotelMap() {
                // å¦‚æœLeafleté‚„æ²’è¼‰å…¥ï¼Œç¨å¾Œå†è©¦
                if (typeof L === 'undefined') {
                    setTimeout(initHotelMap, 500);
                    return;
                }

                const mapContainer = document.getElementById('hotel-map');
                if (!mapContainer) return;

                try {
                    // æ¸…é™¤è¼‰å…¥æç¤º
                    mapContainer.innerHTML = '';

                    // åˆå§‹åŒ–åœ°åœ–
                    hotelMap = L.map('hotel-map').setView([hotelLocation.lat, hotelLocation.lng], 16);

                    // æ·»åŠ åœ°åœ–åœ–å±¤ (ä½¿ç”¨ OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(hotelMap);

                    // å‰µå»ºè‡ªå®šç¾©åœ–æ¨™
                    const hotelIcon = L.divIcon({
                        html: `
                            <div style="
                                width: 40px; 
                                height: 40px; 
                                background-color: #181111; 
                                border: 3px solid white; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            ">ğŸ </div>
                        `,
                        className: 'custom-hotel-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });

                    // æ·»åŠ æ—…é¤¨æ¨™è¨˜
                    const marker = L.marker([hotelLocation.lat, hotelLocation.lng], { 
                        icon: hotelIcon 
                    }).addTo(hotelMap);

                    // é»æ“Šæ¨™è¨˜é¡¯ç¤ºå½ˆå‡ºè¦–çª—
                    marker.bindPopup(`
                        <div style="padding: 8px; font-family: 'Plus Jakarta Sans', sans-serif; max-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: #181111; font-weight: bold;">${hotelLocation.name}</h3>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${hotelLocation.address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}" 
                               target="_blank" 
                               style="color: #1a73e8; text-decoration: none; font-size: 14px;">
                                ğŸ“ é–‹å§‹å°èˆª
                            </a>
                        </div>
                    `);

                    // ç¦ç”¨åœ°åœ–çš„ä¸€äº›æ§åˆ¶é …ä»¥ç¬¦åˆæ‰‹æ©Ÿç‰ˆé¢
                    hotelMap.scrollWheelZoom.disable();
                    hotelMap.doubleClickZoom.disable();
                    hotelMap.dragging.disable();

                    // æ·»åŠ åœ°åœ–é»æ“Šäº‹ä»¶ä¾†å•Ÿç”¨äº¤äº’
                    const hintElement = document.getElementById('map-interaction-hint');
                    if (hintElement) {
                        hintElement.classList.remove('hidden');
                        
                        hotelMap.on('click', function() {
                            hotelMap.dragging.enable();
                            hotelMap.scrollWheelZoom.enable();
                            hotelMap.doubleClickZoom.enable();
                            hintElement.classList.add('hidden');
                        });
                    }

                } catch (error) {
                    console.error('åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                    mapContainer.innerHTML = `
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <span class="text-sm">åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</span>
                        </div>
                    `;
                }
            }

            // åœ°åœ–ç›¸é—œäº‹ä»¶ç›£è½å™¨
            function attachMapListeners() {
                // å°èˆªæŒ‰éˆ•é»æ“Šäº‹ä»¶
                document.getElementById('open-map-btn')?.addEventListener('click', function() {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        // æ‰‹æ©Ÿç«¯å˜—è©¦é–‹å•ŸåŸç”Ÿåœ°åœ–æ‡‰ç”¨
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`;
                        const appleMapsUrl = `http://maps.apple.com/?daddr=${hotelLocation.lat},${hotelLocation.lng}`;
                        
                        // iOS è¨­å‚™å„ªå…ˆä½¿ç”¨ Apple Maps
                        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                            window.open(appleMapsUrl, '_system');
                        } else {
                            window.open(googleMapsUrl, '_system');
                        }
                    } else {
                        // æ¡Œé¢ç«¯é–‹å•Ÿ Google Maps ç¶²é ç‰ˆ
                        window.open(`https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`, '_blank');
                    }
                });
            }

            function renderUserCenterPage() {
                const container = pages.account;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-center">
                        <h2 class="text-[#181111] text-base font-bold">å¸³æˆ¶</h2>
                    </div>
                </div>

                <div class="px-4 py-3 bg-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="https://images.unsplash.com/photo-1548142813-c348350df52b?q=80&w=200" class="w-12 h-12 rounded-full object-cover" alt="avatar">
                            <div>
                                <p class="font-bold text-[#181111]">James</p>
                                <p class="text-xs text-[#886364]">å°åŒ—å¸‚, å°ç£</p>
                            </div>
                        </div>
                        <button id="account-edit-icon" class="p-2 text-[#181111]" aria-label="edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="currentColor"><path d="M227.31,73.37,182.63,28.69a16,16,0,0,0-22.63,0L41.37,147.31A15.86,15.86,0,0,0,36.69,158L24.29,207.14a8,8,0,0,0,9.85,9.85l49.1-12.4a15.86,15.86,0,0,0,10.68-4.68L227.31,96A16,16,0,0,0,227.31,73.37ZM78.4,192.62l-28.2,7.12,7.12-28.2L152,76.86l21.09,21.09ZM197.66,73.37,184,87l-21.09-21.1,13.66-13.66a0,0,0,0,1,0,0L197.66,59.71A0,0,0,0,1,197.66,73.37Z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                ${!isUserMerchant ? `
                <div id="become-merchant-card" class="px-4 py-3 cursor-pointer">
                    <div class="bg-white border border-gray-100 rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-amber-100 flex items_center justify-center">ğŸª</div>
                        <div class="flex-1">
                            <p class="font-bold text-[#181111]">æˆç‚ºå•†å®¶</p>
                            <p class="text-xs text-[#886364]">é¦¬ä¸Šç”³è«‹æˆç‚º Paw Pad çš„åˆä½œå¤¥ä¼´ï¼</p>
                        </div>
                        <div class="text-[#886364]">â€º</div>
                    </div>
                </div>` : `
                <div class="px-4 py-3">
                    <div id="merchant-entry" class="bg-white border border-gray-100 rounded-xl p-4 flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">ğŸ“Š</div><div><p class="font-bold text-[#181111]">å•†å®¶å°ˆå€</p><p class="text-xs text-[#886364]">ç®¡ç†è¨‚å–®ã€è¡Œäº‹æ›†èˆ‡æ–¹æ¡ˆ</p></div></div>
                        <div class="text-[#886364]">â€º</div>
                    </div>
                    <div class="mt-3">
                        <button id="merchant-backend-btn" class="btn-main h-11">é€²å…¥å•†å®¶å¾Œå°</button>
                    </div>
                </div>`}

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2 space-y-2">
                    <div id="account-profile" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>å€‹äººè³‡æ–™</span><span class="text-[#886364]">â€º</span></div>
                    <div id="account-support" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>è¯ç¹«å®¢æœ</span><span class="text-[#886364]">â€º</span></div>
                    <div id="account-privacy" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>éš±ç§</span><span class="text-[#886364]">â€º</span></div>
                    <div id="account-referral" class="bg-white p-4 rounded-xl border border-gray-100 flex justify_between items-center cursor-pointer"><span>æˆ‘çš„æ¨è–¦ä»£ç¢¼</span><span class="text-[#886364]">â€º</span></div>
                    <div id="account-coupons" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>å„ªæƒ åˆ¸åˆ—è¡¨</span><span class="text-[#886364]">â€º</span></div>
                    <div id="account-settings" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer">
                        <span>è¨­å®š</span>
                        <span class="text-[#886364]">â€º</span>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2">
                    <div id="account-logout" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>ç™»å‡º</span><span class="text-[#886364]">â€º</span></div>
                </div>
                `;

                attachAccountListeners();
            }

            function updateUserCenterOptions() {
                const container = document.getElementById('user-options-list');
                if (!container) return;
                let optionsHTML = `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>æˆ‘çš„è³‡æ–™</span><span class="text-[#886364]">></span></div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>è¨­å®š</span><span class="text-[#886364]">></span></div>`;
                
                if (isUserMerchant) {
                    optionsHTML += `<div id="merchant-entry" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>å•†å®¶å°ˆå€</span><span class="text-[#886364]">></span></div>`;
                } else {
                    optionsHTML += `<div id="become-merchant" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>æˆç‚ºå•†å®¶</span><span class="text-blue-600 font-bold">ç«‹å³ç”³è«‹</span></div>`;
                }
                container.innerHTML = optionsHTML + `<div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer text-red-600"><span>ç™»å‡º</span></div>`;
            }

            // å¸³æˆ¶é ï¼šäº‹ä»¶èˆ‡æ¨¡æ…‹
            function attachAccountListeners() {
                document.getElementById('account-edit-icon')?.addEventListener('click', openProfileEditModal);
                document.getElementById('account-profile')?.addEventListener('click', openProfileEditModal);
                document.getElementById('become-merchant-card')?.addEventListener('click', () => { renderMerchantApplicationFlow(); });
                document.getElementById('merchant-entry')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('merchant-backend-btn')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('account-support')?.addEventListener('click', () => showPage('chat'));
                document.getElementById('account-privacy')?.addEventListener('click', openPrivacyModal);
                document.getElementById('account-referral')?.addEventListener('click', openReferralModal);
                document.getElementById('account-coupons')?.addEventListener('click', openCouponsModal);
                document.getElementById('account-settings')?.addEventListener('click', () => showPage('settings'));
                document.getElementById('account-logout')?.addEventListener('click', () => { alert('å·²ç™»å‡º (æ¨¡æ“¬)'); showPage('home'); });
            }

            function openOverlayWithContent(innerHtml) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${innerHtml}</div>`;
                document.body.appendChild(modal);
                modal.addEventListener('click', function(e){ if (e.target === modal || e.target.id === 'modal-close-btn') document.body.removeChild(modal); });
                return modal;
            }

            function openReferralModal() {
                const code = 'PP-JAMES-1234';
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">æˆ‘çš„æ¨è–¦ä»£ç¢¼</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <p class="text-sm text-[#886364] mb-3">åˆ†äº«çµ¦æœ‹å‹ï¼Œé›™æ–¹çš†å¯ç²å¾—å„ªæƒ ã€‚</p>
                    <div class="bg-gray-50 border rounded-xl p-4 text-center mb-3">
                        <p class="text-2xl font-black tracking-widest text-[#181111]">${code}</p>
                    </div>
                    <button id="copy-referral" class="btn-main h-11">è¤‡è£½ä»£ç¢¼</button>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#copy-referral')?.addEventListener('click', async () => {
                    try { await navigator.clipboard.writeText(code); alert('å·²è¤‡è£½'); } catch(_) { alert('è¤‡è£½å¤±æ•—'); }
                });
            }

            function openCouponsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">å„ªæƒ åˆ¸åˆ—è¡¨</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-2">
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">æ–°ç”¨æˆ¶ 85 æŠ˜</p><p class="text-xs text-[#886364]">åˆ°æœŸæ—¥ï¼š2025/12/31</p></div>
                            <span class="text-emerald-600 font-bold">å¯ç”¨</span>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">æ»¿ 2000 æŠ˜ 200</p><p class="text-xs text-[#886364]">åˆ°æœŸæ—¥ï¼š2025/09/30</p></div>
                            <span class="text-emerald-600 font-bold">å¯ç”¨</span>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // å•†å®¶ä¸­å¿ƒï¼šç›®å‰æˆ¿æ³ï¼ˆåœ–è¡¨ç¤ºæ„ï¼‰
            function openOccupancyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">ç›®å‰æˆ¿æ³</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <p class="mb-2 text-[#886364]">ä»Šæ—¥æ•´é«”å…¥ä½ç‡</p>
                            <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                <div class="bg-emerald-500 h-3" style="width: 68%"></div>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">68%</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            ${mockRoomTypes.filter(r=>r.status==='active').map(r=>`
                                <div class="bg-white border rounded-xl p-3">
                                    <p class="font-medium text-[#181111] mb-1">${r.name}</p>
                                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                        <div class="bg-blue-500 h-2" style="width: ${Math.min(100, Math.round((r.stock-1)/r.stock*100))}%"></div>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-600">å¯ç”¨ ${Math.max(0, r.stock-1)} / ${r.stock}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // å•†å®¶ä¸­å¿ƒï¼šé‡‘æµï¼ˆè«‹æ¬¾ / é€€æ¬¾ç”³è«‹å¯©æ ¸ï¼‰
            function openFinanceModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">é‡‘æµ</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="flex gap-2 mb-3 text-sm">
                        <button data-fin-tab="payouts" class="px-3 py-1 rounded-full bg-[#181111] text-white">è«‹æ¬¾</button>
                        <button data-fin-tab="refunds" class="px-3 py-1 rounded-full bg-gray-100">é€€æ¬¾ç”³è«‹å¯©æ ¸</button>
                    </div>
                    <div id="finance-content" class="space-y-2 text-sm"></div>
                `;
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#finance-content');
                function render(tab){
                    modal.querySelectorAll('[data-fin-tab]')?.forEach(b=>{
                        const active = b.dataset.finTab===tab;
                        b.classList.toggle('bg-[#181111]', active);
                        b.classList.toggle('text-white', active);
                        b.classList.toggle('bg-gray-100', !active);
                    });
                    if(tab==='refunds'){
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">è¨‚å–® #A1029</p>
                                    <p class="text-xs text-[#886364]">åŸå› ï¼šè‡¨æ™‚å–æ¶ˆ</p>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <button class="px-3 py-1 bg-gray-200 rounded-full">é§å›</button>
                                    <button class="px-3 py-1 bg-emerald-600 text-white rounded-full">åŒæ„é€€æ¬¾</button>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">å¯è«‹æ¬¾é‡‘é¡</p>
                                    <p class="text-xs text-[#886364]">æœ¬æœŸï¼šNT$ 42,000</p>
                                </div>
                                <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">ç”³è«‹è«‹æ¬¾</button>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="font-medium text-[#181111] mb-1">æ­·å²è«‹æ¬¾ç´€éŒ„</p>
                                <p class="text-xs text-[#886364]">2025/06/01 NT$ 30,000 - å·²åŒ¯æ¬¾</p>
                            </div>
                        `;
                    }
                }
                modal.querySelectorAll('[data-fin-tab]')?.forEach(btn=>btn.addEventListener('click',()=>render(btn.dataset.finTab)));
                render('payouts');
            }

            // å•†å®¶ä¸­å¿ƒï¼šå ±è¡¨ï¼ˆä¸‹è¼‰ï¼‰
            function openReportsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">å ±è¡¨</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">ç¯„åœ</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" class="form-input-styled">
                                <input type="date" class="form-input-styled">
                            </div>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>æ¯æ—¥æ”¶å…¥å ±è¡¨ (CSV)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">ä¸‹è¼‰</button>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>æœˆæ”¶å…¥èˆ‡é ç´„çµ±è¨ˆ (PDF)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">ä¸‹è¼‰</button>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // å•†å®¶ä¸­å¿ƒï¼šå„ªæƒ åˆ¸ç™¼é€èˆ‡ç®¡ç†
            function openCouponManageModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">å„ªæƒ åˆ¸ç®¡ç†</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">æ–°å¢å„ªæƒ åˆ¸</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="new-coupon-name" class="form-input-styled" placeholder="åç¨±ï¼Œä¾‹å¦‚ é¦–è³¼85æŠ˜">
                                <input id="new-coupon-exp" type="date" class="form-input-styled">
                            </div>
                            <div class="mt-2 flex gap-2">
                                <input id="new-coupon-scope" class="form-input-styled flex-1" placeholder="å¯ç”¨ç¯„åœï¼Œä¾‹å¦‚ å…¨é¤¨ / æŒ‡å®šæˆ¿å‹">
                                <button id="add-coupon-btn" class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">æ–°å¢</button>
                            </div>
                        </div>
                        <div id="coupon-list" class="space-y-2">
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">æ–°ç”¨æˆ¶ 85 æŠ˜</p>
                                    <p class="text-xs text-[#886364]">åˆ°æœŸï¼š2025/12/31 â€¢ ç¯„åœï¼šå…¨é¤¨</p>
                                </div>
                                <button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">åœç”¨</button>
                            </div>
                        </div>
                    </div>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#add-coupon-btn')?.addEventListener('click', ()=>{
                    const name = modal.querySelector('#new-coupon-name')?.value || 'æœªå‘½åå„ªæƒ åˆ¸';
                    const exp = modal.querySelector('#new-coupon-exp')?.value || 'â€”';
                    const scope = modal.querySelector('#new-coupon-scope')?.value || 'â€”';
                    const list = modal.querySelector('#coupon-list');
                    const node = document.createElement('div');
                    node.className = 'bg-white border rounded-xl p-3 flex items-center justify-between';
                    node.innerHTML = `<div><p class="font-medium text-[#181111]">${name}</p><p class="text-xs text-[#886364]">åˆ°æœŸï¼š${exp} â€¢ ç¯„åœï¼š${scope}</p></div><button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">åœç”¨</button>`;
                    list?.prepend(node);
                });
            }

            function openSettingsModal(activeTab = 'general') {
                const html = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#181111]">è¨­å®š</h2>
                        <button id="modal-close-btn" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    
                    <!-- è¨­å®šåˆ†é¡æ¨™ç±¤ -->
                    <div class="flex gap-2 mb-6 text-sm overflow-x-auto pb-2">
                        <button data-tab="general" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='general'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">ä¸€èˆ¬è¨­å®š</button>
                        <button data-tab="notifications" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='notifications'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">é€šçŸ¥è¨­å®š</button>
                        <button data-tab="account" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='account'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">å¸³è™Ÿè¨­å®š</button>
                        <button data-tab="app" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='app'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">æ‡‰ç”¨ç¨‹å¼</button>
                        <button data-tab="payment" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='payment'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">ä»˜æ¬¾è¨­å®š</button>
                        <button data-tab="pets" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='pets'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">å¯µç‰©è¨­å®š</button>
                        ${isUserMerchant ? `<button data-tab="merchant" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='merchant'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">å•†å®¶è¨­å®š</button>` : ''}
                    </div>
                    
                    <!-- è¨­å®šå…§å®¹å€åŸŸ -->
                    <div id="settings-content" class="space-y-4 max-h-96 overflow-y-auto"></div>
                `;
                
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#settings-content');

                function renderTab(tab){
                    // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
                    modal.querySelectorAll('[data-tab]')?.forEach(btn=>{
                        btn.classList.toggle('bg-[#181111]', btn.dataset.tab===tab);
                        btn.classList.toggle('text-white', btn.dataset.tab===tab);
                        btn.classList.toggle('bg-gray-100', btn.dataset.tab!==tab);
                        btn.classList.toggle('text-gray-600', btn.dataset.tab!==tab);
                        btn.classList.toggle('hover:bg-gray-200', btn.dataset.tab!==tab);
                    });
                    
                    // æ¸²æŸ“å°æ‡‰å…§å®¹
                    if(tab==='notifications'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">é€šçŸ¥åå¥½è¨­å®š</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">æ¨æ’­é€šçŸ¥</span>
                                            <p class="text-xs text-gray-500">æ¥æ”¶æ‡‰ç”¨ç¨‹å¼æ¨æ’­é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">è¨‚å–®æ›´æ–°</span>
                                            <p class="text-xs text-gray-500">è¨‚å–®ç‹€æ…‹è®Šæ›´é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">å„ªæƒ æ´»å‹•</span>
                                            <p class="text-xs text-gray-500">é™æ™‚å„ªæƒ èˆ‡æ´»å‹•é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">ç³»çµ±å…¬å‘Š</span>
                                            <p class="text-xs text-gray-500">é‡è¦ç³»çµ±æ›´æ–°é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">é€šçŸ¥æ™‚é–“è¨­å®š</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">å®‰éœæ™‚é–“</label>
                                        <div class="flex gap-2 mt-2">
                                            <select class="form-input-styled text-sm">
                                                <option>22:00</option><option>23:00</option><option>00:00</option>
                                            </select>
                                            <span class="text-sm text-gray-500 self-center">è‡³</span>
                                            <select class="form-input-styled text-sm">
                                                <option>07:00</option><option>08:00</option><option>09:00</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='account'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å¸³è™Ÿç®¡ç†</h3>
                                <div class="space-y-3">
                                    <button id="settings-change-password" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">è®Šæ›´å¯†ç¢¼</span>
                                                <p class="text-xs text-gray-500">æ›´æ–°æ‚¨çš„ç™»å…¥å¯†ç¢¼</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                    <button id="settings-referral-btn" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">æŸ¥çœ‹æ¨è–¦ç¢¼</span>
                                                <p class="text-xs text-gray-500">åˆ†äº«çµ¦æœ‹å‹ç²å¾—å„ªæƒ </p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">è³‡æ–™ä¸‹è¼‰</span>
                                                <p class="text-xs text-gray-500">ä¸‹è¼‰æ‚¨çš„å€‹äººè³‡æ–™</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-red-600">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">åˆªé™¤å¸³è™Ÿ</span>
                                                <p class="text-xs text-gray-500">æ°¸ä¹…åˆªé™¤æ‚¨çš„å¸³è™Ÿ</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                        content.querySelector('#settings-referral-btn')?.addEventListener('click', () => openReferralModal());
                    } else if(tab==='app'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">æ‡‰ç”¨ç¨‹å¼è¨­å®š</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">è‡ªå‹•ç™»å…¥</span>
                                            <p class="text-xs text-gray-500">ä¿æŒç™»å…¥ç‹€æ…‹</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">ç”Ÿç‰©è¾¨è­˜ç™»å…¥</span>
                                            <p class="text-xs text-gray-500">ä½¿ç”¨æŒ‡ç´‹æˆ–è‡‰éƒ¨è¾¨è­˜</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">è³‡æ–™åŒæ­¥</span>
                                            <p class="text-xs text-gray-500">è·¨è£ç½®åŒæ­¥è³‡æ–™</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å¿«å–ç®¡ç†</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">æ¸…é™¤å¿«å–</span>
                                                <p class="text-xs text-gray-500">é‡‹æ”¾å„²å­˜ç©ºé–“</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='payment'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">ä»˜æ¬¾è¨­å®š</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">é è¨­ä»˜æ¬¾æ–¹å¼</label>
                                        <select class="form-input-styled mt-2">
                                            <option>ä¿¡ç”¨å¡ (****1234)</option>
                                            <option>Apple Pay</option>
                                            <option>Google Pay</option>
                                        </select>
                                    </div>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">è‡ªå‹•å„²å­˜ä»˜æ¬¾æ–¹å¼</span>
                                            <p class="text-xs text-gray-500">æ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">ç™¼ç¥¨è¨­å®š</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">ç™¼ç¥¨é¡å‹</label>
                                        <select class="form-input-styled mt-2">
                                            <option>é›»å­ç™¼ç¥¨</option>
                                            <option>ç´™æœ¬ç™¼ç¥¨</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">çµ±ä¸€ç·¨è™Ÿ</label>
                                        <input type="text" class="form-input-styled mt-2" placeholder="é¸å¡«">
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='pets'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å¯µç‰©è¨­å®š</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">é è¨­å¯µç‰©è³‡è¨Š</span>
                                            <p class="text-xs text-gray-500">è‡ªå‹•å¡«å…¥å¯µç‰©è³‡æ–™</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">ç‰¹æ®Šéœ€æ±‚è¨˜éŒ„</span>
                                            <p class="text-xs text-gray-500">è¨˜ä½å¯µç‰©ç‰¹æ®Šéœ€æ±‚</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">éæ•è³‡è¨Šæé†’</span>
                                            <p class="text-xs text-gray-500">æé†’å•†å®¶æ³¨æ„éæ•</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å¯µç‰©æª”æ¡ˆ</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">ç®¡ç†å¯µç‰©æª”æ¡ˆ</span>
                                                <p class="text-xs text-gray-500">ç·¨è¼¯å¯µç‰©è©³ç´°è³‡è¨Š</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='merchant' && isUserMerchant){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å•†å®¶è¨­å®š</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">è‡ªå‹•å›è¦†</span>
                                            <p class="text-xs text-gray-500">å•Ÿç”¨è‡ªå‹•å›è¦†åŠŸèƒ½</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">ç‡Ÿæ¥­æ™‚é–“æé†’</span>
                                            <p class="text-xs text-gray-500">ç‡Ÿæ¥­æ™‚é–“è®Šæ›´é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å•†å®¶ç®¡ç†</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">ç‡Ÿæ¥­æ™‚é–“è¨­å®š</span>
                                                <p class="text-xs text-gray-500">è¨­å®šæ¯é€±ç‡Ÿæ¥­æ™‚é–“</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">åƒ¹æ ¼è¨­å®š</span>
                                                <p class="text-xs text-gray-500">ç®¡ç†æœå‹™åƒ¹æ ¼</p>
                                            </div>
                                            <span class="text-gray-400">â€º</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // ä¸€èˆ¬è¨­å®š
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">åŸºæœ¬è¨­å®š</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">èªè¨€</label>
                                        <select class="form-input-styled mt-2">
                                            <option>ç¹é«”ä¸­æ–‡</option>
                                            <option>English</option>
                                            <option>æ—¥æœ¬èª</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">åœ°å€</label>
                                        <select class="form-input-styled mt-2">
                                            <option>å°ç£</option>
                                            <option>é¦™æ¸¯</option>
                                            <option>æ¾³é–€</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">è²¨å¹£</label>
                                        <select class="form-input-styled mt-2">
                                            <option>æ–°å°å¹£ (NT$)</option>
                                            <option>æ¸¯å¹£ (HK$)</option>
                                            <option>äººæ°‘å¹£ (Â¥)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">å¤–è§€è¨­å®š</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">ä¸»é¡Œ</label>
                                        <div class="flex gap-2 mt-2">
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white text-gray-700">æ·ºè‰²</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-800 text-white">æ·±è‰²</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-100 text-gray-700">è‡ªå‹•</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">å­—é«”å¤§å°</label>
                                        <select class="form-input-styled mt-2">
                                            <option>å°</option>
                                            <option selected>ä¸­</option>
                                            <option>å¤§</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // ç¶å®šæ¨™ç±¤é»æ“Šäº‹ä»¶
                modal.querySelectorAll('[data-tab]')?.forEach(btn=>btn.addEventListener('click', ()=>renderTab(btn.dataset.tab)));
                
                // åˆå§‹æ¸²æŸ“
                renderTab(activeTab);
            }

            function openPrivacyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">éš±ç§</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="text-sm text-[#886364] space-y-2">
                        <p>æˆ‘å€‘é‡è¦–æ‚¨çš„éš±ç§ï¼Œåƒ…æ–¼æä¾›æœå‹™æ‰€éœ€ç¯„åœå…§ä½¿ç”¨è³‡æ–™ã€‚</p>
                        <p>å¯æ–¼ã€Œè¨­å®š > å¸³è™Ÿã€ç”³è«‹è³‡æ–™ä¸‹è¼‰æˆ–åˆªé™¤ã€‚</p>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function openProfileEditModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">ç·¨è¼¯å€‹äººè³‡æ–™</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600">åç¨±</label>
                            <input class="form-input-styled mt-1" value="James">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">åŸå¸‚</label>
                            <input class="form-input-styled mt-1" value="å°åŒ—å¸‚">
                        </div>
                        <button class="btn-main h-11">å„²å­˜</button>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function renderMerchantApplicationFlow() {
                let step = 1;
                const appState = {
                    codeSent: false,
                    smsVerified: false,
                    outcome: 'pending'
                };
                if (!window.merchantApplicationStatus) window.merchantApplicationStatus = 'not_applied';
                if (!window.merchantLastRejectReason) window.merchantLastRejectReason = '';

                function render() {
                    formModal.innerHTML = `
                        <div class="p-4 overflow-y-auto max-h-full">
                            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                                <button id="merchant-back-btn" class="text-lg font-bold p-2">${step===1?'&lt; è¿”å›':'&lt; ä¸Šä¸€æ­¥'}</button>
                                <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">æˆç‚ºå•†å®¶</h1>
                                <div class="w-28 text-right text-xs text-[#886364]">${
                                    window.merchantApplicationStatus==='under_review' ? 'ç‹€æ…‹ï¼šå¯©æ ¸ä¸­' :
                                    window.merchantApplicationStatus==='rejected' ? 'ç‹€æ…‹ï¼šä¸é€šé' :
                                    window.merchantApplicationStatus==='re_review' ? 'ç‹€æ…‹ï¼šå†æ¬¡å¯©æ ¸ä¸­' :
                                    window.merchantApplicationStatus==='approved' ? 'ç‹€æ…‹ï¼šå·²é€šé' : ' '}
                                </div>
                            </div>
                            ${step===1 ? renderStep1Info() : ''}
                            ${step===2 ? renderStep2SMS() : ''}
                            ${step===3 ? renderStep3SubmitAndReview() : ''}
                            ${step===4 ? renderStep4Outcome() : ''}
                        </div>
                    `;
                    formModal.classList.remove('hidden');

                    document.getElementById('merchant-back-btn')?.addEventListener('click', () => {
                        if (step === 1) { formModal.classList.add('hidden'); return; }
                        step = Math.max(1, step - 1); render();
                    });

                    document.getElementById('merchant-next-btn')?.addEventListener('click', () => { step = Math.min(4, step + 1); render(); });
                    document.getElementById('merchant-send-code-btn')?.addEventListener('click', () => {
                        appState.codeSent = true; render();
                    });
                    document.getElementById('merchant-verify-code-btn')?.addEventListener('click', () => {
                        appState.smsVerified = true; render();
                    });
                    document.getElementById('merchant-submit-review-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 'under_review';
                        step = 3; render();
                    });
                    document.getElementById('simulate-approve-btn')?.addEventListener('click', () => {
                        appState.outcome = 'approved';
                        window.merchantApplicationStatus = 'approved';
                        step = 4; render();
                    });
                    document.getElementById('simulate-reject-btn')?.addEventListener('click', () => {
                        appState.outcome = 'rejected';
                        window.merchantApplicationStatus = 'rejected';
                        step = 4; render();
                    });
                    document.getElementById('resubmit-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 're_review';
                        step = 1; render();
                    });
                    document.getElementById('go-dashboard-btn')?.addEventListener('click', () => {
                        isUserMerchant = true;
                        formModal.classList.add('hidden');
                        renderUserCenterPage();
                        showPage('merchantDashboard');
                    });
                    document.getElementById('reject-reason-input')?.addEventListener('input', (e) => {
                        window.merchantLastRejectReason = e.target.value || '';
                    });
                }

                function renderStep1Info() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">å•†å®¶å¡«å¯«è³‡æ–™ï¼ˆåç¨±ã€åœ‹å®¶ã€åœ°å€ã€åœ°å€ã€è­‰ä»¶â€¦ï¼‰</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">åº—å®¶åç¨±</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="ä¾‹å¦‚ï¼šå¿«æ¨‚çˆªå­æ—…é¤¨">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">åœ‹å®¶</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="å°ç£">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">åœ°å€</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="å°åŒ—å¸‚/ä¿¡ç¾©å€">
                                </div>
                            </div>
                                                        <div>
                                <label class="text-sm font-medium text-[#886364]">åœ°å€</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="åŸå¸‚ã€è¡—é“ã€é–€ç‰Œ">
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">èº«åˆ†æ–‡ä»¶ï¼ˆç¤ºæ„ï¼‰</p>
                                <div class="grid gap-2 text-sm">
                                    <label class="flex items-center justify-between">èº«åˆ†è­‰<input type="file" class="text-sm"></label>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">é¸å¡«è³‡æ–™</p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-[#886364]">ç‡Ÿæ¥­ç™»è¨˜è­‰</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-[#886364]">éŠ€è¡Œå¸³æˆ¶</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6"><button id="merchant-next-btn" class="btn-main">ä¸‹ä¸€æ­¥ï¼šç°¡è¨Šé©—è­‰</button></div>
                        </div>`;
                }

                function renderStep2SMS() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">ç°¡è¨Šé©—è­‰æ‰‹æ©Ÿ</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="tel" class="form-input-styled flex-1" placeholder="09xx-xxx-xxx">
                                    <button id="merchant-send-code-btn" class="px-3 h-11 rounded-full bg-gray-100 text-sm">${appState.codeSent?'é‡æ–°ç™¼é€':'ç™¼é€é©—è­‰ç¢¼'}</button>
                                </div>
                            </div>
                            ${appState.codeSent ? `
                            <div>
                                <label class="text-sm font-medium text-[#886364]">è¼¸å…¥é©—è­‰ç¢¼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" class="form-input-styled flex-1" placeholder="6 ä½æ•¸ç¢¼">
                                    <button id="merchant-verify-code-btn" class="btn-main h-11 px-4">é©—è­‰</button>
                                </div>
                                ${appState.smsVerified?'<p class="text-xs text-emerald-600 mt-1">é©—è­‰æˆåŠŸ</p>':''}
                            </div>` : ''}
                            <div class="mt-6">
                                <button id="merchant-next-btn" class="btn-main" ${appState.smsVerified?'' : 'disabled'}>ä¸‹ä¸€æ­¥ï¼šé€å‡ºå¯©æ ¸</button>
                            </div>
                        </div>`;
                }

                function renderStep3SubmitAndReview() {
                    const isUnderReview = window.merchantApplicationStatus === 'under_review' || window.merchantApplicationStatus === 're_review';
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">é€å‡ºå¯©æ ¸ï¼ˆç‹€æ…‹ï¼š${isUnderReview?'å¯©æ ¸ä¸­':'å°šæœªé€å‡º'}ï¼‰</div>
                            ${!isUnderReview ? `<button id="merchant-submit-review-btn" class="btn-main w-full">é€å‡ºå¯©æ ¸</button>` : ''}
                            ${isUnderReview ? `
                            <div class="bg-white border rounded-xl p-4 text-sm">
                                <p class="text-[#181111] font-bold mb-1">å¯©æ ¸ä¸­</p>
                                <p class="text-[#886364]">æˆ‘å€‘æœƒæ–¼ 1-3 å€‹å·¥ä½œå¤©å®Œæˆå¯©æ ¸ï¼Œä¸¦ä»¥ä¿¡ä»¶é€šçŸ¥çµæœã€‚</p>
                            </div>
                            <div class="text-xs text-[#886364]">ï¼ˆç¤ºæ„ï¼‰ç®¡ç†è€…æ“ä½œï¼š
                                <div class="flex gap-2 mt-2">
                                    <button id="simulate-approve-btn" class="px-3 py-2 rounded-full bg-emerald-100 text-emerald-700">æ¨¡æ“¬å¯©æ ¸é€šé</button>
                                    <button id="simulate-reject-btn" class="px-3 py-2 rounded-full bg-red-100 text-red-700">æ¨¡æ“¬é€€å¯©</button>
                                </div>
                            </div>` : ''}
                        </div>`;
                }

                function renderStep4Outcome() {
                    if (appState.outcome === 'approved') {
                        return `
                            <div class="space-y-4 px-2">
                                <div class="bg-white border rounded-xl p-4">
                                    <p class="text-base font-bold text-[#181111] mb-1">å¯©æ ¸é€šé</p>
                                    <p class="text-sm text-[#886364]">å·²å¯„å‡ºå…¥é§æˆåŠŸä¿¡ä»¶ï¼Œæ­¡è¿æˆç‚ºåˆä½œå•†å®¶ï¼</p>
                                </div>
                                <button id="go-dashboard-btn" class="btn-main w-full">é€²å…¥å•†å®¶å¾Œå°</button>
                            </div>`;
                    }
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-white border rounded-xl p-4">
                                <p class="text-base font-bold text-[#181111] mb-1">é€€å¯©</p>
                                <p class="text-sm text-[#886364] mb-3">ä»¥ä¸‹ç‚ºä¸é€šéåŸå› ï¼Œè«‹æ›´æ–°è³‡æ–™å¾Œå†æ¬¡é€å‡ºã€‚</p>
                                <textarea id="reject-reason-input" class="form-input-styled w-full" rows="3" placeholder="ç¯„ä¾‹ï¼šè³‡æ–™ä¸å®Œæ•´ã€åœ°å€ç„¡æ³•é©—è­‰ç­‰">${window.merchantLastRejectReason}</textarea>
                            </div>
                            <div class="flex gap-2">
                                <button id="resubmit-btn" class="btn-main flex-1">æ›´æ–°è³‡æ–™ä¸¦å†æ¬¡é€å‡º</button>
                            </div>
                        </div>`;
                }

                render();
            }

            function renderOrdersPage() {
                const container = pages.orders;
                container.innerHTML = `
                    <div class="p-4">
                        <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">æˆ‘çš„è¨‚å–®</h1>
                        <div class="flex justify-around bg-[#f4f0f0] rounded-full p-1 mb-5">
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="pending">é€²è¡Œä¸­</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="completed">å·²å®Œæˆ</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="cancelled">å·²å–æ¶ˆ</button>
                        </div>
                        <div id="order-list" class="space-y-4">
                            <!-- è¨‚å–®å¡ç‰‡ç”±JSç”Ÿæˆ -->
                        </div>
                    </div>
                `;
                renderOrders('pending');
            }

            function renderOrders(filter) {
                const container = document.getElementById('order-list');
                const filterButtons = document.querySelectorAll('.order-filter-btn');
                
                if (!container || !filterButtons) return;

                filterButtons.forEach(btn => {
                    btn.classList.toggle('bg-[#181111]', btn.dataset.filter === filter);
                    btn.classList.toggle('text-white', btn.dataset.filter === filter);
                    btn.classList.toggle('text-[#886364]', btn.dataset.filter !== filter);
                });

                const filteredOrders = mockOrders.filter(order => order.status === filter);
                if (filteredOrders.length === 0) {
                    container.innerHTML = `<p class="text-center text-[#886364]">æ²’æœ‰${filter === 'pending' ? 'é€²è¡Œä¸­' : filter === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ'}çš„è¨‚å–®ã€‚</p>`;
                    return;
                }
                container.innerHTML = filteredOrders.map(order => {
                    let statusBadge;
                    switch(order.status) {
                        case 'pending': statusBadge = `<span class="text-xs font-bold text-white bg-amber-500 px-2 py-1 rounded-full">é€²è¡Œä¸­</span>`; break;
                        case 'completed': statusBadge = `<span class="text-xs font-bold text-white bg-emerald-500 px-2 py-1 rounded-full">å·²å®Œæˆ</span>`; break;
                        case 'cancelled': statusBadge = `<span class="text-xs font-bold text-white bg-red-500 px-2 py-1 rounded-full">å·²å–æ¶ˆ</span>`; break;
                    }
                    return `
                        <div class="bg-white p-4 rounded-xl border border-gray-100">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-base text-[#181111]">${order.name}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-[#886364] mb-1">æ—¥æœŸ: ${order.date}</p>
                            <p class="text-sm text-[#886364] mb-3">å¯µç‰©: ${order.pet}</p>
                            <div class="flex justify-between items-center mt-3 border-t pt-3">
                                <span class="text-base font-bold text-[#181111]">ç¸½è¨ˆ: NT$ ${order.total.toLocaleString()}</span>
                                <button class="py-2 px-4 bg-[#181111] text-white rounded-full text-sm">æŸ¥çœ‹è©³æƒ…</button>
                            </div>
                        </div>`;
                }).join('');
            }
            
            function renderFavoritesPage() {
                const container = pages.favorites;
                container.innerHTML = `
                <div class="p-4">
                    <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">æˆ‘çš„æ”¶è—</h1>
                    <div class="space-y-4">
                        <div class="listing-card">
                            <div class="info-section">
                                <div class="flex flex-col gap-1">
                                    <p class="text-[#886364] text-sm font-normal leading-normal">â­ï¸ 4.9 â€¢ 150 å‰‡è©•åƒ¹</p>
                                    <p class="text-[#181111] text-base font-bold leading-tight">è²“èªå¤©å ‚</p>
                                    <p class="text-[#886364] text-sm font-normal leading-normal">æ–°åŒ—å¸‚ â€¢ åƒ…æ¥å—è²“</p>
                                </div>
                                <button class="text-sm text-red-600 w-fit">ç§»é™¤æ”¶è—</button>
                            </div>
                            <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800");'></div>
                        </div>
                         <div class="listing-card">
                            <div class="info-section">
                                <div class="flex flex-col gap-1">
                                    <p class="text-[#886364] text-sm font-normal leading-normal">â­ï¸ 4.7 â€¢ 85 å‰‡è©•åƒ¹</p>
                                    <p class="text-[#181111] text-base font-bold leading-tight">æ±ªæ˜Ÿäººåº¦å‡æ‘</p>
                                    <p class="text-[#886364] text-sm font-normal leading-normal">å°ä¸­å¸‚ â€¢ åƒ…æ¥å—çŠ¬</p>
                                </div>
                                 <button class="text-sm text-red-600 w-fit">ç§»é™¤æ”¶è—</button>
                            </div>
                            <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600");'></div>
                        </div>
                         <div class="p-4 text-center text-[#886364]">æ²’æœ‰æ›´å¤šæ”¶è—äº†ã€‚</div>
                    </div>
                </div>
                `;
            }

            function renderSettingsPage() {
                const container = pages.settings;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-between">
                        <button id="settings-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                            </svg>
                        </button>
                        <h2 class="text-[#181111] text-base font-bold">è¨­å®š</h2>
                        <div class="w-8"></div>
                    </div>
                </div>

                <div class="p-4">
                    <!-- æ¨™ç±¤å°èˆª -->
                    <div class="flex gap-2 overflow-x-auto pb-2 mb-4">
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active" data-tab="general">ä¸€èˆ¬è¨­å®š</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="notifications">é€šçŸ¥è¨­å®š</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="profile">å€‹äººè³‡æ–™</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="system">ç³»çµ±è¨­å®š</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="payment">ä»˜æ¬¾è¨­å®š</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="pets">å¯µç‰©è¨­å®š</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="emergency">ç·Šæ€¥è¯çµ¡</button>

                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="support">æ”¯æ´</button>
                        ${isUserMerchant ? '<button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="merchant">å•†å®¶è¨­å®š</button>' : ''}
                    </div>

                    <!-- è¨­å®šå…§å®¹å€åŸŸ -->
                    <div id="settings-content" class="space-y-6">
                        <!-- ä¸€èˆ¬è¨­å®š -->
                        <div id="general-settings" class="settings-tab-content active">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">ä¸€èˆ¬è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">èªè¨€</label>
                                    <select class="form-input-styled">
                                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                                        <option value="en">English</option>
                                        <option value="ja">æ—¥æœ¬èª</option>
                                    </select>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">ä¸»é¡Œ</label>
                                    <div class="flex gap-2">
                                        <button class="px-4 py-2 rounded-lg bg-[#181111] text-white text-sm font-medium">æ·ºè‰²</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">æ·±è‰²</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">è‡ªå‹•</button>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- é€šçŸ¥è¨­å®š -->
                        <div id="notifications-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">é€šçŸ¥è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">æ¨æ’­é€šçŸ¥</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">é›»å­éƒµä»¶é€šçŸ¥</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- å€‹äººè³‡æ–™ -->
                        <div id="profile-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">å€‹äººè³‡æ–™</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">å§“å</label>
                                    <input type="text" value="James Chen" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">é›»å­éƒµä»¶</label>
                                    <input type="email" value="james@example.com" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                    <input type="tel" value="+886 912-345-678" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">è®Šæ›´å¯†ç¢¼</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">å„²å­˜è®Šæ›´</button>
                                        <button class="btn-secondary h-11 flex-1">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç³»çµ±è¨­å®š -->
                        <div id="system-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">ç³»çµ±è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">ä½ç½®æœå‹™</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">ç›¸æ©Ÿå­˜å–</label>
                                        </div>
                                        <label class="text-sm text-[#886364]">å·²å…è¨±</label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">æ¸…é™¤å¿«å–</button>
                                </div>
                            </div>
                        </div>

                        <!-- ä»˜æ¬¾è¨­å®š -->
                        <div id="payment-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">ä»˜æ¬¾è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">é è¨­ä»˜æ¬¾æ–¹å¼</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-1" checked>
                                            <label for="card-1" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">ğŸ’³ Visa ****1234</span>
                                                    <span class="text-xs text-[#886364]">åˆ°æœŸæ—¥: 12/25</span>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-2">
                                            <label for="card-2" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">ğŸ’³ Mastercard ****5678</span>
                                                    <span class="text-xs text-[#886364]">åˆ°æœŸæ—¥: 08/26</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">æ–°å¢ä»˜æ¬¾æ–¹å¼</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">ç™¼ç¥¨è¨­å®š</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-1" checked>
                                            <label for="invoice" class="text-sm">é›»å­ç™¼ç¥¨</label>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-2">
                                            <label for="invoice" class="text-sm">ç´™æœ¬ç™¼ç¥¨</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å¯µç‰©è¨­å®š -->
                        <div id="pets-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">å¯µç‰©è¨­å®š</h3>
                            
                            <!-- å¯µç‰©é¸æ“‡å™¨ -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-[#181111]">é¸æ“‡å¯µç‰©</label>
                                    <button class="add-pet-btn p-2 rounded-full bg-[#181111] text-white hover:bg-gray-800">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active bg-[#181111] text-white" data-pet="pet1">ğŸ• å°é»ƒ</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet2">ğŸ± å’ªå’ª</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet3">ğŸ° å°ç™½</button>
                                </div>
                            </div>

                            <!-- å¯µç‰©ç…§ç‰‡ -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-[#181111]">å¯µç‰©ç…§ç‰‡</h4>
                                    <button class="change-photo-btn px-3 py-1 text-xs bg-[#181111] text-white rounded-full hover:bg-gray-800">æ›´æ›ç…§ç‰‡</button>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="relative mb-3">
                                        <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center" 
                                             alt="å°é»ƒçš„ç…§ç‰‡" 
                                             class="w-32 h-32 rounded-full object-cover border-4 border-gray-100 shadow-lg">
                                        <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-[#181111] rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-sm text-[#886364] text-center">é»æ“Šã€Œæ›´æ›ç…§ç‰‡ã€ä¾†ä¸Šå‚³æ–°çš„å¯µç‰©ç…§ç‰‡</p>
                                </div>
                            </div>

                            <!-- å¯µç‰©è©³ç´°è¨­å®š -->
                            <div class="space-y-4">
                                <!-- å¯µç‰©åŸºæœ¬è³‡è¨Š -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">åŸºæœ¬è³‡è¨Š</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">æš±ç¨±</label>
                                            <input type="text" value="å°é»ƒ" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å“ç¨®</label>
                                            <input type="text" value="é»ƒé‡‘çµçŠ¬" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å¹´é½¡</label>
                                            <input type="number" value="3" class="form-input-styled text-sm" min="0" max="30">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é«”é‡ (kg)</label>
                                            <input type="number" value="25" class="form-input-styled text-sm" min="0" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- å¯µç‰©åå¥½è¨­å®š -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">åå¥½è¨­å®š</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å–œæ­¡çš„ç©å…·</label>
                                            <input type="text" value="ç¶²çƒã€é£›ç›¤" class="form-input-styled text-sm" placeholder="è¼¸å…¥å¯µç‰©å–œæ­¡çš„ç©å…·...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å–œæ­¡çš„æ´»å‹•</label>
                                            <input type="text" value="æ•£æ­¥ã€æ¸¸æ³³" class="form-input-styled text-sm" placeholder="è¼¸å…¥å¯µç‰©å–œæ­¡çš„æ´»å‹•...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é£²é£Ÿåå¥½</label>
                                            <input type="text" value="ä¹¾ç³§ã€é›è‚‰" class="form-input-styled text-sm" placeholder="è¼¸å…¥å¯µç‰©çš„é£²é£Ÿåå¥½...">
                                        </div>
                                    </div>
                                </div>

                                <!-- å¥åº·èˆ‡ç‰¹æ®Šéœ€æ±‚ -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">å¥åº·èˆ‡ç‰¹æ®Šéœ€æ±‚</h4>
                                    <div class="space-y-3">
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">å¥åº·è¨˜éŒ„æé†’</label>
                                                    <p class="text-xs text-[#886364]">å®šæœŸæé†’å¯µç‰©å¥åº·æª¢æŸ¥</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- å¥åº·æé†’è©³ç´°è¨­å®š -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">ç–«è‹—æé†’</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="3">æ¯3å€‹æœˆ</option>
                                                            <option value="6" selected>æ¯6å€‹æœˆ</option>
                                                            <option value="12">æ¯å¹´</option>
                                                            <option value="custom">è‡ªè¨‚</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">å¥åº·æª¢æŸ¥</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="6">æ¯6å€‹æœˆ</option>
                                                            <option value="12" selected>æ¯å¹´</option>
                                                            <option value="18">æ¯18å€‹æœˆ</option>
                                                            <option value="custom">è‡ªè¨‚</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-[#886364] mb-1">ä¸‹æ¬¡æé†’æ—¥æœŸ</label>
                                                    <input type="date" value="2025-06-15" class="form-input-styled text-xs">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">å¯µç‰©æª”æ¡ˆåŒæ­¥</label>
                                                    <p class="text-xs text-[#886364]">è‡ªå‹•åŒæ­¥å¯µç‰©è³‡è¨Šåˆ°é›²ç«¯</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- åŒæ­¥è©³ç´°è¨­å®š -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">åŒæ­¥é »ç‡</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="realtime">å³æ™‚åŒæ­¥</option>
                                                            <option value="hourly">æ¯å°æ™‚</option>
                                                            <option value="daily" selected>æ¯å¤©</option>
                                                            <option value="weekly">æ¯é€±</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">åŒæ­¥å…§å®¹</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="all" selected>å…¨éƒ¨è³‡è¨Š</option>
                                                            <option value="basic">åŸºæœ¬è³‡è¨Š</option>
                                                            <option value="health">å¥åº·è¨˜éŒ„</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <input type="checkbox" id="sync-photos" checked class="w-4 h-4">
                                                    <label for="sync-photos" class="text-xs text-[#886364]">åŒæ­¥å¯µç‰©ç…§ç‰‡</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">éæ•åŸ</label>
                                            <input type="text" value="æµ·é®®ã€èŠ±ç”Ÿ" class="form-input-styled text-sm" placeholder="è¼¸å…¥å¯µç‰©çš„éæ•åŸ...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">ç‰¹æ®Šéœ€æ±‚</label>
                                            <textarea class="form-input-styled text-sm" rows="2" placeholder="è¨˜éŒ„å¯µç‰©çš„ç‰¹æ®Šéœ€æ±‚ã€é†«ç™‚ç‹€æ³ç­‰...">éœ€è¦å®šæœŸæœè—¥ï¼Œé—œç¯€è¼ƒæ•æ„Ÿ</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- å„²å­˜æŒ‰éˆ• -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">å„²å­˜è®Šæ›´</button>
                                        <button class="btn-secondary h-11 flex-1">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç·Šæ€¥è¯çµ¡è¨­å®š -->
                        <div id="emergency-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">ç·Šæ€¥è¯çµ¡è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <!-- ä¸»è¦è¯çµ¡äºº -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">ä¸»è¦è¯çµ¡äºº</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å§“å</label>
                                            <input type="text" value="ç‹å°æ˜" class="form-input-styled text-sm" placeholder="è¼¸å…¥è¯çµ¡äººå§“å">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é›»è©±</label>
                                            <input type="tel" value="+886 912-345-678" class="form-input-styled text-sm" placeholder="è¼¸å…¥è¯çµ¡äººé›»è©±">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é—œä¿‚</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family">å®¶äºº</option>
                                                <option value="friend" selected>æœ‹å‹</option>
                                                <option value="colleague">åŒäº‹</option>
                                                <option value="other">å…¶ä»–</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- å‚™ç”¨è¯çµ¡äºº -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">å‚™ç”¨è¯çµ¡äºº</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">å§“å</label>
                                            <input type="text" value="æå°è¯" class="form-input-styled text-sm" placeholder="è¼¸å…¥å‚™ç”¨è¯çµ¡äººå§“å">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é›»è©±</label>
                                            <input type="tel" value="+886 987-654-321" class="form-input-styled text-sm" placeholder="è¼¸å…¥å‚™ç”¨è¯çµ¡äººé›»è©±">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é—œä¿‚</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family" selected>å®¶äºº</option>
                                                <option value="friend">æœ‹å‹</option>
                                                <option value="colleague">åŒäº‹</option>
                                                <option value="other">å…¶ä»–</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>





                                <!-- å„²å­˜æŒ‰éˆ• -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">å„²å­˜è®Šæ›´</button>
                                        <button class="btn-secondary h-11 flex-1">å–æ¶ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ”¯æ´ -->
                        <div id="support-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">æ”¯æ´</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">å¹«åŠ©ä¸­å¿ƒ</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">æ„è¦‹å›é¥‹</button>
                                </div>
                            </div>
                        </div>

                        <!-- å•†å®¶è¨­å®š -->
                        ${isUserMerchant ? `
                        <div id="merchant-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">å•†å®¶è¨­å®š</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">è‡ªå‹•ç¢ºèªè¨‚å–®</label>
                                            <p class="text-xs text-[#886364] mt-1">è‡ªå‹•ç¢ºèªç¬¦åˆæ¢ä»¶çš„è¨‚å–®</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">åº«å­˜è­¦å‘Š</label>
                                            <p class="text-xs text-[#886364] mt-1">åº«å­˜ä¸è¶³æ™‚ç™¼é€é€šçŸ¥</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">ç‡Ÿæ¥­æ™‚é–“</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">é–‹å§‹æ™‚é–“</label>
                                            <input type="time" value="09:00" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">çµæŸæ™‚é–“</label>
                                            <input type="time" value="18:00" class="form-input-styled text-sm">
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">è‡ªå‹•å›è¦†è¨Šæ¯</label>
                                    <textarea class="form-input-styled" rows="3" placeholder="è¨­å®šè‡ªå‹•å›è¦†å®¢æˆ¶çš„è¨Šæ¯..."></textarea>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                attachSettingsListeners();
            }

            function attachSettingsListeners() {
                // è¿”å›æŒ‰éˆ•
                document.getElementById('settings-back-btn')?.addEventListener('click', () => showPage('account'));
                
                // æ¨™ç±¤åˆ‡æ›
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabName = btn.dataset.tab;
                        switchSettingsTab(tabName);
                    });
                });

                // å¯µç‰©é¸æ“‡å™¨
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const petId = btn.dataset.pet;
                        switchPetSettings(petId);
                    });
                });

                // æ–°å¢å¯µç‰©æŒ‰éˆ•
                document.querySelector('.add-pet-btn')?.addEventListener('click', () => {
                    addNewPet();
                });

                // æ›´æ›ç…§ç‰‡æŒ‰éˆ•
                document.querySelector('.change-photo-btn')?.addEventListener('click', () => {
                    changePetPhoto();
                });
            }

            function switchSettingsTab(activeTab) {
                // æ›´æ–°æ¨™ç±¤æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === activeTab);
                });
                
                // éš±è—æ‰€æœ‰å…§å®¹
                document.querySelectorAll('.settings-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹
                const targetContent = document.getElementById(`${activeTab}-settings`);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }

            function switchPetSettings(petId) {
                // æ›´æ–°å¯µç‰©é¸æ“‡å™¨æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.pet === petId);
                    if (btn.dataset.pet === petId) {
                        btn.classList.remove('bg-gray-200', 'text-[#181111]');
                        btn.classList.add('bg-[#181111]', 'text-white');
                    } else {
                        btn.classList.remove('bg-[#181111]', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-[#181111]');
                    }
                });

                // é€™è£¡å¯ä»¥æ ¹æ“šé¸æ“‡çš„å¯µç‰©æ›´æ–°è¡¨å–®å…§å®¹
                // å¯¦éš›æ‡‰ç”¨ä¸­æœƒå¾è³‡æ–™åº«æˆ–ç‹€æ…‹ç®¡ç†ä¸­ç²å–å¯µç‰©è³‡è¨Š
                console.log('åˆ‡æ›åˆ°å¯µç‰©:', petId);
            }

            function addNewPet() {
                // æ–°å¢å¯µç‰©çš„é‚è¼¯
                // å¯¦éš›æ‡‰ç”¨ä¸­æœƒé–‹å•Ÿæ–°å¢å¯µç‰©çš„æ¨¡æ…‹è¦–çª—æˆ–å°èˆªåˆ°æ–°å¢é é¢
                alert('æ–°å¢å¯µç‰©åŠŸèƒ½ - é€™è£¡æœƒé–‹å•Ÿæ–°å¢å¯µç‰©çš„è¡¨å–®');
            }

            function changePetPhoto() {
                // å‰µå»ºéš±è—çš„æ–‡ä»¶è¼¸å…¥å…ƒç´ 
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                
                // ç›£è½æ–‡ä»¶é¸æ“‡
                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // æª¢æŸ¥æ–‡ä»¶é¡å‹
                        if (!file.type.startsWith('image/')) {
                            alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
                            return;
                        }
                        
                        // æª¢æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ç‚º 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('åœ–ç‰‡æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 5MB');
                            return;
                        }
                        
                        // å‰µå»ºé è¦½
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const petPhoto = document.querySelector('#pets-settings img');
                            if (petPhoto) {
                                petPhoto.src = e.target.result;
                                // é€™è£¡å¯ä»¥æ·»åŠ ä¸Šå‚³åˆ°ä¼ºæœå™¨çš„é‚è¼¯
                                console.log('å¯µç‰©ç…§ç‰‡å·²æ›´æ–°');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // è§¸ç™¼æ–‡ä»¶é¸æ“‡
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }

            function renderMerchantDashboard() {
                const container = pages.merchantDashboard;
                container.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">å•†å®¶å°ˆå€</h1>
                    <!-- å„€è¡¨æ¿æ¦‚è¦½ -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">å„€è¡¨æ¿æ¦‚è¦½</h2>
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg">å¾…è™•ç†è¨‚å–®: <span class="font-bold text-blue-700">5</span></div>
                            <div class="p-3 bg-green-50 rounded-lg">ä»Šæ—¥å…¥ä½: <span class="font-bold text-green-700">2</span></div>
                            <div class="p-3 bg-yellow-50 rounded-lg col-span-2">æœ¬æœˆç‡Ÿæ”¶: <span class="font-bold text-yellow-700">NT$ 15,000</span></div>
                        </div>
                        <button id="manage-calendar-btn" class="btn-main h-10 px-5 text-sm w-full">ç®¡ç†è¡Œäº‹æ›†</button>
                    </div>

                    <!-- æˆ¿å‹èˆ‡æ–¹æ¡ˆç®¡ç† -->
                    <div id="manage-rooms-link" class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">æˆ¿å‹èˆ‡æ–¹æ¡ˆç®¡ç†</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">ç®¡ç†æ‚¨çš„æˆ¿å‹èˆ‡åƒ¹æ ¼æ–¹æ¡ˆ</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                     <!-- è¨‚å–®ç®¡ç† -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">è¨‚å–®ç®¡ç†</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">æŸ¥çœ‹èˆ‡ç¢ºèªæ‰€æœ‰è¨‚å–®</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                </div>
                `;
            }

            function renderRoomListPage() {
                const container = pages.roomManagement;
                container.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-[#181111]">æˆ¿å‹ç®¡ç†</h1>
                            <button id="add-new-room-btn" class="btn-main h-10 px-5 text-sm w-auto">ï¼‹ æ–°å¢æˆ¿å‹</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${mockRoomTypes.map(room => `
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-4">
                                        <img src="${room.imageUrl}" class="w-20 h-20 rounded-lg object-cover">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-[#181111] truncate">${room.name}</h3>
                                                <span class="text-xs font-semibold ${room.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'} px-2 py-0.5 rounded-full">${room.status === 'active' ? 'å•Ÿç”¨ä¸­' : 'å·²ç¦ç”¨'}</span>
                                            </div>
                                            <p class="text-sm text-[#886364] mt-1 truncate">${room.description}</p>
                                            <p class="text-sm font-bold text-[#181111] mt-2">ç¸½åº«å­˜: ${room.stock} é–“</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button class="py-1 px-3 bg-red-100 text-red-600 rounded-full text-xs font-medium">åˆªé™¤</button>
                                        <button class="edit-room-btn py-1 px-3 bg-gray-200 text-gray-800 rounded-full text-xs font-medium" data-room-id="${room.id}">ç·¨è¼¯</button>
                                        <button class="manage-packages-btn py-1 px-3 bg-[#181111] text-white rounded-full text-xs font-medium" data-room-id="${room.id}">ç®¡ç†æ–¹æ¡ˆ</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                         <div class="pt-4 mt-2">
                            <button id="back-to-dashboard-btn" class="flex cursor-pointer items-center justify-center w-full h-12 rounded-full bg-gray-200 text-[#181111] font-bold">è¿”å›å•†å®¶å°ˆå€</button>
                        </div>
                    </div>
                `;
            }
            
            function renderPackageListPage(roomId) {
                const container = pages.packageManagement;
                const room = mockRoomTypes.find(r => r.id === roomId);
                if (!room) {
                    container.innerHTML = '<div class="p-4 text-center text-red-500">æ‰¾ä¸åˆ°è©²æˆ¿å‹è³‡è¨Šã€‚</div>';
                    return;
                }

                const roomPackages = mockPackages.filter(p => p.roomId === roomId);

                container.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-xl font-bold text-[#181111]">ç®¡ç† ${room.name} çš„æ–¹æ¡ˆ</h1>
                            <button id="add-new-package-btn" class="btn-main h-10 px-5 text-sm w-auto" data-room-id="${roomId}">ï¼‹ æ–°å¢æ–¹æ¡ˆ</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${roomPackages.length > 0 ? roomPackages.map(pkg => `
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-4 items-center">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-[#181111]">${pkg.name}</h3>
                                                <span class="text-xs font-semibold ${pkg.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'} px-2 py-0.5 rounded-full">${pkg.status === 'active' ? 'å•Ÿç”¨ä¸­' : 'å·²ç¦ç”¨'}</span>
                                            </div>
                                            <p class="text-sm text-[#886364] mt-1">è¨ˆåƒ¹: ${pkg.type === 'overnight' ? 'å¤©' : 'å°æ™‚'}</p>
                                            <p class="text-sm font-bold text-[#181111] mt-2">
                                                ${pkg.type === 'overnight' ? `NT$ ${pkg.basePrice} / æ™š` : `NT$ ${pkg.basePrice} / å°æ™‚`}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button class="py-1 px-3 bg-red-100 text-red-600 rounded-full text-xs font-medium">åˆªé™¤</button>
                                        <button class="edit-package-btn py-1 px-3 bg-gray-200 text-gray-800 rounded-full text-xs font-medium" data-package-id="${pkg.id}" data-room-id="${roomId}">ç·¨è¼¯</button>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="p-4 text-center text-[#886364] border border-dashed rounded-xl">æ­¤æˆ¿å‹ç›®å‰æ²’æœ‰ä»»ä½•æ–¹æ¡ˆã€‚é»æ“Šã€Œæ–°å¢æ–¹æ¡ˆã€å»ºç«‹ç¬¬ä¸€å€‹å§ï¼</div>
                            `}
                        </div>
                        <div class="pt-4 mt-2">
                            <button id="back-to-room-list-btn" class="flex cursor-pointer items-center justify-center w-full h-12 rounded-full bg-gray-200 text-[#181111] font-bold">è¿”å›æˆ¿å‹åˆ—è¡¨</button>
                        </div>
                    </div>
                `;
            }
            
            function renderPackageForm(roomId, packageId) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                const packageData = packageId ? mockPackages.find(p => p.id === packageId) : null;
                const isEditing = !!packageData;

                formModal.innerHTML = `
                    <div class="p-4 overflow-y-auto max-h-full">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                            <button id="cancel-form-btn" class="text-lg font-bold p-2">&lt; è¿”å›</button>
                            <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">${isEditing ? 'ç·¨è¼¯æ–¹æ¡ˆ' : 'æ–°å¢æ–¹æ¡ˆ'}</h1>
                            <div class="w-20"></div>
                        </div>
                        <div class="space-y-4 px-2">
                            <div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-700">
                                ç‚ºæˆ¿å‹ <strong>"${room.name}"</strong> è¨­å®šæ–¹æ¡ˆ
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">æ–¹æ¡ˆåç¨±</label>
                                <input type="text" class="form-input-styled mt-1" id="package-name" value="${isEditing ? packageData.name : ''}" placeholder="ä¾‹å¦‚ï¼šæ¨™æº–æ—¥ç§Ÿæ–¹æ¡ˆ">
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">æ–¹æ¡ˆæè¿°</label>
                                <textarea class="form-input-styled mt-1 h-24" id="package-description" placeholder="è©³ç´°èªªæ˜æ–¹æ¡ˆå…§å®¹...">${isEditing ? packageData.description || '' : ''}</textarea>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">è¨ˆåƒ¹å–®ä½</label>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center">
                                        <input type="radio" name="pricing-unit" value="overnight" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && packageData.type === 'overnight' ? 'checked' : !isEditing ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                        <span class="ml-2 text-sm">å¤© (éå¤œå¯„å®¿)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="pricing-unit" value="daycare" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && packageData.type === 'daycare' ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                        <span class="ml-2 text-sm">å°æ™‚ (æ—¥é–“å®‰è¦ª)</span>
                                    </label>
                                </div>
                                ${isEditing ? '<p class="text-xs text-red-500 mt-1">è¨ˆåƒ¹å–®ä½å„²å­˜å¾Œä¸å¯ä¿®æ”¹ã€‚</p>' : ''}
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">åŸºç¤åƒ¹æ ¼</label>
                                <input type="number" class="form-input-styled mt-1" id="base-price" value="${isEditing ? packageData.basePrice : ''}" min="0" placeholder="ä¾‹å¦‚ï¼š800">
                            </div>

                            <div id="overnight-specific-fields" class="${!isEditing || packageData.type === 'overnight' ? '' : 'hidden'}">
                                <label class="text-sm font-medium text-[#886364]">æœ€çŸ­é è¨‚å¤©æ•¸</label>
                                <input type="number" class="form-input-styled mt-1" id="min-days" value="${isEditing && packageData.type === 'overnight' ? packageData.min : 1}" min="1">
                                <label class="text-sm font-medium text-[#886364] mt-2">æœ€é•·é è¨‚å¤©æ•¸ (é¸å¡«)</label>
                                <input type="number" class="form-input-styled mt-1" id="max-days" value="${isEditing && packageData.type === 'overnight' && packageData.max ? packageData.max : ''}" min="1">
                            </div>

                            <div id="daycare-specific-fields" class="${isEditing && packageData.type === 'daycare' ? '' : 'hidden'}">
                                <label class="text-sm font-medium text-[#886364]">å¯é¸å®‰è¦ªæ™‚é•· (å°æ™‚)</label>
                                <p class="text-xs text-gray-500 mb-1">è¼¸å…¥é€—è™Ÿåˆ†éš”çš„æ™‚é•·é¸é …ï¼Œä¾‹å¦‚ "2,4,8"</p>
                                <input type="text" class="form-input-styled mt-1" id="daycare-lengths" value="${isEditing && packageData.type === 'daycare' && packageData.daycareLengths ? packageData.daycareLengths : ''}" placeholder="ä¾‹å¦‚ï¼š2,4,8">
                                
                                <label class="text-sm font-medium text-[#886364] mt-4">æ¯æ—¥å¯é è¨‚æ™‚æ®µ</label>
                                <p class="text-xs text-gray-500 mb-1">è¨­å®šæ­¤æ–¹æ¡ˆæ¯å¤©å¯æ¥å—é è¨‚çš„èµ·å§‹èˆ‡çµæŸæ™‚é–“</p>
                                <div class="flex gap-2 mt-1">
                                    <input type="time" class="form-input-styled" id="start-time" value="${isEditing && packageData.startTime ? packageData.startTime : '09:00'}">
                                    <span>-</span>
                                    <input type="time" class="form-input-styled" id="end-time" value="${isEditing && packageData.endTime ? packageData.endTime : '18:00'}">
                                </div>
                                
                                <label class="text-sm font-medium text-[#886364] mt-4">è¶…æ™‚è²»ç‡ (æ¯å°æ™‚)</label>
                                <input type="number" class="form-input-styled mt-1" id="overtime-rate" value="${isEditing && packageData.overtimeRate ? packageData.overtimeRate : ''}" min="0" placeholder="ä¾‹å¦‚ï¼š100">
                            </div>
                            
                            <div class="border-t pt-4">
                                <h3 class="text-sm font-bold text-[#181111] mb-2">ä¸Šæ¶èˆ‡æ’ç¨‹è¨­å®š</h3>
                                <div class="space-y-2">
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="permanent" class="h-4 w-4 text-black focus:ring-black" checked> <span class="ml-2 text-sm">æ°¸ä¹…æœ‰æ•ˆ</span></label>
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="date-range" class="h-4 w-4 text-black focus:ring-black"> <span class="ml-2 text-sm">æŒ‡å®šæ—¥æœŸ</span></label>
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="recurring" class="h-4 w-4 text-black focus:ring-black"> <span class="ml-2 text-sm">å¾ªç’°é¡¯ç¤º</span></label>
                                </div>
                            </div>
                            
                            <div id="date-range-fields" class="hidden pl-6 space-y-2 border-l-2 ml-2">
                                <label class="text-sm font-medium text-[#886364]">æ–¹æ¡ˆæœ‰æ•ˆæ—¥æœŸç¯„åœ</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="date" id="package-start-date" class="form-input-styled text-center p-2" value="${isEditing ? packageData.startDate : ''}">
                                    <span>-</span>
                                    <input type="date" id="package-end-date" class="form-input-styled text-center p-2" value="${isEditing ? packageData.endDate : ''}">
                                </div>
                            </div>
                            
                            <div id="recurring-fields" class="hidden pl-6 space-y-4 border-l-2 ml-2">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">é¸æ“‡å¾ªç’°æ˜ŸæœŸ</label>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(day => `<label class="flex items-center text-sm"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-1">${day}</span></label>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">å±•ç¤ºæ™‚é•·</label>
                                    <select class="form-input-styled mt-1"><option>ä¸€å€‹æœˆ</option><option>ä¸‰å€‹æœˆ</option><option>åŠå¹´</option><option>ä¸€å¹´</option></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">æ’é™¤æ—¥æœŸå€é–“ (é¸å¡«)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="date" class="form-input-styled text-center p-2">
                                        <span>-</span>
                                        <input type="date" class="form-input-styled text-center p-2">
                                    </div>
                                    <button class="text-xs text-blue-600 mt-1">+ æ–°å¢æ’é™¤å€é–“</button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center border-t pt-4">
                                <label class="text-sm font-medium text-[#886364]">å•Ÿç”¨ç‹€æ…‹</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="package-status-toggle" ${!isEditing || packageData.status === 'active' ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="btn-main" id="save-package-btn" data-room-id="${roomId}" data-package-id="${packageId || ''}">å„²å­˜æ–¹æ¡ˆ</button>
                        </div>
                    </div>
                `;
                formModal.classList.remove('hidden');
                attachPackageFormListeners();
            }
            
            function attachPackageFormListeners() {
                const pricingUnitRadios = formModal.querySelectorAll('input[name="pricing-unit"]');
                pricingUnitRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const overnightFields = formModal.querySelector('#overnight-specific-fields');
                        const daycareFields = formModal.querySelector('#daycare-specific-fields');
                        overnightFields.classList.toggle('hidden', this.value !== 'overnight');
                        daycareFields.classList.toggle('hidden', this.value !== 'daycare');
                    });
                });
                
                const scheduleModeRadios = formModal.querySelectorAll('input[name="schedule-mode"]');
                scheduleModeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const dateRangeFields = formModal.querySelector('#date-range-fields');
                        const recurringFields = formModal.querySelector('#recurring-fields');
                        dateRangeFields.classList.toggle('hidden', this.value !== 'date-range');
                        recurringFields.classList.toggle('hidden', this.value !== 'recurring');
                    });
                });
            }

            function renderRoomForm(roomId) {
                const roomData = roomId ? mockRoomTypes.find(r => r.id === roomId) : null;
                const isEditing = !!roomData;
                
                formModal.innerHTML = `
                    <div class="p-4 overflow-y-auto max-h-full">
                         <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                            <button id="cancel-form-btn" class="text-lg font-bold p-2">&lt; è¿”å›</button>
                            <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">${isEditing ? 'ç·¨è¼¯æˆ¿å‹' : 'æ–°å¢æˆ¿å‹'}</h1>
                            <div class="w-20"></div>
                        </div>
                        <div class="space-y-4 px-2">
                            <div>
                                <label class="text-sm font-medium text-[#886364]">æˆ¿å‹åç¨±</label>
                                <input type="text" class="form-input-styled mt-1" value="${isEditing ? roomData.name : ''}">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">æˆ¿å‹æè¿°</label>
                                <textarea class="form-input-styled mt-1 h-24">${isEditing ? roomData.description : ''}</textarea>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">åœ–ç‰‡ä¸Šå‚³</label>
                                <div class="mt-1 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                                    <div class="text-center">
                                        <p class="mt-1 text-sm leading-6 text-gray-600">æ‹–æ›³æˆ–é»æ“Šä¸Šå‚³</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-[#886364]">é©ç”¨å¯µç‰©ç¨®é¡</label>
                                <div class="space-y-2 mt-2">
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-black focus:ring-black" name="pet-type" value="dog"> <span class="ml-2 text-sm">ç‹—</span></label>
                                    <div id="dog-size-options" class="hidden pl-6 space-y-2">
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">å°å‹çŠ¬ (0-10å…¬æ–¤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">ä¸­å‹çŠ¬ (10-20å…¬æ–¤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">å¤§å‹çŠ¬ (20å…¬æ–¤ä»¥ä¸Š)</span></label>
                                    </div>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">è²“</span></label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">å¯å®¹ç´å¯µç‰©æ•¸</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? 1 : 1}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">æˆ¿å‹ç¸½åº«å­˜</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? roomData.stock : 1}">
                                </div>
                            </div>
                             <div class="flex justify-between items-center">
                                <label class="text-sm font-medium text-[#886364]">å•Ÿç”¨ç‹€æ…‹</label>
                                <label class="toggle-switch"><input type="checkbox" ${isEditing && roomData.status === 'active' ? 'checked' : !isEditing ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="mt-6">
                             <button class="btn-main">å„²å­˜æˆ¿å‹</button>
                        </div>
                    </div>
                `;
                formModal.classList.remove('hidden');
            }


            // --- æ—¥æ›†åŠŸèƒ½ ---
            function openCalendar() {
                calendarModal.classList.remove('hidden');
                renderCalendar();
            }

            function renderCalendar() {
                const content = calendarModal.querySelector('.modal-content');
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h3 class="font-bold">${currentCalendarDate.getFullYear()}å¹´ ${currentCalendarDate.getMonth() + 1}æœˆ</h3>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 text-center text-sm gap-1"></div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="calendar-cancel" class="py-2 px-4 rounded-full bg-gray-200 text-sm">å–æ¶ˆ</button>
                        <button id="calendar-confirm" class="py-2 px-4 rounded-full bg-[#181111] text-white text-sm">ç¢ºå®š</button>
                    </div>`;

                const daysGrid = document.getElementById('calendar-days');
                const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1).getDay();
                const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    daysGrid.innerHTML += `<div></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), i);
                    const today = new Date(); today.setHours(0,0,0,0);
                    let classes = 'calendar-day';
                    if (dayDate < today) classes += ' disabled';
                    if (selectedCheckinDate && dayDate.getTime() === selectedCheckinDate.getTime()) classes += ' range-start';
                    if (selectedCheckoutDate && dayDate.getTime() === selectedCheckoutDate.getTime()) classes += ' range-end';
                    if (selectedCheckinDate && selectedCheckoutDate && dayDate > selectedCheckinDate && dayDate < selectedCheckoutDate) classes += ' in-range';
                    
                    daysGrid.innerHTML += `<div class="${classes}" data-date="${dayDate.toISOString().split('T')[0]}">${i}</div>`;
                }
            }
            
            function handleDateClick(e) {
                if (!e.target.matches('.calendar-day:not(.disabled)')) return;
                const clickedDate = new Date(e.target.dataset.date);
                if (isSelectingCheckin || clickedDate < selectedCheckinDate) {
                    selectedCheckinDate = clickedDate;
                    selectedCheckoutDate = null;
                    isSelectingCheckin = false;
                } else {
                    selectedCheckoutDate = clickedDate;
                    isSelectingCheckin = true;
                }
                renderCalendar();
            }

            function updatePrice() {
                const priceDisplay = document.getElementById('total-price-display');
                if (!priceDisplay) return;

                const selectedPackage = document.querySelector('.package-item.selected');
                if (!selectedPackage) {
                    priceDisplay.textContent = 'è«‹é¸æ“‡æ–¹æ¡ˆ';
                    return;
                }

                let total = 0;
                const packageType = selectedPackage.dataset.packageType;
                const basePrice = parseInt(selectedPackage.dataset.price);
                
                if (packageType === 'overnight') {
                    // å¯„å®¿æ–¹æ¡ˆï¼šæ ¹æ“šä½å®¿å¤©æ•¸è¨ˆç®—
                    if (selectedCheckinDate && selectedCheckoutDate && selectedCheckoutDate > selectedCheckinDate) {
                        const nights = Math.ceil((selectedCheckoutDate - selectedCheckinDate) / (1000 * 60 * 60 * 24));
                        total = basePrice * nights;
                    } else {
                        priceDisplay.textContent = 'è«‹é¸æ“‡æœ‰æ•ˆæ—¥æœŸ';
                        return;
                    }
                } else if (packageType === 'daycare') {
                    // æ—¥é–“å®‰è¦ªæ–¹æ¡ˆï¼šæª¢æŸ¥æ˜¯å¦å·²é¸æ“‡æ™‚æ®µ
                    const selectedTimeSlot = document.querySelector('.time-slot-btn.selected');
                    if (!selectedTimeSlot) {
                        priceDisplay.textContent = 'è«‹é¸æ“‡æ™‚æ®µ';
                        return;
                    }
                    // æ—¥é–“å®‰è¦ªæ–¹æ¡ˆï¼šå–®æ¬¡è¨ˆè²»
                    total = basePrice;
                }
                
                const petCount = parseInt(document.getElementById('pet-count').value);
                total *= petCount;

                document.querySelectorAll('.addon-service:checked').forEach(cb => {
                    total += parseInt(cb.dataset.price);
                });

                priceDisplay.textContent = `ç¸½è¨ˆ: NT$ ${total.toLocaleString()}`;
            }
            
            // æª¢æŸ¥æŒ‡å®šæ—¥æœŸç¯„åœå…§çš„æˆ¿é–“åº«å­˜
            function checkRoomAvailability(roomId, startDate, endDate) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                if (!room || room.status !== 'active') return 0;
                
                // è¨ˆç®—è©²æ—¥æœŸç¯„åœå…§çš„é è¨‚æ•¸é‡
                const conflictingBookings = mockBookings.filter(booking => {
                    if (booking.roomId !== roomId) return false;
                    
                    const bookingStart = new Date(booking.startDate);
                    const bookingEnd = new Date(booking.endDate);
                    const checkStart = new Date(startDate);
                    const checkEnd = new Date(endDate);
                    
                    // æª¢æŸ¥æ—¥æœŸé‡ç–Š
                    return (bookingStart <= checkEnd && bookingEnd >= checkStart);
                });
                
                const usedCapacity = conflictingBookings.length;
                return Math.max(0, room.stock - usedCapacity);
            }
            
            // æ¸²æŸ“æˆ¿å‹é¸é …
            function renderRoomOptions() {
                const container = document.getElementById('room-options-container');
                if (!container) return;
                
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                const startDate = selectedCheckinDate ? selectedCheckinDate.toISOString().split('T')[0] : today.toISOString().split('T')[0];
                const endDate = selectedCheckoutDate ? selectedCheckoutDate.toISOString().split('T')[0] : tomorrow.toISOString().split('T')[0];
                
                let roomOptionsHTML = '';
                
                // æ ¹æ“šå‡è³‡æ–™æ¸²æŸ“æˆ¿å‹èˆ‡æ–¹æ¡ˆ
                const roomConfigs = [
                    { 
                        name: 'æ¨™æº–æˆ¿ (å°å‹çŠ¬)', 
                        roomId: 1, 
                        description: 'èˆ’é©çš„æ¨™æº–æˆ¿ï¼Œé©åˆä¸­å°å‹çŠ¬',
                        packages: [
                            { name: 'æ—¥ç§Ÿæ–¹æ¡ˆ', price: 800, type: 'overnight' },
                            { 
                                name: 'å®‰è¦ªæ–¹æ¡ˆA', 
                                price: 150, 
                                type: 'daycare', 
                                duration: 4,
                                timeSlots: [
                                    { time: '09:00-13:00', available: true },
                                    { time: '14:00-18:00', available: true }
                                ]
                            },
                            { 
                                name: 'å®‰è¦ªæ–¹æ¡ˆB', 
                                price: 120, 
                                type: 'daycare', 
                                duration: 8,
                                timeSlots: [
                                    { time: '09:00-17:00', available: true },
                                    { time: '10:00-18:00', available: false }
                                ]
                            }
                        ]
                    },
                    { 
                        name: 'è±ªè¯å¥—æˆ¿ (ä¸­å¤§å‹çŠ¬)', 
                        roomId: 2, 
                        description: 'å¯¬æ•çš„è±ªè¯å¥—æˆ¿ï¼Œé©åˆä¸­å¤§å‹çŠ¬',
                        packages: [
                            { name: 'æ—¥ç§Ÿæ–¹æ¡ˆ', price: 1500, type: 'overnight' }
                        ]
                    },
                    { 
                        name: 'è²“å’ªå°ˆå±¬ç©ºé–“', 
                        roomId: 3, 
                        description: 'å°ˆç‚ºè²“å’ªè¨­è¨ˆçš„èˆ’é©ç©ºé–“',
                        packages: [
                            { name: 'æ—¥ç§Ÿæ–¹æ¡ˆ', price: 700, type: 'overnight' }
                        ]
                    },
                    { 
                        name: 'é™½å…‰è±ªè¯é›™äººæˆ¿', 
                        roomId: 4, 
                        description: 'é™„æœ‰é™½å°çš„é›™å¯µç‰©è±ªè¯æˆ¿',
                        packages: [
                            { name: 'æ—¥ç§Ÿæ–¹æ¡ˆ', price: 1200, type: 'overnight' }
                        ]
                    }
                ];
                
                roomConfigs.forEach((config, roomIndex) => {
                    const availableStock = checkRoomAvailability(config.roomId, startDate, endDate);
                    const isAvailable = availableStock > 0;
                    const isFirstRoom = roomIndex === 0;
                    
                    roomOptionsHTML += `
                        <div class="p-3 rounded-lg border-2 border-transparent ${!isAvailable ? 'unavailable' : ''}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-sm ${!isAvailable ? 'text-gray-400' : 'text-[#181111]'}">${config.name}</p>
                                    <p class="text-xs text-gray-500 mt-1">${config.description}</p>
                                    ${!isAvailable ? '<p class="text-xs text-red-500 mt-1">âŒ å·²æ»¿æˆ¿</p>' : `<p class="text-xs text-green-600 mt-1">âœ… å¯è¨‚æˆ¿ (å‰©é¤˜ ${availableStock} é–“)</p>`}
                                </div>
                            </div>
                            <div class="space-y-2 mt-2">
                                ${config.packages.map((pkg, pkgIndex) => {
                                    const isFirstPackage = isFirstRoom && pkgIndex === 0;
                                    const packageId = `package-${config.roomId}-${pkgIndex}`;
                                    let priceUnit = '';
                                    if (pkg.type === 'overnight') {
                                        priceUnit = '/ æ™š';
                                    } else if (pkg.type === 'daycare' && pkg.duration) {
                                        priceUnit = `/ ${pkg.duration}hr`;
                                    } else {
                                        priceUnit = '/ æ¬¡';
                                    }
                                    
                                    let packageHTML = `
                                        <div class="package-wrapper">
                                            <div class="package-item p-3 rounded-lg ${isAvailable ? 'cursor-pointer' : ''} ${isFirstPackage && isAvailable ? 'selected' : ''}" 
                                                 data-price="${pkg.price}" 
                                                 data-room-id="${config.roomId}"
                                                 data-package-type="${pkg.type}"
                                                 data-package-id="${packageId}"
                                                 ${!isAvailable ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm">${pkg.name}</span>
                                                    <span class="font-bold text-sm">NT$ ${pkg.price.toLocaleString()} ${priceUnit}</span>
                                                </div>
                                            </div>
                                    `;
                                    
                                    // å¦‚æœæ˜¯å®‰è¦ªæ–¹æ¡ˆä¸”æœ‰æ™‚æ®µé¸æ“‡ï¼Œæ·»åŠ æ™‚æ®µé¸æ“‡å€åŸŸ
                                    if (pkg.type === 'daycare' && pkg.timeSlots && isAvailable) {
                                        packageHTML += `
                                            <div class="time-slots-container mt-2 ml-4 hidden" id="timeslots-${packageId}">
                                                <p class="text-xs text-gray-600 mb-2">é¸æ“‡æ™‚æ®µï¼š</p>
                                                <div class="flex flex-wrap gap-2">
                                                    ${pkg.timeSlots.map((slot, slotIndex) => `
                                                        <button class="time-slot-btn px-3 py-1 text-sm rounded-full border transition-all ${slot.available ? 'border-gray-300 hover:border-gray-400 hover:bg-gray-50' : 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed'}" 
                                                                data-package-id="${packageId}"
                                                                data-slot-time="${slot.time}"
                                                                ${!slot.available ? 'disabled' : ''}>
                                                            ${slot.time}
                                                            ${!slot.available ? ' (å·²æ»¿)' : ''}
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    packageHTML += `</div>`;
                                    return packageHTML;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = roomOptionsHTML;
                
                // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
                attachRoomOptionListeners();
            }
            
            // è¨‚æˆ¿æµç¨‹ç›¸é—œè®Šæ•¸
            let bookingStep = 1;
            let bookingData = {
                serviceType: '',
                dates: { checkin: null, checkout: null },
                timeSlot: '',
                roomId: null,
                packageId: null,
                preferredRoomId: null, // ç”¨æˆ¶åå¥½çš„æˆ¿å‹
                petCount: 1,
                addons: [],
                serviceDate: null, // æ—¥é–“å®‰è¦ªçš„æœå‹™æ—¥æœŸ
                selectedPlan: null, // é¸æ“‡çš„æ–¹æ¡ˆ
                planPrice: null, // æ–¹æ¡ˆåƒ¹æ ¼
                checkinDate: null, // å…¥ä½æ—¥æœŸ
                checkoutDate: null, // é€€æˆ¿æ—¥æœŸ
                stayDuration: null, // å…¥ä½å¤©æ•¸
                duration: null, // æ—¥é–“å®‰è¦ªæ™‚é•·
                customPrice: null, // è‡ªè¨‚åƒ¹æ ¼
                timeSlotName: null // æ™‚æ®µåç¨±
            };
            
            // æ¸²æŸ“è¨‚æˆ¿æµç¨‹é é¢
            function renderBookingFlowPage() {
                const container = pages.bookingFlow;
                
                if (bookingStep === 4) {
                    renderConfirmationStep();
                } else {
                    // å¦‚æœå‡ºç¾å…¶ä»–æ­¥é©Ÿï¼Œå›åˆ°è©³æƒ…é 
                    showPage('detail');
                }
            }
            

            
            // æ­¥é©Ÿ2: é¸æ“‡æ—¥æœŸæ™‚é–“
            function renderDateTimeStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- æ¨™é¡Œèˆ‡é€²åº¦ -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">â†</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">é¸æ“‡${isOvernight ? 'æ—¥æœŸ' : 'æ—¥æœŸèˆ‡æ™‚æ®µ'}</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">æ­¥é©Ÿ 1/3</p>
                            </div>
                        </div>
                        
                        <!-- æ—¥æœŸé¸æ“‡ -->
                        <div class="space-y-4 mb-8">
                            ${isOvernight ? `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">å…¥ä½/é€€æˆ¿æ—¥æœŸ</h3>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="booking-checkin" class="form-input-styled text-center flex-1">
                                        <span class="text-gray-400">-</span>
                                        <input type="date" id="booking-checkout" class="form-input-styled text-center flex-1">
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">é¸æ“‡æ—¥æœŸ</h3>
                                    <input type="date" id="booking-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">é¸æ“‡æ™‚æ®µ</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-13:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">ä¸Šåˆæ™‚æ®µ</span>
                                                <span class="text-sm text-gray-500">09:00-13:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="14:00-18:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">ä¸‹åˆæ™‚æ®µ</span>
                                                <span class="text-sm text-gray-500">14:00-18:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-17:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">å…¨æ—¥æ™‚æ®µ</span>
                                                <span class="text-sm text-gray-500">09:00-17:00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                ç¹¼çºŒ
                            </button>
                        </div>
                    </div>
                `;
                
                attachDateTimeListeners();
            }
            
            // ç¶å®šæ—¥æœŸæ™‚é–“é¸æ“‡äº‹ä»¶
            function attachDateTimeListeners() {
                const isOvernight = bookingData.serviceType === 'overnight';
                
                if (isOvernight) {
                    // å¯„å®¿æœå‹™çš„æ—¥æœŸè™•ç†
                    const checkinInput = document.getElementById('booking-checkin');
                    const checkoutInput = document.getElementById('booking-checkout');
                    
                    // è¨­å®šé è¨­æ—¥æœŸ
                    const today = new Date();
                    const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // ç«‹å³æ›´æ–°è³‡æ–™ä¸¦å•Ÿç”¨æŒ‰éˆ•
                    bookingData.dates.checkin = checkinInput.value;
                    bookingData.dates.checkout = checkoutInput.value;
                    enableNextButton();
                    
                    checkinInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        // ç¢ºä¿é€€æˆ¿æ—¥æœŸä¸æ—©æ–¼å…¥ä½æ—¥æœŸ
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            bookingData.dates.checkout = checkoutInput.value;
                        }
                        checkDatesValid();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        bookingData.dates.checkout = this.value;
                        checkDatesValid();
                    });
                    
                } else {
                    // å®‰è¦ªæœå‹™çš„æ—¥æœŸå’Œæ™‚æ®µè™•ç†
                    const dateInput = document.getElementById('booking-date');
                    const today = new Date();
                    dateInput.value = today.toISOString().split('T')[0];
                    bookingData.dates.checkin = dateInput.value;
                    
                    dateInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        checkDatesValid();
                    });
                    
                    // æ™‚æ®µé¸æ“‡
                    document.querySelectorAll('.time-slot-option').forEach(option => {
                        option.addEventListener('click', function() {
                            // ç§»é™¤å…¶ä»–é¸é …çš„é¸ä¸­ç‹€æ…‹
                            document.querySelectorAll('.time-slot-option').forEach(opt => {
                                opt.classList.remove('border-[#181111]', 'bg-gray-50');
                                opt.classList.add('border-gray-200');
                            });
                            
                            // é¸ä¸­ç•¶å‰é¸é …
                            this.classList.remove('border-gray-200');
                            this.classList.add('border-[#181111]', 'bg-gray-50');
                            
                            bookingData.timeSlot = this.dataset.slot;
                            checkDatesValid();
                        });
                    });
                }
                
                function checkDatesValid() {
                    const nextBtn = document.getElementById('next-step-btn');
                    if (isOvernight) {
                        if (bookingData.dates.checkin && bookingData.dates.checkout) {
                            enableNextButton();
                        }
                    } else {
                        if (bookingData.dates.checkin && bookingData.timeSlot) {
                            enableNextButton();
                        }
                    }
                }
                
                function enableNextButton() {
                    const nextBtn = document.getElementById('next-step-btn');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // ç¹¼çºŒæŒ‰éˆ•äº‹ä»¶
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 3;
                        renderBookingFlowPage();
                    }
                });
                
                // è¿”å›æŒ‰éˆ•äº‹ä»¶
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    showPage('detail');
                });
            }
            
            // æ­¥é©Ÿ3: é¸æ“‡æˆ¿å‹
            function renderRoomSelectionStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // æ ¹æ“šæœå‹™é¡å‹éæ¿¾æˆ¿å‹ï¼Œä¸¦æ ¹æ“šç”¨æˆ¶åå¥½æ’åº
                let availableRooms = mockRoomTypes.filter(room => room.status === 'active');
                
                // å¦‚æœç”¨æˆ¶æœ‰åå¥½æˆ¿å‹ï¼Œå„ªå…ˆé¡¯ç¤º
                if (bookingData.preferredRoomId) {
                    availableRooms = availableRooms.sort((a, b) => {
                        if (a.id === bookingData.preferredRoomId) return -1;
                        if (b.id === bookingData.preferredRoomId) return 1;
                        return 0;
                    });
                }
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- æ¨™é¡Œèˆ‡é€²åº¦ -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">â†</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">é¸æ“‡æˆ¿å‹</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">æ­¥é©Ÿ 1/2</p>
                            </div>
                        </div>
                        
                        <!-- é¸æ“‡æ‘˜è¦ -->
                        <div class="bg-blue-50 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-800">
                                <span class="font-medium">${isOvernight ? 'å¯„å®¿éå¤œ' : 'æ—¥é–“å®‰è¦ª'}</span>
                                ${isOvernight ? 
                                    ` â€¢ ${bookingData.dates.checkin} è‡³ ${bookingData.dates.checkout}` :
                                    ` â€¢ ${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                }
                            </p>
                        </div>
                        
                        <!-- æˆ¿å‹é¸æ“‡ -->
                        <div class="space-y-4 mb-8">
                            <h2 class="text-lg font-bold text-[#181111]">é¸æ“‡é©åˆçš„æˆ¿å‹</h2>
                            
                            <div class="space-y-3">
                                ${availableRooms.map(room => {
                                    const startDate = bookingData.dates.checkin;
                                    const endDate = bookingData.dates.checkout || startDate;
                                    const availableStock = checkRoomAvailability(room.id, startDate, endDate);
                                    const isAvailable = availableStock > 0;
                                    
                                    // æ ¹æ“šæœå‹™é¡å‹éæ¿¾æ–¹æ¡ˆ
                                    const packages = mockPackages.filter(pkg => 
                                        pkg.roomId === room.id && 
                                        pkg.status === 'active' && 
                                        pkg.type === bookingData.serviceType
                                    );
                                    
                                    if (packages.length === 0) return ''; // æ²’æœ‰å°æ‡‰æ–¹æ¡ˆå°±ä¸é¡¯ç¤º
                                    
                                    const isPreferred = room.id === bookingData.preferredRoomId;
                                    
                                    return `
                                        <div class="room-selection-card p-4 rounded-xl border-2 ${isPreferred ? 'border-blue-400 bg-blue-50' : 'border-gray-200'} ${isAvailable ? 'cursor-pointer hover:border-[#181111]' : 'opacity-60'} transition-all" 
                                             data-room-id="${room.id}" 
                                             ${!isAvailable ? 'data-unavailable="true"' : ''}>
                                            <div class="flex items-start">
                                                <img src="${room.imageUrl}" alt="${room.name}" class="w-20 h-20 rounded-lg object-cover mr-4">
                                                <div class="flex-1">
                                                    <h3 class="font-bold text-[#181111] mb-1">
                                                        ${room.name}
                                                        ${isPreferred ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full ml-2">æ¨è–¦</span>' : ''}
                                                    </h3>
                                                    <p class="text-sm text-gray-500 mb-2">${room.description}</p>
                                                    ${isAvailable ? 
                                                        `<p class="text-xs text-green-600">âœ… å¯è¨‚æˆ¿ (å‰©é¤˜ ${availableStock} é–“)</p>` :
                                                        `<p class="text-xs text-red-500">âŒ å·²æ»¿æˆ¿</p>`
                                                    }
                                                    <div class="mt-2">
                                                        ${packages.map(pkg => `
                                                            <div class="text-sm">
                                                                <span class="font-medium">${pkg.name}</span>
                                                                <span class="text-[#181111] font-bold ml-2">
                                                                    NT$ ${pkg.basePrice.toLocaleString()} ${pkg.type === 'overnight' ? '/ æ™š' : `/ ${pkg.daycareLengths || '4'}hr`}
                                                                </span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).filter(html => html).join('')}
                            </div>
                        </div>
                        
                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                ç¹¼çºŒ
                            </button>
                        </div>
                    </div>
                `;
                
                attachRoomSelectionListeners();
            }
            
            // ç¶å®šæˆ¿å‹é¸æ“‡äº‹ä»¶
            function attachRoomSelectionListeners() {
                document.querySelectorAll('.room-selection-card').forEach(card => {
                    card.addEventListener('click', function() {
                        if (this.dataset.unavailable === 'true') return;
                        
                        // ç§»é™¤å…¶ä»–å¡ç‰‡çš„é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll('.room-selection-card').forEach(c => {
                            c.classList.remove('border-[#181111]', 'bg-gray-50');
                            c.classList.add('border-gray-200');
                        });
                        
                        // é¸ä¸­ç•¶å‰å¡ç‰‡
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-gray-50');
                        
                        // æ›´æ–°è³‡æ–™
                        bookingData.roomId = parseInt(this.dataset.roomId);
                        
                        // æ‰¾åˆ°å°æ‡‰çš„æ–¹æ¡ˆ
                        const selectedPackage = mockPackages.find(pkg => 
                            pkg.roomId === bookingData.roomId && 
                            pkg.type === bookingData.serviceType && 
                            pkg.status === 'active'
                        );
                        if (selectedPackage) {
                            bookingData.packageId = selectedPackage.id;
                        }
                        
                        // å•Ÿç”¨ç¹¼çºŒæŒ‰éˆ•
                        const nextBtn = document.getElementById('next-step-btn');
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                });
                
                // ç¹¼çºŒæŒ‰éˆ•äº‹ä»¶
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 4;
                        renderBookingFlowPage();
                    }
                });
                
                // è¿”å›æŒ‰éˆ•äº‹ä»¶
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // å¾æˆ¿å‹é¸æ“‡è¿”å›è©³æƒ…é 
                    showPage('detail');
                });
                        }
            
            // æ­¥é©Ÿ4: ç¢ºèªè¨‚å–®
            function renderConfirmationStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // å–å¾—é¸ä¸­çš„æˆ¿å‹å’Œæ–¹æ¡ˆè³‡è¨Š
                const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                const selectedPackage = mockPackages.find(pkg => pkg.id === bookingData.packageId);
                
                // è¨ˆç®—åƒ¹æ ¼
                let basePrice = selectedPackage ? selectedPackage.basePrice : 0;
                let totalPrice = basePrice;
                
                if (isOvernight && bookingData.dates.checkin && bookingData.dates.checkout) {
                    const checkinDate = new Date(bookingData.dates.checkin);
                    const checkoutDate = new Date(bookingData.dates.checkout);
                    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                    totalPrice = basePrice * nights;
                }
                
                totalPrice *= bookingData.petCount;
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">â†</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">ç¢ºèªè¨‚å–®</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">ç¢ºèªæ‚¨çš„é è¨‚è³‡è¨Š</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-8">
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">è¨‚å–®è©³æƒ…</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">æœå‹™é¡å‹</span>
                                        <span class="font-medium">${isOvernight ? 'å¯„å®¿éå¤œ' : 'æ—¥é–“å®‰è¦ª'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">æ—¥æœŸæ™‚é–“</span>
                                        <span class="font-medium">
                                            ${isOvernight ? 
                                                `${bookingData.dates.checkin} è‡³ ${bookingData.dates.checkout}` :
                                                `${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                            }
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">æˆ¿å‹</span>
                                        <span class="font-medium">${selectedRoom ? selectedRoom.name : ''}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">æ–¹æ¡ˆ</span>
                                        <span class="font-medium">${selectedPackage ? selectedPackage.name : ''}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">ä½å®¿å¤©æ•¸</span>
                                            <span class="font-medium">${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} æ™š</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- å¯µç‰©æ•¸é‡å’ŒåŠ è³¼æœå‹™ -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">å…¶ä»–é¸é …</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">å¯µç‰©æ•¸é‡</label>
                                        <div class="flex items-center border-2 border-[#f4f0f0] rounded-full p-1 w-fit">
                                            <button id="decrease-pet-count" class="px-3 py-1 text-lg font-bold">-</button>
                                            <input type="text" id="pet-count" value="${bookingData.petCount}" readonly class="w-10 text-center bg-transparent font-bold">
                                            <button id="increase-pet-count" class="px-3 py-1 text-lg font-bold">+</button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">åŠ è³¼æœå‹™</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">å¯µç‰©æ´—æ¾¡ (NT$ 300)</span>
                                                <input type="checkbox" data-price="300" data-name="å¯µç‰©æ´—æ¾¡" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">å°ˆäººé™ªç© (NT$ 200)</span>
                                                <input type="checkbox" data-price="200" data-name="å°ˆäººé™ªç©" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">ç¾å®¹ä¿®å‰ª (NT$ 400)</span>
                                                <input type="checkbox" data-price="400" data-name="ç¾å®¹ä¿®å‰ª" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="font-bold text-[#181111] mb-3">åƒ¹æ ¼æ˜ç´°</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span>${selectedPackage ? selectedPackage.name : ''}</span>
                                        <span>NT$ ${basePrice.toLocaleString()}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between text-sm text-gray-600">
                                            <span>ä½å®¿å¤©æ•¸</span>
                                            <span>Ã— ${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} æ™š</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>å¯µç‰©æ•¸é‡</span>
                                        <span>Ã— ${bookingData.petCount}</span>
                                    </div>
                                    <div id="addon-prices"></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>ç¸½è¨ˆ</span>
                                        <span id="final-total">NT$ ${totalPrice.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="confirm-booking-btn" class="btn-main w-full">
                                ç¢ºèªé è¨‚
                            </button>
                        </div>
                    </div>
                `;
                
                attachConfirmationListeners();
            }
            
            // ç¶å®šç¢ºèªé é¢äº‹ä»¶
            function attachConfirmationListeners() {
                // å¯µç‰©æ•¸é‡èª¿æ•´
                document.getElementById('decrease-pet-count')?.addEventListener('click', function() {
                    if (bookingData.petCount > 1) {
                        bookingData.petCount--;
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    }
                });
                
                document.getElementById('increase-pet-count')?.addEventListener('click', function() {
                    bookingData.petCount++;
                    updatePriceTransparency();
                    checkCanContinueBooking();
                });
                
                // åŠ è³¼æœå‹™
                document.querySelectorAll('.addon-service').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const price = parseInt(this.dataset.price);
                        const name = this.dataset.name;
                        
                        if (this.checked) {
                            bookingData.addons.push({ name, price });
                        } else {
                            bookingData.addons = bookingData.addons.filter(addon => addon.name !== name);
                        }
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // ç¢ºèªé è¨‚æŒ‰éˆ•
                document.getElementById('confirm-booking-btn')?.addEventListener('click', function() {
                    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                    this.textContent = 'è™•ç†ä¸­...';
                    this.disabled = true;
                    this.classList.add('opacity-50');
                    
                    // æ¨¡æ“¬è™•ç†æ™‚é–“
                    setTimeout(() => {
                        alert('é è¨‚æˆåŠŸï¼æ„Ÿè¬æ‚¨çš„é è¨‚ã€‚');
                        showPage('detail');
                    }, 1500);
                });
                
                // è¿”å›æŒ‰éˆ•äº‹ä»¶  
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // è¿”å›è©³æƒ…é é‡æ–°é¸æ“‡
                    showPage('detail');
                });
            }
            
            // æ›´æ–°ç¢ºèªé é¢çš„é¡¯ç¤º
            function updateConfirmationDisplay() {
                const selectedPackage = mockPackages.find(pkg => pkg.id === bookingData.packageId);
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // æ›´æ–°å¯µç‰©æ•¸é‡é¡¯ç¤º
                const petCountInput = document.getElementById('pet-count');
                if (petCountInput) {
                    petCountInput.value = bookingData.petCount;
                }
                
                // è¨ˆç®—æ–°çš„ç¸½åƒ¹æ ¼
                let basePrice = selectedPackage ? selectedPackage.basePrice : 0;
                let totalPrice = basePrice;
                
                if (isOvernight && bookingData.dates.checkin && bookingData.dates.checkout) {
                    const checkinDate = new Date(bookingData.dates.checkin);
                    const checkoutDate = new Date(bookingData.dates.checkout);
                    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                    totalPrice = basePrice * nights;
                }
                
                totalPrice *= bookingData.petCount;
                
                // åŠ è³¼æœå‹™åƒ¹æ ¼
                const addonTotal = bookingData.addons.reduce((sum, addon) => sum + addon.price, 0);
                totalPrice += addonTotal;
                
                // æ›´æ–°åƒ¹æ ¼é¡¯ç¤º
                const totalElement = document.querySelector('#final-total');
                if (totalElement) {
                    totalElement.textContent = `NT$ ${totalPrice.toLocaleString()}`;
                }
                
                // æ›´æ–°åŠ è³¼æœå‹™é¡¯ç¤º
                const addonPricesElement = document.getElementById('addon-prices');
                if (addonPricesElement) {
                    addonPricesElement.innerHTML = bookingData.addons.map(addon => `
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${addon.name}</span>
                            <span>NT$ ${addon.price.toLocaleString()}</span>
                        </div>
                    `).join('');
                }
            }
            
            function renderCalendarManagementPage() {
                const container = pages.calendarManagement;
                const activeRooms = mockRoomTypes.filter(room => room.status === 'active');
                const selectedRoom = activeRooms.find(r => r.id === currentManagementRoomId) || activeRooms[0];

                
                if (!selectedRoom) {
                    container.innerHTML = `
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-4">
                                <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                                <h1 class="text-xl font-bold text-[#181111]">ç®¡ç†è¡Œäº‹æ›†</h1>
                                <div class="w-8"></div>
                            </div>
                            <div class="text-center text-gray-500 mt-20">
                                <p>æ‚¨é‚„æ²’æœ‰å»ºç«‹ä»»ä½•æˆ¿å‹</p>
                                <button class="btn-main mt-4" onclick="showPage('roomManagement')">å‰å¾€å»ºç«‹æˆ¿å‹</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="p-4">
                        <!-- é é¢æ¨™é¡Œèˆ‡è¿”å›æŒ‰éˆ• -->
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                            <h1 class="text-xl font-bold text-[#181111]">ç®¡ç†è¡Œäº‹æ›†</h1>
                            <div class="w-8"></div>
                        </div>

                        <!-- æˆ¿å‹é¸æ“‡ -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">é¸æ“‡æˆ¿å‹</label>
                            <select id="room-type-select" class="form-input-styled">
                                ${activeRooms.map(room => `
                                    <option value="${room.id}" ${room.id === selectedRoom.id ? 'selected' : ''}>
                                        ${room.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <!-- é¡¯ç¤ºæ¨¡å¼é¸æ“‡ -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">é¡¯ç¤ºæ¨¡å¼</label>
                            <select id="view-mode-select" class="form-input-styled">
                                <option value="monthly" ${managementViewMode === 'monthly' ? 'selected' : ''}>æœˆæ›†æ¨¡å¼</option>
                                <option value="daily" ${managementViewMode === 'daily' ? 'selected' : ''}>æ™‚ç¨‹æ¨¡å¼</option>
                            </select>
                        </div>

                        <!-- æ—¥æ›†å€åŸŸ -->
                        <div id="calendar-container" class="bg-white rounded-xl border border-gray-100 p-4">
                            ${renderCalendarView(null, selectedRoom)}
                        </div>
                    </div>
                `;

                // ç¶å®šäº‹ä»¶ç›£è½å™¨
                attachCalendarManagementListeners();
            }

            function renderCalendarView(selectedPackage, selectedRoom) {
                const currentDate = managementCalendarDate;
                
                if (managementViewMode === 'monthly') {
                    return renderMonthlyCalendar(currentDate, selectedRoom);
                } else {
                    // æ™‚ç¨‹æ¨¡å¼ï¼šå°‹æ‰¾ä¸€å€‹æ—¥é–“å®‰è¦ªæ–¹æ¡ˆä½œç‚ºæ™‚é–“è¨­å®šåƒè€ƒï¼Œå¦‚æœæ²’æœ‰å°±ä½¿ç”¨é è¨­å€¼
                    const roomPackages = mockPackages.filter(p => p.roomId === selectedRoom.id && p.status === 'active');
                    const daycarePackage = roomPackages.find(p => p.type === 'daycare') || {
                        startTime: '09:00',
                        endTime: '18:00',
                        name: 'æ—¥é–“å®‰è¦ª'
                    };
                    return renderWeeklyCalendar(currentDate, daycarePackage, selectedRoom);
                }
            }

            function renderMonthlyCalendar(currentDate, selectedRoom) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-month-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${year}å¹´ ${month + 1}æœˆ</h3>
                            <button id="next-month-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                `;

                // å¡«å……æœˆåˆç©ºç™½
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div class="h-16"></div>';
                }

                // ç”Ÿæˆæ—¥æœŸæ ¼å­
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isPast = date < today;
                    const stockInfo = calculateDailyStock(date, selectedRoom);
                    const stockClass = getStockColorClass(stockInfo.available);
                    
                    calendarHTML += `
                        <div class="calendar-day-cell h-16 border border-gray-200 rounded-lg p-1 cursor-pointer ${isPast ? 'opacity-50' : ''} ${stockClass}" 
                             data-date="${date.toISOString().split('T')[0]}" 
                             data-room-id="${selectedRoom.id}" 
                             data-view-mode="monthly">
                            <div class="text-xs font-medium">${day}</div>
                            <div class="text-xs ${stockInfo.available === 0 ? 'text-red-600' : 'text-gray-600'}">
                                ${stockInfo.available > 0 ? `ç©ºæˆ¿ ${stockInfo.available}` : 'å·²æ»¿'}
                            </div>
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                return calendarHTML;
            }

            function renderWeeklyCalendar(currentDate, selectedPackage, selectedRoom) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // ç”Ÿæˆè©³ç´°æ™‚é–“æ®µ (æ¯15åˆ†é˜ä¸€å€‹æ™‚æ®µ)
                const timeSlots = generateTimeSlots(selectedPackage);
                
                // ç”Ÿæˆæˆ¿é–“åˆ—è¡¨ï¼Œä½¿ç”¨å¯¦éš›çš„æˆ¿é–“åº«å­˜æ•¸é‡
                const rooms = Array.from({length: selectedRoom.stock}, (_, i) => ({
                    id: i + 1,
                    name: `${selectedRoom.name}`,
                    roomNumber: `${i + 1}è™Ÿæˆ¿`,
                    type: selectedRoom.name
                }));

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-day-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${formatDate(currentDate)}</h3>
                            <button id="next-day-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                        <div class="text-sm text-gray-600 text-center">
                            ${selectedRoom.name} (ç¸½è¨ˆ ${selectedRoom.stock} é–“)
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-96">
                        <div class="flex">
                            <!-- æ™‚é–“è»¸ -->
                            <div class="flex-shrink-0 w-16 bg-gray-50 border-r">
                                <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium">æ™‚é–“</div>
                                ${timeSlots.map((slot, index) => `
                                    <div class="h-8 border-b flex items-center justify-center text-xs font-medium text-gray-800" style="min-height: 32px;">
                                        ${slot.startTime}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- æˆ¿é–“åˆ— -->
                            ${rooms.map(room => `
                                <div class="flex-1 border-r min-w-0">
                                    <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium px-1">
                                        <div class="text-center w-full">
                                            <div class="text-xs font-medium">${room.roomNumber}</div>
                                        </div>
                                    </div>
                                    ${generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                return calendarHTML;
            }

            function generateTimeSlots(selectedPackage) {
                const slots = [];
                const startTime = selectedPackage.startTime || '09:00';
                const endTime = selectedPackage.endTime || '18:00';
                
                // è§£æé–‹å§‹å’ŒçµæŸæ™‚é–“
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // ä»¥æ•´é»ç‚ºå–®ä½ç”Ÿæˆæ™‚æ®µ (ä¾‹å¦‚ 9:00-10:00, 10:00-11:00)
                for (let hour = startHour; hour < endHour; hour++) {
                    const startTimeStr = `${hour.toString().padStart(2, '0')}:00`;
                    const endTimeStr = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    
                    slots.push({
                        startTime: startTimeStr,
                        endTime: endTimeStr,
                        display: `${startTimeStr}`,
                        minutes: hour * 60 // æ·»åŠ åˆ†é˜æ•¸ä¾¿æ–¼è¨ˆç®—
                    });
                }
                
                return slots;
            }

            function isPastTime(timeStr) {
                const now = new Date();
                const [hour, min] = timeStr.split(':').map(Number);
                const timeToCheck = new Date();
                timeToCheck.setHours(hour, min, 0, 0);
                return now > timeToCheck;
            }

            function isCurrentTimeSlot(startTime, endTime) {
                const now = new Date();
                const currentHour = now.getHours();
                
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // æª¢æŸ¥ç•¶å‰å°æ™‚æ˜¯å¦åœ¨é€™å€‹æ•´é»æ™‚æ®µå…§
                return currentHour >= startHour && currentHour < endHour;
            }

            function generateRoomTimeline(currentDate, room, timeSlots, selectedPackage, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // ç²å–è©²æˆ¿é–“çš„æ‰€æœ‰é è¨‚
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                let timelineHTML = '';
                let skipSlots = 0; // ç”¨æ–¼è·³éå·²è¢«åˆä½µçš„æ™‚æ®µ
                
                for (let index = 0; index < timeSlots.length; index++) {
                    const slot = timeSlots[index];
                    
                    // å¦‚æœé€™å€‹æ™‚æ®µå·²è¢«å‰é¢çš„é è¨‚åˆä½µï¼Œè·³é
                    if (skipSlots > 0) {
                        skipSlots--;
                        continue;
                    }
                    
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰é è¨‚è¦†è“‹é€™å€‹æ™‚æ®µ
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    if (booking) {
                        // è¨ˆç®—é€™å€‹é è¨‚è·¨è¶Šå¤šå°‘å€‹æ™‚æ®µ
                        const bookingSpan = calculateBookingSpan(booking.timeSlot, timeSlots, index);
                        skipSlots = bookingSpan - 1; // è·³éå¾ŒçºŒçš„æ™‚æ®µ
                        
                        // ç”Ÿæˆè·¨è¶Šå¤šå€‹æ™‚æ®µçš„é è¨‚æ ¼å­
                        timelineHTML += `
                            <td class="border-r border-gray-200 h-10 cursor-pointer relative bg-red-400" 
                                colspan="${bookingSpan}"
                                data-date="${dateStr}"
                                data-time-slot="${booking.timeSlot}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                <div class="text-xs text-white text-center font-medium leading-tight px-1" style="font-size: 10px;">
                                    ${booking.customer}
                                </div>
                                <div class="text-xs text-red-100 text-center leading-tight px-1" style="font-size: 9px;">
                                    ${booking.timeSlot}
                                </div>
                            </td>
                        `;
                    } else {
                        // ç”Ÿæˆç©ºçš„å¯é è¨‚æ ¼å­
                        let cellClass = 'border-r border-gray-200 h-10 cursor-pointer relative bg-green-100 hover:bg-green-200';
                        let cellContent = '<div class="text-xs text-green-700 text-center mt-2" style="font-size: 9px;">å¯é è¨‚</div>';
                        
                        // æ·»åŠ ç•¶å‰æ™‚é–“ç·š
                        if (isCurrentTime) {
                            cellContent += '<div class="absolute inset-0 border-l-4 border-green-500 current-time-line pointer-events-none"></div>';
                            cellContent += '<div class="absolute top-0 left-0 w-1 h-full bg-green-500 current-time-line pointer-events-none"></div>';
                        }
                        
                        timelineHTML += `
                            <td class="${cellClass}"
                                data-date="${dateStr}"
                                data-time-slot="${slot.startTime}-${slot.endTime}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                ${cellContent}
                            </td>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // ç²å–è©²æˆ¿é–“çš„æ‰€æœ‰é è¨‚
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // å‰µå»ºæ™‚æ®µç‹€æ…‹é™£åˆ—
                const slotStates = timeSlots.map((slot, index) => {
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    return {
                        slot,
                        index,
                        isCurrentTime,
                        booking,
                        isBooked: !!booking,
                        processed: false
                    };
                });
                
                let timelineHTML = '';
                
                for (let i = 0; i < slotStates.length; i++) {
                    const currentState = slotStates[i];
                    
                    if (currentState.processed) {
                        continue;
                    }
                    
                    if (currentState.isBooked) {
                        // è™•ç†é è¨‚æ™‚æ®µ
                        const bookingSpan = calculateBookingSpan(currentState.booking.timeSlot, timeSlots, i);
                        
                        // æ¨™è¨˜ç›¸é—œæ™‚æ®µç‚ºå·²è™•ç†
                        for (let j = i; j < i + bookingSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = bookingSpan * 32; // æ¯å€‹æ•´é»æ™‚æ®µ32pxé«˜åº¦
                        
                        timelineHTML += `
                            <div class="border-b bg-red-400 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${currentState.booking.timeSlot}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-white font-medium leading-tight" style="font-size: 10px;">
                                        ${currentState.booking.customer}
                                    </div>
                                    <div class="text-xs text-red-100 leading-tight" style="font-size: 9px;">
                                        ${currentState.booking.timeSlot}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // è™•ç†å¯é è¨‚æ™‚æ®µ - å°‹æ‰¾é€£çºŒçš„å¯é è¨‚æ™‚æ®µ
                        let availableSpan = 1;
                        let hasCurrentTime = currentState.isCurrentTime;
                        
                        // è¨ˆç®—é€£çºŒçš„å¯é è¨‚æ™‚æ®µæ•¸é‡
                        for (let j = i + 1; j < slotStates.length; j++) {
                            if (slotStates[j].isBooked || slotStates[j].processed) {
                                break;
                            }
                            availableSpan++;
                            if (slotStates[j].isCurrentTime) {
                                hasCurrentTime = true;
                            }
                        }
                        
                        // æ¨™è¨˜ç›¸é—œæ™‚æ®µç‚ºå·²è™•ç†
                        for (let j = i; j < i + availableSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = availableSpan * 32; // æ¯å€‹æ•´é»æ™‚æ®µ32pxé«˜åº¦
                        
                        // è¨ˆç®—æ™‚é–“ç¯„åœé¡¯ç¤º
                        const startTime = currentState.slot.startTime;
                        const endTime = timeSlots[i + availableSpan - 1]?.endTime || currentState.slot.endTime;
                        const timeRange = availableSpan > 1 ? `${startTime}-${endTime}` : `${startTime}-${currentState.slot.endTime}`;
                        
                        timelineHTML += `
                            <div class="border-b bg-green-100 hover:bg-green-200 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${timeRange}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-green-700 font-medium" style="font-size: 9px;">
                                        å¯é è¨‚
                                    </div>
                                    ${availableSpan > 2 ? `<div class="text-xs text-green-600 leading-tight" style="font-size: 8px;">${timeRange}</div>` : ''}
                                </div>
                                ${hasCurrentTime ? '<div class="absolute left-0 top-0 w-full h-1 bg-green-500 current-time-line"></div>' : ''}
                            </div>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function getRoomBookings(dateStr, roomId) {
                // æ¨¡æ“¬å¤šå¤©çš„é è¨‚è³‡æ–™ (ä»¥æ•´é»ç‚ºå–®ä½)
                const allBookings = {
                    // ä»Šå¤© - æ¯”è¼ƒæ»¿çš„ä¸€å¤©
                    [getTodayString()]: [
                        { roomId: 1, timeSlot: '09:00-11:00', customer: 'ç‹å°æ˜', pet: 'é»ƒé‡‘çµçŠ¬' },
                        { roomId: 1, timeSlot: '14:00-16:00', customer: 'æå°è¯', pet: 'è‹±çŸ­è²“' },
                        { roomId: 2, timeSlot: '10:00-12:00', customer: 'é™³å¤§åŒ', pet: 'æŸ´çŠ¬' },
                        { roomId: 2, timeSlot: '15:00-17:00', customer: 'å‘¨é›…å©·', pet: 'è²´è³“ç‹—' },
                        { roomId: 3, timeSlot: '09:00-10:00', customer: 'å¼µç¾ç²', pet: 'æ³¢æ–¯è²“' },
                        { roomId: 3, timeSlot: '13:00-15:00', customer: 'åŠ‰å¿—æ˜', pet: 'å“ˆå£«å¥‡' },
                        // 4è™Ÿæˆ¿å’Œ5è™Ÿæˆ¿ç©ºæˆ¿
                    ],
                    // æ˜å¤© - è¼•é¬†çš„ä¸€å¤©
                    [getTomorrowString()]: [
                        { roomId: 1, timeSlot: '10:00-12:00', customer: 'æ—ç¾æƒ ', pet: 'æ‘ºè€³è²“' },
                        { roomId: 3, timeSlot: '14:00-16:00', customer: 'å¼µå¿—å‰', pet: 'æŸ¯åŸºçŠ¬' },
                        // å…¶ä»–æˆ¿é–“ç©ºæˆ¿
                    ],
                    // å¾Œå¤© - å¿™ç¢Œçš„ä¸€å¤©
                    [getDateString(2)]: [
                        { roomId: 1, timeSlot: '09:00-12:00', customer: 'å³é›…ç²', pet: 'å“ˆå£«å¥‡' },
                        { roomId: 1, timeSlot: '15:00-17:00', customer: 'é»ƒå¿—æ˜', pet: 'è²´è³“ç‹—' },
                        { roomId: 2, timeSlot: '09:00-11:00', customer: 'é™³ä½³æ…§', pet: 'æ‹‰å¸ƒæ‹‰å¤š' },
                        { roomId: 2, timeSlot: '13:00-16:00', customer: 'åŠ‰å»ºåœ‹', pet: 'é»ƒé‡‘çµçŠ¬' },
                        { roomId: 3, timeSlot: '10:00-13:00', customer: 'è¨±é›…å©·', pet: 'åšç¾çŠ¬' },
                        { roomId: 4, timeSlot: '11:00-14:00', customer: 'ç‹å¤§æ˜', pet: 'æŸ´çŠ¬' },
                        { roomId: 5, timeSlot: '09:00-11:00', customer: 'æå°èŠ³', pet: 'è‹±çŸ­è²“' },
                        { roomId: 5, timeSlot: '16:00-18:00', customer: 'è”¡å¿—è±ª', pet: 'ç±³å…‹æ–¯' },
                    ],
                    // å¤§å¾Œå¤© - é€±æœ«æ»¿æˆ¿
                    [getDateString(3)]: [
                        { roomId: 1, timeSlot: '09:00-13:00', customer: 'å‘¨ç¾ç²', pet: 'è–©æ‘©è€¶' },
                        { roomId: 1, timeSlot: '14:00-18:00', customer: 'å¼µå®¶è±ª', pet: 'é˜¿æ‹‰æ–¯åŠ ' },
                        { roomId: 2, timeSlot: '09:00-12:00', customer: 'æ—å¿—ç²', pet: 'å‰å¨ƒå¨ƒ' },
                        { roomId: 2, timeSlot: '13:00-17:00', customer: 'ç‹å»ºæ°‘', pet: 'æ³•é¬¥' },
                        { roomId: 3, timeSlot: '09:00-14:00', customer: 'é™³ç¾è¯', pet: 'ç‘ªçˆ¾æ¿Ÿæ–¯' },
                        { roomId: 3, timeSlot: '15:00-18:00', customer: 'åŠ‰å¾·è¯', pet: 'ç´„å…‹å¤' },
                        { roomId: 4, timeSlot: '09:00-15:00', customer: 'è”¡ä¾æ—', pet: 'é‚Šå¢ƒç‰§ç¾ŠçŠ¬' },
                        { roomId: 4, timeSlot: '16:00-18:00', customer: 'éƒ­å¯ŒåŸ', pet: 'å²è³“æ ¼' },
                        { roomId: 5, timeSlot: '09:00-16:00', customer: 'å‘¨æ°å€«', pet: 'å¾·åœ‹ç‰§ç¾ŠçŠ¬' },
                        { roomId: 5, timeSlot: '17:00-18:00', customer: 'æ—ä¿Šå‚‘', pet: 'å¨çˆ¾æ–¯æŸ¯åŸº' },
                    ],
                    // ç¬¬äº”å¤© - æ™®é€šå·¥ä½œæ—¥
                    [getDateString(4)]: [
                        { roomId: 2, timeSlot: '10:00-13:00', customer: 'ä½•ä½³ç²', pet: 'é›ªç´ç‘' },
                        { roomId: 4, timeSlot: '14:00-17:00', customer: 'å‘‚å¿—å‰', pet: 'è¥¿é«˜åœ°ç™½æ¢—' },
                    ],
                };
                
                const dayBookings = allBookings[dateStr] || [];
                return dayBookings.filter(b => b.roomId === roomId).map(b => ({
                    ...b,
                    date: dateStr
                }));
            }
            
            // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—æ—¥æœŸå­—ä¸²
            function getTodayString() {
                return new Date().toISOString().split('T')[0];
            }
            
            function getTomorrowString() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow.toISOString().split('T')[0];
            }
            
            function getDateString(daysFromNow) {
                const date = new Date();
                date.setDate(date.getDate() + daysFromNow);
                return date.toISOString().split('T')[0];
            }

            function calculateBookingSpan(bookingTimeSlot, timeSlots, startIndex) {
                const [bookingStart, bookingEnd] = bookingTimeSlot.split('-');
                const bookingStartMinutes = timeToMinutes(bookingStart);
                const bookingEndMinutes = timeToMinutes(bookingEnd);
                
                let span = 0;
                for (let i = startIndex; i < timeSlots.length; i++) {
                    const slot = timeSlots[i];
                    const slotStartMinutes = timeToMinutes(slot.startTime);
                    const slotEndMinutes = timeToMinutes(slot.endTime);
                    
                    // å¦‚æœæ™‚æ®µèˆ‡é è¨‚æœ‰é‡ç–Šï¼Œå¢åŠ è·¨åº¦
                    if (slotStartMinutes < bookingEndMinutes && slotEndMinutes > bookingStartMinutes) {
                        span++;
                    } else if (slotStartMinutes >= bookingEndMinutes) {
                        // å¦‚æœæ™‚æ®µé–‹å§‹æ™‚é–“å·²ç¶“è¶…éé è¨‚çµæŸæ™‚é–“ï¼Œåœæ­¢è¨ˆç®—
                        break;
                    }
                }
                
                return Math.max(1, span); // è‡³å°‘è·¨è¶Š1å€‹æ™‚æ®µ
            }

            function timeToMinutes(timeStr) {
                const [hour, min] = timeStr.split(':').map(Number);
                return hour * 60 + min;
            }

            function getRoomBookingInfo(date, timeSlot, room, selectedPackage) {
                // æ¨¡æ“¬é è¨‚è³‡æ–™ - æ ¹æ“šæˆ¿é–“IDå’Œæ™‚é–“æ®µç”Ÿæˆä¸€äº›é è¨‚
                const dateStr = date.toISOString().split('T')[0];
                const timeKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                
                // ç²å–æˆ¿é–“é è¨‚
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é è¨‚è¡çª
                const booking = roomBookings.find(b => 
                    isTimeSlotOverlap(b.timeSlot, timeKey)
                );
                
                if (booking) {
                    return {
                        isBooked: true,
                        customerName: booking.customer,
                        petInfo: booking.pet,
                        timeSlot: booking.timeSlot
                    };
                }
                
                return {
                    isBooked: false,
                    customerName: null,
                    petInfo: null,
                    timeSlot: null
                };
            }

            function isTimeSlotOverlap(bookedSlot, checkSlot) {
                // ç°¡åŒ–çš„æ™‚é–“é‡ç–Šæª¢æŸ¥
                const [bookedStart, bookedEnd] = bookedSlot.split('-');
                const [checkStart, checkEnd] = checkSlot.split('-');
                
                const bookedStartMin = timeToMinutes(bookedStart);
                const bookedEndMin = timeToMinutes(bookedEnd);
                const checkStartMin = timeToMinutes(checkStart);
                const checkEndMin = timeToMinutes(checkEnd);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Š
                return !(bookedEndMin <= checkStartMin || bookedStartMin >= checkEndMin);
            }

            function calculateDailyStock(date, room) {
                const totalStock = room.stock;
                const dateStr = date.toISOString().split('T')[0];
                
                // è¨ˆç®—ç•¶å¤©æœ‰é è¨‚çš„æˆ¿é–“æ•¸é‡ï¼ˆæ¯å€‹æˆ¿é–“åªè¦æœ‰ä»»ä½•æ™‚æ®µé è¨‚å°±ç®—ä½”ç”¨ä¸€é–“ï¼‰
                const occupiedRooms = new Set(); // ä½¿ç”¨ Set ä¾†é¿å…é‡è¤‡è¨ˆç®—åŒä¸€æˆ¿é–“
                
                // æª¢æŸ¥æ¯å€‹æˆ¿é–“æ˜¯å¦åœ¨ç•¶å¤©æœ‰ä»»ä½•é è¨‚
                for (let roomNumber = 1; roomNumber <= totalStock; roomNumber++) {
                    const roomBookings = getRoomBookings(dateStr, roomNumber);
                    if (roomBookings.length > 0) {
                        occupiedRooms.add(roomNumber);
                    }
                }
                
                const bookedCount = occupiedRooms.size;
                const available = Math.max(0, totalStock - bookedCount);
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: available
                };
            }

            function calculateHourlyStock(date, timeSlot, room) {
                // æ¨¡æ“¬è¨ˆç®—é‚è¼¯
                const totalStock = room.stock;
                
                // è™•ç†æ–°çš„æ™‚é–“æ®µæ ¼å¼
                let timeSlotKey;
                if (typeof timeSlot === 'object') {
                    timeSlotKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                } else {
                    timeSlotKey = timeSlot;
                }
                
                const bookings = mockBookings.filter(b => 
                    b.roomId === room.id && 
                    new Date(b.startDate).toDateString() === date.toDateString()
                );
                
                // æ ¹æ“šæ™‚é–“æ®µå’Œæ—¥æœŸè¨ˆç®—é è¨‚æ•¸é‡
                const bookedCount = Math.min(bookings.length, Math.floor(Math.random() * 3)); // æ¨¡æ“¬æ™‚æ®µé è¨‚
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: Math.max(0, totalStock - bookedCount)
                };
            }

            function getStockColorClass(available) {
                if (available === 0) return 'bg-red-100';
                if (available <= 2) return 'bg-yellow-100';
                return 'bg-green-100';
            }

            function formatDate(date) {
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }

            function updateCalendarView(isRoomChange = false) {
                const roomId = currentManagementRoomId;
                const selectedRoom = mockRoomTypes.find(r => r.id === roomId);
                const roomPackages = mockPackages.filter(p => p.roomId === roomId && p.status === 'active');
                
                const packageSelect = document.getElementById('package-select');
                let packageId;
                
                if (isRoomChange) {
                    // æˆ¿å‹æ”¹è®Šæ™‚ï¼Œæ›´æ–°æ–¹æ¡ˆé¸æ“‡åˆ—è¡¨ä¸¦é¸æ“‡ç¬¬ä¸€å€‹
                    if (packageSelect) {
                        packageSelect.innerHTML = roomPackages.map(pkg => `
                            <option value="${pkg.id}">${pkg.name}</option>
                        `).join('');
                    }
                    packageId = roomPackages[0]?.id || 0;
                } else {
                    // æ–¹æ¡ˆé¸æ“‡æ”¹è®Šæ™‚ï¼Œç›´æ¥ä½¿ç”¨ç•¶å‰é¸ä¸­çš„æ–¹æ¡ˆ
                    packageId = parseInt(packageSelect?.value || roomPackages[0]?.id || 0);
                }
                
                const selectedPackage = mockPackages.find(p => p.id === packageId);
                
                const calendarContainer = document.getElementById('calendar-container');
                if (calendarContainer) {
                    calendarContainer.innerHTML = renderCalendarView(selectedPackage, selectedRoom);
                }
            }

            function attachCalendarManagementListeners() {
                // æˆ¿å‹é¸æ“‡
                document.getElementById('room-type-select')?.addEventListener('change', function() {
                    currentManagementRoomId = parseInt(this.value);
                    updateCalendarView(true); // å‚³å…¥ true è¡¨ç¤ºæ˜¯æˆ¿å‹æ”¹è®Š
                });

                // é¡¯ç¤ºæ¨¡å¼é¸æ“‡
                document.getElementById('view-mode-select')?.addEventListener('change', function() {
                    managementViewMode = this.value;
                    updateCalendarView(false);
                });

                // æœˆæ›†å°èˆª
                document.getElementById('prev-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() - 1);
                    updateCalendarView(false); // å°èˆªä¸æ”¹è®Šæˆ¿å‹æˆ–æ–¹æ¡ˆ
                });

                document.getElementById('next-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() + 1);
                    updateCalendarView(false); // å°èˆªä¸æ”¹è®Šæˆ¿å‹æˆ–æ–¹æ¡ˆ
                });

                // æ—¥æœŸå°èˆª
                document.getElementById('prev-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() - 1);
                    updateCalendarView(false);
                });

                document.getElementById('next-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() + 1);
                    updateCalendarView(false);
                });

                // æ—¥æœŸ/æ™‚æ®µé»æ“Šäº‹ä»¶
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.calendar-day-cell, td[data-date], div[data-date]')) {
                        const element = e.target.closest('.calendar-day-cell, td[data-date], div[data-date]');
                        const date = element.dataset.date;
                        const roomId = parseInt(element.dataset.roomId);
                        const viewMode = element.dataset.viewMode;
                        const timeSlot = element.dataset.timeSlot;
                        
                        showAvailabilityModal(date, roomId, viewMode, timeSlot);
                    }
                });
            }

            function showAvailabilityModal(date, roomId, viewMode, timeSlot) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                const stockInfo = timeSlot ? 
                    calculateHourlyStock(new Date(date), timeSlot, room) :
                    calculateDailyStock(new Date(date), room);
                
                const modalTitle = timeSlot ? 
                    `ç®¡ç† ${formatDate(new Date(date))} ${timeSlot} æ™‚æ®µå¯ç”¨æ€§` :
                    `ç®¡ç† ${formatDate(new Date(date))} æ—¥æœŸå¯ç”¨æ€§`;

                const serviceTypeText = viewMode === 'monthly' ? 'éå¤œå¯„å®¿' : 'æ—¥é–“å®‰è¦ª';

                const modalContent = `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">${modalTitle}</h2>
                            <button id="close-availability-modal" class="text-2xl">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">æœå‹™é¡å‹ï¼š${serviceTypeText}</p>
                                <p class="text-sm text-gray-600">æˆ¿å‹ï¼š${room.name}</p>
                                <p class="text-sm text-gray-600">ç•¶å‰å‰©é¤˜ç©ºæˆ¿</p>
                                <p class="text-lg font-bold text-[#181111]">${stockInfo.available} / ${stockInfo.total}</p>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">æ‰‹å‹•èª¿æ•´å¯ç”¨æ•¸é‡</label>
                                <input type="number" id="manual-stock-input" class="form-input-styled mt-1" 
                                       value="${stockInfo.available}" min="0" max="${stockInfo.total}">
                                <p class="text-xs text-gray-500 mt-1">è¨­å®šç‚º 0 è¡¨ç¤ºå®Œå…¨ä¸å¯é è¨‚</p>
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-[#886364]">è¨­ç‚ºä¸å¯é è¨‚</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="unavailable-toggle" ${stockInfo.available === 0 ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">å‚™è¨» (é¸å¡«)</label>
                                <textarea id="availability-note" class="form-input-styled mt-1 h-20" 
                                          placeholder="ä¾‹å¦‚ï¼šå› æ¶ˆæ¯’é—œé–‰ã€å“¡å·¥ä¸è¶³ç­‰"></textarea>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button id="clear-manual-settings" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-full text-sm">
                                    æ¸…é™¤æ‰‹å‹•è¨­å®š
                                </button>
                                <button id="save-availability" class="flex-1 py-2 px-4 bg-[#181111] text-white rounded-full text-sm">
                                    å„²å­˜
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // å‰µå»ºæ¨¡æ…‹æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content max-w-md w-full">
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);

                // ç¶å®šæ¨¡æ…‹æ¡†äº‹ä»¶
                modal.querySelector('#close-availability-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.querySelector('#unavailable-toggle').addEventListener('change', function() {
                    const stockInput = modal.querySelector('#manual-stock-input');
                    stockInput.value = this.checked ? '0' : stockInfo.available;
                });

                modal.querySelector('#save-availability').addEventListener('click', () => {
                    alert('å¯ç”¨æ€§è¨­å®šå·²å„²å­˜ (æ¨¡æ“¬)');
                    document.body.removeChild(modal);
                });

                modal.querySelector('#clear-manual-settings').addEventListener('click', () => {
                    modal.querySelector('#manual-stock-input').value = stockInfo.available;
                    modal.querySelector('#unavailable-toggle').checked = false;
                    modal.querySelector('#availability-note').value = '';
                });
            }

            // --- äº‹ä»¶ç›£è½å™¨ç¶å®š ---
            function attachBookingModuleListeners() {
                document.getElementById('checkin-date')?.addEventListener('click', openCalendar);
                document.getElementById('checkout-date')?.addEventListener('click', openCalendar);
                document.getElementById('decrease-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    let count = parseInt(input.value);
                    if (count > 1) input.value = count - 1;
                    updatePrice();
                });
                document.getElementById('increase-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    input.value = parseInt(input.value) + 1;
                    updatePrice();
                });
                document.querySelectorAll('.addon-service').forEach(el => el.addEventListener('change', updatePrice));
            }
            
            // ç¶å®šæˆ¿å‹é¸é …äº‹ä»¶ç›£è½å™¨
            function attachRoomOptionListeners() {
                document.querySelectorAll('.package-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // æª¢æŸ¥æ˜¯å¦ç‚ºä¸å¯ç”¨çš„æˆ¿å‹
                        if(this.style.opacity === '0.5' || this.style.pointerEvents === 'none') return;
                        
                        // ç§»é™¤æ‰€æœ‰é¸ä¸­çš„æ–¹æ¡ˆ
                        document.querySelectorAll('.package-item.selected').forEach(p => p.classList.remove('selected'));
                        // éš±è—æ‰€æœ‰æ™‚æ®µé¸æ“‡å€åŸŸ
                        document.querySelectorAll('.time-slots-container').forEach(container => container.classList.add('hidden'));
                        // é‡ç½®æ‰€æœ‰æ™‚æ®µæŒ‰éˆ•ç‹€æ…‹
                        document.querySelectorAll('.time-slot-btn.selected').forEach(btn => btn.classList.remove('selected'));
                        
                        // é¸ä¸­ç•¶å‰æ–¹æ¡ˆ
                        this.classList.add('selected');
                        
                        // å¦‚æœæ˜¯å®‰è¦ªæ–¹æ¡ˆï¼Œé¡¯ç¤ºå°æ‡‰çš„æ™‚æ®µé¸æ“‡
                        const packageType = this.dataset.packageType;
                        const packageId = this.dataset.packageId;
                        if (packageType === 'daycare' && packageId) {
                            const timeSlotsContainer = document.getElementById(`timeslots-${packageId}`);
                            if (timeSlotsContainer) {
                                timeSlotsContainer.classList.remove('hidden');
                            }
                        }
                        
                        updatePrice();
                    });
                });
                
                // ç¶å®šæ™‚æ®µæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶ç´šçš„package-itemé»æ“Šäº‹ä»¶
                        
                        if (this.disabled) return;
                        
                        const packageId = this.dataset.packageId;
                        
                        // ç§»é™¤åŒä¸€æ–¹æ¡ˆä¸‹å…¶ä»–æ™‚æ®µçš„é¸ä¸­ç‹€æ…‹
                        document.querySelectorAll(`.time-slot-btn[data-package-id="${packageId}"].selected`).forEach(otherBtn => {
                            otherBtn.classList.remove('selected');
                        });
                        
                        // é¸ä¸­ç•¶å‰æ™‚æ®µ
                        this.classList.add('selected');
                        
                        updatePrice();
                    });
                });
            }

            document.body.addEventListener('click', function(e) {
                // é é¢åˆ‡æ›
                if (e.target.closest('.nav-item')) showPage(e.target.closest('.nav-item').dataset.page);
                if (e.target.closest('#profile-icon-button')) showPage('account');
                if (e.target.closest('.listing-card')) showPage('detail');
                if (e.target.closest('#chat-icon-button')) showPage('chat');
                // æœå°‹æ¡†
                if (e.target.id === 'home-search-input') showPage('searchResult');
                // æœƒå“¡ä¸­å¿ƒ
                if (e.target.closest('#become-merchant')) {
                    alert('æ„Ÿè¬æ‚¨çš„ç”³è«‹ï¼æ‚¨ç¾åœ¨æ˜¯å•†å®¶äº†ã€‚');
                    isUserMerchant = true;
                    updateUserCenterOptions();
                }
                if (e.target.closest('#merchant-entry')) showPage('merchantDashboard');
                if (e.target.closest('#back-to-dashboard-btn')) showPage('merchantDashboard');
                if (e.target.closest('#manage-rooms-link')) showPage('roomManagement');
                if (e.target.closest('#manage-calendar-btn')) showPage('calendarManagement');
                // æ–°å¢ï¼šå•†å®¶ä¸­å¿ƒå„å…¥å£
                if (e.target.closest('#md-orders')) {
                    alert('è¨‚å–®ç®¡ç†ï¼ˆç¤ºæ„ï¼‰ï¼šé¡¯ç¤ºé¡§å®¢è³‡è¨Šèˆ‡å¯µç‰©éœ€æ±‚');
                }
                if (e.target.closest('#md-occupancy')) {
                    openOccupancyModal();
                }
                if (e.target.closest('#md-finance')) {
                    openFinanceModal();
                }
                if (e.target.closest('#md-reports')) {
                    openReportsModal();
                }
                if (e.target.closest('#md-chat')) {
                    showPage('chat');
                }
                if (e.target.closest('#md-coupons')) {
                    openCouponManageModal();
                }
                if (e.target.closest('#add-new-room-btn')) renderRoomForm();
                if (e.target.closest('.edit-room-btn')) {
                    const roomId = parseInt(e.target.closest('.edit-room-btn').dataset.roomId);
                    renderRoomForm(roomId);
                }
                if (e.target.closest('#cancel-form-btn')) {
                     formModal.classList.add('hidden');
                     if(document.getElementById('package-name')) { // åˆ¤æ–·æ˜¯æ–¹æ¡ˆè¡¨å–®
                        const roomId = parseInt(document.getElementById('save-package-btn').dataset.roomId);
                        showPage('packageManagement', { roomId: roomId });
                     } else {
                        showPage('roomManagement');
                     }
                }

                // è¨‚å–®ç¯©é¸
                if (e.target.closest('.order-filter-btn')) renderOrders(e.target.closest('.order-filter-btn').dataset.filter);
                // æ—¥æ›†
                if (e.target.closest('#prev-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
                if (e.target.closest('#next-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }
                if (e.target.closest('#calendar-cancel')) calendarModal.classList.add('hidden');
                if (e.target.closest('#calendar-confirm')) {
                    const checkinInput = document.getElementById('checkin-date');
                    const checkoutInput = document.getElementById('checkout-date');
                    if(selectedCheckinDate) checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                    if(selectedCheckoutDate) checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
                    updatePrice();
                    calendarModal.classList.add('hidden');
                }
                if (e.target.closest('#calendar-days')) handleDateClick(e);
                // ç®¡ç†è¡Œäº‹æ›† - ç§»é™¤å…¨åŸŸäº‹ä»¶ç›£è½å™¨ï¼Œæ”¹ç”± attachCalendarManagementListeners è™•ç†
                // æˆ¿å‹è¡¨å–®ä¸­çš„å¯µç‰©é¡å‹
                if (e.target.matches('input[name="pet-type"][value="dog"]')) {
                    document.getElementById('dog-size-options').classList.toggle('hidden', !e.target.checked);
                }
                // æ–¹æ¡ˆç®¡ç†
                if (e.target.closest('.manage-packages-btn')) {
                    const roomId = parseInt(e.target.closest('.manage-packages-btn').dataset.roomId);
                    showPage('packageManagement', { roomId: roomId });
                }
                if (e.target.closest('#add-new-package-btn')) {
                    const roomId = parseInt(e.target.dataset.roomId);
                    renderPackageForm(roomId, null);
                }
                if (e.target.closest('.edit-package-btn')) {
                    const packageId = parseInt(e.target.dataset.packageId);
                    const roomId = parseInt(e.target.dataset.roomId);
                    renderPackageForm(roomId, packageId);
                }
                if (e.target.closest('#back-to-room-list-btn')) showPage('roomManagement');
                if (e.target.id === 'save-package-btn') {
                    alert('æ–¹æ¡ˆå·²å„²å­˜ (æ¨¡æ“¬)ã€‚');
                    formModal.classList.add('hidden');
                    const roomId = parseInt(e.target.dataset.roomId);
                    showPage('packageManagement', { roomId: roomId });
                }
            });

            // --- åˆå§‹åŒ– ---
            showPage('home');
            
            // è¨­å®šå…¥ä½/é€€æˆ¿æ—¥æœŸé è¨­ç‚ºä»Šå¤©
            const today = new Date();
            selectedCheckinDate = today;
            selectedCheckoutDate = new Date(today.getTime() + (24 * 60 * 60 * 1000)); // æ˜å¤©
            
            // æ›´æ–°æ—¥æœŸè¼¸å…¥æ¡†é¡¯ç¤º
            const checkinInput = document.getElementById('checkin-date');
            const checkoutInput = document.getElementById('checkout-date');
            if(checkinInput && checkoutInput) {
                checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
            }

            // Leaflet åœ°åœ–ç„¡éœ€å…¨å±€å›èª¿ï¼Œç›´æ¥åœ¨é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        });
    </script>
</body>
</html>
