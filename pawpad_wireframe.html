<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paw Pad App</title>
    <!-- 引入新設計的字體 -->
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800" />
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Leaflet 地圖 (免費替代方案) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* 匹配新設計的基礎樣式 */
        body {
            font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
            background-color: #f0f2f5; /* 整體背景色 */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
        }

        .phone-mockup {
            width: 375px;
            min-height: 667px;
            background-color: #fff;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* 為底部導航預留空間 */
            position: relative; /* 為訂房流程的absolute定位提供參考 */
        }

        /* 隱藏滾動條 */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* 新設計風格的按鈕 */
        .btn-main {
             display: flex;
             cursor: pointer;
             align-items: center;
             justify-content: center;
             overflow: hidden;
             border-radius: 9999px; /* rounded-full */
             height: 48px; /* h-12 */
             padding-left: 24px; /* px-6 */
             padding-right: 24px;
             background-color: #181111;
             color: #ffffff;
             font-size: 1rem; /* text-base */
             font-weight: 700; /* font-bold */
             line-height: 1.5; /* leading-normal */
             border: none;
             width: 100%;
        }
        .btn-main:hover {
            background-color: #333;
        }
        
        /* 表單輸入框樣式 */
        .form-input-styled {
            width: 100%;
            border-radius: 0.5rem; /* rounded-lg */
            color: #181111;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            padding: 0.75rem;
            font-size: 1rem;
        }
        .form-input-styled:focus {
            outline: none;
            box-shadow: 0 0 0 2px #181111;
            border-color: #181111;
        }
        
        /* 卡片樣式 */
        .listing-card {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            gap: 1rem; /* gap-4 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            border: 1px solid #f4f0f0;
            background-color: #fff;
        }
        
        .listing-card .info-section {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* gap-4 */
            flex: 2 1 0%;
        }
        
        .listing-card .image-section {
            width: 100%;
            background-position: center;
            background-repeat: no-repeat;
            aspect-ratio: 1 / 1;
            background-size: cover;
            border-radius: 0.75rem; /* rounded-xl */
            flex: 1.5 1 0%;
        }
        
        /* 底部導航項目 */
        .nav-item .icon-wrapper { color: #886364; }
        .nav-item p { color: #886364; }
        .nav-item.active .icon-wrapper { color: #181111; }
        .nav-item.active p { color: #181111; }

        /* 模態框樣式 */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content {
            background: #fff; padding: 20px; border-radius: 15px; width: 90%; max-width: 360px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .calendar-day {
            padding: 8px 0; border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s;
        }
        .calendar-day.selected { background-color: #181111; color: #fff; }
        .calendar-day.in-range { background-color: #e5e7eb; color: #181111; border-radius: 0; }
        .calendar-day.range-start { background-color: #181111; color: #fff; border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .calendar-day.range-end { background-color: #181111; color: #fff; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        
        /* 服務類型切換 */
        .service-type-toggle button {
            transition: all 0.2s ease-in-out;
        }
        .service-type-toggle button.active {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: #181111;
        }
        .service-type-toggle button:not(.active) {
            color: #886364;
        }
        
        /* 方案樣式 */
        .package-item {
            border: 2px solid #f4f0f0;
            transition: all 0.2s ease-in-out;
        }
        .package-item.selected {
            border-color: #181111;
            background-color: #f9fafb;
        }
        .package-item.unavailable {
            opacity: 0.5;
            background-color: #f9fafb;
            cursor: not-allowed;
        }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #181111; }
        input:checked + .toggle-slider:before { transform: translateX(22px); }
        
        /* 時間滑桿樣式 */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #e5e7eb;
            outline: none;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .slider:hover {
            background: #d1d5db;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #181111;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .slider::-moz-range-thumb:hover {
            background: #333;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        /* 時間顯示標籤樣式 */
        #start-time-display {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        #end-time-display {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        /* 管理行事曆樣式 */
        .mgmt-calendar-cell.blocked {
            background-image: repeating-linear-gradient(45deg, #e5e7eb, #e5e7eb 5px, #f9fafb 5px, #f9fafb 10px);
        }

        /* 當前時間線動畫 */
        .current-time-line {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* UI優化：隱藏結束時間滑桿，只保留開始時間選擇 */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }
        
        /* 優化時長顯示區域 */
        #daycare-date-selection .bg-gray-50 {
            background-color: #eff6ff;
            border: 1px solid #dbeafe;
        }

        /* 美化時間選擇區域 */
        #daycare-date-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        #daycare-date-selection .mb-4 {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        #daycare-date-selection .bg-gray-50 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* 確保所有時間滑桿都顯示 - 覆蓋之前的隱藏規則 */
        #daycare-date-selection .mb-4:has(#end-time-slider),
        #daycare-date-selection .mb-4:nth-child(4) {
            display: block !important;
        }

        /* 更強制的顯示規則 */
        #end-time-slider,
        #end-time-display {
            display: block !important;
            visibility: visible !important;
        }
        
        /* 確保結束時間區域顯示 */
        #daycare-date-selection div:has(#end-time-slider) {
            display: block !important;
            opacity: 1 !important;
        }

        /* 設定頁面標籤樣式 */
        .settings-tab-btn {
            background-color: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        
        .settings-tab-btn.active {
            background-color: #181111;
            color: white;
        }
        
        .settings-tab-btn:hover:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .settings-tab-content {
            transition: opacity 0.3s ease;
        }

        /* 日間安親時間選擇優化 */
        .daycare-time-selection {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        /* 確保時段選擇器文字可見 */
        .time-range-selector {
            background: white !important;
            border: 2px solid #e5e7eb !important;
        }
        
        .time-range-selector select {
            color: #181111 !important;
            background: white !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector label {
            color: #374151 !important;
            font-weight: 600 !important;
        }
        
        /* 時段資訊顯示區域 */
        .time-range-selector .bg-white {
            background: #f9fafb !important;
            border: 1px solid #d1d5db !important;
        }
        
        .time-range-selector .bg-white span {
            color: #181111 !important;
        }
        

        
        .preset-time-slots {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .preset-time-slot {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .preset-time-slot:hover {
            border-color: #181111;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .preset-time-slot.selected {
            border-color: #181111;
            background-color: #f9fafb;
            box-shadow: 0 2px 8px rgba(24, 17, 17, 0.15);
        }
        
        .preset-time-slot .time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .time-label {
            font-weight: 600;
            color: #181111;
            font-size: 16px;
        }
        
        .preset-time-slot .price {
            font-weight: 700;
            color: #059669;
            font-size: 18px;
        }
        
        .preset-time-slot .time-detail {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .preset-time-slot .features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .preset-time-slot .feature-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        /* 價格透明度改進 */
        .price-transparency {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .price-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .price-item:last-child {
            border-bottom: none;
        }
        
        .price-item.addon {
            background: #f9fafb;
            margin: 8px -12px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .price-item .item-label {
            color: #374151;
            font-size: 14px;
        }
        
        .price-item .item-detail {
            color: #6b7280;
            font-size: 13px;
        }
        
        .price-item .item-price {
            font-weight: 600;
            color: #181111;
        }
        
        .price-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 2px solid #e5e7eb;
            margin-top: 8px;
        }
        
        .price-total .total-label {
            font-weight: 700;
            color: #181111;
            font-size: 16px;
        }
        
        .price-total .total-price {
            font-weight: 700;
            color: #059669;
            font-size: 20px;
        }
        
        /* 錯誤處理機制優化 */
        .error-handling {
            margin: 16px 0;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        
        .error-message .error-title {
            color: #dc2626;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message .error-list {
            color: #7f1d1d;
            font-size: 13px;
            margin: 0;
            padding-left: 20px;
        }
        
        .error-message .error-list li {
            margin-bottom: 4px;
        }
        
        .validation-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 4px;
        }
        
        .validation-indicator.valid {
            color: #059669;
        }
        
        .validation-indicator.invalid {
            color: #dc2626;
        }
        
        .validation-indicator .icon {
            width: 16px;
            height: 16px;
        }
        
        /* 自訂時段選擇優化 */
        .custom-time-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 16px;
            margin-top: 16px;
        }
        
        .custom-time-toggle {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 16px;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .custom-time-toggle:hover {
            border-color: #181111;
            color: #181111;
        }
        
        .custom-time-toggle.active {
            background: #181111;
            color: white;
            border-color: #181111;
        }
        
        .time-sliders {
            margin-top: 16px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .time-sliders.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="phone-mockup">
        <!-- 主內容區域 -->
        <div id="main-content" class="content-area no-scrollbar">

            <!-- 所有頁面容器 -->
            <div id="home-page" class="page-content"></div>
            <div id="search-result-page" class="page-content hidden"></div>
            <div id="detail-page" class="page-content hidden"></div>
            <div id="favorites-page" class="page-content hidden"></div>
            <div id="orders-page" class="page-content hidden"></div>
            <div id="user-center-page" class="page-content hidden"></div>
            <div id="merchant-dashboard-page" class="page-content hidden"></div>
            <div id="room-management-page" class="page-content hidden"></div>
            <div id="package-management-page" class="page-content hidden"></div>
            <div id="chat-page" class="page-content hidden"></div>
            <div id="calendar-management-page" class="page-content hidden"></div>
            <div id="booking-flow-page" class="page-content hidden"></div>
            <div id="settings-page" class="page-content hidden"></div>
        </div>

        <!-- 全螢幕模態框 (用於新增/編輯) -->
        <div id="form-modal" class="absolute inset-0 bg-gray-50 z-20 hidden page-content no-scrollbar">
            <!-- 內容由JS動態生成 -->
        </div>

        <!-- 日曆 Modal -->
        <div id="calendar-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <!-- 日曆內容由JS生成 -->
            </div>
        </div>

        <!-- 底部導覽列 -->
        <div class="absolute bottom-0 left-0 right-0 z-10">
            <div class="flex gap-2 border-t border-[#f4f0f0] bg-white px-4 pb-3 pt-2">
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="home">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,115.55V208a16,16,0,0,1-16,16H168a16,16,0,0,1-16-16V168a8,8,0,0,0-8-8H112a8,8,0,0,0-8,8v40a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V115.55a16,16,0,0,1,5.17-11.78l80-75.48.11-.11a16,16,0,0,1,21.53,0,1.14,1.14,0,0,0,.11.11l80,75.48A16,16,0,0,1,224,115.55Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">首頁</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="favorites">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,16V161.57l-51.77-32.35a8,8,0,0,0-8.48,0L72,161.56V48Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">我的收藏</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="orders">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,48H48A16,16,0,0,0,32,64V192a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V64A16,16,0,0,0,208,48Zm-40,96H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Zm0-32H88a8,8,0,0,1,0-16h80a8,8,0,0,1,0,16Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">訂單</p>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-end gap-1 cursor-pointer" data-page="account">
                    <div class="icon-wrapper flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg></div>
                    <p class="text-xs font-medium leading-normal tracking-[0.015em]">我的帳戶</p>
                </a>
            </div>
            <div class="h-5 bg-white"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 狀態與資料 ---
            let isUserMerchant = false;
            let currentCalendarDate = new Date();
            let selectedCheckinDate = null;
            let selectedCheckoutDate = null;
            let isSelectingCheckin = true;
            let managementCalendarDate = new Date();
            let currentManagementRoomId = 1;
            let managementViewMode = 'monthly'; // 'monthly' or 'daily'


            const mockOrders = [
                { id: 1, name: '快樂爪子旅館', date: '2025/07/10 - 2025/07/12', pet: '1 犬', total: 1600, status: 'pending' },
                { id: 2, name: '貓語天堂', date: '2025/06/01 - 2025/06/05', pet: '2 貓', total: 3250, status: 'completed' },
                { id: 3, name: '寵物樂園', date: '2025/05/20 - 2025/05/22', pet: '1 犬', total: 1800, status: 'cancelled' },
                { id: 4, name: '汪星人度假村', date: '2025-07-01 - 2025-07-03', pet: '1 犬', total: 2850, status: 'pending' },
                { id: 5, name: '快樂爪子旅館', date: '2025-04-10 - 2025-04-12', pet: '1 貓', total: 1300, status: 'completed' },
            ];
            
            let mockRoomTypes = [
                { id: 1, name: '標準犬房', description: '舒適的標準房，適合中小型犬。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 5, status: 'active' },
                { id: 2, name: '豪華貓別墅', description: '寬敞的豪華別墅，附有貓跳台與獨立通風。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 3, status: 'active' },
                { id: 3, name: '小型寵物寄宿籠', description: '安全舒適的寄宿籠，適合兔子、倉鼠等。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 10, status: 'disabled' },
                { id: 4, name: '陽光豪華雙人房', description: '附有陽台的雙寵物豪華房。', imageUrl: 'https://images.unsplash.com/photo-1573865526739-10659fec78a5?q=80&w=600', stock: 2, status: 'active' }
            ];
            
            let mockPackages = [
                { id: 101, roomId: 1, name: '標準日租方案', description: '提供標準舒適過夜寄宿服務。', type: 'overnight', basePrice: 800, min: 1, max: 30, quota: 3, status: 'active', startDate: '', endDate: '', color: 'bg-blue-400' },
                { id: 102, roomId: 1, name: '安親方案A', description: '日間安親，四小時方案。', type: 'daycare', basePrice: 150, daycareLengths: '4', startTime: '09:00', endTime: '18:00', overtimeRate: 180, quota: 2, status: 'active', startDate: '', endDate: '', color: 'bg-green-400' },
                { id: 103, roomId: 1, name: '安親方案B', description: '日間安親，八小時方案。', type: 'daycare', basePrice: 120, daycareLengths: '8', startTime: '09:00', endTime: '18:00', overtimeRate: 150, quota: 1, status: 'disabled', startDate: '', endDate: '', color: 'bg-yellow-400' },
                { id: 201, roomId: 2, name: '豪華貓別墅日租', description: '專屬豪華空間，貓咪最愛。', type: 'overnight', basePrice: 1500, min: 1, max: 15, quota: 3, status: 'active', startDate: '', endDate: '', color: 'bg-pink-400' },
            ];
            
            let mockBookings = [
                { id: 1, roomId: 1, packageId: 101, customer: '陳先生', startDate: '2025-07-10', endDate: '2025-07-12' },
                { id: 2, roomId: 2, packageId: 201, customer: '林小姐', startDate: '2025-07-15', endDate: '2025-07-18' },
                { id: 3, roomId: 1, packageId: 101, customer: '王小姐', startDate: '2025-07-20', endDate: '2025-07-25' },
                { id: 4, roomId: 1, packageId: 102, customer: '李先生', startDate: '2025-07-05', endDate: '2025-07-05' },
                { id: 5, roomId: 2, packageId: 201, customer: '張太太', startDate: '2025-07-01', endDate: '2025-07-03' },
                { id: 6, roomId: 1, packageId: 102, customer: '吳先生', startDate: '2025-07-14', endDate: '2025-07-14' },
                { id: 7, roomId: 4, customer: '蔡小姐', startDate: '2025-07-22', endDate: '2025-07-23' },
                { id: 8, roomId: 4, customer: '鄭先生', startDate: '2025-07-08', endDate: '2025-07-11' },
                { id: 9, roomId: 1, packageId: 101, customer: '趙小姐', startDate: '2025-07-10', endDate: '2025-07-11' },
                // 新增更多預訂來模擬滿房情況
                { id: 10, roomId: 1, packageId: 101, customer: '劉先生', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 11, roomId: 1, packageId: 101, customer: '黃小姐', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 12, roomId: 1, packageId: 101, customer: '周先生', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 13, roomId: 1, packageId: 101, customer: '吳太太', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 14, roomId: 1, packageId: 101, customer: '林先生', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 15, roomId: 3, packageId: 103, customer: '陳太太', startDate: '2025-01-15', endDate: '2025-01-20' },
                { id: 16, roomId: 3, packageId: 103, customer: '張先生', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 17, roomId: 3, packageId: 103, customer: '李小姐', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 18, roomId: 3, packageId: 103, customer: '王先生', startDate: '2025-01-15', endDate: '2025-01-19' },
                { id: 19, roomId: 3, packageId: 103, customer: '劉太太', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 20, roomId: 3, packageId: 103, customer: '黃先生', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 21, roomId: 3, packageId: 103, customer: '周太太', startDate: '2025-01-15', endDate: '2025-01-18' },
                { id: 22, roomId: 3, packageId: 103, customer: '吳先生', startDate: '2025-01-15', endDate: '2025-01-20' },
                { id: 23, roomId: 3, packageId: 103, customer: '林太太', startDate: '2025-01-15', endDate: '2025-01-16' },
                { id: 24, roomId: 3, packageId: 103, customer: '陳先生', startDate: '2025-01-15', endDate: '2025-01-17' },
                { id: 25, roomId: 3, packageId: 103, customer: '張太太', startDate: '2025-01-15', endDate: '2025-01-19' },
            ];

            // --- 元素選擇 ---
            const navItems = document.querySelectorAll('.nav-item');
            const mainContent = document.getElementById('main-content');
            const pages = {
                home: document.getElementById('home-page'),
                searchResult: document.getElementById('search-result-page'),
                detail: document.getElementById('detail-page'),
                favorites: document.getElementById('favorites-page'),
                orders: document.getElementById('orders-page'),
                account: document.getElementById('user-center-page'),
                chat: document.getElementById('chat-page'),
                merchantDashboard: document.getElementById('merchant-dashboard-page'),
                roomManagement: document.getElementById('room-management-page'),
                packageManagement: document.getElementById('package-management-page'),
                calendarManagement: document.getElementById('calendar-management-page'),
                bookingFlow: document.getElementById('booking-flow-page'),
                settings: document.getElementById('settings-page'),
            };
            const calendarModal = document.getElementById('calendar-modal');
            const formModal = document.getElementById('form-modal');

            // --- 核心功能：頁面切換 ---
            function showPage(pageKey, state = {}) {
                Object.values(pages).forEach(page => page && page.classList.add('hidden'));
                
                const targetPage = pages[pageKey];
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    if (pageKey === 'detail') renderDetailPage(state);
                    if (pageKey === 'orders') renderOrdersPage();
                    if (pageKey === 'account') renderUserCenterPage();
                    if (pageKey === 'merchantDashboard') renderMerchantDashboard();
                    if (pageKey === 'roomManagement') renderRoomListPage();
                    if (pageKey === 'packageManagement') renderPackageListPage(state.roomId);
                    if (pageKey === 'chat') renderChatPage();
                    if (pageKey === 'home') renderHomePage();
                    if (pageKey === 'favorites') renderFavoritesPage();
                    if (pageKey === 'calendarManagement') renderCalendarManagementPage();
                    if (pageKey === 'bookingFlow') renderBookingFlowPage();
                    if (pageKey === 'settings') renderSettingsPage();
                }
                updateNavActiveState(pageKey);
            }

            function updateNavActiveState(activePageKey) {
                navItems.forEach(item => {
                    const page = item.dataset.page;
                    item.classList.toggle('active', page === activePageKey);
                });
            }

            // --- 渲染函式 ---
            function renderHomePage() {
                const container = pages.home;
                container.innerHTML = `
                <!-- 頁首 -->
                <div class="flex items-center bg-white p-4 pb-2 justify-between sticky top-0 z-10 border-b border-gray-100">
                    <div class="flex w-12 items-center justify-start">
                        <button id="chat-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H40A16,16,0,0,0,24,64V224a15.84,15.84,0,0,0,9.37,14.66A16,16,0,0,0,40,240a15.82,15.82,0,0,0,10.63-4.37L82.37,204H216a16,16,0,0,0,16-16V64A16,16,0,0,0,216,48ZM128,144a8,8,0,1,1,8-8A8,8,0,0,1,128,144Zm40,0a8,8,0,1,1,8-8A8,8,0,0,1,168,144ZM88,144a8,8,0,1,1,8-8A8,8,0,0,1,88,144Z"></path></svg>
                        </button>
                    </div>
                    <h2 class="text-[#181111] text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Paw Pad</h2>
                    <div class="flex w-12 items-center justify-end">
                        <button id="profile-icon-button" class="flex cursor-pointer items-center justify-center rounded-full h-12 bg-transparent text-[#181111] min-w-0 p-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"></path></svg>
                        </button>
                    </div>
                </div>
                <!-- 搜尋框 -->
                <div class="px-4 py-3">
                    <div class="flex w-full flex-1 items-stretch rounded-xl h-12">
                        <div class="text-[#886364] flex border-none bg-[#f4f0f0] items-center justify-center pl-4 rounded-l-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                        </div>
                        <input id="home-search-input" placeholder="搜尋地點、寵物旅館或保母..." class="form-input-styled placeholder:text-[#886364] px-4 rounded-l-none pl-2 text-base font-normal leading-normal" />
                    </div>
                </div>
                
                <!-- 廣告橫幅 -->
                <div class="px-4 mb-4">
                    <div class="relative w-full bg-center bg-no-repeat aspect-[2/1] bg-cover rounded-xl flex flex-col justify-end p-4 text-white" style='background-image: linear-gradient(to top, rgba(0,0,0,0.6), transparent), url("https://images.unsplash.com/photo-1552053831-71594a27632d?q=80&w=1000");'>
                         <h3 class="font-bold text-lg">夏日優惠</h3>
                         <p class="text-sm">立即預訂，享 85 折優惠！</p>
                    </div>
                </div>

                <!-- 推薦區塊 -->
                <h2 class="text-[#181111] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-2">推薦給您</h2>
                <div class="px-4 space-y-4">
                    <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.8 • 120 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">快樂爪子旅館</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">台北市 • 接受犬、貓</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$800/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.9 • 150 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">貓語天堂</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">新北市 • 僅接受貓</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$650/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800");'></div>
                    </div>
                     <div class="listing-card cursor-pointer">
                        <div class="info-section">
                            <div class="flex flex-col gap-1">
                                <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.7 • 85 則評價</p>
                                <p class="text-[#181111] text-base font-bold leading-tight">汪星人度假村</p>
                                <p class="text-[#886364] text-sm font-normal leading-normal">台中市 • 僅接受犬</p>
                            </div>
                            <div class="flex min-w-[84px] max-w-[480px] items-center justify-center overflow-hidden rounded-full h-8 px-4 bg-[#f4f0f0] text-[#181111] text-sm font-medium leading-normal w-fit">
                                <span class="truncate">$950/晚 起</span>
                            </div>
                        </div>
                        <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600");'></div>
                    </div>
                </div>
                `;
            }
            
            function renderChatPage() {
                pages.chat.innerHTML = `
                 <h1 class="text-2xl font-bold mb-4 text-center text-[#181111] p-4">訊息中心</h1>
                 <div class="space-y-3 px-4">
                    <!-- 置頂聊天項目 -->
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-200 flex items-center gap-4 cursor-pointer">
                        <div class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg flex-shrink-0">P</div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">Paw Pad 官方客服</p>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full flex-shrink-0">置頂</span>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">歡迎使用！有任何問題隨時與我們聯繫。</p>
                            </div>
                        </div>
                    </div>
                    <!-- 一般聊天項目 -->
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">快樂爪子旅館</p>
                                <p class="text-xs text-[#886364]">昨天</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">好的，您的預訂已確認！</p>
                                <span class="bg-red-500 text-white text-xs w-5 h-5 flex items-center justify-center rounded-full">2</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 flex items-center gap-4 cursor-pointer hover:bg-gray-50">
                        <img src="https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=100" class="w-12 h-12 rounded-full object-cover flex-shrink-0">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <p class="font-bold text-[#181111]">貓語天堂</p>
                                <p class="text-xs text-[#886364]">2天前</p>
                            </div>
                            <div class="flex justify-between items-end mt-1">
                                <p class="text-sm text-[#886364] truncate">不客氣！</p>
                            </div>
                        </div>
                    </div>
                 </div>`;
            }

            function renderDetailPage() {
                pages.detail.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">快樂爪子旅館</h1>
                    <div class="w-full bg-center bg-no-repeat aspect-[4/3] bg-cover rounded-xl" style='background-image: url("https://images.unsplash.com/photo-1548681528-6a5c45b66b42?q=80&w=600");'></div>
                    
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">關於</p>
                         <p class="text-[#886364] text-sm mt-2">提供最溫馨舒適的環境，讓您的寵物如同在家一般自在。我們有專業的照護人員與寬敞的活動空間。</p>
                    </div>

                    <!-- 預訂區塊 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">預訂服務</h2>
                        
                        <!-- 步驟指示器 -->
                        <div class="mb-6">
                            <div class="flex items-center justify-center space-x-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-[#181111] text-white flex items-center justify-center text-sm font-bold">1</div>
                                    <span class="ml-2 text-sm font-medium text-[#181111]">服務類型</span>
                                </div>
                                <div class="w-8 h-1 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold">2</div>
                                    <span class="ml-2 text-sm font-medium text-gray-500">選擇方案</span>
                                </div>
                                <div class="w-8 h-1 bg-gray-300"></div>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center text-sm font-bold">3</div>
                                    <span class="ml-2 text-sm font-medium text-gray-500">選擇時段</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步驟 1: 服務類型選擇 -->
                        <div id="step-1-service-type" class="booking-step">
                            <h3 class="font-medium text-[#181111] mb-4 text-center">請選擇您需要的服務類型</h3>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <button id="select-overnight" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="overnight">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">🏠</div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">寄宿過夜</div>
                                    <div class="text-sm text-gray-600 mb-3">適合出差旅行、度假時使用</div>
                                    <div class="text-xs text-blue-600 font-medium">24小時專業照護</div>
                                </button>
                                <button id="select-daycare" class="service-type-btn p-6 border-2 border-gray-200 rounded-xl text-center hover:border-[#181111] hover:shadow-lg transition-all" data-service="daycare">
                                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">⏰</div>
                                    <div class="font-bold text-[#181111] text-lg mb-2">日間安親</div>
                                    <div class="text-sm text-gray-600 mb-3">上班時間的專業陪伴</div>
                                    <div class="text-xs text-green-600 font-medium">彈性時段選擇</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 步驟 2: 方案選擇 -->
                        <div id="step-2-plan-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇方案</h3>
                                <button id="back-to-service-type" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 寄宿過夜方案 -->
                            <div id="overnight-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="standard" data-price="1200">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">標準套房</div>
                                            <div class="text-sm text-gray-600">舒適單人房，適合小型寵物</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,200</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="deluxe" data-price="1800">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">豪華套房</div>
                                            <div class="text-sm text-gray-600">寬敞雙人房，含獨立陽台</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 1,800</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="premium" data-price="2500">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">頂級套房</div>
                                            <div class="text-sm text-gray-600">總統級待遇，含專屬管家</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 2,500</div>
                                            <div class="text-xs text-gray-500">每晚</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 日間安親方案 -->
                            <div id="daycare-plans" class="space-y-3 hidden">
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="1小時方案" data-price="150">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">1小時方案</div>
                                            <div class="text-sm text-gray-600">基本陪伴與照護服務</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 150</div>
                                            <div class="text-xs text-gray-500">1小時</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="2小時方案" data-price="300">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">2小時方案</div>
                                            <div class="text-sm text-gray-600">含戶外活動與營養餐點</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 300</div>
                                            <div class="text-xs text-gray-500">2小時</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="plan-option p-4 border-2 border-gray-200 rounded-lg hover:border-[#181111] cursor-pointer transition-all" data-plan="4小時方案" data-price="540">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-[#181111]">4小時方案</div>
                                            <div class="text-sm text-gray-600">含洗澡、美容等增值服務</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-green-600">NT$ 540</div>
                                            <div class="text-xs text-gray-500">4小時</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 步驟 3: 時段選擇 -->
                        <div id="step-3-time-selection" class="booking-step hidden">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-medium text-[#181111]">選擇時段</h3>
                                <button id="back-to-plan-selection" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                                    <span class="mr-1">←</span> 返回
                                </button>
                            </div>
                            
                            <!-- 寄宿過夜的日期選擇 -->
                            <div id="overnight-date-selection" class="space-y-4 hidden">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">入住日期</label>
                                        <input type="date" id="detail-checkin-date" class="form-input-styled text-center w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-600 block mb-2 font-medium">退房日期</label>
                                        <input type="date" id="detail-checkout-date" class="form-input-styled text-center w-full">
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg">
                                    <div class="text-sm text-blue-800">
                                        <span class="font-medium">入住天數：</span>
                                        <span id="stay-duration">請選擇日期</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 日間安親的日期+時段選擇 -->
                            <div id="daycare-date-selection" class="space-y-4 hidden">
                                <div class="mb-4">
                                    <label class="text-sm text-gray-600 block mb-2 font-medium">服務日期</label>
                                    <input type="date" id="detail-service-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <!-- 時段選擇 -->
                                <div class="daycare-time-selection">
                                    <h4 class="font-medium text-[#181111] mb-3">選擇服務時段</h4>
                                    
                                    <!-- 自由時段選擇 -->
                                    <div class="flexible-time-selection space-y-4">
                                        <!-- 時段選擇器 -->
                                        <div class="time-range-selector p-4 bg-gray-50 rounded-lg">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">開始時間</label>
                                                    <select id="start-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="8">08:00</option>
                                                        <option value="9">09:00</option>
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-sm text-gray-600 block mb-2 font-medium">結束時間</label>
                                                    <select id="end-time-select" class="w-full p-2 border border-gray-300 rounded-lg focus:border-[#181111] focus:outline-none">
                                                        <option value="10">10:00</option>
                                                        <option value="11">11:00</option>
                                                        <option value="12">12:00</option>
                                                        <option value="13">13:00</option>
                                                        <option value="14">14:00</option>
                                                        <option value="15">15:00</option>
                                                        <option value="16">16:00</option>
                                                        <option value="17">17:00</option>
                                                        <option value="18">18:00</option>
                                                        <option value="19">19:00</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <!-- 方案時長提示 -->
                                            <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                                <div class="text-sm text-blue-800">
                                                    <span class="font-medium">方案時長：</span>
                                                    <span id="plan-duration-hint">請先選擇方案</span>
                                                </div>
                                            </div>
                                            
                                            <!-- 時段資訊顯示 -->
                                            <div class="mt-4 p-3 bg-white rounded-lg border">
                                                <div class="flex justify-between items-center mb-2">
                                                    <span class="text-sm text-gray-600">服務時長</span>
                                                    <span class="font-medium text-[#181111]" id="flexible-duration-display">請選擇時段</span>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm text-gray-600">預估費用</span>
                                                    <span class="font-bold text-green-600" id="flexible-price-display">請選擇時段</span>
                                                </div>
                                            </div>
                                        </div>
                                        

                                        
                                        <!-- 時段可用性檢查 -->
                                        <div class="availability-check mt-4">
                                            <button id="check-availability-btn" class="w-full p-3 bg-[#181111] text-white rounded-lg hover:bg-gray-800 transition-colors">
                                                檢查時段可用性
                                            </button>
                                            <div id="availability-result" class="mt-3 p-3 rounded-lg hidden">
                                                <!-- 可用性結果將在這裡顯示 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 錯誤處理區域 -->
                        <div id="booking-errors" class="error-handling hidden">
                            <!-- 錯誤訊息將在這裡動態生成 -->
                        </div>
                        
                        <!-- 價格透明度改進 -->
                        <div id="price-transparency" class="price-transparency hidden">
                            <h3 class="font-bold text-[#181111] mb-3">價格明細</h3>
                            <div class="price-breakdown">
                                <div class="price-item">
                                    <span class="item-label">房型費用</span>
                                    <span class="item-detail" id="room-price-detail">請選擇房型</span>
                                    <span class="item-price" id="room-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="duration-item" style="display: none;">
                                    <span class="item-label">服務時長</span>
                                    <span class="item-detail" id="duration-detail">請選擇時段</span>
                                    <span class="item-price" id="duration-price">NT$ 0</span>
                                </div>
                                <div class="price-item" id="pet-count-item" style="display: none;">
                                    <span class="item-label">寵物數量</span>
                                    <span class="item-detail" id="pet-count-detail">1 隻</span>
                                    <span class="item-price" id="pet-count-price">× 1</span>
                                </div>
                                <div id="addon-items">
                                    <!-- 加購服務項目將在這裡動態生成 -->
                                </div>
                                <div class="price-total">
                                    <span class="total-label">總計</span>
                                    <span class="total-price" id="total-price">NT$ 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 繼續預訂按鈕 -->
                        <div id="continue-booking-section" class="mt-4 hidden">
                            <button id="continue-booking-btn" class="btn-main w-full h-12 text-base">
                                繼續預訂
                            </button>
                        </div>
                    </div>

                     <div class="p-4 rounded-xl border border-gray-100 bg-white">
                         <p class="text-[#181111] text-lg font-bold">用戶評價</p>
                         <div class="mt-2 space-y-3">
                            <div class="border-b pb-2">
                                <p class="font-bold text-sm">王小明 <span class="text-xs text-gray-500 ml-2">⭐️⭐️⭐️⭐️⭐️</span></p>
                                <p class="text-[#886364] text-sm mt-1">環境很乾淨，狗狗玩得很開心！</p>
                            </div>
                             <div class="border-b pb-2">
                                <p class="font-bold text-sm">陳太太 <span class="text-xs text-gray-500 ml-2">⭐️⭐️⭐️⭐️</span></p>
                                <p class="text-[#886364] text-sm mt-1">貓咪很適應，只是房間隔音可以再加強。</p>
                            </div>
                         </div>
                    </div>

                    <!-- 位置地圖 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-[#181111] text-lg font-bold">位置資訊</p>
                            <button id="open-map-btn" class="text-sm bg-[#181111] text-white px-3 py-1 rounded-full hover:bg-gray-800 transition-colors">
                                導航
                            </button>
                        </div>
                        <div class="mb-3">
                            <p class="text-sm text-[#886364] mb-1">📍 台北市信義區信義路五段7號</p>
                            <p class="text-xs text-gray-500">距離捷運市政府站 5分鐘步行</p>
                        </div>
                        <div id="hotel-map" class="h-48 rounded-lg bg-gray-100 relative overflow-hidden">
                            <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                                <span class="text-sm">載入地圖中...</span>
                            </div>
                            <!-- 地圖交互提示 -->
                            <div id="map-interaction-hint" class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded hidden">
                                點擊地圖啟用交互
                            </div>
                        </div>
                    </div>
                </div>`;
                
                const style = document.createElement('style');
                style.innerHTML = `
                    .daycare-time-btn { padding: 6px 12px; border-radius: 9999px; background-color: #f4f0f0; color: #886364; font-size: 0.875rem; transition: all 0.2s; border:none; }
                    .daycare-time-btn.active { background-color: #181111; color: white; }
                    
                    /* 滿房狀態樣式 */
                    .unavailable {
                        opacity: 0.6;
                        background-color: #f8f9fa;
                    }
                    
                    .unavailable .package-item {
                        background-color: #f1f3f4 !important;
                        border: 1px solid #e0e0e0 !important;
                        cursor: not-allowed !important;
                    }
                    
                    .unavailable .package-item:hover {
                        background-color: #f1f3f4 !important;
                        transform: none !important;
                    }
                    
                    .package-item {
                        transition: all 0.2s ease;
                        border: 1px solid transparent;
                    }
                    
                    .package-item:hover:not([style*="opacity: 0.5"]) {
                        background-color: #f8f9fa;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }
                    
                    .package-item.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .package-item.selected:hover {
                        background-color: #181111 !important;
                        transform: none !important;
                    }
                    
                    /* 時段按鈕樣式 */
                    .time-slot-btn {
                        background-color: #fff;
                        color: #374151;
                    }
                    
                    .time-slot-btn:hover:not(:disabled) {
                        background-color: #f3f4f6;
                        border-color: #6b7280;
                    }
                    
                    .time-slot-btn.selected {
                        background-color: #181111 !important;
                        color: white !important;
                        border-color: #181111 !important;
                    }
                    
                    .time-slot-btn:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    
                    /* 訂房流程樣式 */
                    .service-type-card {
                        transition: all 0.2s ease;
                    }
                    
                    .service-type-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    
                    .time-slot-option {
                        transition: all 0.2s ease;
                    }
                    
                    .time-slot-option:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .room-selection-card {
                        transition: all 0.2s ease;
                    }
                    
                    .room-selection-card:hover:not([data-unavailable="true"]) {
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                `;
                document.head.appendChild(style);

                // 新增服務選擇事件監聽器
                attachDetailPageListeners();
            }

            // 詳情頁面事件監聽器
            function attachDetailPageListeners() {
                initHotelMap();
                attachMapListeners();
                attachDetailDateListeners();
            }

            // 綁定詳情頁日期選擇事件
            function attachDetailDateListeners() {
                // 設定預設日期
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                
                // 更新全域變數
                selectedCheckinDate = today;
                selectedCheckoutDate = tomorrow;
                
                // 綁定服務類型選擇
                attachServiceTypeListeners();
                
                // 設定過夜寄宿的預設日期
                const checkinInput = document.getElementById('detail-checkin-date');
                const checkoutInput = document.getElementById('detail-checkout-date');
                const serviceDateInput = document.getElementById('detail-service-date');
                
                if (checkinInput && checkoutInput) {
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // 設定預設日期後，自動計算入住天數
                    bookingData.checkinDate = today.toISOString().split('T')[0];
                    bookingData.checkoutDate = tomorrow.toISOString().split('T')[0];
                    bookingData.stayDuration = 1; // 預設1晚
                    
                    console.log('預設日期已設定:', { 
                        checkin: bookingData.checkinDate, 
                        checkout: bookingData.checkoutDate, 
                        duration: bookingData.stayDuration 
                    });
                    
                    // 如果有選擇方案，自動更新價格顯示
                    if (bookingData.selectedPlan && bookingData.planPrice) {
                        console.log('檢測到已選擇方案，自動更新價格顯示');
                        updatePriceTransparency();
                    }
                    
                    checkinInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            selectedCheckoutDate = nextDay;
                        }
                        checkCanContinueBooking();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        selectedCheckoutDate = new Date(this.value);
                        checkCanContinueBooking();
                    });
                }
                
                // 設定日間安親的預設日期
                if (serviceDateInput) {
                    serviceDateInput.value = today.toISOString().split('T')[0];
                    serviceDateInput.addEventListener('change', function() {
                        selectedCheckinDate = new Date(this.value);
                        
                        // 重置後續選擇
                        bookingData.duration = '';
                        bookingData.timeSlot = '';
                        bookingData.preferredRoomId = null;
                        
                        // 隱藏房型選項
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) roomServiceList.classList.add('hidden');
                        
                        // 清除時段選擇
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 重置滑桿到預設值
                        const startTimeSlider = document.getElementById('start-time-slider');
                        const endTimeSlider = document.getElementById('end-time-slider');
                        if (startTimeSlider) startTimeSlider.value = 9;
                        if (endTimeSlider) endTimeSlider.value = 13;
                        
                        // 隱藏自訂時段選擇
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // 重置自訂時段按鈕
                        const customToggle = document.querySelector('.custom-time-toggle');
                        if (customToggle) {
                            customToggle.classList.remove('active');
                            customToggle.innerHTML = '<span>自訂時段</span>';
                        }
                        
                        checkCanContinueBooking();
                    });
                }
                
                // 綁定時段選擇
                attachTimeSlotListeners();
                
                // 初始化其他訂房功能
                initializeBookingFunctions();
            }

            // 綁定服務類型選擇事件 - 新的三步驟流程
            function attachServiceTypeListeners() {
                const overnightBtn = document.getElementById('select-overnight');
                const daycareBtn = document.getElementById('select-daycare');
                
                overnightBtn?.addEventListener('click', function() {
                    console.log('寄宿過夜按鈕被點擊');
                    
                    // 簡單測試：直接切換步驟
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    console.log('找到的元素:', { step1, step2 });
                    
                    if (step1 && step2) {
                        // 隱藏步驟1
                        step1.style.display = 'none';
                        console.log('步驟1已隱藏');
                        
                        // 顯示步驟2
                        step2.style.display = 'block';
                        console.log('步驟2已顯示');
                        
                        // 顯示寄宿過夜方案
                        const overnightPlans = document.getElementById('overnight-plans');
                        const daycarePlans = document.getElementById('daycare-plans');
                        
                        if (overnightPlans && daycarePlans) {
                            overnightPlans.style.display = 'block';
                            daycarePlans.style.display = 'none';
                            console.log('方案顯示切換完成');
                        }
                        
                        // 更新預訂資料
                        bookingData.serviceType = 'overnight';
                        console.log('預訂資料已更新:', bookingData);
                    } else {
                        console.error('找不到步驟元素');
                    }
                });
                
                daycareBtn?.addEventListener('click', function() {
                    console.log('日間安親按鈕被點擊');
                    
                    // 簡單測試：直接切換步驟
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    console.log('找到的元素:', { step1, step2 });
                    
                    if (step1 && step2) {
                        // 隱藏步驟1
                        step1.style.display = 'none';
                        console.log('步驟1已隱藏');
                        
                        // 顯示步驟2
                        step2.style.display = 'block';
                        console.log('步驟2已顯示');
                        
                        // 顯示日間安親方案
                        const daycarePlans = document.getElementById('daycare-plans');
                        const overnightPlans = document.getElementById('overnight-plans');
                        
                        if (daycarePlans && overnightPlans) {
                            daycarePlans.style.display = 'block';
                            overnightPlans.style.display = 'none';
                            console.log('方案顯示切換完成');
                        }
                        
                        // 更新預訂資料
                        bookingData.serviceType = 'daycare';
                        console.log('預訂資料已更新:', bookingData);
                    } else {
                        console.error('找不到步驟元素');
                    }
                });
            }
            
            // 更新步驟指示器
            function updateStepIndicator(currentStep) {
                console.log('更新步驟指示器到步驟:', currentStep);
                
                // 修正選擇器：找到步驟指示器容器下的每個步驟
                const stepIndicators = document.querySelectorAll('.mb-6 .flex.items-center.justify-center.space-x-2 > .flex.items-center');
                console.log('找到步驟指示器:', stepIndicators.length);
                
                stepIndicators.forEach((indicator, index) => {
                    const stepNumber = indicator.querySelector('.w-8.h-8');
                    const stepText = indicator.querySelector('span');
                    
                    console.log(`步驟 ${index + 1}:`, { stepNumber, stepText });
                    
                    if (index + 1 < currentStep) {
                        // 已完成的步驟
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else if (index + 1 === currentStep) {
                        // 當前步驟
                        stepNumber.classList.remove('bg-gray-300', 'text-gray-600');
                        stepNumber.classList.add('bg-[#181111]', 'text-white');
                        stepText.classList.remove('text-gray-500');
                        stepText.classList.add('text-[#181111]');
                    } else {
                        // 未完成的步驟
                        stepNumber.classList.remove('bg-[#181111]', 'text-white');
                        stepNumber.classList.add('bg-gray-300', 'text-gray-600');
                        stepText.classList.remove('text-[#181111]');
                        stepText.classList.add('text-gray-500');
                    }
                });
                
                // 更新連接線
                const connectors = document.querySelectorAll('.mb-6 .flex.items-center.justify-center.space-x-2 > .w-8.h-1');
                console.log('找到連接線:', connectors.length);
                
                connectors.forEach((connector, index) => {
                    if (index + 1 < currentStep) {
                        connector.classList.remove('bg-gray-300');
                        connector.classList.add('bg-[#181111]');
                    } else {
                        connector.classList.remove('bg-[#181111]');
                        connector.classList.add('bg-gray-300');
                    }
                });
                
                console.log('步驟指示器更新完成');
            }
            
            // 綁定方案選擇事件 - 新的三步驟流程
            function attachPlanSelectionListeners() {
                // 綁定返回按鈕
                document.getElementById('back-to-service-type')?.addEventListener('click', function() {
                    console.log('返回按鈕被點擊');
                    
                    // 返回步驟1
                    const step1 = document.getElementById('step-1-service-type');
                    const step2 = document.getElementById('step-2-plan-selection');
                    
                    if (step1 && step2) {
                        // 隱藏步驟2
                        step2.style.display = 'none';
                        console.log('步驟2已隱藏');
                        
                        // 顯示步驟1
                        step1.style.display = 'block';
                        console.log('步驟1已顯示');
                        
                        // 重置方案選擇狀態
                        document.querySelectorAll('.plan-option').forEach(option => {
                            option.classList.remove('border-[#181111]', 'bg-blue-50');
                            option.classList.add('border-gray-200');
                        });
                        
                        console.log('方案選擇狀態已重置');
                    } else {
                        console.error('找不到步驟元素');
                    }
                });
                
                // 綁定方案選項點擊事件
                document.querySelectorAll('.plan-option').forEach(option => {
                    option.addEventListener('click', function() {
                        console.log('方案被選擇:', this.dataset.plan);
                        
                        // 移除其他方案的選中狀態
                        document.querySelectorAll('.plan-option').forEach(opt => {
                            opt.classList.remove('border-[#181111]', 'bg-blue-50');
                            opt.classList.add('border-gray-200');
                        });
                        
                        // 選中當前方案
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-blue-50');
                        
                        // 更新預訂資料
                        const plan = this.dataset.plan;
                        const price = parseInt(this.dataset.price);
                        bookingData.selectedPlan = plan;
                        bookingData.planPrice = price;
                        
                        console.log('預訂資料已更新:', { plan, price });
                        
                        // 如果是日間安親，更新時段選擇
                        if (bookingData.serviceType === 'daycare') {
                            // 更新方案時長提示
                            if (window.updateDaycarePlanDuration) {
                                window.updateDaycarePlanDuration();
                            }
                            // 更新結束時間選項
                            const startTimeSelect = document.getElementById('start-time-select');
                            if (startTimeSelect) {
                                startTimeSelect.dispatchEvent(new Event('change'));
                            }
                        }
                        
                        // 立即更新價格顯示（如果有預設日期）
                        if (bookingData.checkinDate && bookingData.checkoutDate) {
                            console.log('檢測到預設日期，立即更新價格顯示');
                            updatePriceTransparency();
                        }
                        
                        // 延遲一下再進入下一步，讓使用者看到選中效果
                        setTimeout(() => {
                            // 進入步驟3
                            const step2 = document.getElementById('step-2-plan-selection');
                            const step3 = document.getElementById('step-3-time-selection');
                            
                            if (step2 && step3) {
                                // 隱藏步驟2
                                step2.style.display = 'none';
                                console.log('步驟2已隱藏');
                                
                                // 顯示步驟3
                                step3.style.display = 'block';
                                console.log('步驟3已顯示');
                                
                                // 根據服務類型顯示對應的時段選擇
                                if (bookingData.serviceType === 'overnight') {
                                    const overnightDateSelection = document.getElementById('overnight-date-selection');
                                    const daycareDateSelection = document.getElementById('daycare-date-selection');
                                    
                                    if (overnightDateSelection && daycareDateSelection) {
                                        overnightDateSelection.style.display = 'block';
                                        daycareDateSelection.style.display = 'none';
                                        console.log('寄宿過夜日期選擇已顯示');
                                    }
                                } else {
                                    const daycareDateSelection = document.getElementById('daycare-date-selection');
                                    const overnightDateSelection = document.getElementById('overnight-date-selection');
                                    
                                    if (daycareDateSelection && overnightDateSelection) {
                                        daycareDateSelection.style.display = 'block';
                                        overnightDateSelection.style.display = 'none';
                                        console.log('日間安親日期選擇已顯示');
                                    }
                                }
                            } else {
                                console.error('找不到步驟3元素');
                            }
                        }, 300);
                    });
                });
            }
            
            // 綁定時段選擇事件 - 新的三步驟流程
            function attachTimeSelectionListeners() {
                // 綁定返回按鈕
                document.getElementById('back-to-plan-selection')?.addEventListener('click', function() {
                    console.log('返回方案選擇按鈕被點擊');
                    
                    // 返回步驟2
                    const step2 = document.getElementById('step-2-plan-selection');
                    const step3 = document.getElementById('step-3-time-selection');
                    
                    if (step2 && step3) {
                        // 隱藏步驟3
                        step3.style.display = 'none';
                        console.log('步驟3已隱藏');
                        
                        // 顯示步驟2
                        step2.style.display = 'block';
                        console.log('步驟2已顯示');
                        
                        // 重置時段選擇狀態
                        if (bookingData.serviceType === 'overnight') {
                            const checkinDate = document.getElementById('detail-checkin-date');
                            const checkoutDate = document.getElementById('detail-checkout-date');
                            const stayDuration = document.getElementById('stay-duration');
                            
                            if (checkinDate && checkoutDate && stayDuration) {
                                checkinDate.value = '';
                                checkoutDate.value = '';
                                stayDuration.textContent = '請選擇日期';
                                console.log('寄宿過夜日期選擇已重置');
                            }
                        } else {
                            const serviceDate = document.getElementById('detail-service-date');
                            if (serviceDate) {
                                serviceDate.value = '';
                                console.log('日間安親日期已重置');
                            }
                            
                            document.querySelectorAll('.preset-time-slot').forEach(slot => {
                                slot.classList.remove('border-[#181111]', 'bg-blue-50');
                                slot.classList.add('border-gray-200');
                            });
                            console.log('時段選擇狀態已重置');
                        }
                    } else {
                        console.error('找不到步驟元素');
                    }
                });
                
                // 綁定寄宿過夜的日期選擇
                const checkinDate = document.getElementById('detail-checkin-date');
                const checkoutDate = document.getElementById('detail-checkout-date');
                
                if (checkinDate && checkoutDate) {
                    checkinDate.addEventListener('change', updateStayDuration);
                    checkoutDate.addEventListener('change', updateStayDuration);
                }
                
                // 綁定日間安親的時段選擇
                bindFlexibleTimeSelection();
                
                // 綁定可用性檢查
                bindAvailabilityCheck();
            }
            
            // 綁定靈活時段選擇
            function bindFlexibleTimeSelection() {
                console.log('開始綁定靈活時段選擇');
                
                const startTimeSelect = document.getElementById('start-time-select');
                const endTimeSelect = document.getElementById('end-time-select');
                const durationDisplay = document.getElementById('flexible-duration-display');
                const priceDisplay = document.getElementById('flexible-price-display');
                const serviceDateInput = document.getElementById('detail-service-date');
                const planDurationHint = document.getElementById('plan-duration-hint');
                
                console.log('找到的元素:', { startTimeSelect, endTimeSelect, durationDisplay, priceDisplay, serviceDateInput, planDurationHint });
                
                if (startTimeSelect && endTimeSelect) {
                    // 設定預設值
                    startTimeSelect.value = '8';
                    endTimeSelect.value = '9';
                    
                    // 設定預設服務日期為今天
                    if (serviceDateInput) {
                        const today = new Date();
                        serviceDateInput.value = today.toISOString().split('T')[0];
                        bookingData.serviceDate = today.toISOString().split('T')[0];
                        console.log('服務日期已設定為:', serviceDateInput.value);
                    }
                    
                    // 更新方案時長提示
                    updatePlanDurationHint();
                    
                    // 立即更新顯示
                    if (durationDisplay && priceDisplay) {
                        durationDisplay.textContent = '1 小時';
                        priceDisplay.textContent = 'NT$ 150';
                        console.log('預設顯示已更新');
                    }
                    
                    updateFlexibleTimeInfo();
                    
                    // 綁定開始時間變更
                    startTimeSelect.addEventListener('change', function() {
                        updateEndTimeOptions();
                        updateFlexibleTimeInfo();
                    });
                    
                    // 綁定結束時間變更
                    endTimeSelect.addEventListener('change', function() {
                        updateFlexibleTimeInfo();
                    });
                    
                    // 綁定服務日期變更
                    if (serviceDateInput) {
                        serviceDateInput.addEventListener('change', function() {
                            bookingData.serviceDate = this.value;
                            console.log('服務日期已更新:', this.value);
                        });
                    }
                    
                    console.log('靈活時段選擇綁定完成');
                } else {
                    console.error('找不到時段選擇元素');
                }
                
                // 更新方案時長提示
                function updatePlanDurationHint() {
                    if (planDurationHint) {
                        if (bookingData.selectedPlan) {
                            const planHours = getPlanHours(bookingData.selectedPlan);
                            planDurationHint.textContent = `${planHours}小時 (${planHours}小時為單位選擇)`;
                            planDurationHint.className = 'text-blue-800 font-medium';
                        } else {
                            planDurationHint.textContent = '請先選擇方案';
                            planDurationHint.className = 'text-gray-600';
                        }
                    }
                }
                
                // 根據方案小時數獲取時長
                function getPlanHours(planName) {
                    const planMap = {
                        '1小時方案': 1,
                        '2小時方案': 2,
                        '4小時方案': 4,
                        '6小時方案': 6,
                        '8小時方案': 8
                    };
                    return planMap[planName] || 1; // 預設1小時
                }
                
                // 更新結束時間選項
                function updateEndTimeOptions() {
                    const startHour = parseInt(startTimeSelect.value);
                    const planHours = getPlanHours(bookingData.selectedPlan || '2小時方案');
                    
                    // 清空現有選項
                    endTimeSelect.innerHTML = '';
                    
                    // 根據方案小時數添加選項
                    for (let hour = startHour + planHours; hour <= 19; hour += planHours) {
                        const option = document.createElement('option');
                        option.value = hour;
                        option.textContent = `${hour.toString().padStart(2, '0')}:00`;
                        endTimeSelect.appendChild(option);
                    }
                    
                    // 設定預設結束時間
                    if (endTimeSelect.options.length > 0) {
                        endTimeSelect.value = endTimeSelect.options[0].value;
                    }
                }
                
                // 更新時段資訊顯示
                function updateFlexibleTimeInfo() {
                    const startHour = parseInt(startTimeSelect.value);
                    const endHour = parseInt(endTimeSelect.value);
                    const duration = endHour - startHour;
                    
                    console.log('更新時段資訊:', { startHour, endHour, duration });
                    
                    if (duration > 0 && durationDisplay && priceDisplay) {
                        // 更新顯示
                        durationDisplay.textContent = `${duration} 小時`;
                        
                        // 計算價格（每小時150元，4小時以上有優惠）
                        let price = duration * 150;
                        if (duration >= 4) {
                            price = Math.floor(price * 0.9); // 9折優惠
                        }
                        if (duration >= 8) {
                            price = Math.floor(price * 0.85); // 85折優惠
                        }
                        
                        priceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                        
                        // 更新預訂資料
                        bookingData.duration = duration;
                        bookingData.timeSlot = `${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00`;
                        bookingData.timeSlotName = `${duration}小時 (${startHour.toString().padStart(2, '0')}:00-${endHour.toString().padStart(2, '0')}:00)`;
                        bookingData.customPrice = price;
                        
                        console.log('靈活時段選擇已更新:', { duration, timeSlot: bookingData.timeSlot, price });
                        
                        // 檢查當前步驟是否可以繼續
                        checkCurrentStepCanContinue();
                    }
                }
                
                // 公開更新方案時長提示的方法
                window.updateDaycarePlanDuration = updatePlanDurationHint;
            }
            

            
            // 綁定可用性檢查
            function bindAvailabilityCheck() {
                const checkBtn = document.getElementById('check-availability-btn');
                const resultDiv = document.getElementById('availability-result');
                
                if (checkBtn && resultDiv) {
                    checkBtn.addEventListener('click', function() {
                        const startHour = document.getElementById('start-time-select').value;
                        const endHour = document.getElementById('end-time-select').value;
                        const serviceDate = document.getElementById('detail-service-date').value;
                        
                        if (!serviceDate) {
                            alert('請先選擇服務日期');
                            return;
                        }
                        
                        // 模擬檢查可用性（實際應用中會調用API）
                        checkTimeSlotAvailability(serviceDate, startHour, endHour, resultDiv);
                    });
                }
            }
            
            // 檢查時段可用性
            function checkTimeSlotAvailability(date, startHour, endHour, resultDiv) {
                // 模擬可用性資料（實際應用中會從後端獲取）
                const mockAvailability = {
                    '09:00-10:00': { available: true, capacity: 5, booked: 2 },
                    '10:00-11:00': { available: true, capacity: 5, booked: 3 },
                    '11:00-12:00': { available: false, capacity: 5, booked: 5 },
                    '12:00-13:00': { available: true, capacity: 5, booked: 1 },
                    '13:00-14:00': { available: true, capacity: 5, booked: 0 },
                    '14:00-15:00': { available: true, capacity: 5, booked: 2 },
                    '15:00-16:00': { available: true, capacity: 5, booked: 1 },
                    '16:00-17:00': { available: true, capacity: 5, booked: 0 },
                    '17:00-18:00': { available: true, capacity: 5, booked: 1 }
                };
                
                let allAvailable = true;
                let unavailableSlots = [];
                
                // 檢查選擇時段內的每個小時
                for (let hour = parseInt(startHour); hour < parseInt(endHour); hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00-${(hour + 1).toString().padStart(2, '0')}:00`;
                    const slotInfo = mockAvailability[timeSlot];
                    
                    if (!slotInfo || !slotInfo.available) {
                        allAvailable = false;
                        unavailableSlots.push(timeSlot);
                    }
                }
                
                // 顯示結果
                if (allAvailable) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-green-600 mr-2">✅</span>
                                <span class="text-green-800 font-medium">時段可用</span>
                            </div>
                            <p class="text-green-700 text-sm mt-1">選擇的時段 ${startHour}:00-${endHour}:00 可以預訂</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="text-red-600 mr-2">❌</span>
                                <span class="text-red-800 font-medium">時段額滿</span>
                            </div>
                            <p class="text-red-700 text-sm mt-1">以下時段已額滿：${unavailableSlots.join(', ')}</p>
                            <p class="text-red-600 text-xs mt-2">建議選擇其他時段或日期</p>
                        </div>
                    `;
                }
                
                resultDiv.classList.remove('hidden');
            }
            
            // 更新入住天數顯示
            function updateStayDuration() {
                const checkinDate = document.getElementById('detail-checkin-date').value;
                const checkoutDate = document.getElementById('detail-checkout-date').value;
                const durationDisplay = document.getElementById('stay-duration');
                
                if (checkinDate && checkoutDate) {
                    const checkin = new Date(checkinDate);
                    const checkout = new Date(checkoutDate);
                    const diffTime = Math.abs(checkout - checkin);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays > 0) {
                        durationDisplay.textContent = `${diffDays} 晚`;
                        bookingData.checkinDate = checkinDate;
                        bookingData.checkoutDate = checkoutDate;
                        bookingData.stayDuration = diffDays;
                        
                        console.log('入住天數已更新:', { checkinDate, checkoutDate, diffDays });
                        
                        // 檢查當前步驟是否可以繼續
                        checkCurrentStepCanContinue();
                    } else {
                        durationDisplay.textContent = '請選擇有效的退房日期';
                    }
                }
            }
            
            // 在函數定義完成後，調用必要的初始化函數
            function initializeBookingFunctions() {
                attachPlanSelectionListeners();
                attachTimeSelectionListeners();
            }

            // 綁定時段選擇事件
            function attachTimeSlotListeners() {
                // 預設時段選擇
                document.querySelectorAll('.preset-time-slot').forEach(slot => {
                    slot.addEventListener('click', function() {
                        // 移除其他時段的選中狀態
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 選中當前時段
                        this.classList.add('selected');
                        
                        // 更新預訂資料
                        const hours = parseInt(this.dataset.hours);
                        const time = this.dataset.time;
                        const price = parseInt(this.dataset.price);
                        
                        bookingData.duration = hours;
                        bookingData.timeSlot = time;
                        bookingData.timeSlotName = `${hours}小時 (${time})`;
                        bookingData.customPrice = price;
                        
                        // 隱藏自訂時段選擇
                        const timeSliders = document.querySelector('.time-sliders');
                        if (timeSliders) {
                            timeSliders.classList.add('hidden');
                        }
                        
                        // 顯示房型選項
                        showRoomServiceOptions('daycare');
                        
                        // 更新價格顯示
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // 自訂時段切換
                document.querySelector('.custom-time-toggle')?.addEventListener('click', function() {
                    const timeSliders = document.querySelector('.time-sliders');
                    const isHidden = timeSliders.classList.contains('hidden');
                    
                    if (isHidden) {
                        // 顯示自訂時段選擇
                        timeSliders.classList.remove('hidden');
                        this.classList.add('active');
                        this.innerHTML = '<span>收起自訂時段</span>';
                        
                        // 清除預設時段選擇
                        document.querySelectorAll('.preset-time-slot').forEach(s => {
                            s.classList.remove('selected');
                        });
                        
                        // 隱藏房型選項，等待自訂時段選擇完成
                        const roomServiceList = document.getElementById('room-service-list');
                        if (roomServiceList) {
                            roomServiceList.classList.add('hidden');
                        }
                    } else {
                        // 隱藏自訂時段選擇
                        timeSliders.classList.add('hidden');
                        this.classList.remove('active');
                        this.innerHTML = '<span>自訂時段</span>';
                    }
                });
                
                // 滑桿時間選擇 (保留原有功能)
                const startTimeSlider = document.getElementById('start-time-slider');
                const endTimeSlider = document.getElementById('end-time-slider');
                const startTimeDisplay = document.getElementById('start-time-display');
                const endTimeDisplay = document.getElementById('end-time-display');
                const durationDisplay = document.getElementById('duration-display');
                const timePriceDisplay = document.getElementById('time-price-display');
                
                if (!startTimeSlider || !endTimeSlider) return;
                
                // 初始化顯示
                updateTimeDisplays();
                
                // 開始時間滑桿事件
                startTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(this.value);
                    const endHour = parseInt(endTimeSlider.value);
                    
                    // 確保結束時間大於開始時間
                    if (endHour <= startHour) {
                        endTimeSlider.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // 結束時間滑桿事件
                endTimeSlider.addEventListener('input', function() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(this.value);
                    
                    // 確保結束時間大於開始時間
                    if (endHour <= startHour) {
                        this.value = startHour + 1;
                    }
                    
                    updateTimeDisplays();
                    updateCustomBookingData();
                });
                
                // 更新時間顯示
                function updateTimeDisplays() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    // 格式化時間顯示
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // 更新顯示元素
                    if (startTimeDisplay) startTimeDisplay.textContent = startTime;
                    if (endTimeDisplay) endTimeDisplay.textContent = endTime;
                    if (durationDisplay) durationDisplay.textContent = `${duration} 小時`;
                    
                    // 計算價格 (每小時150元)
                    const price = duration * 150;
                    if (timePriceDisplay) timePriceDisplay.textContent = `NT$ ${price.toLocaleString()}`;
                }
                
                // 更新自訂預訂資料
                function updateCustomBookingData() {
                    const startHour = parseInt(startTimeSlider.value);
                    const endHour = parseInt(endTimeSlider.value);
                    const duration = endHour - startHour;
                    
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:00`;
                    
                    // 更新全域預訂資料
                    bookingData.duration = duration;
                    bookingData.timeSlot = `${startTime}-${endTime}`;
                    bookingData.timeSlotName = `${duration}小時 (${startTime}-${endTime})`;
                    bookingData.customPrice = duration * 150;
                    
                    // 顯示房型選項（如果時間已選擇）
                    if (duration > 0) {
                        showRoomServiceOptions('daycare');
                    }
                    
                    // 隱藏自訂時段選擇
                    const timeSliders = document.querySelector('.time-sliders');
                    if (timeSliders) {
                        timeSliders.classList.add('hidden');
                    }
                    
                    updatePriceTransparency();
                    checkCanContinueBooking();
                }
            }
            
            // 顯示可用時段
            function showAvailableTimeSlots(duration) {
                const timeSlotSelection = document.getElementById('time-slot-selection');
                const availableTimeSlots = document.getElementById('available-time-slots');
                
                if (!timeSlotSelection || !availableTimeSlots) return;
                
                // 生成可選的開始時間 (營業時間 9:00-18:00)
                const startHour = 9;
                const endHour = 18;
                const slots = [];
                
                for (let hour = startHour; hour <= endHour - duration; hour++) {
                    const startTime = `${hour.toString().padStart(2, '0')}:00`;
                    const endTime = `${(hour + duration).toString().padStart(2, '0')}:00`;
                    slots.push({
                        start: startTime,
                        end: endTime,
                        display: `${startTime}-${endTime}`
                    });
                }
                
                // 生成HTML
                availableTimeSlots.innerHTML = slots.map(slot => `
                    <button class="time-slot-btn p-2 border-2 border-gray-200 rounded-lg text-center hover:border-[#181111] transition-all text-sm" 
                            data-slot="${slot.display}" data-start="${slot.start}" data-end="${slot.end}">
                        ${slot.display}
                    </button>
                `).join('');
                
                // 綁定時段按鈕事件
                availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 重置所有時段按鈕
                        availableTimeSlots.querySelectorAll('.time-slot-btn').forEach(b => {
                            b.classList.remove('border-[#181111]', 'bg-green-50');
                            b.classList.add('border-gray-200');
                        });
                        
                        // 選中當前時段
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-green-50');
                        
                                                 // 保存時段信息
                         bookingData.timeSlot = this.dataset.slot;
                         bookingData.timeSlotName = `${duration}小時 (${this.dataset.slot})`;
                         
                         // 選擇時段後，顯示房型選項
                         showRoomServiceOptions('daycare');
                         
                         checkCanContinueBooking();
                    });
                });
                
                                 // 顯示時段選擇區域
                 timeSlotSelection.classList.remove('hidden');
             }
             
             // 顯示房型服務選項
             function showRoomServiceOptions(serviceType) {
                 const roomServiceList = document.getElementById('room-service-list');
                 if (!roomServiceList) return;
                 
                 // 如果是日間安親，顯示方案選擇界面
                 if (serviceType === 'daycare') {
                     showDaycarePackageSelection();
                     return;
                 }
                 
                 // 整理房型和對應的服務
                 const roomTypeMap = new Map();
                 
                 // 從 mockRoomTypes 和 mockPackages 整理數據
                 mockRoomTypes.forEach(room => {
                     if (room.status === 'active') {
                         const packages = mockPackages.filter(pkg => 
                             pkg.roomId === room.id && 
                             pkg.status === 'active' && 
                             pkg.type === serviceType
                         );
                         
                         if (packages.length > 0) {
                             roomTypeMap.set(room.id, {
                                 name: room.name,
                                 description: room.description || '',
                                 packages: packages
                             });
                         }
                     }
                 });

                 let html = '';
                 roomTypeMap.forEach((roomData, roomId) => {
                     const minPrice = Math.min(...roomData.packages.map(pkg => pkg.basePrice));
                     const serviceIcon = serviceType === 'overnight' ? '🏠' : '⏰';
                     const priceUnit = serviceType === 'overnight' ? '/ 晚' : '/ 次';
                     
                     // 顯示可用的方案
                     const packageNames = roomData.packages.map(pkg => pkg.name).join('、');
                     
                     html += `
                         <div class="border border-gray-200 rounded-lg p-4">
                             <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                             <p class="text-sm text-gray-500 mb-2">${roomData.description}</p>
                             <p class="text-xs text-blue-600 mb-3">可選方案：${packageNames}</p>
                             <button class="room-service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                     data-service-type="${serviceType}" data-room-id="${roomId}">
                                 <div class="flex justify-between items-center">
                                     <div class="flex items-center">
                                         <span class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center mr-3 text-sm">${serviceIcon}</span>
                                         <div>
                                             <span class="font-medium text-[#181111]">選擇此房型</span>
                                             <p class="text-xs text-gray-500">${serviceType === 'overnight' ? '寄宿過夜服務' : '日間安親服務'}</p>
                                         </div>
                                     </div>
                                     <div class="text-right">
                                         <span class="font-bold text-sm">NT$ ${minPrice.toLocaleString()}起</span>
                                         <p class="text-xs text-gray-500">${priceUnit}</p>
                                     </div>
                                 </div>
                             </button>
                         </div>
                     `;
                 });

                 roomServiceList.innerHTML = html;
                 roomServiceList.classList.remove('hidden');
                 
                 // 綁定房型選擇事件
                 attachRoomServiceListeners();
             }
             
             // 顯示日間安親方案選擇
             function showDaycarePackageSelection() {
                 const roomServiceList = document.getElementById('room-service-list');
                 if (!roomServiceList) return;
                 
                 // 獲取所有日間安親方案
                 const daycarePackages = mockPackages.filter(pkg => 
                     pkg.type === 'daycare' && pkg.status === 'active'
                 );
                 
                 let html = '<h4 class="font-medium text-[#181111] mb-3">選擇日間安親方案</h4>';
                 
                 daycarePackages.forEach(pkg => {
                     const roomData = mockRoomTypes.find(room => room.id === pkg.roomId);
                     if (!roomData) return;
                     
                     html += `
                         <div class="border border-gray-200 rounded-lg p-4 mb-3">
                             <div class="flex justify-between items-start mb-2">
                                 <div>
                                     <h5 class="font-medium text-[#181111]">${pkg.name}</h5>
                                     <p class="text-sm text-gray-600">${roomData.name}</p>
                                     <p class="text-xs text-gray-500 mt-1">${pkg.description}</p>
                                 </div>
                                 <div class="text-right">
                                     <div class="font-bold text-lg">NT$ ${pkg.basePrice}</div>
                                     <div class="text-xs text-gray-500">/ ${pkg.daycareLengths}小時</div>
                                 </div>
                             </div>
                             <button class="daycare-package-btn w-full p-3 border-2 border-gray-200 rounded-lg hover:border-blue-300 transition-all" 
                                     data-package-id="${pkg.id}">
                                 選擇此方案
                             </button>
                         </div>
                     `;
                 });
                 
                 roomServiceList.innerHTML = html;
                 roomServiceList.classList.remove('hidden');
                 
                 // 綁定方案選擇事件
                 document.querySelectorAll('.daycare-package-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         // 選中當前方案
                         document.querySelectorAll('.daycare-package-btn').forEach(b => {
                             b.classList.remove('border-blue-300', 'bg-blue-50');
                             b.classList.add('border-gray-200');
                         });
                         this.classList.remove('border-gray-200');
                         this.classList.add('border-blue-300', 'bg-blue-50');
                         
                         // 選擇方案後顯示時間滑桿
                         const daycareDateSection = document.getElementById('daycare-date-selection');
                         if (daycareDateSection) {
                             daycareDateSection.classList.remove('hidden');
                         }
                         
                         checkCanContinueBooking();
                     });
                 });
             }
             
             // 綁定房型服務選擇事件
             function attachRoomServiceListeners() {
                 document.querySelectorAll('.room-service-option-btn').forEach(btn => {
                     btn.addEventListener('click', function() {
                         // 移除其他按鈕的選中狀態
                         document.querySelectorAll('.room-service-option-btn').forEach(b => {
                             b.classList.remove('selected');
                             b.style.borderColor = '#e5e7eb';
                             b.style.backgroundColor = '';
                         });
                         
                         // 選中當前按鈕
                         this.classList.add('selected');
                         this.style.borderColor = '#181111';
                         this.style.backgroundColor = '#f9fafb';
                         
                         const serviceType = this.dataset.serviceType;
                         const roomId = parseInt(this.dataset.roomId);
                         
                         // 設定預訂資料
                         bookingData.preferredRoomId = roomId;
                         
                         checkCanContinueBooking();
                     });
                 });
             }

            // 更新價格透明度顯示
            function updatePriceTransparency() {
                const priceTransparency = document.getElementById('price-transparency');
                const roomPriceDetail = document.getElementById('room-price-detail');
                const roomPrice = document.getElementById('room-price');
                const durationItem = document.getElementById('duration-item');
                const durationDetail = document.getElementById('duration-detail');
                const durationPrice = document.getElementById('duration-price');
                const petCountItem = document.getElementById('pet-count-item');
                const petCountDetail = document.getElementById('pet-count-detail');
                const petCountPrice = document.getElementById('pet-count-price');
                const totalPrice = document.getElementById('total-price');
                
                let total = 0;
                let hasValidData = false;
                
                // 方案費用 (新的邏輯)
                if (bookingData.selectedPlan && bookingData.planPrice) {
                    // 根據服務類型顯示不同的標籤
                    if (bookingData.serviceType === 'overnight') {
                        roomPriceDetail.textContent = `${getPlanDisplayName(bookingData.selectedPlan)}套房`;
                    } else {
                        roomPriceDetail.textContent = `${getPlanDisplayName(bookingData.selectedPlan)}照護`;
                    }
                    
                    roomPrice.textContent = `NT$ ${bookingData.planPrice.toLocaleString()}`;
                    total += bookingData.planPrice;
                    hasValidData = true;
                    
                    console.log('方案費用已計算:', { plan: bookingData.selectedPlan, price: bookingData.planPrice });
                } else {
                    roomPriceDetail.textContent = '請選擇方案';
                    roomPrice.textContent = 'NT$ 0';
                }
                
                // 服務時長和費用計算
                if (bookingData.serviceType === 'overnight' && bookingData.stayDuration) {
                    // 寄宿過夜：按天數計算
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.stayDuration} 晚`;
                    
                    const durationCost = bookingData.planPrice * bookingData.stayDuration;
                    durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    total = durationCost; // 總價就是天數 × 每晚價格
                    hasValidData = true;
                    
                    console.log('寄宿過夜費用已計算:', { days: bookingData.stayDuration, totalCost: durationCost });
                } else if (bookingData.serviceType === 'daycare' && bookingData.duration) {
                    // 日間安親：按時數計算
                    durationItem.style.display = 'flex';
                    durationDetail.textContent = `${bookingData.duration}小時`;
                    
                    const durationCost = bookingData.customPrice || (bookingData.duration * 150);
                    durationPrice.textContent = `NT$ ${durationCost.toLocaleString()}`;
                    total = durationCost; // 總價就是時段費用
                    hasValidData = true;
                    
                    console.log('日間安親費用已計算:', { hours: bookingData.duration, totalCost: durationCost });
                } else {
                    durationItem.style.display = 'none';
                }
                
                // 寵物數量
                if (bookingData.petCount > 1) {
                    petCountItem.style.display = 'flex';
                    petCountDetail.textContent = `${bookingData.petCount} 隻`;
                    petCountPrice.textContent = `× ${bookingData.petCount}`;
                    total *= bookingData.petCount;
                } else {
                    petCountItem.style.display = 'none';
                }
                
                // 加購服務
                const addonItems = document.getElementById('addon-items');
                addonItems.innerHTML = '';
                bookingData.addons.forEach(addon => {
                    const addonItem = document.createElement('div');
                    addonItem.className = 'price-item addon';
                    addonItem.innerHTML = `
                        <span class="item-label">加購服務</span>
                        <span class="item-detail">${addon.name}</span>
                        <span class="item-price">NT$ ${addon.price.toLocaleString()}</span>
                    `;
                    addonItems.appendChild(addonItem);
                    total += addon.price;
                });
                
                // 更新總價
                if (totalPrice) {
                    totalPrice.textContent = `NT$ ${total.toLocaleString()}`;
                }
                
                // 顯示/隱藏價格透明度區域
                if (hasValidData) {
                    priceTransparency.classList.remove('hidden');
                    console.log('價格透明度區域已顯示，總價:', total);
                } else {
                    priceTransparency.classList.add('hidden');
                    console.log('價格透明度區域已隱藏，沒有有效資料');
                }
            }
            
            // 輔助函數：獲取方案顯示名稱
            function getPlanDisplayName(plan) {
                const planNames = {
                    'standard': '標準',
                    'deluxe': '豪華',
                    'premium': '頂級',
                    'basic': '基礎'
                };
                return planNames[plan] || plan;
            }
            
            // 驗證預訂資料 - 新的三步驟流程
            function validateBookingData() {
                const errors = [];
                
                console.log('驗證預訂資料:', bookingData);
                
                // 檢查服務類型
                if (!bookingData.serviceType) {
                    errors.push('請選擇服務類型');
                }
                
                // 檢查方案選擇
                if (!bookingData.selectedPlan) {
                    errors.push('請選擇方案');
                }
                
                // 根據服務類型檢查時段選擇
                if (bookingData.serviceType === 'overnight') {
                    if (!bookingData.checkinDate) {
                        errors.push('請選擇入住日期');
                    }
                    if (!bookingData.checkoutDate) {
                        errors.push('請選擇退房日期');
                    } else if (new Date(bookingData.checkoutDate) <= new Date(bookingData.checkinDate)) {
                        errors.push('退房日期必須晚於入住日期');
                    }
                } else if (bookingData.serviceType === 'daycare') {
                    if (!bookingData.timeSlot) {
                        errors.push('請選擇服務時段');
                    }
                    if (!bookingData.duration) {
                        errors.push('請選擇服務時長');
                    }
                }
                
                console.log('驗證結果:', errors);
                return errors;
            }
            
            // 輕量級驗證 - 僅檢查當前步驟的資料
            function validateCurrentStep() {
                const errors = [];
                
                // 如果已經選擇了服務類型，檢查方案
                if (bookingData.serviceType && !bookingData.selectedPlan) {
                    errors.push('請選擇方案');
                }
                
                // 如果已經選擇了方案，檢查時段
                if (bookingData.selectedPlan) {
                    if (bookingData.serviceType === 'overnight') {
                        if (!bookingData.checkinDate || !bookingData.checkoutDate) {
                            errors.push('請選擇入住和退房日期');
                        }
                    } else if (bookingData.serviceType === 'daycare') {
                        if (!bookingData.timeSlot || !bookingData.duration) {
                            errors.push('請選擇服務時段');
                        }
                    }
                }
                
                return errors;
            }
            
            // 顯示錯誤訊息
            function showBookingErrors(errors) {
                const errorContainer = document.getElementById('booking-errors');
                if (errors.length > 0) {
                    errorContainer.innerHTML = `
                        <div class="error-message">
                            <div class="error-title">
                                <svg class="icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                請修正以下問題：
                            </div>
                            <ul class="error-list">
                                ${errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    errorContainer.classList.remove('hidden');
                } else {
                    errorContainer.classList.add('hidden');
                }
            }
            
            // 檢查是否可以繼續預訂
            function checkCanContinueBooking() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateBookingData();
                
                // 顯示錯誤訊息
                showBookingErrors(errors);
                
                // 更新價格透明度
                updatePriceTransparency();
                
                // 檢查是否可以繼續
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                    
                    // 重新綁定繼續按鈕事件
                    const continueBtn = document.getElementById('continue-booking-btn');
                    continueBtn.replaceWith(continueBtn.cloneNode(true));
                    const newBtn = document.getElementById('continue-booking-btn');
                    newBtn.addEventListener('click', function() {
                        // 確保選中的房型資料完整
                        const selectedRoomBtn = document.querySelector('.room-service-option-btn.selected');
                        if (selectedRoomBtn) {
                            const roomId = parseInt(selectedRoomBtn.dataset.roomId);
                            const serviceType = selectedRoomBtn.dataset.serviceType;
                            
                            // 找到對應的方案
                            const selectedPackage = mockPackages.find(pkg => 
                                pkg.roomId === roomId && 
                                pkg.type === serviceType && 
                                pkg.status === 'active'
                            );
                            
                            if (selectedPackage) {
                                bookingData.roomId = roomId;
                                bookingData.packageId = selectedPackage.id;
                            }
                        }
                        
                        // 直接跳到確認訂單步驟
                        bookingStep = 4;
                        showPage('bookingFlow');
                    });
                } else {
                    continueSection.classList.add('hidden');
                }
            }
            
            // 檢查當前步驟是否可以繼續（輕量級檢查）
            function checkCurrentStepCanContinue() {
                const continueSection = document.getElementById('continue-booking-section');
                const errors = validateCurrentStep();
                
                // 顯示錯誤訊息
                showBookingErrors(errors);
                
                // 更新價格透明度
                updatePriceTransparency();
                
                // 檢查是否可以繼續
                if (errors.length === 0) {
                    continueSection.classList.remove('hidden');
                } else {
                    continueSection.classList.add('hidden');
                }
            }



            // 渲染房型與服務列表
            function renderRoomServiceList() {
                const container = document.getElementById('room-service-list');
                if (!container) return;

                // 整理房型和對應的服務
                const roomTypeMap = new Map();
                
                // 從 mockRoomTypes 和 mockPackages 整理數據
                mockRoomTypes.forEach(room => {
                    if (room.status === 'active') {
                        const packages = mockPackages.filter(pkg => 
                            pkg.roomId === room.id && pkg.status === 'active'
                        );
                        
                        if (packages.length > 0) {
                            roomTypeMap.set(room.id, {
                                name: room.name,
                                description: room.description || '',
                                packages: packages
                            });
                        }
                    }
                });

                let html = '';
                roomTypeMap.forEach((roomData, roomId) => {
                    // 分類服務類型
                    const overnightPackages = roomData.packages.filter(pkg => pkg.type === 'overnight');
                    const daycarePackages = roomData.packages.filter(pkg => pkg.type === 'daycare');
                    
                    html += `
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-[#181111] mb-2">${roomData.name}</h3>
                            <p class="text-sm text-gray-500 mb-3">${roomData.description}</p>
                            <div class="space-y-2">
                    `;
                    
                    // 過夜服務
                    if (overnightPackages.length > 0) {
                        const minPrice = Math.min(...overnightPackages.map(pkg => pkg.basePrice));
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="overnight" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3 text-sm">🏠</span>
                                        <div>
                                            <span class="font-medium text-[#181111]">寄宿過夜</span>
                                            <p class="text-xs text-gray-500">適合出差旅行</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm price-display">NT$ ${minPrice.toLocaleString()}起</span>
                                        <p class="text-xs text-gray-500">每晚</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }
                    
                    // 日間安親服務
                    if (daycarePackages.length > 0) {
                        const minPrice = Math.min(...daycarePackages.map(pkg => pkg.basePrice));
                        const minDuration = Math.min(...daycarePackages.map(pkg => parseInt(pkg.daycareLengths) || 4));
                        html += `
                            <button class="service-option-btn w-full text-left p-3 rounded-lg border-2 border-gray-200 hover:border-[#181111] transition-all" 
                                    data-service-type="daycare" data-room-id="${roomId}">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3 text-sm">⏰</span>
                                        <div>
                                            <span class="font-medium text-[#181111]">日間安親</span>
                                            <p class="text-xs text-gray-500">專業照護陪伴</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-sm">NT$ ${minPrice.toLocaleString()}起</span>
                                        <p class="text-xs text-gray-500">/${minDuration}hr</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;

                // 綁定點擊事件
                document.querySelectorAll('.service-option-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // 移除其他按鈕的選中狀態
                        document.querySelectorAll('.service-option-btn').forEach(b => {
                            b.classList.remove('selected');
                            b.style.borderColor = '#e5e7eb';
                            b.style.backgroundColor = '';
                        });
                        
                        // 選中當前按鈕
                        this.classList.add('selected');
                        this.style.borderColor = '#181111';
                        this.style.backgroundColor = '#f9fafb';
                        
                        const serviceType = this.dataset.serviceType;
                        const roomId = parseInt(this.dataset.roomId);
                        
                        // 設定預訂資料，使用詳情頁已選擇的日期
                        bookingData.serviceType = serviceType;
                        bookingData.preferredRoomId = roomId;
                        bookingData.dates.checkin = selectedCheckinDate.toISOString().split('T')[0];
                        bookingData.dates.checkout = selectedCheckoutDate.toISOString().split('T')[0];
                        
                        // 直接跳到房型選擇步驟，跳過日期選擇
                        bookingStep = 3;
                        
                        // 更新價格預覽
                        updateDetailPricePreview();
                        
                        // 顯示繼續預訂按鈕
                        showContinueBookingButton();
                    });
                });
            }

            // 地圖相關功能
            let hotelMap = null;
            const hotelLocation = {
                lat: 25.0330,  // 台北市信義區座標
                lng: 121.5654,
                address: "台北市信義區信義路五段7號",
                name: "快樂爪子旅館"
            };

            // 初始化旅館地圖
            function initHotelMap() {
                // 如果Leaflet還沒載入，稍後再試
                if (typeof L === 'undefined') {
                    setTimeout(initHotelMap, 500);
                    return;
                }

                const mapContainer = document.getElementById('hotel-map');
                if (!mapContainer) return;

                try {
                    // 清除載入提示
                    mapContainer.innerHTML = '';

                    // 初始化地圖
                    hotelMap = L.map('hotel-map').setView([hotelLocation.lat, hotelLocation.lng], 16);

                    // 添加地圖圖層 (使用 OpenStreetMap)
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(hotelMap);

                    // 創建自定義圖標
                    const hotelIcon = L.divIcon({
                        html: `
                            <div style="
                                width: 40px; 
                                height: 40px; 
                                background-color: #181111; 
                                border: 3px solid white; 
                                border-radius: 50%; 
                                display: flex; 
                                align-items: center; 
                                justify-content: center; 
                                font-size: 16px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            ">🏠</div>
                        `,
                        className: 'custom-hotel-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40]
                    });

                    // 添加旅館標記
                    const marker = L.marker([hotelLocation.lat, hotelLocation.lng], { 
                        icon: hotelIcon 
                    }).addTo(hotelMap);

                    // 點擊標記顯示彈出視窗
                    marker.bindPopup(`
                        <div style="padding: 8px; font-family: 'Plus Jakarta Sans', sans-serif; max-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: #181111; font-weight: bold;">${hotelLocation.name}</h3>
                            <p style="margin: 0 0 8px 0; color: #666; font-size: 14px;">${hotelLocation.address}</p>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}" 
                               target="_blank" 
                               style="color: #1a73e8; text-decoration: none; font-size: 14px;">
                                📍 開始導航
                            </a>
                        </div>
                    `);

                    // 禁用地圖的一些控制項以符合手機版面
                    hotelMap.scrollWheelZoom.disable();
                    hotelMap.doubleClickZoom.disable();
                    hotelMap.dragging.disable();

                    // 添加地圖點擊事件來啟用交互
                    const hintElement = document.getElementById('map-interaction-hint');
                    if (hintElement) {
                        hintElement.classList.remove('hidden');
                        
                        hotelMap.on('click', function() {
                            hotelMap.dragging.enable();
                            hotelMap.scrollWheelZoom.enable();
                            hotelMap.doubleClickZoom.enable();
                            hintElement.classList.add('hidden');
                        });
                    }

                } catch (error) {
                    console.error('地圖初始化失敗:', error);
                    mapContainer.innerHTML = `
                        <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                            <span class="text-sm">地圖載入失敗，請稍後再試</span>
                        </div>
                    `;
                }
            }

            // 地圖相關事件監聽器
            function attachMapListeners() {
                // 導航按鈕點擊事件
                document.getElementById('open-map-btn')?.addEventListener('click', function() {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        // 手機端嘗試開啟原生地圖應用
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`;
                        const appleMapsUrl = `http://maps.apple.com/?daddr=${hotelLocation.lat},${hotelLocation.lng}`;
                        
                        // iOS 設備優先使用 Apple Maps
                        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                            window.open(appleMapsUrl, '_system');
                        } else {
                            window.open(googleMapsUrl, '_system');
                        }
                    } else {
                        // 桌面端開啟 Google Maps 網頁版
                        window.open(`https://www.google.com/maps/dir/?api=1&destination=${hotelLocation.lat},${hotelLocation.lng}`, '_blank');
                    }
                });
            }

            function renderUserCenterPage() {
                const container = pages.account;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-center">
                        <h2 class="text-[#181111] text-base font-bold">帳戶</h2>
                    </div>
                </div>

                <div class="px-4 py-3 bg-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="https://images.unsplash.com/photo-1548142813-c348350df52b?q=80&w=200" class="w-12 h-12 rounded-full object-cover" alt="avatar">
                            <div>
                                <p class="font-bold text-[#181111]">James</p>
                                <p class="text-xs text-[#886364]">台北市, 台灣</p>
                            </div>
                        </div>
                        <button id="account-edit-icon" class="p-2 text-[#181111]" aria-label="edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="currentColor"><path d="M227.31,73.37,182.63,28.69a16,16,0,0,0-22.63,0L41.37,147.31A15.86,15.86,0,0,0,36.69,158L24.29,207.14a8,8,0,0,0,9.85,9.85l49.1-12.4a15.86,15.86,0,0,0,10.68-4.68L227.31,96A16,16,0,0,0,227.31,73.37ZM78.4,192.62l-28.2,7.12,7.12-28.2L152,76.86l21.09,21.09ZM197.66,73.37,184,87l-21.09-21.1,13.66-13.66a0,0,0,0,1,0,0L197.66,59.71A0,0,0,0,1,197.66,73.37Z"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                ${!isUserMerchant ? `
                <div id="become-merchant-card" class="px-4 py-3 cursor-pointer">
                    <div class="bg-white border border-gray-100 rounded-xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-amber-100 flex items_center justify-center">🏪</div>
                        <div class="flex-1">
                            <p class="font-bold text-[#181111]">成為商家</p>
                            <p class="text-xs text-[#886364]">馬上申請成為 Paw Pad 的合作夥伴！</p>
                        </div>
                        <div class="text-[#886364]">›</div>
                    </div>
                </div>` : `
                <div class="px-4 py-3">
                    <div id="merchant-entry" class="bg-white border border-gray-100 rounded-xl p-4 flex items-center justify-between cursor-pointer">
                        <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center">📊</div><div><p class="font-bold text-[#181111]">商家專區</p><p class="text-xs text-[#886364]">管理訂單、行事曆與方案</p></div></div>
                        <div class="text-[#886364]">›</div>
                    </div>
                    <div class="mt-3">
                        <button id="merchant-backend-btn" class="btn-main h-11">進入商家後台</button>
                    </div>
                </div>`}

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2 space-y-2">
                    <div id="account-profile" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>個人資料</span><span class="text-[#886364]">›</span></div>
                    <div id="account-support" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>聯繫客服</span><span class="text-[#886364]">›</span></div>
                    <div id="account-privacy" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>隱私</span><span class="text-[#886364]">›</span></div>
                    <div id="account-referral" class="bg-white p-4 rounded-xl border border-gray-100 flex justify_between items-center cursor-pointer"><span>我的推薦代碼</span><span class="text-[#886364]">›</span></div>
                    <div id="account-coupons" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>優惠券列表</span><span class="text-[#886364]">›</span></div>
                    <div id="account-settings" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer">
                        <span>設定</span>
                        <span class="text-[#886364]">›</span>
                    </div>
                </div>

                <div class="h-2 bg-gray-100"></div>

                <div class="px-4 py-2">
                    <div id="account-logout" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>登出</span><span class="text-[#886364]">›</span></div>
                </div>
                `;

                attachAccountListeners();
            }

            function updateUserCenterOptions() {
                const container = document.getElementById('user-options-list');
                if (!container) return;
                let optionsHTML = `
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>我的資料</span><span class="text-[#886364]">></span></div>
                    <div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>設定</span><span class="text-[#886364]">></span></div>`;
                
                if (isUserMerchant) {
                    optionsHTML += `<div id="merchant-entry" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>商家專區</span><span class="text-[#886364]">></span></div>`;
                } else {
                    optionsHTML += `<div id="become-merchant" class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer"><span>成為商家</span><span class="text-blue-600 font-bold">立即申請</span></div>`;
                }
                container.innerHTML = optionsHTML + `<div class="bg-white p-4 rounded-xl border border-gray-100 flex justify-between items-center cursor-pointer text-red-600"><span>登出</span></div>`;
            }

            // 帳戶頁：事件與模態
            function attachAccountListeners() {
                document.getElementById('account-edit-icon')?.addEventListener('click', openProfileEditModal);
                document.getElementById('account-profile')?.addEventListener('click', openProfileEditModal);
                document.getElementById('become-merchant-card')?.addEventListener('click', () => { renderMerchantApplicationFlow(); });
                document.getElementById('merchant-entry')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('merchant-backend-btn')?.addEventListener('click', () => showPage('merchantDashboard'));
                document.getElementById('account-support')?.addEventListener('click', () => showPage('chat'));
                document.getElementById('account-privacy')?.addEventListener('click', openPrivacyModal);
                document.getElementById('account-referral')?.addEventListener('click', openReferralModal);
                document.getElementById('account-coupons')?.addEventListener('click', openCouponsModal);
                document.getElementById('account-settings')?.addEventListener('click', () => showPage('settings'));
                document.getElementById('account-logout')?.addEventListener('click', () => { alert('已登出 (模擬)'); showPage('home'); });
            }

            function openOverlayWithContent(innerHtml) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal-content">${innerHtml}</div>`;
                document.body.appendChild(modal);
                modal.addEventListener('click', function(e){ if (e.target === modal || e.target.id === 'modal-close-btn') document.body.removeChild(modal); });
                return modal;
            }

            function openReferralModal() {
                const code = 'PP-JAMES-1234';
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">我的推薦代碼</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <p class="text-sm text-[#886364] mb-3">分享給朋友，雙方皆可獲得優惠。</p>
                    <div class="bg-gray-50 border rounded-xl p-4 text-center mb-3">
                        <p class="text-2xl font-black tracking-widest text-[#181111]">${code}</p>
                    </div>
                    <button id="copy-referral" class="btn-main h-11">複製代碼</button>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#copy-referral')?.addEventListener('click', async () => {
                    try { await navigator.clipboard.writeText(code); alert('已複製'); } catch(_) { alert('複製失敗'); }
                });
            }

            function openCouponsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">優惠券列表</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-2">
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">新用戶 85 折</p><p class="text-xs text-[#886364]">到期日：2025/12/31</p></div>
                            <span class="text-emerald-600 font-bold">可用</span>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex justify-between items-center">
                            <div><p class="font-bold text-[#181111]">滿 2000 折 200</p><p class="text-xs text-[#886364]">到期日：2025/09/30</p></div>
                            <span class="text-emerald-600 font-bold">可用</span>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：目前房況（圖表示意）
            function openOccupancyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">目前房況</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <p class="mb-2 text-[#886364]">今日整體入住率</p>
                            <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                <div class="bg-emerald-500 h-3" style="width: 68%"></div>
                            </div>
                            <div class="mt-1 text-xs text-gray-600">68%</div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            ${mockRoomTypes.filter(r=>r.status==='active').map(r=>`
                                <div class="bg-white border rounded-xl p-3">
                                    <p class="font-medium text-[#181111] mb-1">${r.name}</p>
                                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                        <div class="bg-blue-500 h-2" style="width: ${Math.min(100, Math.round((r.stock-1)/r.stock*100))}%"></div>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-600">可用 ${Math.max(0, r.stock-1)} / ${r.stock}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：金流（請款 / 退款申請審核）
            function openFinanceModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">金流</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="flex gap-2 mb-3 text-sm">
                        <button data-fin-tab="payouts" class="px-3 py-1 rounded-full bg-[#181111] text-white">請款</button>
                        <button data-fin-tab="refunds" class="px-3 py-1 rounded-full bg-gray-100">退款申請審核</button>
                    </div>
                    <div id="finance-content" class="space-y-2 text-sm"></div>
                `;
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#finance-content');
                function render(tab){
                    modal.querySelectorAll('[data-fin-tab]')?.forEach(b=>{
                        const active = b.dataset.finTab===tab;
                        b.classList.toggle('bg-[#181111]', active);
                        b.classList.toggle('text-white', active);
                        b.classList.toggle('bg-gray-100', !active);
                    });
                    if(tab==='refunds'){
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">訂單 #A1029</p>
                                    <p class="text-xs text-[#886364]">原因：臨時取消</p>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <button class="px-3 py-1 bg-gray-200 rounded-full">駁回</button>
                                    <button class="px-3 py-1 bg-emerald-600 text-white rounded-full">同意退款</button>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">可請款金額</p>
                                    <p class="text-xs text-[#886364]">本期：NT$ 42,000</p>
                                </div>
                                <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">申請請款</button>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="font-medium text-[#181111] mb-1">歷史請款紀錄</p>
                                <p class="text-xs text-[#886364]">2025/06/01 NT$ 30,000 - 已匯款</p>
                            </div>
                        `;
                    }
                }
                modal.querySelectorAll('[data-fin-tab]')?.forEach(btn=>btn.addEventListener('click',()=>render(btn.dataset.finTab)));
                render('payouts');
            }

            // 商家中心：報表（下載）
            function openReportsModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">報表</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">範圍</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" class="form-input-styled">
                                <input type="date" class="form-input-styled">
                            </div>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>每日收入報表 (CSV)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">下載</button>
                        </div>
                        <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                            <span>月收入與預約統計 (PDF)</span>
                            <button class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">下載</button>
                        </div>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            // 商家中心：優惠券發送與管理
            function openCouponManageModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">優惠券管理</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3 text-sm">
                        <div class="bg-white border rounded-xl p-3">
                            <label class="block mb-1">新增優惠券</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input id="new-coupon-name" class="form-input-styled" placeholder="名稱，例如 首購85折">
                                <input id="new-coupon-exp" type="date" class="form-input-styled">
                            </div>
                            <div class="mt-2 flex gap-2">
                                <input id="new-coupon-scope" class="form-input-styled flex-1" placeholder="可用範圍，例如 全館 / 指定房型">
                                <button id="add-coupon-btn" class="px-3 py-1 bg-[#181111] text-white rounded-full text-xs">新增</button>
                            </div>
                        </div>
                        <div id="coupon-list" class="space-y-2">
                            <div class="bg-white border rounded-xl p-3 flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-[#181111]">新用戶 85 折</p>
                                    <p class="text-xs text-[#886364]">到期：2025/12/31 • 範圍：全館</p>
                                </div>
                                <button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">停用</button>
                            </div>
                        </div>
                    </div>
                `;
                const modal = openOverlayWithContent(html);
                modal.querySelector('#add-coupon-btn')?.addEventListener('click', ()=>{
                    const name = modal.querySelector('#new-coupon-name')?.value || '未命名優惠券';
                    const exp = modal.querySelector('#new-coupon-exp')?.value || '—';
                    const scope = modal.querySelector('#new-coupon-scope')?.value || '—';
                    const list = modal.querySelector('#coupon-list');
                    const node = document.createElement('div');
                    node.className = 'bg-white border rounded-xl p-3 flex items-center justify-between';
                    node.innerHTML = `<div><p class="font-medium text-[#181111]">${name}</p><p class="text-xs text-[#886364]">到期：${exp} • 範圍：${scope}</p></div><button class="px-3 py-1 bg-red-100 text-red-600 rounded-full text-xs">停用</button>`;
                    list?.prepend(node);
                });
            }

            function openSettingsModal(activeTab = 'general') {
                const html = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#181111]">設定</h2>
                        <button id="modal-close-btn" class="text-2xl text-gray-500 hover:text-gray-700">&times;</button>
                    </div>
                    
                    <!-- 設定分類標籤 -->
                    <div class="flex gap-2 mb-6 text-sm overflow-x-auto pb-2">
                        <button data-tab="general" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='general'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">一般設定</button>
                        <button data-tab="notifications" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='notifications'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">通知設定</button>
                        <button data-tab="account" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='account'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">帳號設定</button>
                        <button data-tab="app" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='app'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">應用程式</button>
                        <button data-tab="payment" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='payment'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">付款設定</button>
                        <button data-tab="pets" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='pets'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">寵物設定</button>
                        ${isUserMerchant ? `<button data-tab="merchant" class="px-4 py-2 rounded-full whitespace-nowrap ${activeTab==='merchant'?'bg-[#181111] text-white':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">商家設定</button>` : ''}
                    </div>
                    
                    <!-- 設定內容區域 -->
                    <div id="settings-content" class="space-y-4 max-h-96 overflow-y-auto"></div>
                `;
                
                const modal = openOverlayWithContent(html);
                const content = modal.querySelector('#settings-content');

                function renderTab(tab){
                    // 更新標籤狀態
                    modal.querySelectorAll('[data-tab]')?.forEach(btn=>{
                        btn.classList.toggle('bg-[#181111]', btn.dataset.tab===tab);
                        btn.classList.toggle('text-white', btn.dataset.tab===tab);
                        btn.classList.toggle('bg-gray-100', btn.dataset.tab!==tab);
                        btn.classList.toggle('text-gray-600', btn.dataset.tab!==tab);
                        btn.classList.toggle('hover:bg-gray-200', btn.dataset.tab!==tab);
                    });
                    
                    // 渲染對應內容
                    if(tab==='notifications'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">通知偏好設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">推播通知</span>
                                            <p class="text-xs text-gray-500">接收應用程式推播通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">訂單更新</span>
                                            <p class="text-xs text-gray-500">訂單狀態變更通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">優惠活動</span>
                                            <p class="text-xs text-gray-500">限時優惠與活動通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">系統公告</span>
                                            <p class="text-xs text-gray-500">重要系統更新通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">通知時間設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">安靜時間</label>
                                        <div class="flex gap-2 mt-2">
                                            <select class="form-input-styled text-sm">
                                                <option>22:00</option><option>23:00</option><option>00:00</option>
                                            </select>
                                            <span class="text-sm text-gray-500 self-center">至</span>
                                            <select class="form-input-styled text-sm">
                                                <option>07:00</option><option>08:00</option><option>09:00</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='account'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">帳號管理</h3>
                                <div class="space-y-3">
                                    <button id="settings-change-password" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">變更密碼</span>
                                                <p class="text-xs text-gray-500">更新您的登入密碼</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button id="settings-referral-btn" class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">查看推薦碼</span>
                                                <p class="text-xs text-gray-500">分享給朋友獲得優惠</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">資料下載</span>
                                                <p class="text-xs text-gray-500">下載您的個人資料</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-red-600">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">刪除帳號</span>
                                                <p class="text-xs text-gray-500">永久刪除您的帳號</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                        content.querySelector('#settings-referral-btn')?.addEventListener('click', () => openReferralModal());
                    } else if(tab==='app'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">應用程式設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動登入</span>
                                            <p class="text-xs text-gray-500">保持登入狀態</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">生物辨識登入</span>
                                            <p class="text-xs text-gray-500">使用指紋或臉部辨識</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">資料同步</span>
                                            <p class="text-xs text-gray-500">跨裝置同步資料</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">快取管理</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">清除快取</span>
                                                <p class="text-xs text-gray-500">釋放儲存空間</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='payment'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">付款設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">預設付款方式</label>
                                        <select class="form-input-styled mt-2">
                                            <option>信用卡 (****1234)</option>
                                            <option>Apple Pay</option>
                                            <option>Google Pay</option>
                                        </select>
                                    </div>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動儲存付款方式</span>
                                            <p class="text-xs text-gray-500">方便下次使用</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">發票設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">發票類型</label>
                                        <select class="form-input-styled mt-2">
                                            <option>電子發票</option>
                                            <option>紙本發票</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">統一編號</label>
                                        <input type="text" class="form-input-styled mt-2" placeholder="選填">
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if(tab==='pets'){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">寵物設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">預設寵物資訊</span>
                                            <p class="text-xs text-gray-500">自動填入寵物資料</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">特殊需求記錄</span>
                                            <p class="text-xs text-gray-500">記住寵物特殊需求</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">過敏資訊提醒</span>
                                            <p class="text-xs text-gray-500">提醒商家注意過敏</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">寵物檔案</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">管理寵物檔案</span>
                                                <p class="text-xs text-gray-500">編輯寵物詳細資訊</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else if(tab==='merchant' && isUserMerchant){
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">商家設定</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">自動回覆</span>
                                            <p class="text-xs text-gray-500">啟用自動回覆功能</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label>
                                    </label>
                                    <label class="flex items-center justify-between">
                                        <div>
                                            <span class="text-sm font-medium">營業時間提醒</span>
                                            <p class="text-xs text-gray-500">營業時間變更通知</p>
                                        </div>
                                        <label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">商家管理</h3>
                                <div class="space-y-3">
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">營業時間設定</span>
                                                <p class="text-xs text-gray-500">設定每週營業時間</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                    <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <span class="text-sm font-medium">價格設定</span>
                                                <p class="text-xs text-gray-500">管理服務價格</p>
                                            </div>
                                            <span class="text-gray-400">›</span>
                                        </div>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // 一般設定
                        content.innerHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">基本設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">語言</label>
                                        <select class="form-input-styled mt-2">
                                            <option>繁體中文</option>
                                            <option>English</option>
                                            <option>日本語</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">地區</label>
                                        <select class="form-input-styled mt-2">
                                            <option>台灣</option>
                                            <option>香港</option>
                                            <option>澳門</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">貨幣</label>
                                        <select class="form-input-styled mt-2">
                                            <option>新台幣 (NT$)</option>
                                            <option>港幣 (HK$)</option>
                                            <option>人民幣 (¥)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-gray-200 rounded-xl p-4">
                                <h3 class="font-semibold text-[#181111] mb-3">外觀設定</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm font-medium">主題</label>
                                        <div class="flex gap-2 mt-2">
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white text-gray-700">淺色</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-800 text-white">深色</button>
                                            <button class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-gray-100 text-gray-700">自動</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium">字體大小</label>
                                        <select class="form-input-styled mt-2">
                                            <option>小</option>
                                            <option selected>中</option>
                                            <option>大</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // 綁定標籤點擊事件
                modal.querySelectorAll('[data-tab]')?.forEach(btn=>btn.addEventListener('click', ()=>renderTab(btn.dataset.tab)));
                
                // 初始渲染
                renderTab(activeTab);
            }

            function openPrivacyModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">隱私</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="text-sm text-[#886364] space-y-2">
                        <p>我們重視您的隱私，僅於提供服務所需範圍內使用資料。</p>
                        <p>可於「設定 > 帳號」申請資料下載或刪除。</p>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function openProfileEditModal() {
                const html = `
                    <div class="flex justify-between items-center mb-2"><h2 class="text-lg font-bold text-[#181111]">編輯個人資料</h2><button id="modal-close-btn" class="text-2xl">&times;</button></div>
                    <div class="space-y-3">
                        <div>
                            <label class="text-sm text-gray-600">名稱</label>
                            <input class="form-input-styled mt-1" value="James">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600">城市</label>
                            <input class="form-input-styled mt-1" value="台北市">
                        </div>
                        <button class="btn-main h-11">儲存</button>
                    </div>
                `;
                openOverlayWithContent(html);
            }

            function renderMerchantApplicationFlow() {
                let step = 1;
                const appState = {
                    codeSent: false,
                    smsVerified: false,
                    outcome: 'pending'
                };
                if (!window.merchantApplicationStatus) window.merchantApplicationStatus = 'not_applied';
                if (!window.merchantLastRejectReason) window.merchantLastRejectReason = '';

                function render() {
                    formModal.innerHTML = `
                        <div class="p-4 overflow-y-auto max-h-full">
                            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                                <button id="merchant-back-btn" class="text-lg font-bold p-2">${step===1?'&lt; 返回':'&lt; 上一步'}</button>
                                <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">成為商家</h1>
                                <div class="w-28 text-right text-xs text-[#886364]">${
                                    window.merchantApplicationStatus==='under_review' ? '狀態：審核中' :
                                    window.merchantApplicationStatus==='rejected' ? '狀態：不通過' :
                                    window.merchantApplicationStatus==='re_review' ? '狀態：再次審核中' :
                                    window.merchantApplicationStatus==='approved' ? '狀態：已通過' : ' '}
                                </div>
                            </div>
                            ${step===1 ? renderStep1Info() : ''}
                            ${step===2 ? renderStep2SMS() : ''}
                            ${step===3 ? renderStep3SubmitAndReview() : ''}
                            ${step===4 ? renderStep4Outcome() : ''}
                        </div>
                    `;
                    formModal.classList.remove('hidden');

                    document.getElementById('merchant-back-btn')?.addEventListener('click', () => {
                        if (step === 1) { formModal.classList.add('hidden'); return; }
                        step = Math.max(1, step - 1); render();
                    });

                    document.getElementById('merchant-next-btn')?.addEventListener('click', () => { step = Math.min(4, step + 1); render(); });
                    document.getElementById('merchant-send-code-btn')?.addEventListener('click', () => {
                        appState.codeSent = true; render();
                    });
                    document.getElementById('merchant-verify-code-btn')?.addEventListener('click', () => {
                        appState.smsVerified = true; render();
                    });
                    document.getElementById('merchant-submit-review-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 'under_review';
                        step = 3; render();
                    });
                    document.getElementById('simulate-approve-btn')?.addEventListener('click', () => {
                        appState.outcome = 'approved';
                        window.merchantApplicationStatus = 'approved';
                        step = 4; render();
                    });
                    document.getElementById('simulate-reject-btn')?.addEventListener('click', () => {
                        appState.outcome = 'rejected';
                        window.merchantApplicationStatus = 'rejected';
                        step = 4; render();
                    });
                    document.getElementById('resubmit-btn')?.addEventListener('click', () => {
                        window.merchantApplicationStatus = 're_review';
                        step = 1; render();
                    });
                    document.getElementById('go-dashboard-btn')?.addEventListener('click', () => {
                        isUserMerchant = true;
                        formModal.classList.add('hidden');
                        renderUserCenterPage();
                        showPage('merchantDashboard');
                    });
                    document.getElementById('reject-reason-input')?.addEventListener('input', (e) => {
                        window.merchantLastRejectReason = e.target.value || '';
                    });
                }

                function renderStep1Info() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">商家填寫資料（名稱、國家、地區、地址、證件…）</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">店家名稱</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="例如：快樂爪子旅館">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">國家</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="台灣">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">地區</label>
                                    <input type="text" class="form-input-styled mt-1" placeholder="台北市/信義區">
                                </div>
                            </div>
                                                        <div>
                                <label class="text-sm font-medium text-[#886364]">地址</label>
                                <input type="text" class="form-input-styled mt-1" placeholder="城市、街道、門牌">
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">身分文件（示意）</p>
                                <div class="grid gap-2 text-sm">
                                    <label class="flex items-center justify-between">身分證<input type="file" class="text-sm"></label>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-3">
                                <p class="text-sm text-[#886364] mb-2">選填資料</p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-sm text-[#886364]">營業登記證</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                    <div>
                                        <label class="text-sm text-[#886364]">銀行帳戶</label>
                                        <input type="file" class="text-sm mt-1 w-full">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6"><button id="merchant-next-btn" class="btn-main">下一步：簡訊驗證</button></div>
                        </div>`;
                }

                function renderStep2SMS() {
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">簡訊驗證手機</div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">手機號碼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="tel" class="form-input-styled flex-1" placeholder="09xx-xxx-xxx">
                                    <button id="merchant-send-code-btn" class="px-3 h-11 rounded-full bg-gray-100 text-sm">${appState.codeSent?'重新發送':'發送驗證碼'}</button>
                                </div>
                            </div>
                            ${appState.codeSent ? `
                            <div>
                                <label class="text-sm font-medium text-[#886364]">輸入驗證碼</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" class="form-input-styled flex-1" placeholder="6 位數碼">
                                    <button id="merchant-verify-code-btn" class="btn-main h-11 px-4">驗證</button>
                                </div>
                                ${appState.smsVerified?'<p class="text-xs text-emerald-600 mt-1">驗證成功</p>':''}
                            </div>` : ''}
                            <div class="mt-6">
                                <button id="merchant-next-btn" class="btn-main" ${appState.smsVerified?'' : 'disabled'}>下一步：送出審核</button>
                            </div>
                        </div>`;
                }

                function renderStep3SubmitAndReview() {
                    const isUnderReview = window.merchantApplicationStatus === 'under_review' || window.merchantApplicationStatus === 're_review';
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">送出審核（狀態：${isUnderReview?'審核中':'尚未送出'}）</div>
                            ${!isUnderReview ? `<button id="merchant-submit-review-btn" class="btn-main w-full">送出審核</button>` : ''}
                            ${isUnderReview ? `
                            <div class="bg-white border rounded-xl p-4 text-sm">
                                <p class="text-[#181111] font-bold mb-1">審核中</p>
                                <p class="text-[#886364]">我們會於 1-3 個工作天完成審核，並以信件通知結果。</p>
                            </div>
                            <div class="text-xs text-[#886364]">（示意）管理者操作：
                                <div class="flex gap-2 mt-2">
                                    <button id="simulate-approve-btn" class="px-3 py-2 rounded-full bg-emerald-100 text-emerald-700">模擬審核通過</button>
                                    <button id="simulate-reject-btn" class="px-3 py-2 rounded-full bg-red-100 text-red-700">模擬退審</button>
                                </div>
                            </div>` : ''}
                        </div>`;
                }

                function renderStep4Outcome() {
                    if (appState.outcome === 'approved') {
                        return `
                            <div class="space-y-4 px-2">
                                <div class="bg-white border rounded-xl p-4">
                                    <p class="text-base font-bold text-[#181111] mb-1">審核通過</p>
                                    <p class="text-sm text-[#886364]">已寄出入駐成功信件，歡迎成為合作商家！</p>
                                </div>
                                <button id="go-dashboard-btn" class="btn-main w-full">進入商家後台</button>
                            </div>`;
                    }
                    return `
                        <div class="space-y-4 px-2">
                            <div class="bg-white border rounded-xl p-4">
                                <p class="text-base font-bold text-[#181111] mb-1">退審</p>
                                <p class="text-sm text-[#886364] mb-3">以下為不通過原因，請更新資料後再次送出。</p>
                                <textarea id="reject-reason-input" class="form-input-styled w-full" rows="3" placeholder="範例：資料不完整、地址無法驗證等">${window.merchantLastRejectReason}</textarea>
                            </div>
                            <div class="flex gap-2">
                                <button id="resubmit-btn" class="btn-main flex-1">更新資料並再次送出</button>
                            </div>
                        </div>`;
                }

                render();
            }

            function renderOrdersPage() {
                const container = pages.orders;
                container.innerHTML = `
                    <div class="p-4">
                        <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">我的訂單</h1>
                        <div class="flex justify-around bg-[#f4f0f0] rounded-full p-1 mb-5">
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="pending">進行中</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="completed">已完成</button>
                            <button class="order-filter-btn flex-1 py-2 text-sm font-medium rounded-full" data-filter="cancelled">已取消</button>
                        </div>
                        <div id="order-list" class="space-y-4">
                            <!-- 訂單卡片由JS生成 -->
                        </div>
                    </div>
                `;
                renderOrders('pending');
            }

            function renderOrders(filter) {
                const container = document.getElementById('order-list');
                const filterButtons = document.querySelectorAll('.order-filter-btn');
                
                if (!container || !filterButtons) return;

                filterButtons.forEach(btn => {
                    btn.classList.toggle('bg-[#181111]', btn.dataset.filter === filter);
                    btn.classList.toggle('text-white', btn.dataset.filter === filter);
                    btn.classList.toggle('text-[#886364]', btn.dataset.filter !== filter);
                });

                const filteredOrders = mockOrders.filter(order => order.status === filter);
                if (filteredOrders.length === 0) {
                    container.innerHTML = `<p class="text-center text-[#886364]">沒有${filter === 'pending' ? '進行中' : filter === 'completed' ? '已完成' : '已取消'}的訂單。</p>`;
                    return;
                }
                container.innerHTML = filteredOrders.map(order => {
                    let statusBadge;
                    switch(order.status) {
                        case 'pending': statusBadge = `<span class="text-xs font-bold text-white bg-amber-500 px-2 py-1 rounded-full">進行中</span>`; break;
                        case 'completed': statusBadge = `<span class="text-xs font-bold text-white bg-emerald-500 px-2 py-1 rounded-full">已完成</span>`; break;
                        case 'cancelled': statusBadge = `<span class="text-xs font-bold text-white bg-red-500 px-2 py-1 rounded-full">已取消</span>`; break;
                    }
                    return `
                        <div class="bg-white p-4 rounded-xl border border-gray-100">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-base text-[#181111]">${order.name}</h3>
                                ${statusBadge}
                            </div>
                            <p class="text-sm text-[#886364] mb-1">日期: ${order.date}</p>
                            <p class="text-sm text-[#886364] mb-3">寵物: ${order.pet}</p>
                            <div class="flex justify-between items-center mt-3 border-t pt-3">
                                <span class="text-base font-bold text-[#181111]">總計: NT$ ${order.total.toLocaleString()}</span>
                                <button class="py-2 px-4 bg-[#181111] text-white rounded-full text-sm">查看詳情</button>
                            </div>
                        </div>`;
                }).join('');
            }
            
            function renderFavoritesPage() {
                const container = pages.favorites;
                container.innerHTML = `
                <div class="p-4">
                    <h1 class="text-2xl font-bold mb-4 text-center text-[#181111]">我的收藏</h1>
                    <div class="space-y-4">
                        <div class="listing-card">
                            <div class="info-section">
                                <div class="flex flex-col gap-1">
                                    <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.9 • 150 則評價</p>
                                    <p class="text-[#181111] text-base font-bold leading-tight">貓語天堂</p>
                                    <p class="text-[#886364] text-sm font-normal leading-normal">新北市 • 僅接受貓</p>
                                </div>
                                <button class="text-sm text-red-600 w-fit">移除收藏</button>
                            </div>
                            <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1596854407944-bf87f6fdd49e?q=80&w=800");'></div>
                        </div>
                         <div class="listing-card">
                            <div class="info-section">
                                <div class="flex flex-col gap-1">
                                    <p class="text-[#886364] text-sm font-normal leading-normal">⭐️ 4.7 • 85 則評價</p>
                                    <p class="text-[#181111] text-base font-bold leading-tight">汪星人度假村</p>
                                    <p class="text-[#886364] text-sm font-normal leading-normal">台中市 • 僅接受犬</p>
                                </div>
                                 <button class="text-sm text-red-600 w-fit">移除收藏</button>
                            </div>
                            <div class="image-section" style='background-image: url("https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=600");'></div>
                        </div>
                         <div class="p-4 text-center text-[#886364]">沒有更多收藏了。</div>
                    </div>
                </div>
                `;
            }

            function renderSettingsPage() {
                const container = pages.settings;
                container.innerHTML = `
                <div class="sticky top-0 z-10 bg-white border-b border-gray-100">
                    <div class="px-4 py-3 flex items-center justify-between">
                        <button id="settings-back-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
                            </svg>
                        </button>
                        <h2 class="text-[#181111] text-base font-bold">設定</h2>
                        <div class="w-8"></div>
                    </div>
                </div>

                <div class="p-4">
                    <!-- 標籤導航 -->
                    <div class="flex gap-2 overflow-x-auto pb-2 mb-4">
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active" data-tab="general">一般設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="notifications">通知設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="profile">個人資料</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="system">系統設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="payment">付款設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="pets">寵物設定</button>
                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="emergency">緊急聯絡</button>

                        <button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="support">支援</button>
                        ${isUserMerchant ? '<button class="settings-tab-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap" data-tab="merchant">商家設定</button>' : ''}
                    </div>

                    <!-- 設定內容區域 -->
                    <div id="settings-content" class="space-y-6">
                        <!-- 一般設定 -->
                        <div id="general-settings" class="settings-tab-content active">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">一般設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">語言</label>
                                    <select class="form-input-styled">
                                        <option value="zh-TW">繁體中文</option>
                                        <option value="en">English</option>
                                        <option value="ja">日本語</option>
                                    </select>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">主題</label>
                                    <div class="flex gap-2">
                                        <button class="px-4 py-2 rounded-lg bg-[#181111] text-white text-sm font-medium">淺色</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">深色</button>
                                        <button class="px-4 py-2 rounded-lg bg-gray-200 text-[#181111] text-sm font-medium border border-gray-200">自動</button>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- 通知設定 -->
                        <div id="notifications-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">通知設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">推播通知</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">電子郵件通知</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- 個人資料 -->
                        <div id="profile-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">個人資料</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">姓名</label>
                                    <input type="text" value="James Chen" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">電子郵件</label>
                                    <input type="email" value="james@example.com" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">手機號碼</label>
                                    <input type="tel" value="+886 912-345-678" class="form-input-styled">
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">變更密碼</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 系統設定 -->
                        <div id="system-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">系統設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">位置服務</label>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">相機存取</label>
                                        </div>
                                        <label class="text-sm text-[#886364]">已允許</label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">清除快取</button>
                                </div>
                            </div>
                        </div>

                        <!-- 付款設定 -->
                        <div id="payment-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">付款設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">預設付款方式</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-1" checked>
                                            <label for="card-1" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">💳 Visa ****1234</span>
                                                    <span class="text-xs text-[#886364]">到期日: 12/25</span>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                            <input type="radio" name="default-payment" id="card-2">
                                            <label for="card-2" class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-medium">💳 Mastercard ****5678</span>
                                                    <span class="text-xs text-[#886364]">到期日: 08/26</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11">新增付款方式</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">發票設定</h4>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-1" checked>
                                            <label for="invoice" class="text-sm">電子發票</label>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <input type="radio" name="invoice" id="invoice-2">
                                            <label for="invoice" class="text-sm">紙本發票</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 寵物設定 -->
                        <div id="pets-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">寵物設定</h3>
                            
                            <!-- 寵物選擇器 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="block text-sm font-medium text-[#181111]">選擇寵物</label>
                                    <button class="add-pet-btn p-2 rounded-full bg-[#181111] text-white hover:bg-gray-800">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="flex gap-2 overflow-x-auto pb-2">
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap active bg-[#181111] text-white" data-pet="pet1">🐕 小黃</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet2">🐱 咪咪</button>
                                    <button class="pet-selector-btn px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap bg-gray-200 text-[#181111]" data-pet="pet3">🐰 小白</button>
                                </div>
                            </div>

                            <!-- 寵物照片 -->
                            <div class="bg-white p-4 rounded-xl border border-gray-100 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-[#181111]">寵物照片</h4>
                                    <button class="change-photo-btn px-3 py-1 text-xs bg-[#181111] text-white rounded-full hover:bg-gray-800">更換照片</button>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="relative mb-3">
                                        <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?w=150&h=150&fit=crop&crop=center" 
                                             alt="小黃的照片" 
                                             class="w-32 h-32 rounded-full object-cover border-4 border-gray-100 shadow-lg">
                                        <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-[#181111] rounded-full flex items-center justify-center">
                                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                        </div>
                                    </div>
                                    <p class="text-sm text-[#886364] text-center">點擊「更換照片」來上傳新的寵物照片</p>
                                </div>
                            </div>

                            <!-- 寵物詳細設定 -->
                            <div class="space-y-4">
                                <!-- 寵物基本資訊 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">基本資訊</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">暱稱</label>
                                            <input type="text" value="小黃" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">品種</label>
                                            <input type="text" value="黃金獵犬" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">年齡</label>
                                            <input type="number" value="3" class="form-input-styled text-sm" min="0" max="30">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">體重 (kg)</label>
                                            <input type="number" value="25" class="form-input-styled text-sm" min="0" step="0.1">
                                        </div>
                                    </div>
                                </div>

                                <!-- 寵物偏好設定 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">偏好設定</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">喜歡的玩具</label>
                                            <input type="text" value="網球、飛盤" class="form-input-styled text-sm" placeholder="輸入寵物喜歡的玩具...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">喜歡的活動</label>
                                            <input type="text" value="散步、游泳" class="form-input-styled text-sm" placeholder="輸入寵物喜歡的活動...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">飲食偏好</label>
                                            <input type="text" value="乾糧、雞肉" class="form-input-styled text-sm" placeholder="輸入寵物的飲食偏好...">
                                        </div>
                                    </div>
                                </div>

                                <!-- 健康與特殊需求 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">健康與特殊需求</h4>
                                    <div class="space-y-3">
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">健康記錄提醒</label>
                                                    <p class="text-xs text-[#886364]">定期提醒寵物健康檢查</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- 健康提醒詳細設定 -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">疫苗提醒</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="3">每3個月</option>
                                                            <option value="6" selected>每6個月</option>
                                                            <option value="12">每年</option>
                                                            <option value="custom">自訂</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">健康檢查</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="6">每6個月</option>
                                                            <option value="12" selected>每年</option>
                                                            <option value="18">每18個月</option>
                                                            <option value="custom">自訂</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-[#886364] mb-1">下次提醒日期</label>
                                                    <input type="date" value="2025-06-15" class="form-input-styled text-xs">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <label class="block text-sm font-medium text-[#181111]">寵物檔案同步</label>
                                                    <p class="text-xs text-[#886364]">自動同步寵物資訊到雲端</p>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <!-- 同步詳細設定 -->
                                            <div class="pl-4 space-y-2 border-l-2 border-gray-200">
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">同步頻率</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="realtime">即時同步</option>
                                                            <option value="hourly">每小時</option>
                                                            <option value="daily" selected>每天</option>
                                                            <option value="weekly">每週</option>
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-[#886364] mb-1">同步內容</label>
                                                        <select class="form-input-styled text-xs">
                                                            <option value="all" selected>全部資訊</option>
                                                            <option value="basic">基本資訊</option>
                                                            <option value="health">健康記錄</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <input type="checkbox" id="sync-photos" checked class="w-4 h-4">
                                                    <label for="sync-photos" class="text-xs text-[#886364]">同步寵物照片</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">過敏原</label>
                                            <input type="text" value="海鮮、花生" class="form-input-styled text-sm" placeholder="輸入寵物的過敏原...">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">特殊需求</label>
                                            <textarea class="form-input-styled text-sm" rows="2" placeholder="記錄寵物的特殊需求、醫療狀況等...">需要定期服藥，關節較敏感</textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- 儲存按鈕 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 緊急聯絡設定 -->
                        <div id="emergency-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">緊急聯絡設定</h3>
                            
                            <div class="space-y-4">
                                <!-- 主要聯絡人 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">主要聯絡人</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">姓名</label>
                                            <input type="text" value="王小明" class="form-input-styled text-sm" placeholder="輸入聯絡人姓名">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">電話</label>
                                            <input type="tel" value="+886 912-345-678" class="form-input-styled text-sm" placeholder="輸入聯絡人電話">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">關係</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family">家人</option>
                                                <option value="friend" selected>朋友</option>
                                                <option value="colleague">同事</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- 備用聯絡人 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <h4 class="font-medium text-[#181111] mb-3">備用聯絡人</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">姓名</label>
                                            <input type="text" value="李小華" class="form-input-styled text-sm" placeholder="輸入備用聯絡人姓名">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">電話</label>
                                            <input type="tel" value="+886 987-654-321" class="form-input-styled text-sm" placeholder="輸入備用聯絡人電話">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">關係</label>
                                            <select class="form-input-styled text-sm">
                                                <option value="family" selected>家人</option>
                                                <option value="friend">朋友</option>
                                                <option value="colleague">同事</option>
                                                <option value="other">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>





                                <!-- 儲存按鈕 -->
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-3">
                                        <button class="btn-main h-11 flex-1">儲存變更</button>
                                        <button class="btn-secondary h-11 flex-1">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 支援 -->
                        <div id="support-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">支援</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">幫助中心</button>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <button class="btn-main h-11 w-full">意見回饋</button>
                                </div>
                            </div>
                        </div>

                        <!-- 商家設定 -->
                        ${isUserMerchant ? `
                        <div id="merchant-settings" class="settings-tab-content hidden">
                            <h3 class="text-lg font-bold text-[#181111] mb-4">商家設定</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">自動確認訂單</label>
                                            <p class="text-xs text-[#886364] mt-1">自動確認符合條件的訂單</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <label class="block text-sm font-medium text-[#181111]">庫存警告</label>
                                            <p class="text-xs text-[#886364] mt-1">庫存不足時發送通知</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">營業時間</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">開始時間</label>
                                            <input type="time" value="09:00" class="form-input-styled text-sm">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-[#886364] mb-1">結束時間</label>
                                            <input type="time" value="18:00" class="form-input-styled text-sm">
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <label class="block text-sm font-medium text-[#181111] mb-2">自動回覆訊息</label>
                                    <textarea class="form-input-styled" rows="3" placeholder="設定自動回覆客戶的訊息..."></textarea>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                `;

                attachSettingsListeners();
            }

            function attachSettingsListeners() {
                // 返回按鈕
                document.getElementById('settings-back-btn')?.addEventListener('click', () => showPage('account'));
                
                // 標籤切換
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabName = btn.dataset.tab;
                        switchSettingsTab(tabName);
                    });
                });

                // 寵物選擇器
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const petId = btn.dataset.pet;
                        switchPetSettings(petId);
                    });
                });

                // 新增寵物按鈕
                document.querySelector('.add-pet-btn')?.addEventListener('click', () => {
                    addNewPet();
                });

                // 更換照片按鈕
                document.querySelector('.change-photo-btn')?.addEventListener('click', () => {
                    changePetPhoto();
                });
            }

            function switchSettingsTab(activeTab) {
                // 更新標籤按鈕狀態
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === activeTab);
                });
                
                // 隱藏所有內容
                document.querySelectorAll('.settings-tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // 顯示選中的內容
                const targetContent = document.getElementById(`${activeTab}-settings`);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                }
            }

            function switchPetSettings(petId) {
                // 更新寵物選擇器按鈕狀態
                document.querySelectorAll('.pet-selector-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.pet === petId);
                    if (btn.dataset.pet === petId) {
                        btn.classList.remove('bg-gray-200', 'text-[#181111]');
                        btn.classList.add('bg-[#181111]', 'text-white');
                    } else {
                        btn.classList.remove('bg-[#181111]', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-[#181111]');
                    }
                });

                // 這裡可以根據選擇的寵物更新表單內容
                // 實際應用中會從資料庫或狀態管理中獲取寵物資訊
                console.log('切換到寵物:', petId);
            }

            function addNewPet() {
                // 新增寵物的邏輯
                // 實際應用中會開啟新增寵物的模態視窗或導航到新增頁面
                alert('新增寵物功能 - 這裡會開啟新增寵物的表單');
            }

            function changePetPhoto() {
                // 創建隱藏的文件輸入元素
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                
                // 監聽文件選擇
                fileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        // 檢查文件類型
                        if (!file.type.startsWith('image/')) {
                            alert('請選擇圖片檔案');
                            return;
                        }
                        
                        // 檢查文件大小 (限制為 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('圖片檔案大小不能超過 5MB');
                            return;
                        }
                        
                        // 創建預覽
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const petPhoto = document.querySelector('#pets-settings img');
                            if (petPhoto) {
                                petPhoto.src = e.target.result;
                                // 這裡可以添加上傳到伺服器的邏輯
                                console.log('寵物照片已更新');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // 觸發文件選擇
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            }

            function renderMerchantDashboard() {
                const container = pages.merchantDashboard;
                container.innerHTML = `
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center text-[#181111]">商家專區</h1>
                    <!-- 儀表板概覽 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white">
                        <h2 class="text-lg font-bold text-[#181111] mb-4">儀表板概覽</h2>
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg">待處理訂單: <span class="font-bold text-blue-700">5</span></div>
                            <div class="p-3 bg-green-50 rounded-lg">今日入住: <span class="font-bold text-green-700">2</span></div>
                            <div class="p-3 bg-yellow-50 rounded-lg col-span-2">本月營收: <span class="font-bold text-yellow-700">NT$ 15,000</span></div>
                        </div>
                        <button id="manage-calendar-btn" class="btn-main h-10 px-5 text-sm w-full">管理行事曆</button>
                    </div>

                    <!-- 房型與方案管理 -->
                    <div id="manage-rooms-link" class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">房型與方案管理</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">管理您的房型與價格方案</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                     <!-- 訂單管理 -->
                    <div class="p-4 rounded-xl border border-gray-100 bg-white cursor-pointer hover:bg-gray-50">
                        <h2 class="text-lg font-bold text-[#181111] mb-2">訂單管理</h2>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-[#886364]">查看與確認所有訂單</p>
                            <span class="text-[#886364]">></span>
                        </div>
                    </div>
                </div>
                `;
            }

            function renderRoomListPage() {
                const container = pages.roomManagement;
                container.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-[#181111]">房型管理</h1>
                            <button id="add-new-room-btn" class="btn-main h-10 px-5 text-sm w-auto">＋ 新增房型</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${mockRoomTypes.map(room => `
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-4">
                                        <img src="${room.imageUrl}" class="w-20 h-20 rounded-lg object-cover">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-[#181111] truncate">${room.name}</h3>
                                                <span class="text-xs font-semibold ${room.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'} px-2 py-0.5 rounded-full">${room.status === 'active' ? '啟用中' : '已禁用'}</span>
                                            </div>
                                            <p class="text-sm text-[#886364] mt-1 truncate">${room.description}</p>
                                            <p class="text-sm font-bold text-[#181111] mt-2">總庫存: ${room.stock} 間</p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button class="py-1 px-3 bg-red-100 text-red-600 rounded-full text-xs font-medium">刪除</button>
                                        <button class="edit-room-btn py-1 px-3 bg-gray-200 text-gray-800 rounded-full text-xs font-medium" data-room-id="${room.id}">編輯</button>
                                        <button class="manage-packages-btn py-1 px-3 bg-[#181111] text-white rounded-full text-xs font-medium" data-room-id="${room.id}">管理方案</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                         <div class="pt-4 mt-2">
                            <button id="back-to-dashboard-btn" class="flex cursor-pointer items-center justify-center w-full h-12 rounded-full bg-gray-200 text-[#181111] font-bold">返回商家專區</button>
                        </div>
                    </div>
                `;
            }
            
            function renderPackageListPage(roomId) {
                const container = pages.packageManagement;
                const room = mockRoomTypes.find(r => r.id === roomId);
                if (!room) {
                    container.innerHTML = '<div class="p-4 text-center text-red-500">找不到該房型資訊。</div>';
                    return;
                }

                const roomPackages = mockPackages.filter(p => p.roomId === roomId);

                container.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-xl font-bold text-[#181111]">管理 ${room.name} 的方案</h1>
                            <button id="add-new-package-btn" class="btn-main h-10 px-5 text-sm w-auto" data-room-id="${roomId}">＋ 新增方案</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            ${roomPackages.length > 0 ? roomPackages.map(pkg => `
                                <div class="bg-white p-4 rounded-xl border border-gray-100">
                                    <div class="flex gap-4 items-center">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <h3 class="font-bold text-[#181111]">${pkg.name}</h3>
                                                <span class="text-xs font-semibold ${pkg.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'} px-2 py-0.5 rounded-full">${pkg.status === 'active' ? '啟用中' : '已禁用'}</span>
                                            </div>
                                            <p class="text-sm text-[#886364] mt-1">計價: ${pkg.type === 'overnight' ? '天' : '小時'}</p>
                                            <p class="text-sm font-bold text-[#181111] mt-2">
                                                ${pkg.type === 'overnight' ? `NT$ ${pkg.basePrice} / 晚` : `NT$ ${pkg.basePrice} / 小時`}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-3">
                                        <button class="py-1 px-3 bg-red-100 text-red-600 rounded-full text-xs font-medium">刪除</button>
                                        <button class="edit-package-btn py-1 px-3 bg-gray-200 text-gray-800 rounded-full text-xs font-medium" data-package-id="${pkg.id}" data-room-id="${roomId}">編輯</button>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="p-4 text-center text-[#886364] border border-dashed rounded-xl">此房型目前沒有任何方案。點擊「新增方案」建立第一個吧！</div>
                            `}
                        </div>
                        <div class="pt-4 mt-2">
                            <button id="back-to-room-list-btn" class="flex cursor-pointer items-center justify-center w-full h-12 rounded-full bg-gray-200 text-[#181111] font-bold">返回房型列表</button>
                        </div>
                    </div>
                `;
            }
            
            function renderPackageForm(roomId, packageId) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                const packageData = packageId ? mockPackages.find(p => p.id === packageId) : null;
                const isEditing = !!packageData;

                formModal.innerHTML = `
                    <div class="p-4 overflow-y-auto max-h-full">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                            <button id="cancel-form-btn" class="text-lg font-bold p-2">&lt; 返回</button>
                            <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">${isEditing ? '編輯方案' : '新增方案'}</h1>
                            <div class="w-20"></div>
                        </div>
                        <div class="space-y-4 px-2">
                            <div class="bg-gray-100 p-3 rounded-lg text-sm text-gray-700">
                                為房型 <strong>"${room.name}"</strong> 設定方案
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">方案名稱</label>
                                <input type="text" class="form-input-styled mt-1" id="package-name" value="${isEditing ? packageData.name : ''}" placeholder="例如：標準日租方案">
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">方案描述</label>
                                <textarea class="form-input-styled mt-1 h-24" id="package-description" placeholder="詳細說明方案內容...">${isEditing ? packageData.description || '' : ''}</textarea>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">計價單位</label>
                                <div class="flex space-x-4 mt-1">
                                    <label class="flex items-center">
                                        <input type="radio" name="pricing-unit" value="overnight" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && packageData.type === 'overnight' ? 'checked' : !isEditing ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                        <span class="ml-2 text-sm">天 (過夜寄宿)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="pricing-unit" value="daycare" class="h-4 w-4 text-[#181111] focus:ring-[#181111]" ${isEditing && packageData.type === 'daycare' ? 'checked' : ''} ${isEditing ? 'disabled' : ''}>
                                        <span class="ml-2 text-sm">小時 (日間安親)</span>
                                    </label>
                                </div>
                                ${isEditing ? '<p class="text-xs text-red-500 mt-1">計價單位儲存後不可修改。</p>' : ''}
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">基礎價格</label>
                                <input type="number" class="form-input-styled mt-1" id="base-price" value="${isEditing ? packageData.basePrice : ''}" min="0" placeholder="例如：800">
                            </div>

                            <div id="overnight-specific-fields" class="${!isEditing || packageData.type === 'overnight' ? '' : 'hidden'}">
                                <label class="text-sm font-medium text-[#886364]">最短預訂天數</label>
                                <input type="number" class="form-input-styled mt-1" id="min-days" value="${isEditing && packageData.type === 'overnight' ? packageData.min : 1}" min="1">
                                <label class="text-sm font-medium text-[#886364] mt-2">最長預訂天數 (選填)</label>
                                <input type="number" class="form-input-styled mt-1" id="max-days" value="${isEditing && packageData.type === 'overnight' && packageData.max ? packageData.max : ''}" min="1">
                            </div>

                            <div id="daycare-specific-fields" class="${isEditing && packageData.type === 'daycare' ? '' : 'hidden'}">
                                <label class="text-sm font-medium text-[#886364]">可選安親時長 (小時)</label>
                                <p class="text-xs text-gray-500 mb-1">輸入逗號分隔的時長選項，例如 "2,4,8"</p>
                                <input type="text" class="form-input-styled mt-1" id="daycare-lengths" value="${isEditing && packageData.type === 'daycare' && packageData.daycareLengths ? packageData.daycareLengths : ''}" placeholder="例如：2,4,8">
                                
                                <label class="text-sm font-medium text-[#886364] mt-4">每日可預訂時段</label>
                                <p class="text-xs text-gray-500 mb-1">設定此方案每天可接受預訂的起始與結束時間</p>
                                <div class="flex gap-2 mt-1">
                                    <input type="time" class="form-input-styled" id="start-time" value="${isEditing && packageData.startTime ? packageData.startTime : '09:00'}">
                                    <span>-</span>
                                    <input type="time" class="form-input-styled" id="end-time" value="${isEditing && packageData.endTime ? packageData.endTime : '18:00'}">
                                </div>
                                
                                <label class="text-sm font-medium text-[#886364] mt-4">超時費率 (每小時)</label>
                                <input type="number" class="form-input-styled mt-1" id="overtime-rate" value="${isEditing && packageData.overtimeRate ? packageData.overtimeRate : ''}" min="0" placeholder="例如：100">
                            </div>
                            
                            <div class="border-t pt-4">
                                <h3 class="text-sm font-bold text-[#181111] mb-2">上架與排程設定</h3>
                                <div class="space-y-2">
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="permanent" class="h-4 w-4 text-black focus:ring-black" checked> <span class="ml-2 text-sm">永久有效</span></label>
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="date-range" class="h-4 w-4 text-black focus:ring-black"> <span class="ml-2 text-sm">指定日期</span></label>
                                     <label class="flex items-center"><input type="radio" name="schedule-mode" value="recurring" class="h-4 w-4 text-black focus:ring-black"> <span class="ml-2 text-sm">循環顯示</span></label>
                                </div>
                            </div>
                            
                            <div id="date-range-fields" class="hidden pl-6 space-y-2 border-l-2 ml-2">
                                <label class="text-sm font-medium text-[#886364]">方案有效日期範圍</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <input type="date" id="package-start-date" class="form-input-styled text-center p-2" value="${isEditing ? packageData.startDate : ''}">
                                    <span>-</span>
                                    <input type="date" id="package-end-date" class="form-input-styled text-center p-2" value="${isEditing ? packageData.endDate : ''}">
                                </div>
                            </div>
                            
                            <div id="recurring-fields" class="hidden pl-6 space-y-4 border-l-2 ml-2">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">選擇循環星期</label>
                                    <div class="grid grid-cols-4 gap-2 mt-1">
                                        ${['日', '一', '二', '三', '四', '五', '六'].map(day => `<label class="flex items-center text-sm"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-1">${day}</span></label>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">展示時長</label>
                                    <select class="form-input-styled mt-1"><option>一個月</option><option>三個月</option><option>半年</option><option>一年</option></select>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">排除日期區間 (選填)</label>
                                    <div class="flex items-center gap-2 mt-1">
                                        <input type="date" class="form-input-styled text-center p-2">
                                        <span>-</span>
                                        <input type="date" class="form-input-styled text-center p-2">
                                    </div>
                                    <button class="text-xs text-blue-600 mt-1">+ 新增排除區間</button>
                                </div>
                            </div>

                            <div class="flex justify-between items-center border-t pt-4">
                                <label class="text-sm font-medium text-[#886364]">啟用狀態</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="package-status-toggle" ${!isEditing || packageData.status === 'active' ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="mt-6">
                            <button class="btn-main" id="save-package-btn" data-room-id="${roomId}" data-package-id="${packageId || ''}">儲存方案</button>
                        </div>
                    </div>
                `;
                formModal.classList.remove('hidden');
                attachPackageFormListeners();
            }
            
            function attachPackageFormListeners() {
                const pricingUnitRadios = formModal.querySelectorAll('input[name="pricing-unit"]');
                pricingUnitRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const overnightFields = formModal.querySelector('#overnight-specific-fields');
                        const daycareFields = formModal.querySelector('#daycare-specific-fields');
                        overnightFields.classList.toggle('hidden', this.value !== 'overnight');
                        daycareFields.classList.toggle('hidden', this.value !== 'daycare');
                    });
                });
                
                const scheduleModeRadios = formModal.querySelectorAll('input[name="schedule-mode"]');
                scheduleModeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const dateRangeFields = formModal.querySelector('#date-range-fields');
                        const recurringFields = formModal.querySelector('#recurring-fields');
                        dateRangeFields.classList.toggle('hidden', this.value !== 'date-range');
                        recurringFields.classList.toggle('hidden', this.value !== 'recurring');
                    });
                });
            }

            function renderRoomForm(roomId) {
                const roomData = roomId ? mockRoomTypes.find(r => r.id === roomId) : null;
                const isEditing = !!roomData;
                
                formModal.innerHTML = `
                    <div class="p-4 overflow-y-auto max-h-full">
                         <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 py-2 z-10">
                            <button id="cancel-form-btn" class="text-lg font-bold p-2">&lt; 返回</button>
                            <h1 class="text-xl font-bold text-[#181111] flex-1 text-center">${isEditing ? '編輯房型' : '新增房型'}</h1>
                            <div class="w-20"></div>
                        </div>
                        <div class="space-y-4 px-2">
                            <div>
                                <label class="text-sm font-medium text-[#886364]">房型名稱</label>
                                <input type="text" class="form-input-styled mt-1" value="${isEditing ? roomData.name : ''}">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">房型描述</label>
                                <textarea class="form-input-styled mt-1 h-24">${isEditing ? roomData.description : ''}</textarea>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-[#886364]">圖片上傳</label>
                                <div class="mt-1 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                                    <div class="text-center">
                                        <p class="mt-1 text-sm leading-6 text-gray-600">拖曳或點擊上傳</p>
                                    </div>
                                </div>
                            </div>
                             <div>
                                <label class="text-sm font-medium text-[#886364]">適用寵物種類</label>
                                <div class="space-y-2 mt-2">
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-black focus:ring-black" name="pet-type" value="dog"> <span class="ml-2 text-sm">狗</span></label>
                                    <div id="dog-size-options" class="hidden pl-6 space-y-2">
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">小型犬 (0-10公斤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">中型犬 (10-20公斤)</span></label>
                                         <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">大型犬 (20公斤以上)</span></label>
                                    </div>
                                    <label class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300"> <span class="ml-2 text-sm">貓</span></label>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">可容納寵物數</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? 1 : 1}">
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-[#886364]">房型總庫存</label>
                                    <input type="number" class="form-input-styled mt-1" value="${isEditing ? roomData.stock : 1}">
                                </div>
                            </div>
                             <div class="flex justify-between items-center">
                                <label class="text-sm font-medium text-[#886364]">啟用狀態</label>
                                <label class="toggle-switch"><input type="checkbox" ${isEditing && roomData.status === 'active' ? 'checked' : !isEditing ? 'checked' : ''}><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                        <div class="mt-6">
                             <button class="btn-main">儲存房型</button>
                        </div>
                    </div>
                `;
                formModal.classList.remove('hidden');
            }


            // --- 日曆功能 ---
            function openCalendar() {
                calendarModal.classList.remove('hidden');
                renderCalendar();
            }

            function renderCalendar() {
                const content = calendarModal.querySelector('.modal-content');
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h3 class="font-bold">${currentCalendarDate.getFullYear()}年 ${currentCalendarDate.getMonth() + 1}月</h3>
                        <button id="next-month" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 text-center text-sm gap-1"></div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="calendar-cancel" class="py-2 px-4 rounded-full bg-gray-200 text-sm">取消</button>
                        <button id="calendar-confirm" class="py-2 px-4 rounded-full bg-[#181111] text-white text-sm">確定</button>
                    </div>`;

                const daysGrid = document.getElementById('calendar-days');
                const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1).getDay();
                const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    daysGrid.innerHTML += `<div></div>`;
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), i);
                    const today = new Date(); today.setHours(0,0,0,0);
                    let classes = 'calendar-day';
                    if (dayDate < today) classes += ' disabled';
                    if (selectedCheckinDate && dayDate.getTime() === selectedCheckinDate.getTime()) classes += ' range-start';
                    if (selectedCheckoutDate && dayDate.getTime() === selectedCheckoutDate.getTime()) classes += ' range-end';
                    if (selectedCheckinDate && selectedCheckoutDate && dayDate > selectedCheckinDate && dayDate < selectedCheckoutDate) classes += ' in-range';
                    
                    daysGrid.innerHTML += `<div class="${classes}" data-date="${dayDate.toISOString().split('T')[0]}">${i}</div>`;
                }
            }
            
            function handleDateClick(e) {
                if (!e.target.matches('.calendar-day:not(.disabled)')) return;
                const clickedDate = new Date(e.target.dataset.date);
                if (isSelectingCheckin || clickedDate < selectedCheckinDate) {
                    selectedCheckinDate = clickedDate;
                    selectedCheckoutDate = null;
                    isSelectingCheckin = false;
                } else {
                    selectedCheckoutDate = clickedDate;
                    isSelectingCheckin = true;
                }
                renderCalendar();
            }

            function updatePrice() {
                const priceDisplay = document.getElementById('total-price-display');
                if (!priceDisplay) return;

                const selectedPackage = document.querySelector('.package-item.selected');
                if (!selectedPackage) {
                    priceDisplay.textContent = '請選擇方案';
                    return;
                }

                let total = 0;
                const packageType = selectedPackage.dataset.packageType;
                const basePrice = parseInt(selectedPackage.dataset.price);
                
                if (packageType === 'overnight') {
                    // 寄宿方案：根據住宿天數計算
                    if (selectedCheckinDate && selectedCheckoutDate && selectedCheckoutDate > selectedCheckinDate) {
                        const nights = Math.ceil((selectedCheckoutDate - selectedCheckinDate) / (1000 * 60 * 60 * 24));
                        total = basePrice * nights;
                    } else {
                        priceDisplay.textContent = '請選擇有效日期';
                        return;
                    }
                } else if (packageType === 'daycare') {
                    // 日間安親方案：檢查是否已選擇時段
                    const selectedTimeSlot = document.querySelector('.time-slot-btn.selected');
                    if (!selectedTimeSlot) {
                        priceDisplay.textContent = '請選擇時段';
                        return;
                    }
                    // 日間安親方案：單次計費
                    total = basePrice;
                }
                
                const petCount = parseInt(document.getElementById('pet-count').value);
                total *= petCount;

                document.querySelectorAll('.addon-service:checked').forEach(cb => {
                    total += parseInt(cb.dataset.price);
                });

                priceDisplay.textContent = `總計: NT$ ${total.toLocaleString()}`;
            }
            
            // 檢查指定日期範圍內的房間庫存
            function checkRoomAvailability(roomId, startDate, endDate) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                if (!room || room.status !== 'active') return 0;
                
                // 計算該日期範圍內的預訂數量
                const conflictingBookings = mockBookings.filter(booking => {
                    if (booking.roomId !== roomId) return false;
                    
                    const bookingStart = new Date(booking.startDate);
                    const bookingEnd = new Date(booking.endDate);
                    const checkStart = new Date(startDate);
                    const checkEnd = new Date(endDate);
                    
                    // 檢查日期重疊
                    return (bookingStart <= checkEnd && bookingEnd >= checkStart);
                });
                
                const usedCapacity = conflictingBookings.length;
                return Math.max(0, room.stock - usedCapacity);
            }
            
            // 渲染房型選項
            function renderRoomOptions() {
                const container = document.getElementById('room-options-container');
                if (!container) return;
                
                const today = new Date();
                const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                const startDate = selectedCheckinDate ? selectedCheckinDate.toISOString().split('T')[0] : today.toISOString().split('T')[0];
                const endDate = selectedCheckoutDate ? selectedCheckoutDate.toISOString().split('T')[0] : tomorrow.toISOString().split('T')[0];
                
                let roomOptionsHTML = '';
                
                // 根據假資料渲染房型與方案
                const roomConfigs = [
                    { 
                        name: '標準房 (小型犬)', 
                        roomId: 1, 
                        description: '舒適的標準房，適合中小型犬',
                        packages: [
                            { name: '日租方案', price: 800, type: 'overnight' },
                            { 
                                name: '安親方案A', 
                                price: 150, 
                                type: 'daycare', 
                                duration: 4,
                                timeSlots: [
                                    { time: '09:00-13:00', available: true },
                                    { time: '14:00-18:00', available: true }
                                ]
                            },
                            { 
                                name: '安親方案B', 
                                price: 120, 
                                type: 'daycare', 
                                duration: 8,
                                timeSlots: [
                                    { time: '09:00-17:00', available: true },
                                    { time: '10:00-18:00', available: false }
                                ]
                            }
                        ]
                    },
                    { 
                        name: '豪華套房 (中大型犬)', 
                        roomId: 2, 
                        description: '寬敞的豪華套房，適合中大型犬',
                        packages: [
                            { name: '日租方案', price: 1500, type: 'overnight' }
                        ]
                    },
                    { 
                        name: '貓咪專屬空間', 
                        roomId: 3, 
                        description: '專為貓咪設計的舒適空間',
                        packages: [
                            { name: '日租方案', price: 700, type: 'overnight' }
                        ]
                    },
                    { 
                        name: '陽光豪華雙人房', 
                        roomId: 4, 
                        description: '附有陽台的雙寵物豪華房',
                        packages: [
                            { name: '日租方案', price: 1200, type: 'overnight' }
                        ]
                    }
                ];
                
                roomConfigs.forEach((config, roomIndex) => {
                    const availableStock = checkRoomAvailability(config.roomId, startDate, endDate);
                    const isAvailable = availableStock > 0;
                    const isFirstRoom = roomIndex === 0;
                    
                    roomOptionsHTML += `
                        <div class="p-3 rounded-lg border-2 border-transparent ${!isAvailable ? 'unavailable' : ''}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-bold text-sm ${!isAvailable ? 'text-gray-400' : 'text-[#181111]'}">${config.name}</p>
                                    <p class="text-xs text-gray-500 mt-1">${config.description}</p>
                                    ${!isAvailable ? '<p class="text-xs text-red-500 mt-1">❌ 已滿房</p>' : `<p class="text-xs text-green-600 mt-1">✅ 可訂房 (剩餘 ${availableStock} 間)</p>`}
                                </div>
                            </div>
                            <div class="space-y-2 mt-2">
                                ${config.packages.map((pkg, pkgIndex) => {
                                    const isFirstPackage = isFirstRoom && pkgIndex === 0;
                                    const packageId = `package-${config.roomId}-${pkgIndex}`;
                                    let priceUnit = '';
                                    if (pkg.type === 'overnight') {
                                        priceUnit = '/ 晚';
                                    } else if (pkg.type === 'daycare' && pkg.duration) {
                                        priceUnit = `/ ${pkg.duration}hr`;
                                    } else {
                                        priceUnit = '/ 次';
                                    }
                                    
                                    let packageHTML = `
                                        <div class="package-wrapper">
                                            <div class="package-item p-3 rounded-lg ${isAvailable ? 'cursor-pointer' : ''} ${isFirstPackage && isAvailable ? 'selected' : ''}" 
                                                 data-price="${pkg.price}" 
                                                 data-room-id="${config.roomId}"
                                                 data-package-type="${pkg.type}"
                                                 data-package-id="${packageId}"
                                                 ${!isAvailable ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-sm">${pkg.name}</span>
                                                    <span class="font-bold text-sm">NT$ ${pkg.price.toLocaleString()} ${priceUnit}</span>
                                                </div>
                                            </div>
                                    `;
                                    
                                    // 如果是安親方案且有時段選擇，添加時段選擇區域
                                    if (pkg.type === 'daycare' && pkg.timeSlots && isAvailable) {
                                        packageHTML += `
                                            <div class="time-slots-container mt-2 ml-4 hidden" id="timeslots-${packageId}">
                                                <p class="text-xs text-gray-600 mb-2">選擇時段：</p>
                                                <div class="flex flex-wrap gap-2">
                                                    ${pkg.timeSlots.map((slot, slotIndex) => `
                                                        <button class="time-slot-btn px-3 py-1 text-sm rounded-full border transition-all ${slot.available ? 'border-gray-300 hover:border-gray-400 hover:bg-gray-50' : 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed'}" 
                                                                data-package-id="${packageId}"
                                                                data-slot-time="${slot.time}"
                                                                ${!slot.available ? 'disabled' : ''}>
                                                            ${slot.time}
                                                            ${!slot.available ? ' (已滿)' : ''}
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    
                                    packageHTML += `</div>`;
                                    return packageHTML;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = roomOptionsHTML;
                
                // 重新綁定事件監聽器
                attachRoomOptionListeners();
            }
            
            // 訂房流程相關變數
            let bookingStep = 1;
            let bookingData = {
                serviceType: '',
                dates: { checkin: null, checkout: null },
                timeSlot: '',
                roomId: null,
                packageId: null,
                preferredRoomId: null, // 用戶偏好的房型
                petCount: 1,
                addons: [],
                serviceDate: null, // 日間安親的服務日期
                selectedPlan: null, // 選擇的方案
                planPrice: null, // 方案價格
                checkinDate: null, // 入住日期
                checkoutDate: null, // 退房日期
                stayDuration: null, // 入住天數
                duration: null, // 日間安親時長
                customPrice: null, // 自訂價格
                timeSlotName: null // 時段名稱
            };
            
            // 渲染訂房流程頁面
            function renderBookingFlowPage() {
                const container = pages.bookingFlow;
                
                if (bookingStep === 4) {
                    renderConfirmationStep();
                } else {
                    // 如果出現其他步驟，回到詳情頁
                    showPage('detail');
                }
            }
            

            
            // 步驟2: 選擇日期時間
            function renderDateTimeStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- 標題與進度 -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">選擇${isOvernight ? '日期' : '日期與時段'}</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">步驟 1/3</p>
                            </div>
                        </div>
                        
                        <!-- 日期選擇 -->
                        <div class="space-y-4 mb-8">
                            ${isOvernight ? `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">入住/退房日期</h3>
                                    <div class="flex items-center gap-2">
                                        <input type="date" id="booking-checkin" class="form-input-styled text-center flex-1">
                                        <span class="text-gray-400">-</span>
                                        <input type="date" id="booking-checkout" class="form-input-styled text-center flex-1">
                                    </div>
                                </div>
                            ` : `
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">選擇日期</h3>
                                    <input type="date" id="booking-date" class="form-input-styled text-center w-full">
                                </div>
                                
                                <div>
                                    <h3 class="font-bold text-[#181111] mb-3">選擇時段</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-13:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">上午時段</span>
                                                <span class="text-sm text-gray-500">09:00-13:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="14:00-18:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">下午時段</span>
                                                <span class="text-sm text-gray-500">14:00-18:00</span>
                                            </div>
                                        </div>
                                        <div class="time-slot-option p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-[#181111]" data-slot="09:00-17:00">
                                            <div class="flex justify-between items-center">
                                                <span class="font-medium">全日時段</span>
                                                <span class="text-sm text-gray-500">09:00-17:00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <!-- 底部按鈕 -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                繼續
                            </button>
                        </div>
                    </div>
                `;
                
                attachDateTimeListeners();
            }
            
            // 綁定日期時間選擇事件
            function attachDateTimeListeners() {
                const isOvernight = bookingData.serviceType === 'overnight';
                
                if (isOvernight) {
                    // 寄宿服務的日期處理
                    const checkinInput = document.getElementById('booking-checkin');
                    const checkoutInput = document.getElementById('booking-checkout');
                    
                    // 設定預設日期
                    const today = new Date();
                    const tomorrow = new Date(today.getTime() + (24 * 60 * 60 * 1000));
                    checkinInput.value = today.toISOString().split('T')[0];
                    checkoutInput.value = tomorrow.toISOString().split('T')[0];
                    
                    // 立即更新資料並啟用按鈕
                    bookingData.dates.checkin = checkinInput.value;
                    bookingData.dates.checkout = checkoutInput.value;
                    enableNextButton();
                    
                    checkinInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        // 確保退房日期不早於入住日期
                        if (this.value >= checkoutInput.value) {
                            const nextDay = new Date(this.value);
                            nextDay.setDate(nextDay.getDate() + 1);
                            checkoutInput.value = nextDay.toISOString().split('T')[0];
                            bookingData.dates.checkout = checkoutInput.value;
                        }
                        checkDatesValid();
                    });
                    
                    checkoutInput.addEventListener('change', function() {
                        bookingData.dates.checkout = this.value;
                        checkDatesValid();
                    });
                    
                } else {
                    // 安親服務的日期和時段處理
                    const dateInput = document.getElementById('booking-date');
                    const today = new Date();
                    dateInput.value = today.toISOString().split('T')[0];
                    bookingData.dates.checkin = dateInput.value;
                    
                    dateInput.addEventListener('change', function() {
                        bookingData.dates.checkin = this.value;
                        checkDatesValid();
                    });
                    
                    // 時段選擇
                    document.querySelectorAll('.time-slot-option').forEach(option => {
                        option.addEventListener('click', function() {
                            // 移除其他選項的選中狀態
                            document.querySelectorAll('.time-slot-option').forEach(opt => {
                                opt.classList.remove('border-[#181111]', 'bg-gray-50');
                                opt.classList.add('border-gray-200');
                            });
                            
                            // 選中當前選項
                            this.classList.remove('border-gray-200');
                            this.classList.add('border-[#181111]', 'bg-gray-50');
                            
                            bookingData.timeSlot = this.dataset.slot;
                            checkDatesValid();
                        });
                    });
                }
                
                function checkDatesValid() {
                    const nextBtn = document.getElementById('next-step-btn');
                    if (isOvernight) {
                        if (bookingData.dates.checkin && bookingData.dates.checkout) {
                            enableNextButton();
                        }
                    } else {
                        if (bookingData.dates.checkin && bookingData.timeSlot) {
                            enableNextButton();
                        }
                    }
                }
                
                function enableNextButton() {
                    const nextBtn = document.getElementById('next-step-btn');
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // 繼續按鈕事件
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 3;
                        renderBookingFlowPage();
                    }
                });
                
                // 返回按鈕事件
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    showPage('detail');
                });
            }
            
            // 步驟3: 選擇房型
            function renderRoomSelectionStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 根據服務類型過濾房型，並根據用戶偏好排序
                let availableRooms = mockRoomTypes.filter(room => room.status === 'active');
                
                // 如果用戶有偏好房型，優先顯示
                if (bookingData.preferredRoomId) {
                    availableRooms = availableRooms.sort((a, b) => {
                        if (a.id === bookingData.preferredRoomId) return -1;
                        if (b.id === bookingData.preferredRoomId) return 1;
                        return 0;
                    });
                }
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <!-- 標題與進度 -->
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">選擇房型</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                    <div class="flex-1 h-1 bg-gray-200 rounded-full ml-1"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">步驟 1/2</p>
                            </div>
                        </div>
                        
                        <!-- 選擇摘要 -->
                        <div class="bg-blue-50 rounded-lg p-3 mb-4">
                            <p class="text-sm text-blue-800">
                                <span class="font-medium">${isOvernight ? '寄宿過夜' : '日間安親'}</span>
                                ${isOvernight ? 
                                    ` • ${bookingData.dates.checkin} 至 ${bookingData.dates.checkout}` :
                                    ` • ${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                }
                            </p>
                        </div>
                        
                        <!-- 房型選擇 -->
                        <div class="space-y-4 mb-8">
                            <h2 class="text-lg font-bold text-[#181111]">選擇適合的房型</h2>
                            
                            <div class="space-y-3">
                                ${availableRooms.map(room => {
                                    const startDate = bookingData.dates.checkin;
                                    const endDate = bookingData.dates.checkout || startDate;
                                    const availableStock = checkRoomAvailability(room.id, startDate, endDate);
                                    const isAvailable = availableStock > 0;
                                    
                                    // 根據服務類型過濾方案
                                    const packages = mockPackages.filter(pkg => 
                                        pkg.roomId === room.id && 
                                        pkg.status === 'active' && 
                                        pkg.type === bookingData.serviceType
                                    );
                                    
                                    if (packages.length === 0) return ''; // 沒有對應方案就不顯示
                                    
                                    const isPreferred = room.id === bookingData.preferredRoomId;
                                    
                                    return `
                                        <div class="room-selection-card p-4 rounded-xl border-2 ${isPreferred ? 'border-blue-400 bg-blue-50' : 'border-gray-200'} ${isAvailable ? 'cursor-pointer hover:border-[#181111]' : 'opacity-60'} transition-all" 
                                             data-room-id="${room.id}" 
                                             ${!isAvailable ? 'data-unavailable="true"' : ''}>
                                            <div class="flex items-start">
                                                <img src="${room.imageUrl}" alt="${room.name}" class="w-20 h-20 rounded-lg object-cover mr-4">
                                                <div class="flex-1">
                                                    <h3 class="font-bold text-[#181111] mb-1">
                                                        ${room.name}
                                                        ${isPreferred ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full ml-2">推薦</span>' : ''}
                                                    </h3>
                                                    <p class="text-sm text-gray-500 mb-2">${room.description}</p>
                                                    ${isAvailable ? 
                                                        `<p class="text-xs text-green-600">✅ 可訂房 (剩餘 ${availableStock} 間)</p>` :
                                                        `<p class="text-xs text-red-500">❌ 已滿房</p>`
                                                    }
                                                    <div class="mt-2">
                                                        ${packages.map(pkg => `
                                                            <div class="text-sm">
                                                                <span class="font-medium">${pkg.name}</span>
                                                                <span class="text-[#181111] font-bold ml-2">
                                                                    NT$ ${pkg.basePrice.toLocaleString()} ${pkg.type === 'overnight' ? '/ 晚' : `/ ${pkg.daycareLengths || '4'}hr`}
                                                                </span>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).filter(html => html).join('')}
                            </div>
                        </div>
                        
                        <!-- 底部按鈕 -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="next-step-btn" class="btn-main w-full opacity-50 cursor-not-allowed" disabled>
                                繼續
                            </button>
                        </div>
                    </div>
                `;
                
                attachRoomSelectionListeners();
            }
            
            // 綁定房型選擇事件
            function attachRoomSelectionListeners() {
                document.querySelectorAll('.room-selection-card').forEach(card => {
                    card.addEventListener('click', function() {
                        if (this.dataset.unavailable === 'true') return;
                        
                        // 移除其他卡片的選中狀態
                        document.querySelectorAll('.room-selection-card').forEach(c => {
                            c.classList.remove('border-[#181111]', 'bg-gray-50');
                            c.classList.add('border-gray-200');
                        });
                        
                        // 選中當前卡片
                        this.classList.remove('border-gray-200');
                        this.classList.add('border-[#181111]', 'bg-gray-50');
                        
                        // 更新資料
                        bookingData.roomId = parseInt(this.dataset.roomId);
                        
                        // 找到對應的方案
                        const selectedPackage = mockPackages.find(pkg => 
                            pkg.roomId === bookingData.roomId && 
                            pkg.type === bookingData.serviceType && 
                            pkg.status === 'active'
                        );
                        if (selectedPackage) {
                            bookingData.packageId = selectedPackage.id;
                        }
                        
                        // 啟用繼續按鈕
                        const nextBtn = document.getElementById('next-step-btn');
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                });
                
                // 繼續按鈕事件
                document.getElementById('next-step-btn')?.addEventListener('click', function() {
                    if (!this.disabled) {
                        bookingStep = 4;
                        renderBookingFlowPage();
                    }
                });
                
                // 返回按鈕事件
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // 從房型選擇返回詳情頁
                    showPage('detail');
                });
                        }
            
            // 步驟4: 確認訂單
            function renderConfirmationStep() {
                const container = pages.bookingFlow;
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 取得選中的房型和方案資訊
                const selectedRoom = mockRoomTypes.find(room => room.id === bookingData.roomId);
                const selectedPackage = mockPackages.find(pkg => pkg.id === bookingData.packageId);
                
                // 計算價格
                let basePrice = selectedPackage ? selectedPackage.basePrice : 0;
                let totalPrice = basePrice;
                
                if (isOvernight && bookingData.dates.checkin && bookingData.dates.checkout) {
                    const checkinDate = new Date(bookingData.dates.checkin);
                    const checkoutDate = new Date(bookingData.dates.checkout);
                    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                    totalPrice = basePrice * nights;
                }
                
                totalPrice *= bookingData.petCount;
                
                container.innerHTML = `
                    <div class="p-4 relative min-h-full pb-20">
                        <div class="flex items-center mb-6">
                            <button id="booking-back-btn" class="p-2 mr-3">←</button>
                            <div class="flex-1">
                                <h1 class="text-xl font-bold text-[#181111]">確認訂單</h1>
                                <div class="flex mt-2">
                                    <div class="flex-1 h-1 bg-[#181111] rounded-full"></div>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">確認您的預訂資訊</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-8">
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">訂單詳情</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">服務類型</span>
                                        <span class="font-medium">${isOvernight ? '寄宿過夜' : '日間安親'}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">日期時間</span>
                                        <span class="font-medium">
                                            ${isOvernight ? 
                                                `${bookingData.dates.checkin} 至 ${bookingData.dates.checkout}` :
                                                `${bookingData.dates.checkin} ${bookingData.timeSlotName || bookingData.timeSlot}`
                                            }
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">房型</span>
                                        <span class="font-medium">${selectedRoom ? selectedRoom.name : ''}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">方案</span>
                                        <span class="font-medium">${selectedPackage ? selectedPackage.name : ''}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">住宿天數</span>
                                            <span class="font-medium">${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} 晚</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- 寵物數量和加購服務 -->
                            <div class="bg-white rounded-xl border border-gray-100 p-4">
                                <h3 class="font-bold text-[#181111] mb-3">其他選項</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">寵物數量</label>
                                        <div class="flex items-center border-2 border-[#f4f0f0] rounded-full p-1 w-fit">
                                            <button id="decrease-pet-count" class="px-3 py-1 text-lg font-bold">-</button>
                                            <input type="text" id="pet-count" value="${bookingData.petCount}" readonly class="w-10 text-center bg-transparent font-bold">
                                            <button id="increase-pet-count" class="px-3 py-1 text-lg font-bold">+</button>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="text-sm font-medium text-[#886364] block mb-2">加購服務</label>
                                        <div class="space-y-2">
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">寵物洗澡 (NT$ 300)</span>
                                                <input type="checkbox" data-price="300" data-name="寵物洗澡" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">專人陪玩 (NT$ 200)</span>
                                                <input type="checkbox" data-price="200" data-name="專人陪玩" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                            <label class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                                <span class="text-gray-700 text-sm">美容修剪 (NT$ 400)</span>
                                                <input type="checkbox" data-price="400" data-name="美容修剪" class="addon-service rounded text-black focus:ring-black">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-xl p-4">
                                <h3 class="font-bold text-[#181111] mb-3">價格明細</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between text-sm">
                                        <span>${selectedPackage ? selectedPackage.name : ''}</span>
                                        <span>NT$ ${basePrice.toLocaleString()}</span>
                                    </div>
                                    ${isOvernight && bookingData.dates.checkin && bookingData.dates.checkout ? `
                                        <div class="flex justify-between text-sm text-gray-600">
                                            <span>住宿天數</span>
                                            <span>× ${Math.ceil((new Date(bookingData.dates.checkout) - new Date(bookingData.dates.checkin)) / (1000 * 60 * 60 * 24))} 晚</span>
                                        </div>
                                    ` : ''}
                                    <div class="flex justify-between text-sm text-gray-600">
                                        <span>寵物數量</span>
                                        <span>× ${bookingData.petCount}</span>
                                    </div>
                                    <div id="addon-prices"></div>
                                    <hr class="my-2">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>總計</span>
                                        <span id="final-total">NT$ ${totalPrice.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-4 left-4 right-4">
                            <button id="confirm-booking-btn" class="btn-main w-full">
                                確認預訂
                            </button>
                        </div>
                    </div>
                `;
                
                attachConfirmationListeners();
            }
            
            // 綁定確認頁面事件
            function attachConfirmationListeners() {
                // 寵物數量調整
                document.getElementById('decrease-pet-count')?.addEventListener('click', function() {
                    if (bookingData.petCount > 1) {
                        bookingData.petCount--;
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    }
                });
                
                document.getElementById('increase-pet-count')?.addEventListener('click', function() {
                    bookingData.petCount++;
                    updatePriceTransparency();
                    checkCanContinueBooking();
                });
                
                // 加購服務
                document.querySelectorAll('.addon-service').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const price = parseInt(this.dataset.price);
                        const name = this.dataset.name;
                        
                        if (this.checked) {
                            bookingData.addons.push({ name, price });
                        } else {
                            bookingData.addons = bookingData.addons.filter(addon => addon.name !== name);
                        }
                        updatePriceTransparency();
                        checkCanContinueBooking();
                    });
                });
                
                // 確認預訂按鈕
                document.getElementById('confirm-booking-btn')?.addEventListener('click', function() {
                    // 顯示載入狀態
                    this.textContent = '處理中...';
                    this.disabled = true;
                    this.classList.add('opacity-50');
                    
                    // 模擬處理時間
                    setTimeout(() => {
                        alert('預訂成功！感謝您的預訂。');
                        showPage('detail');
                    }, 1500);
                });
                
                // 返回按鈕事件  
                document.getElementById('booking-back-btn')?.addEventListener('click', function() {
                    // 返回詳情頁重新選擇
                    showPage('detail');
                });
            }
            
            // 更新確認頁面的顯示
            function updateConfirmationDisplay() {
                const selectedPackage = mockPackages.find(pkg => pkg.id === bookingData.packageId);
                const isOvernight = bookingData.serviceType === 'overnight';
                
                // 更新寵物數量顯示
                const petCountInput = document.getElementById('pet-count');
                if (petCountInput) {
                    petCountInput.value = bookingData.petCount;
                }
                
                // 計算新的總價格
                let basePrice = selectedPackage ? selectedPackage.basePrice : 0;
                let totalPrice = basePrice;
                
                if (isOvernight && bookingData.dates.checkin && bookingData.dates.checkout) {
                    const checkinDate = new Date(bookingData.dates.checkin);
                    const checkoutDate = new Date(bookingData.dates.checkout);
                    const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                    totalPrice = basePrice * nights;
                }
                
                totalPrice *= bookingData.petCount;
                
                // 加購服務價格
                const addonTotal = bookingData.addons.reduce((sum, addon) => sum + addon.price, 0);
                totalPrice += addonTotal;
                
                // 更新價格顯示
                const totalElement = document.querySelector('#final-total');
                if (totalElement) {
                    totalElement.textContent = `NT$ ${totalPrice.toLocaleString()}`;
                }
                
                // 更新加購服務顯示
                const addonPricesElement = document.getElementById('addon-prices');
                if (addonPricesElement) {
                    addonPricesElement.innerHTML = bookingData.addons.map(addon => `
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>${addon.name}</span>
                            <span>NT$ ${addon.price.toLocaleString()}</span>
                        </div>
                    `).join('');
                }
            }
            
            function renderCalendarManagementPage() {
                const container = pages.calendarManagement;
                const activeRooms = mockRoomTypes.filter(room => room.status === 'active');
                const selectedRoom = activeRooms.find(r => r.id === currentManagementRoomId) || activeRooms[0];

                
                if (!selectedRoom) {
                    container.innerHTML = `
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-4">
                                <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                                <h1 class="text-xl font-bold text-[#181111]">管理行事曆</h1>
                                <div class="w-8"></div>
                            </div>
                            <div class="text-center text-gray-500 mt-20">
                                <p>您還沒有建立任何房型</p>
                                <button class="btn-main mt-4" onclick="showPage('roomManagement')">前往建立房型</button>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="p-4">
                        <!-- 頁面標題與返回按鈕 -->
                        <div class="flex justify-between items-center mb-4">
                            <button id="back-to-dashboard-btn" class="text-lg p-2 font-bold">&lt;</button>
                            <h1 class="text-xl font-bold text-[#181111]">管理行事曆</h1>
                            <div class="w-8"></div>
                        </div>

                        <!-- 房型選擇 -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">選擇房型</label>
                            <select id="room-type-select" class="form-input-styled">
                                ${activeRooms.map(room => `
                                    <option value="${room.id}" ${room.id === selectedRoom.id ? 'selected' : ''}>
                                        ${room.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <!-- 顯示模式選擇 -->
                        <div class="mb-4">
                            <label class="text-sm font-medium text-[#886364] mb-2 block">顯示模式</label>
                            <select id="view-mode-select" class="form-input-styled">
                                <option value="monthly" ${managementViewMode === 'monthly' ? 'selected' : ''}>月曆模式</option>
                                <option value="daily" ${managementViewMode === 'daily' ? 'selected' : ''}>時程模式</option>
                            </select>
                        </div>

                        <!-- 日曆區域 -->
                        <div id="calendar-container" class="bg-white rounded-xl border border-gray-100 p-4">
                            ${renderCalendarView(null, selectedRoom)}
                        </div>
                    </div>
                `;

                // 綁定事件監聽器
                attachCalendarManagementListeners();
            }

            function renderCalendarView(selectedPackage, selectedRoom) {
                const currentDate = managementCalendarDate;
                
                if (managementViewMode === 'monthly') {
                    return renderMonthlyCalendar(currentDate, selectedRoom);
                } else {
                    // 時程模式：尋找一個日間安親方案作為時間設定參考，如果沒有就使用預設值
                    const roomPackages = mockPackages.filter(p => p.roomId === selectedRoom.id && p.status === 'active');
                    const daycarePackage = roomPackages.find(p => p.type === 'daycare') || {
                        startTime: '09:00',
                        endTime: '18:00',
                        name: '日間安親'
                    };
                    return renderWeeklyCalendar(currentDate, daycarePackage, selectedRoom);
                }
            }

            function renderMonthlyCalendar(currentDate, selectedRoom) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-month-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${year}年 ${month + 1}月</h3>
                            <button id="next-month-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center text-sm text-[#886364] mb-2">
                        <span>日</span><span>一</span><span>二</span><span>三</span><span>四</span><span>五</span><span>六</span>
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                `;

                // 填充月初空白
                for (let i = 0; i < firstDay; i++) {
                    calendarHTML += '<div class="h-16"></div>';
                }

                // 生成日期格子
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isPast = date < today;
                    const stockInfo = calculateDailyStock(date, selectedRoom);
                    const stockClass = getStockColorClass(stockInfo.available);
                    
                    calendarHTML += `
                        <div class="calendar-day-cell h-16 border border-gray-200 rounded-lg p-1 cursor-pointer ${isPast ? 'opacity-50' : ''} ${stockClass}" 
                             data-date="${date.toISOString().split('T')[0]}" 
                             data-room-id="${selectedRoom.id}" 
                             data-view-mode="monthly">
                            <div class="text-xs font-medium">${day}</div>
                            <div class="text-xs ${stockInfo.available === 0 ? 'text-red-600' : 'text-gray-600'}">
                                ${stockInfo.available > 0 ? `空房 ${stockInfo.available}` : '已滿'}
                            </div>
                        </div>
                    `;
                }

                calendarHTML += '</div>';
                return calendarHTML;
            }

            function renderWeeklyCalendar(currentDate, selectedPackage, selectedRoom) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // 生成詳細時間段 (每15分鐘一個時段)
                const timeSlots = generateTimeSlots(selectedPackage);
                
                // 生成房間列表，使用實際的房間庫存數量
                const rooms = Array.from({length: selectedRoom.stock}, (_, i) => ({
                    id: i + 1,
                    name: `${selectedRoom.name}`,
                    roomNumber: `${i + 1}號房`,
                    type: selectedRoom.name
                }));

                let calendarHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between items-center">
                            <button id="prev-day-manage" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                            <h3 class="font-bold text-lg">${formatDate(currentDate)}</h3>
                            <button id="next-day-manage" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                        </div>
                        <div class="text-sm text-gray-600 text-center">
                            ${selectedRoom.name} (總計 ${selectedRoom.stock} 間)
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-96">
                        <div class="flex">
                            <!-- 時間軸 -->
                            <div class="flex-shrink-0 w-16 bg-gray-50 border-r">
                                <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium">時間</div>
                                ${timeSlots.map((slot, index) => `
                                    <div class="h-8 border-b flex items-center justify-center text-xs font-medium text-gray-800" style="min-height: 32px;">
                                        ${slot.startTime}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- 房間列 -->
                            ${rooms.map(room => `
                                <div class="flex-1 border-r min-w-0">
                                    <div class="h-10 border-b bg-white flex items-center justify-center text-xs font-medium px-1">
                                        <div class="text-center w-full">
                                            <div class="text-xs font-medium">${room.roomNumber}</div>
                                        </div>
                                    </div>
                                    ${generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today)}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                return calendarHTML;
            }

            function generateTimeSlots(selectedPackage) {
                const slots = [];
                const startTime = selectedPackage.startTime || '09:00';
                const endTime = selectedPackage.endTime || '18:00';
                
                // 解析開始和結束時間
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // 以整點為單位生成時段 (例如 9:00-10:00, 10:00-11:00)
                for (let hour = startHour; hour < endHour; hour++) {
                    const startTimeStr = `${hour.toString().padStart(2, '0')}:00`;
                    const endTimeStr = `${(hour + 1).toString().padStart(2, '0')}:00`;
                    
                    slots.push({
                        startTime: startTimeStr,
                        endTime: endTimeStr,
                        display: `${startTimeStr}`,
                        minutes: hour * 60 // 添加分鐘數便於計算
                    });
                }
                
                return slots;
            }

            function isPastTime(timeStr) {
                const now = new Date();
                const [hour, min] = timeStr.split(':').map(Number);
                const timeToCheck = new Date();
                timeToCheck.setHours(hour, min, 0, 0);
                return now > timeToCheck;
            }

            function isCurrentTimeSlot(startTime, endTime) {
                const now = new Date();
                const currentHour = now.getHours();
                
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                // 檢查當前小時是否在這個整點時段內
                return currentHour >= startHour && currentHour < endHour;
            }

            function generateRoomTimeline(currentDate, room, timeSlots, selectedPackage, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // 獲取該房間的所有預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                let timelineHTML = '';
                let skipSlots = 0; // 用於跳過已被合併的時段
                
                for (let index = 0; index < timeSlots.length; index++) {
                    const slot = timeSlots[index];
                    
                    // 如果這個時段已被前面的預訂合併，跳過
                    if (skipSlots > 0) {
                        skipSlots--;
                        continue;
                    }
                    
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    
                    // 檢查是否有預訂覆蓋這個時段
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    if (booking) {
                        // 計算這個預訂跨越多少個時段
                        const bookingSpan = calculateBookingSpan(booking.timeSlot, timeSlots, index);
                        skipSlots = bookingSpan - 1; // 跳過後續的時段
                        
                        // 生成跨越多個時段的預訂格子
                        timelineHTML += `
                            <td class="border-r border-gray-200 h-10 cursor-pointer relative bg-red-400" 
                                colspan="${bookingSpan}"
                                data-date="${dateStr}"
                                data-time-slot="${booking.timeSlot}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                <div class="text-xs text-white text-center font-medium leading-tight px-1" style="font-size: 10px;">
                                    ${booking.customer}
                                </div>
                                <div class="text-xs text-red-100 text-center leading-tight px-1" style="font-size: 9px;">
                                    ${booking.timeSlot}
                                </div>
                            </td>
                        `;
                    } else {
                        // 生成空的可預訂格子
                        let cellClass = 'border-r border-gray-200 h-10 cursor-pointer relative bg-green-100 hover:bg-green-200';
                        let cellContent = '<div class="text-xs text-green-700 text-center mt-2" style="font-size: 9px;">可預訂</div>';
                        
                        // 添加當前時間線
                        if (isCurrentTime) {
                            cellContent += '<div class="absolute inset-0 border-l-4 border-green-500 current-time-line pointer-events-none"></div>';
                            cellContent += '<div class="absolute top-0 left-0 w-1 h-full bg-green-500 current-time-line pointer-events-none"></div>';
                        }
                        
                        timelineHTML += `
                            <td class="${cellClass}"
                                data-date="${dateStr}"
                                data-time-slot="${slot.startTime}-${slot.endTime}"
                                data-room-id="${room.id}"
                                data-view-mode="daily">
                                ${cellContent}
                            </td>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function generateVerticalRoomTimeline(currentDate, room, timeSlots, selectedRoom, today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // 獲取該房間的所有預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // 創建時段狀態陣列
                const slotStates = timeSlots.map((slot, index) => {
                    const isCurrentTime = currentDate.toDateString() === today.toDateString() && isCurrentTimeSlot(slot.startTime, slot.endTime);
                    const booking = roomBookings.find(b => 
                        isTimeSlotOverlap(b.timeSlot, `${slot.startTime}-${slot.endTime}`)
                    );
                    
                    return {
                        slot,
                        index,
                        isCurrentTime,
                        booking,
                        isBooked: !!booking,
                        processed: false
                    };
                });
                
                let timelineHTML = '';
                
                for (let i = 0; i < slotStates.length; i++) {
                    const currentState = slotStates[i];
                    
                    if (currentState.processed) {
                        continue;
                    }
                    
                    if (currentState.isBooked) {
                        // 處理預訂時段
                        const bookingSpan = calculateBookingSpan(currentState.booking.timeSlot, timeSlots, i);
                        
                        // 標記相關時段為已處理
                        for (let j = i; j < i + bookingSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = bookingSpan * 32; // 每個整點時段32px高度
                        
                        timelineHTML += `
                            <div class="border-b bg-red-400 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${currentState.booking.timeSlot}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-white font-medium leading-tight" style="font-size: 10px;">
                                        ${currentState.booking.customer}
                                    </div>
                                    <div class="text-xs text-red-100 leading-tight" style="font-size: 9px;">
                                        ${currentState.booking.timeSlot}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // 處理可預訂時段 - 尋找連續的可預訂時段
                        let availableSpan = 1;
                        let hasCurrentTime = currentState.isCurrentTime;
                        
                        // 計算連續的可預訂時段數量
                        for (let j = i + 1; j < slotStates.length; j++) {
                            if (slotStates[j].isBooked || slotStates[j].processed) {
                                break;
                            }
                            availableSpan++;
                            if (slotStates[j].isCurrentTime) {
                                hasCurrentTime = true;
                            }
                        }
                        
                        // 標記相關時段為已處理
                        for (let j = i; j < i + availableSpan && j < slotStates.length; j++) {
                            slotStates[j].processed = true;
                        }
                        
                        const blockHeight = availableSpan * 32; // 每個整點時段32px高度
                        
                        // 計算時間範圍顯示
                        const startTime = currentState.slot.startTime;
                        const endTime = timeSlots[i + availableSpan - 1]?.endTime || currentState.slot.endTime;
                        const timeRange = availableSpan > 1 ? `${startTime}-${endTime}` : `${startTime}-${currentState.slot.endTime}`;
                        
                        timelineHTML += `
                            <div class="border-b bg-green-100 hover:bg-green-200 cursor-pointer relative flex items-center justify-center text-center" 
                                 style="height: ${blockHeight}px; min-height: 32px;"
                                 data-date="${dateStr}"
                                 data-time-slot="${timeRange}"
                                 data-room-id="${room.id}"
                                 data-view-mode="daily">
                                <div class="px-2">
                                    <div class="text-xs text-green-700 font-medium" style="font-size: 9px;">
                                        可預訂
                                    </div>
                                    ${availableSpan > 2 ? `<div class="text-xs text-green-600 leading-tight" style="font-size: 8px;">${timeRange}</div>` : ''}
                                </div>
                                ${hasCurrentTime ? '<div class="absolute left-0 top-0 w-full h-1 bg-green-500 current-time-line"></div>' : ''}
                            </div>
                        `;
                    }
                }
                
                return timelineHTML;
            }

            function getRoomBookings(dateStr, roomId) {
                // 模擬多天的預訂資料 (以整點為單位)
                const allBookings = {
                    // 今天 - 比較滿的一天
                    [getTodayString()]: [
                        { roomId: 1, timeSlot: '09:00-11:00', customer: '王小明', pet: '黃金獵犬' },
                        { roomId: 1, timeSlot: '14:00-16:00', customer: '李小華', pet: '英短貓' },
                        { roomId: 2, timeSlot: '10:00-12:00', customer: '陳大同', pet: '柴犬' },
                        { roomId: 2, timeSlot: '15:00-17:00', customer: '周雅婷', pet: '貴賓狗' },
                        { roomId: 3, timeSlot: '09:00-10:00', customer: '張美玲', pet: '波斯貓' },
                        { roomId: 3, timeSlot: '13:00-15:00', customer: '劉志明', pet: '哈士奇' },
                        // 4號房和5號房空房
                    ],
                    // 明天 - 輕鬆的一天
                    [getTomorrowString()]: [
                        { roomId: 1, timeSlot: '10:00-12:00', customer: '林美惠', pet: '摺耳貓' },
                        { roomId: 3, timeSlot: '14:00-16:00', customer: '張志偉', pet: '柯基犬' },
                        // 其他房間空房
                    ],
                    // 後天 - 忙碌的一天
                    [getDateString(2)]: [
                        { roomId: 1, timeSlot: '09:00-12:00', customer: '吳雅玲', pet: '哈士奇' },
                        { roomId: 1, timeSlot: '15:00-17:00', customer: '黃志明', pet: '貴賓狗' },
                        { roomId: 2, timeSlot: '09:00-11:00', customer: '陳佳慧', pet: '拉布拉多' },
                        { roomId: 2, timeSlot: '13:00-16:00', customer: '劉建國', pet: '黃金獵犬' },
                        { roomId: 3, timeSlot: '10:00-13:00', customer: '許雅婷', pet: '博美犬' },
                        { roomId: 4, timeSlot: '11:00-14:00', customer: '王大明', pet: '柴犬' },
                        { roomId: 5, timeSlot: '09:00-11:00', customer: '李小芳', pet: '英短貓' },
                        { roomId: 5, timeSlot: '16:00-18:00', customer: '蔡志豪', pet: '米克斯' },
                    ],
                    // 大後天 - 週末滿房
                    [getDateString(3)]: [
                        { roomId: 1, timeSlot: '09:00-13:00', customer: '周美玲', pet: '薩摩耶' },
                        { roomId: 1, timeSlot: '14:00-18:00', customer: '張家豪', pet: '阿拉斯加' },
                        { roomId: 2, timeSlot: '09:00-12:00', customer: '林志玲', pet: '吉娃娃' },
                        { roomId: 2, timeSlot: '13:00-17:00', customer: '王建民', pet: '法鬥' },
                        { roomId: 3, timeSlot: '09:00-14:00', customer: '陳美華', pet: '瑪爾濟斯' },
                        { roomId: 3, timeSlot: '15:00-18:00', customer: '劉德華', pet: '約克夏' },
                        { roomId: 4, timeSlot: '09:00-15:00', customer: '蔡依林', pet: '邊境牧羊犬' },
                        { roomId: 4, timeSlot: '16:00-18:00', customer: '郭富城', pet: '史賓格' },
                        { roomId: 5, timeSlot: '09:00-16:00', customer: '周杰倫', pet: '德國牧羊犬' },
                        { roomId: 5, timeSlot: '17:00-18:00', customer: '林俊傑', pet: '威爾斯柯基' },
                    ],
                    // 第五天 - 普通工作日
                    [getDateString(4)]: [
                        { roomId: 2, timeSlot: '10:00-13:00', customer: '何佳玲', pet: '雪納瑞' },
                        { roomId: 4, timeSlot: '14:00-17:00', customer: '呂志偉', pet: '西高地白梗' },
                    ],
                };
                
                const dayBookings = allBookings[dateStr] || [];
                return dayBookings.filter(b => b.roomId === roomId).map(b => ({
                    ...b,
                    date: dateStr
                }));
            }
            
            // 輔助函數：取得日期字串
            function getTodayString() {
                return new Date().toISOString().split('T')[0];
            }
            
            function getTomorrowString() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow.toISOString().split('T')[0];
            }
            
            function getDateString(daysFromNow) {
                const date = new Date();
                date.setDate(date.getDate() + daysFromNow);
                return date.toISOString().split('T')[0];
            }

            function calculateBookingSpan(bookingTimeSlot, timeSlots, startIndex) {
                const [bookingStart, bookingEnd] = bookingTimeSlot.split('-');
                const bookingStartMinutes = timeToMinutes(bookingStart);
                const bookingEndMinutes = timeToMinutes(bookingEnd);
                
                let span = 0;
                for (let i = startIndex; i < timeSlots.length; i++) {
                    const slot = timeSlots[i];
                    const slotStartMinutes = timeToMinutes(slot.startTime);
                    const slotEndMinutes = timeToMinutes(slot.endTime);
                    
                    // 如果時段與預訂有重疊，增加跨度
                    if (slotStartMinutes < bookingEndMinutes && slotEndMinutes > bookingStartMinutes) {
                        span++;
                    } else if (slotStartMinutes >= bookingEndMinutes) {
                        // 如果時段開始時間已經超過預訂結束時間，停止計算
                        break;
                    }
                }
                
                return Math.max(1, span); // 至少跨越1個時段
            }

            function timeToMinutes(timeStr) {
                const [hour, min] = timeStr.split(':').map(Number);
                return hour * 60 + min;
            }

            function getRoomBookingInfo(date, timeSlot, room, selectedPackage) {
                // 模擬預訂資料 - 根據房間ID和時間段生成一些預訂
                const dateStr = date.toISOString().split('T')[0];
                const timeKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                
                // 獲取房間預訂
                const roomBookings = getRoomBookings(dateStr, room.id);
                
                // 檢查是否有預訂衝突
                const booking = roomBookings.find(b => 
                    isTimeSlotOverlap(b.timeSlot, timeKey)
                );
                
                if (booking) {
                    return {
                        isBooked: true,
                        customerName: booking.customer,
                        petInfo: booking.pet,
                        timeSlot: booking.timeSlot
                    };
                }
                
                return {
                    isBooked: false,
                    customerName: null,
                    petInfo: null,
                    timeSlot: null
                };
            }

            function isTimeSlotOverlap(bookedSlot, checkSlot) {
                // 簡化的時間重疊檢查
                const [bookedStart, bookedEnd] = bookedSlot.split('-');
                const [checkStart, checkEnd] = checkSlot.split('-');
                
                const bookedStartMin = timeToMinutes(bookedStart);
                const bookedEndMin = timeToMinutes(bookedEnd);
                const checkStartMin = timeToMinutes(checkStart);
                const checkEndMin = timeToMinutes(checkEnd);
                
                // 檢查是否有重疊
                return !(bookedEndMin <= checkStartMin || bookedStartMin >= checkEndMin);
            }

            function calculateDailyStock(date, room) {
                const totalStock = room.stock;
                const dateStr = date.toISOString().split('T')[0];
                
                // 計算當天有預訂的房間數量（每個房間只要有任何時段預訂就算佔用一間）
                const occupiedRooms = new Set(); // 使用 Set 來避免重複計算同一房間
                
                // 檢查每個房間是否在當天有任何預訂
                for (let roomNumber = 1; roomNumber <= totalStock; roomNumber++) {
                    const roomBookings = getRoomBookings(dateStr, roomNumber);
                    if (roomBookings.length > 0) {
                        occupiedRooms.add(roomNumber);
                    }
                }
                
                const bookedCount = occupiedRooms.size;
                const available = Math.max(0, totalStock - bookedCount);
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: available
                };
            }

            function calculateHourlyStock(date, timeSlot, room) {
                // 模擬計算邏輯
                const totalStock = room.stock;
                
                // 處理新的時間段格式
                let timeSlotKey;
                if (typeof timeSlot === 'object') {
                    timeSlotKey = `${timeSlot.startTime}-${timeSlot.endTime}`;
                } else {
                    timeSlotKey = timeSlot;
                }
                
                const bookings = mockBookings.filter(b => 
                    b.roomId === room.id && 
                    new Date(b.startDate).toDateString() === date.toDateString()
                );
                
                // 根據時間段和日期計算預訂數量
                const bookedCount = Math.min(bookings.length, Math.floor(Math.random() * 3)); // 模擬時段預訂
                
                return {
                    total: totalStock,
                    booked: bookedCount,
                    available: Math.max(0, totalStock - bookedCount)
                };
            }

            function getStockColorClass(available) {
                if (available === 0) return 'bg-red-100';
                if (available <= 2) return 'bg-yellow-100';
                return 'bg-green-100';
            }

            function formatDate(date) {
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }

            function updateCalendarView(isRoomChange = false) {
                const roomId = currentManagementRoomId;
                const selectedRoom = mockRoomTypes.find(r => r.id === roomId);
                const roomPackages = mockPackages.filter(p => p.roomId === roomId && p.status === 'active');
                
                const packageSelect = document.getElementById('package-select');
                let packageId;
                
                if (isRoomChange) {
                    // 房型改變時，更新方案選擇列表並選擇第一個
                    if (packageSelect) {
                        packageSelect.innerHTML = roomPackages.map(pkg => `
                            <option value="${pkg.id}">${pkg.name}</option>
                        `).join('');
                    }
                    packageId = roomPackages[0]?.id || 0;
                } else {
                    // 方案選擇改變時，直接使用當前選中的方案
                    packageId = parseInt(packageSelect?.value || roomPackages[0]?.id || 0);
                }
                
                const selectedPackage = mockPackages.find(p => p.id === packageId);
                
                const calendarContainer = document.getElementById('calendar-container');
                if (calendarContainer) {
                    calendarContainer.innerHTML = renderCalendarView(selectedPackage, selectedRoom);
                }
            }

            function attachCalendarManagementListeners() {
                // 房型選擇
                document.getElementById('room-type-select')?.addEventListener('change', function() {
                    currentManagementRoomId = parseInt(this.value);
                    updateCalendarView(true); // 傳入 true 表示是房型改變
                });

                // 顯示模式選擇
                document.getElementById('view-mode-select')?.addEventListener('change', function() {
                    managementViewMode = this.value;
                    updateCalendarView(false);
                });

                // 月曆導航
                document.getElementById('prev-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() - 1);
                    updateCalendarView(false); // 導航不改變房型或方案
                });

                document.getElementById('next-month-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setMonth(managementCalendarDate.getMonth() + 1);
                    updateCalendarView(false); // 導航不改變房型或方案
                });

                // 日期導航
                document.getElementById('prev-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() - 1);
                    updateCalendarView(false);
                });

                document.getElementById('next-day-manage')?.addEventListener('click', function() {
                    managementCalendarDate.setDate(managementCalendarDate.getDate() + 1);
                    updateCalendarView(false);
                });

                // 日期/時段點擊事件
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.calendar-day-cell, td[data-date], div[data-date]')) {
                        const element = e.target.closest('.calendar-day-cell, td[data-date], div[data-date]');
                        const date = element.dataset.date;
                        const roomId = parseInt(element.dataset.roomId);
                        const viewMode = element.dataset.viewMode;
                        const timeSlot = element.dataset.timeSlot;
                        
                        showAvailabilityModal(date, roomId, viewMode, timeSlot);
                    }
                });
            }

            function showAvailabilityModal(date, roomId, viewMode, timeSlot) {
                const room = mockRoomTypes.find(r => r.id === roomId);
                const stockInfo = timeSlot ? 
                    calculateHourlyStock(new Date(date), timeSlot, room) :
                    calculateDailyStock(new Date(date), room);
                
                const modalTitle = timeSlot ? 
                    `管理 ${formatDate(new Date(date))} ${timeSlot} 時段可用性` :
                    `管理 ${formatDate(new Date(date))} 日期可用性`;

                const serviceTypeText = viewMode === 'monthly' ? '過夜寄宿' : '日間安親';

                const modalContent = `
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#181111]">${modalTitle}</h2>
                            <button id="close-availability-modal" class="text-2xl">&times;</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <p class="text-sm text-gray-600">服務類型：${serviceTypeText}</p>
                                <p class="text-sm text-gray-600">房型：${room.name}</p>
                                <p class="text-sm text-gray-600">當前剩餘空房</p>
                                <p class="text-lg font-bold text-[#181111]">${stockInfo.available} / ${stockInfo.total}</p>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">手動調整可用數量</label>
                                <input type="number" id="manual-stock-input" class="form-input-styled mt-1" 
                                       value="${stockInfo.available}" min="0" max="${stockInfo.total}">
                                <p class="text-xs text-gray-500 mt-1">設定為 0 表示完全不可預訂</p>
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-[#886364]">設為不可預訂</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="unavailable-toggle" ${stockInfo.available === 0 ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div>
                                <label class="text-sm font-medium text-[#886364]">備註 (選填)</label>
                                <textarea id="availability-note" class="form-input-styled mt-1 h-20" 
                                          placeholder="例如：因消毒關閉、員工不足等"></textarea>
                            </div>

                            <div class="flex gap-2 pt-4">
                                <button id="clear-manual-settings" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded-full text-sm">
                                    清除手動設定
                                </button>
                                <button id="save-availability" class="flex-1 py-2 px-4 bg-[#181111] text-white rounded-full text-sm">
                                    儲存
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // 創建模態框
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content max-w-md w-full">
                        ${modalContent}
                    </div>
                `;
                document.body.appendChild(modal);

                // 綁定模態框事件
                modal.querySelector('#close-availability-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.querySelector('#unavailable-toggle').addEventListener('change', function() {
                    const stockInput = modal.querySelector('#manual-stock-input');
                    stockInput.value = this.checked ? '0' : stockInfo.available;
                });

                modal.querySelector('#save-availability').addEventListener('click', () => {
                    alert('可用性設定已儲存 (模擬)');
                    document.body.removeChild(modal);
                });

                modal.querySelector('#clear-manual-settings').addEventListener('click', () => {
                    modal.querySelector('#manual-stock-input').value = stockInfo.available;
                    modal.querySelector('#unavailable-toggle').checked = false;
                    modal.querySelector('#availability-note').value = '';
                });
            }

            // --- 事件監聽器綁定 ---
            function attachBookingModuleListeners() {
                document.getElementById('checkin-date')?.addEventListener('click', openCalendar);
                document.getElementById('checkout-date')?.addEventListener('click', openCalendar);
                document.getElementById('decrease-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    let count = parseInt(input.value);
                    if (count > 1) input.value = count - 1;
                    updatePrice();
                });
                document.getElementById('increase-pet-count')?.addEventListener('click', () => {
                    let input = document.getElementById('pet-count');
                    input.value = parseInt(input.value) + 1;
                    updatePrice();
                });
                document.querySelectorAll('.addon-service').forEach(el => el.addEventListener('change', updatePrice));
            }
            
            // 綁定房型選項事件監聽器
            function attachRoomOptionListeners() {
                document.querySelectorAll('.package-item').forEach(item => {
                    item.addEventListener('click', function() {
                        // 檢查是否為不可用的房型
                        if(this.style.opacity === '0.5' || this.style.pointerEvents === 'none') return;
                        
                        // 移除所有選中的方案
                        document.querySelectorAll('.package-item.selected').forEach(p => p.classList.remove('selected'));
                        // 隱藏所有時段選擇區域
                        document.querySelectorAll('.time-slots-container').forEach(container => container.classList.add('hidden'));
                        // 重置所有時段按鈕狀態
                        document.querySelectorAll('.time-slot-btn.selected').forEach(btn => btn.classList.remove('selected'));
                        
                        // 選中當前方案
                        this.classList.add('selected');
                        
                        // 如果是安親方案，顯示對應的時段選擇
                        const packageType = this.dataset.packageType;
                        const packageId = this.dataset.packageId;
                        if (packageType === 'daycare' && packageId) {
                            const timeSlotsContainer = document.getElementById(`timeslots-${packageId}`);
                            if (timeSlotsContainer) {
                                timeSlotsContainer.classList.remove('hidden');
                            }
                        }
                        
                        updatePrice();
                    });
                });
                
                // 綁定時段按鈕事件監聽器
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation(); // 防止觸發父級的package-item點擊事件
                        
                        if (this.disabled) return;
                        
                        const packageId = this.dataset.packageId;
                        
                        // 移除同一方案下其他時段的選中狀態
                        document.querySelectorAll(`.time-slot-btn[data-package-id="${packageId}"].selected`).forEach(otherBtn => {
                            otherBtn.classList.remove('selected');
                        });
                        
                        // 選中當前時段
                        this.classList.add('selected');
                        
                        updatePrice();
                    });
                });
            }

            document.body.addEventListener('click', function(e) {
                // 頁面切換
                if (e.target.closest('.nav-item')) showPage(e.target.closest('.nav-item').dataset.page);
                if (e.target.closest('#profile-icon-button')) showPage('account');
                if (e.target.closest('.listing-card')) showPage('detail');
                if (e.target.closest('#chat-icon-button')) showPage('chat');
                // 搜尋框
                if (e.target.id === 'home-search-input') showPage('searchResult');
                // 會員中心
                if (e.target.closest('#become-merchant')) {
                    alert('感謝您的申請！您現在是商家了。');
                    isUserMerchant = true;
                    updateUserCenterOptions();
                }
                if (e.target.closest('#merchant-entry')) showPage('merchantDashboard');
                if (e.target.closest('#back-to-dashboard-btn')) showPage('merchantDashboard');
                if (e.target.closest('#manage-rooms-link')) showPage('roomManagement');
                if (e.target.closest('#manage-calendar-btn')) showPage('calendarManagement');
                // 新增：商家中心各入口
                if (e.target.closest('#md-orders')) {
                    alert('訂單管理（示意）：顯示顧客資訊與寵物需求');
                }
                if (e.target.closest('#md-occupancy')) {
                    openOccupancyModal();
                }
                if (e.target.closest('#md-finance')) {
                    openFinanceModal();
                }
                if (e.target.closest('#md-reports')) {
                    openReportsModal();
                }
                if (e.target.closest('#md-chat')) {
                    showPage('chat');
                }
                if (e.target.closest('#md-coupons')) {
                    openCouponManageModal();
                }
                if (e.target.closest('#add-new-room-btn')) renderRoomForm();
                if (e.target.closest('.edit-room-btn')) {
                    const roomId = parseInt(e.target.closest('.edit-room-btn').dataset.roomId);
                    renderRoomForm(roomId);
                }
                if (e.target.closest('#cancel-form-btn')) {
                     formModal.classList.add('hidden');
                     if(document.getElementById('package-name')) { // 判斷是方案表單
                        const roomId = parseInt(document.getElementById('save-package-btn').dataset.roomId);
                        showPage('packageManagement', { roomId: roomId });
                     } else {
                        showPage('roomManagement');
                     }
                }

                // 訂單篩選
                if (e.target.closest('.order-filter-btn')) renderOrders(e.target.closest('.order-filter-btn').dataset.filter);
                // 日曆
                if (e.target.closest('#prev-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); }
                if (e.target.closest('#next-month')) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); }
                if (e.target.closest('#calendar-cancel')) calendarModal.classList.add('hidden');
                if (e.target.closest('#calendar-confirm')) {
                    const checkinInput = document.getElementById('checkin-date');
                    const checkoutInput = document.getElementById('checkout-date');
                    if(selectedCheckinDate) checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                    if(selectedCheckoutDate) checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
                    updatePrice();
                    calendarModal.classList.add('hidden');
                }
                if (e.target.closest('#calendar-days')) handleDateClick(e);
                // 管理行事曆 - 移除全域事件監聽器，改由 attachCalendarManagementListeners 處理
                // 房型表單中的寵物類型
                if (e.target.matches('input[name="pet-type"][value="dog"]')) {
                    document.getElementById('dog-size-options').classList.toggle('hidden', !e.target.checked);
                }
                // 方案管理
                if (e.target.closest('.manage-packages-btn')) {
                    const roomId = parseInt(e.target.closest('.manage-packages-btn').dataset.roomId);
                    showPage('packageManagement', { roomId: roomId });
                }
                if (e.target.closest('#add-new-package-btn')) {
                    const roomId = parseInt(e.target.dataset.roomId);
                    renderPackageForm(roomId, null);
                }
                if (e.target.closest('.edit-package-btn')) {
                    const packageId = parseInt(e.target.dataset.packageId);
                    const roomId = parseInt(e.target.dataset.roomId);
                    renderPackageForm(roomId, packageId);
                }
                if (e.target.closest('#back-to-room-list-btn')) showPage('roomManagement');
                if (e.target.id === 'save-package-btn') {
                    alert('方案已儲存 (模擬)。');
                    formModal.classList.add('hidden');
                    const roomId = parseInt(e.target.dataset.roomId);
                    showPage('packageManagement', { roomId: roomId });
                }
            });

            // --- 初始化 ---
            showPage('home');
            
            // 設定入住/退房日期預設為今天
            const today = new Date();
            selectedCheckinDate = today;
            selectedCheckoutDate = new Date(today.getTime() + (24 * 60 * 60 * 1000)); // 明天
            
            // 更新日期輸入框顯示
            const checkinInput = document.getElementById('checkin-date');
            const checkoutInput = document.getElementById('checkout-date');
            if(checkinInput && checkoutInput) {
                checkinInput.value = selectedCheckinDate.toISOString().split('T')[0];
                checkoutInput.value = selectedCheckoutDate.toISOString().split('T')[0];
            }

            // Leaflet 地圖無需全局回調，直接在頁面載入時初始化
        });
    </script>
</body>
</html>
